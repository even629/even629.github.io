<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>AArch64 ASM | even629的博客</title><meta name="author" content="even629"><meta name="copyright" content="even629"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="arm64 asm">
<meta property="og:type" content="article">
<meta property="og:title" content="AArch64 ASM">
<meta property="og:url" content="https://even629.com/posts/42868/index.html">
<meta property="og:site_name" content="even629的博客">
<meta property="og:description" content="arm64 asm">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://even629.com/img/avatar.jpg">
<meta property="article:published_time" content="2025-06-22T02:25:13.000Z">
<meta property="article:modified_time" content="2025-06-22T02:25:13.000Z">
<meta property="article:author" content="even629">
<meta property="article:tag" content="asm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://even629.com/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://even629.com/posts/42868/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><meta name="baidu-site-verification" content="codeva-g8sPzVXu98"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"中"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: even629","link":"链接: ","source":"来源: even629的博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'AArch64 ASM',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><link rel='preload', href='/img/avatar.webp', as='image'><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/right_menu.css"><link rel="stylesheet" href="/css/music.css"><span id="fps"></span><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="/css/wow_animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body><div class="float-box left top"></div><div class="float-box left bottom"></div><div class="float-box right top"></div><div class="float-box right bottom"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg" style="background-image: url(/img/black.jpg);"></div><div id="an_music_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/charts/"><i class="fa-fw fas fa-solid fa-chart-simple"></i><span> 统计</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 分享</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comments"></i><span> 说说</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-solid fa-link"></i><span> 友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/black-rock-shotter.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/avatar.jpg" alt="Logo"><span class="site-name">even629的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">AArch64 ASM</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/charts/"><i class="fa-fw fas fa-solid fa-chart-simple"></i><span> 统计</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 分享</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comments"></i><span> 说说</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-solid fa-link"></i><span> 友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">AArch64 ASM</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-06-22T02:25:13.000Z" title="发表于 2025-06-22 10:25:13">2025-06-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-06-22T02:25:13.000Z" title="更新于 2025-06-22 10:25:13">2025-06-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/arm64/">arm64</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">14.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>81分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/42868/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="preknowledge"><a href="#preknowledge" class="headerlink" title="preknowledge"></a>preknowledge</h1><p>1 <strong>byte</strong> has 8 <strong>bits</strong></p>
<ul>
<li><strong>char</strong> has 1 <strong>byte</strong></li>
<li><strong>short</strong> has 2 <strong>byte</strong></li>
<li><strong>int</strong> has 4 <strong>byte</strong></li>
</ul>
<p><img src="https://raw.githubusercontent.com/even629/myPicGo/main/v2-b9e8babf753b1691039458592667121a_1440w.jpg" alt="img"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -E hello.c -o hello.i</span><br><span class="line">gcc -S hello.i -o hello.s</span><br><span class="line">gcc -c hello.s -o hello.o</span><br><span class="line">gcc hello.o -o hello</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>All</strong> AARCH64 instructions are 4 bytes in width.</p>
</li>
<li><p><strong>All</strong> AARCH64 pointers are 8 bytes in width†.</p>
<blockquote>
<p>While this is technically true, typically only the lower 39, 42 or 48 bits of addresses in Linux systems are used - i.e. the virtual address space of an ARM Linux process is smaller than 64 bits. The upper bits are set to zero when considering the address as an 8-byte value.</p>
</blockquote>
</li>
</ul>
<h1 id="register"><a href="#register" class="headerlink" title="register"></a>register</h1><h2 id="register-access-speed"><a href="#register-access-speed" class="headerlink" title="register access speed"></a>register access speed</h2><p><img src="https://raw.githubusercontent.com/even629/myPicGo/main/latency.png" alt="Latency"></p>
<blockquote>
<p>This says that if we liken accessing a register (which can be done at <em>least</em> once per CPU Clock Cycle) to one second, accessing RAM would be like a 3.5 to 5.5 minute wait.</p>
</blockquote>
<h2 id="register-type"><a href="#register-type" class="headerlink" title="register type"></a>register type</h2><ul>
<li>rn means register “of some type” number n.</li>
</ul>
<p>The kind of register is specified by a letter. Which register within a given type is specified by a number. There are some exceptions to this. Here is an introductory summary:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Letter</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>x</td>
<td>64 bit integer or pointer</td>
</tr>
<tr>
<td>w</td>
<td>32 bit <em>or smaller</em> integer</td>
</tr>
<tr>
<td>d</td>
<td>64 bit floats (doubles)</td>
</tr>
<tr>
<td>s</td>
<td>32 bit floats</td>
</tr>
</tbody>
</table>
</div>
<p>Some register types have been left out.</p>
<p>（Chapter 9.1）（Cortex-A Series Programmer’s Guide for ARMv8-A）</p>
<p><img src="https://raw.githubusercontent.com/even629/myPicGo/main/image-20250511155518113.png" alt="image-20250511155518113"></p>
<ul>
<li>x29是栈帧指针（FP）</li>
<li>x30是链接寄存器（LR，即返回地址）</li>
</ul>
<p>The registers used for floating point types (and vector operations) are coincident:</p>
<p><img src="https://raw.githubusercontent.com/even629/myPicGo/main/image-20250511210301586.png" alt="image-20250511210301586"></p>
<ul>
<li><code>q</code> registers are a massive 16 bytes wide - quad words.(vn的别名，主要用于<strong>SIMD/Neon</strong> 指令中)</li>
<li><code>v</code> registers are also 16 bytes wide and are synonyms for the <code>q</code> registers.</li>
<li><code>d</code> registers for <code>doubles</code> which are 8 bytes wide - <strong>double precision</strong>. 2 per <code>v</code>.</li>
<li><code>s</code> registers for <code>floats</code> which are 4 bytes wide - <strong>single precisio</strong>n. 4 per <code>v</code>.</li>
<li><code>h</code> registers for <code>half precisions floats</code> which are 2 bytes wide. 8 per <code>v</code>.</li>
<li><code>b</code> registers for byte operations. 16 per <code>v</code>.</li>
</ul>
<h2 id="register-and-C-type"><a href="#register-and-C-type" class="headerlink" title="register and C type"></a>register and C type</h2><h3 id="Integers"><a href="#Integers" class="headerlink" title="Integers"></a>Integers</h3><div class="table-container">
<table>
<thead>
<tr>
<th>This declares an integer</th>
<th>This IS an integer</th>
</tr>
</thead>
<tbody>
<tr>
<td>char</td>
<td>wn</td>
</tr>
<tr>
<td>short</td>
<td>wn</td>
</tr>
<tr>
<td>int</td>
<td>wn</td>
</tr>
<tr>
<td>long</td>
<td>xn</td>
</tr>
</tbody>
</table>
</div>
<h3 id="Pointers"><a href="#Pointers" class="headerlink" title="Pointers"></a>Pointers</h3><div class="table-container">
<table>
<thead>
<tr>
<th>This declares a pointer</th>
<th>This IS a pointer</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>type</em> *</td>
<td>xn</td>
</tr>
</tbody>
</table>
</div>
<p>All pointers are stored in x registers. X registers are 64 bits long but many operating systems do not support 64 bit address spaces because keeping track of that big of an address space itself would use a lot of space. Instead <strong>OS’s typically have 48 to 52 bit address spaces</strong>. </p>
<h3 id="Floating-Point"><a href="#Floating-Point" class="headerlink" title="Floating Point"></a>Floating Point</h3><div class="table-container">
<table>
<thead>
<tr>
<th>This declares a float</th>
<th>This IS a float</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>float</code></td>
<td><code>sn</code></td>
</tr>
<tr>
<td><code>double</code></td>
<td><code>dn</code></td>
</tr>
<tr>
<td><code>__fp16</code> (half)</td>
<td><code>hn</code></td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://raw.githubusercontent.com/even629/myPicGo/main/image-20250511210512600.png" alt="image-20250511210512600"></p>
<p><img src="https://raw.githubusercontent.com/even629/myPicGo/main/image-20250511210539205.png" alt="image-20250511210539205"></p>
<p>vn是真正的物理寄存器名，<strong>推荐使用</strong>, 支持最多类型的访问（浮点 + SIMD）</p>
<p>qn是vn的别名，主要用于<strong>SIMD/Neon</strong> 指令中(<em>Single Instruction - Multiple Data</em>)</p>
<h1 id="instructions"><a href="#instructions" class="headerlink" title="instructions"></a>instructions</h1><h2 id="preknowledge-1"><a href="#preknowledge-1" class="headerlink" title="preknowledge"></a>preknowledge</h2><p><strong>EVERY</strong> AARCH64 instruction is 4 bytes wide. Everything the CPU needs to know about what the instruction is and what variation it might be plus what data it will use will be found in those 4 bytes.</p>
<ul>
<li>Most (but not all) AARCH64 instructions have three <em>operands</em>. These are read in the following way:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">op     ra, rb, rc</span><br></pre></td></tr></table></figure>
<p>means:</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ra</span> <span class="operator">=</span> rb op rc</span><br></pre></td></tr></table></figure>
<p>examples:</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sub</span>    <span class="keyword">x</span><span class="number">0</span><span class="punctuation">,</span> <span class="keyword">x</span><span class="number">0</span><span class="punctuation">,</span> <span class="keyword">x</span><span class="number">1</span> <span class="comment">; means x0 = x0 - x1</span></span><br><span class="line">mov    <span class="keyword">x</span><span class="number">0</span><span class="punctuation">,</span> <span class="keyword">x</span><span class="number">1</span>     <span class="comment">; means x0 = x1</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>[ ]</strong></li>
</ul>
<p>the <code>[</code> and <code>]</code> serve the same purpose of the asterisk in C and C++ indicating “dereference.” It means <strong>use what’s inside the brackets as an address for going out to memory</strong>.</p>
<p>when a  <strong>!</strong> is at the end of <strong>[]</strong> , for example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stp     x21, x30, [sp, -16]!  </span><br><span class="line"></span><br><span class="line">stp     x29, x30, [sp, -16]!    </span><br></pre></td></tr></table></figure>
<blockquote>
<p>Lastly, the exclamation point means that the stack pointer should be changed (i.e. the -16 applied to it) <em>before</em> the value of the stack pointer is used as the address in memory to which the registers will be copied. Again, this is a <strong>predecrement</strong>.</p>
</blockquote>
<p>it means:</p>
<ol>
<li><code>sp = sp - 16</code>（栈指针向下移动 16 字节）</li>
<li>把 <code>x29</code> 存入 <code>[sp]</code>，把 <code>x30</code> 存入 <code>[sp + 8]</code></li>
</ol>
<p>对应：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldp     x29, x30, [sp], 16</span><br></pre></td></tr></table></figure>
<p>it means:</p>
<ol>
<li>从 <code>[sp]</code> 读取 8 字节给 <code>x29</code>，从 <code>[sp + 8]</code> 读取 8 字节给 <code>x30</code></li>
<li><code>sp = sp + 16</code>（释放栈帧空间）</li>
</ol>
<p><strong>The stack pointer in ARM V8 can only be manipulated in multiples of 16.</strong></p>
<p><strong>The stack pointer in ARM V8 can only be manipulated in multiples of 16.</strong></p>
<p><strong>The stack pointer in ARM V8 can only be manipulated in multiples of 16.</strong></p>
<blockquote>
<p>x29是栈帧寄存器，但不是必须保存的</p>
</blockquote>
<h2 id="memory-access"><a href="#memory-access" class="headerlink" title="memory access"></a>memory access</h2><h3 id="ldr"><a href="#ldr" class="headerlink" title="ldr"></a>ldr</h3><blockquote>
<p><strong>load register</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ldr    x0, [sp]   // load 8 bytes from address specified by sp</span><br><span class="line">ldr    w0, [sp]   // load 4 bytes from address specified by sp</span><br><span class="line">ldrh   w0, [sp]   // load 2 bytes from address specified by sp</span><br><span class="line">ldrb   w0, [sp]   // load 1 byte  from address specified by sp</span><br></pre></td></tr></table></figure>
<p><strong>When misaligned accesses to RAM are made, the processor must slow down and access each byte individually. This is a big performance hit. Properly aligned access is critical to performance.</strong></p>
<h3 id="str"><a href="#str" class="headerlink" title="str"></a>str</h3><blockquote>
<p><strong>store register</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">str    x0, [sp]   // store 8 bytes to address specified by sp</span><br><span class="line">str    w0, [sp]   // store 4 bytes to address specified by sp</span><br><span class="line">strh   w0, [sp]   // store 2 bytes to address specified by sp</span><br><span class="line">strb   w0, [sp]   // store 1 byte  to address specified by sp</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Casting between integer types is in some cases accomplished by <code>anding</code> with <code>255</code> and <code>65535</code> (for <code>char</code> and <code>short</code>) or :</p>
<p>Whenever a narrower portion of a register is written to, the remainder of the register is zero’d out. That is: <code>ldrb</code> overwrites the least significant byte of an <code>x</code> register and zeros out the upper 7 bytes.</p>
</blockquote>
<h3 id="ldp"><a href="#ldp" class="headerlink" title="ldp"></a>ldp</h3><blockquote>
<p><strong>load pair, same as ldr but load a pair of value</strong></p>
</blockquote>
<h3 id="stp"><a href="#stp" class="headerlink" title="stp"></a>stp</h3><blockquote>
<p><strong>store pair, same as str but load a pair of value</strong></p>
</blockquote>
<p><strong>offsets</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1) LDR Xt, [Xn|SP&#123;, #pimm&#125;] ; 64-bit general registers</span><br><span class="line">2) LDR Xt, [Xn|SP], #simm ; 64-bit general registers, Post-index</span><br><span class="line">3) LDR Xt, [Xn|SP, #simm]! ; 64-bit general registers, Pre-index</span><br></pre></td></tr></table></figure>
<ul>
<li><code>simm</code> can be in the range of -256 to 255 (10 byte signed value).</li>
<li><code>pimm</code> can be in the range of 0 to 32760 in multiples of 8.</li>
</ul>
<h3 id="three-patterns"><a href="#three-patterns" class="headerlink" title="three patterns"></a><strong>three patterns</strong></h3><ol>
<li>普通偏移模式</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LDR Xt, [Xn, #pimm]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从 <code>Xn + pimm</code> 的地址加载数据到 <code>Xt</code>；<strong>地址寄存器 <code>Xn</code> 不变</strong>；</p>
<p><code>pimm</code> 是一个 <strong>正的立即数（positive immediate）</strong>，必须是 8 的倍数，最大为 32760。</p>
</blockquote>
<ol>
<li>后变基模式</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LDR Xt, [Xn], #simm</span><br></pre></td></tr></table></figure>
<blockquote>
<p>先用 <code>Xn</code> 的原始值作为地址加载数据到 <code>Xt</code>，然后再用 <code>simm</code> 更新 <code>Xn</code>；<strong>地址寄存器 <code>Xn</code> 改变</strong>；</p>
</blockquote>
<ol>
<li>前变基模式</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LDR Xt, [Xn, #simm]!</span><br></pre></td></tr></table></figure>
<blockquote>
<p>先用 <code>Xn + simm</code> 作为地址加载数据到 <code>Xt</code>，并将更新后的地址写回 <code>Xn</code>；<strong>地址寄存器 <code>Xn</code> 改变</strong>；</p>
</blockquote>
<h3 id="pseudo-instruction"><a href="#pseudo-instruction" class="headerlink" title="pseudo instruction"></a>pseudo instruction</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldr     x1, =label</span><br></pre></td></tr></table></figure>
<ul>
<li><p>the assembler puts the address of the label into a special region of memory called a “<strong>literal pool</strong>.” What matters is <strong>this region of memory is placed immediately after (therefore nearby) your code</strong>.</p>
</li>
<li><p>Then, the assembler computes the difference between the address of the current instruction (the <code>ldr</code> itself) and the address of the data in the literal pool made from the labeled data.</p>
</li>
<li><p>The assembler generates a different <code>ldr</code> instruction which uses the difference (or offset) of the data relative to the program counter (<code>pc</code>). The <code>pc</code> is non-other the address of the current instruction.</p>
</li>
<li><p>Because the literal pool for your code is located nearby your code, the offset from the current instruction to the data in the pool is a relatively <strong>small</strong> number. Small enough, to fit inside a four byte <code>ldr</code> instruction.</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldr    x1, [pc, offset to data in literal pool]</span><br></pre></td></tr></table></figure>
<blockquote>
<p><em>A downside of this approach is that the literal pool, from which the address is loaded, resides in RAM. This means each of these <code>ldr</code> pseudo instructions incurs a memory reference.</em></p>
</blockquote>
<h3 id="literal-pool"><a href="#literal-pool" class="headerlink" title="literal pool"></a>literal pool</h3><p>compare</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldr x1, =q</span><br><span class="line">ldr x1, q</span><br></pre></td></tr></table></figure>
<p>aarch64 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">        .global     main       // expose main to linker                                        </span><br><span class="line">        .text                  // begin to write code                 </span><br><span class="line">        .align      2          // the code should certainly begin on an even address                    </span><br><span class="line">                                                                       </span><br><span class="line">main:   str         x30, [sp, -16]!                                     </span><br><span class="line">                                                                       </span><br><span class="line">        ldr         x0, =fmt          </span><br><span class="line">        ldr         x1, =q                     </span><br><span class="line">        ldr         x2, [x1]                 </span><br><span class="line">        bl          printf               </span><br><span class="line">                                                                       </span><br><span class="line">        ldr         x0, =fmt                   </span><br><span class="line">        ldr         x1, q                    </span><br><span class="line">        ldr         x2, [x1]                   </span><br><span class="line">        bl          printf            </span><br><span class="line">                                    </span><br><span class="line">        ldr         x30, [sp], 16           </span><br><span class="line">        mov         w0, wzr                                             </span><br><span class="line">        ret                                                             </span><br><span class="line">                                                                       </span><br><span class="line">        .data                                                           </span><br><span class="line">q:      .quad       0x1122334455667788                                 </span><br><span class="line">fmt:    .asciz      &quot;address: %p value: %lx\n&quot;                         </span><br><span class="line">                                                                       </span><br><span class="line">        .end                                                           </span><br><span class="line">                                                                       </span><br></pre></td></tr></table></figure>
<p>disasembling the binary machine code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0000000000007a0 &lt;main&gt;:</span><br><span class="line"> 7a0:   f81f0ffe   str  x30, [sp, #-16]!</span><br><span class="line"> 7a4:   58000160   ldr  x0, 7d0 &lt;main+0x30&gt;</span><br><span class="line"> 7a8:   58000181   ldr  x1, 7d8 &lt;main+0x38&gt;</span><br><span class="line"> 7ac:   f9400022   ldr  x2, [x1]</span><br><span class="line"> 7b0:   97ffffb4   bl   680 &lt;printf@plt&gt;</span><br><span class="line"> 7b4:   580000e0   ldr  x0, 7d0 &lt;main+0x30&gt;</span><br><span class="line"> 7b8:   580842c1   ldr  x1, 11010 &lt;q&gt;</span><br><span class="line"> 7bc:   f9400022   ldr  x2, [x1]</span><br><span class="line"> 7c0:   97ffffb0   bl   680 &lt;printf@plt&gt;</span><br><span class="line"> 7c4:   f84107fe   ldr  x30, [sp], #16</span><br><span class="line"> 7c8:   2a1f03e0   mov  w0, wzr</span><br><span class="line"> 7cc:   d65f03c0   ret</span><br></pre></td></tr></table></figure>
<p>and</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">000000000011010 &lt;q&gt;:</span><br><span class="line">   11010:   55667788</span><br><span class="line">   11014:   11223344</span><br></pre></td></tr></table></figure>
<ul>
<li><p>It says <code>000000000011010 &lt;q&gt;:</code>. This means that what comes next is the data corresponding to what is labeled <code>q</code> in our source code. Notice the relocatable address of <code>11010</code>. We will explain “relocatable address” below.</p>
</li>
<li><p>Now, look at the disassembled code on the line beginning with <code>7b8</code>. It reads <code>ldr x1, 11010</code>. So the disassembled executable is saying “go to address 11010 and fetch its contents” which are our <code>1122334455667788</code>.</p>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>Instruction</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>ldr r, =label</td>
<td>Load the address of the label into r</td>
</tr>
<tr>
<td>ldr r, label</td>
<td>Load the value found at the label into r</td>
</tr>
</tbody>
</table>
</div>
<h3 id="relocation-of-address-when-executing"><a href="#relocation-of-address-when-executing" class="headerlink" title="relocation of address when executing"></a>relocation of address when executing</h3><blockquote>
<p>None of the addresses we have seen so far are the final addresses that will be used once the program is actually running. <strong>All addresses will be <em>relocated</em></strong>.</p>
</blockquote>
<p>One reason for this is a guard against malware. A technique called <strong>Address Space Layout Randomization (ASLR)</strong> prevents malware writers from being able to know ahead where to modify your executable in order to accomplish their nefarious purposes.</p>
<p><strong>64 bit ARM Linux kernels allocate 39, 42 or 48 bits for the size of a process’s virtual address space</strong>. Notice 42 and 48 bit values require 6 bytes to hold them. A virtual address space is all of the addresses a process can generate / use. Further, all addresses used by processes are virtual addresses.</p>
<p>using this can avoid literal pool</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adrp    x0, s</span><br><span class="line">add     x0, x0, :lo12:s</span><br></pre></td></tr></table></figure>
<h3 id="examples"><a href="#examples" class="headerlink" title="examples"></a>examples</h3><h4 id="loading-storing-various-sizes-of-integers"><a href="#loading-storing-various-sizes-of-integers" class="headerlink" title="loading (storing) various sizes of integers"></a>loading (storing) various sizes of integers</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Instruction</th>
<th style="text-align:left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ldr x0, [x1]</code></td>
<td style="text-align:left">Fetches a 64 bit value from the address specified by <code>x1</code> and places it in <code>x0</code></td>
</tr>
<tr>
<td><code>ldr w0, [x1]</code></td>
<td style="text-align:left">Fetches a 32 bit value from the address specified by <code>x1</code> and places it in <code>w0</code></td>
</tr>
<tr>
<td><code>ldrh w0, [x1]</code></td>
<td style="text-align:left">Fetches a 16 bit value from the address specified by <code>x1</code> and places it in <code>x0</code></td>
</tr>
<tr>
<td><code>ldrb w0, [x1]</code></td>
<td style="text-align:left">Fetches an 8 bit value from the address specified by <code>x1</code> and places it in <code>x0</code></td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>Pointers and longs use <code>x</code> registers.</li>
<li>All other integer sizes use <code>w</code> registers where the instruction itself specifies the size.</li>
</ul>
<h4 id="array-indexing"><a href="#array-indexing" class="headerlink" title="array indexing"></a>array indexing</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">Sum</span><span class="params">(<span class="type">long</span> * values, <span class="type">long</span> length)</span>   </span><br><span class="line">&#123;                                          </span><br><span class="line">    <span class="type">long</span> sum = <span class="number">0</span>;                          </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">long</span> i = <span class="number">0</span>; i &lt; length; i++)            </span><br><span class="line">    &#123;                                           </span><br><span class="line">        sum += values[i];                         </span><br><span class="line">    &#125;                                                   </span><br><span class="line">    <span class="keyword">return</span> sum;                                            </span><br><span class="line">&#125;                                                                                                     </span><br></pre></td></tr></table></figure>
<p>Notice we’re using the index variable <code>i</code> for nothing more than traipsing through the array. This is fantastically inefficient (in this case).</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">Sum</span><span class="params">(<span class="type">long</span> * values, <span class="type">long</span> length)</span>         </span><br><span class="line">&#123;                                     </span><br><span class="line">    <span class="type">long</span> sum = <span class="number">0</span>;                           </span><br><span class="line">    <span class="type">long</span> * end = values + length;                   </span><br><span class="line">    <span class="keyword">while</span> (values &lt; end)                     </span><br><span class="line">    &#123;                                              </span><br><span class="line">        sum += *(values++);                            </span><br><span class="line">    &#125;                                                </span><br><span class="line">    <span class="keyword">return</span> sum;                                           </span><br><span class="line">&#125;                                                            </span><br></pre></td></tr></table></figure>
<p>Notice we don’t use an index variable any longer. Instead, we use the pointer itself for both the dereferencing <em>and</em> to tell us when to stop the loop.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    .global Sum                                           </span><br><span class="line">    .text                                                </span><br><span class="line">    .align  4                                           </span><br><span class="line"></span><br><span class="line">//  x0 is the pointer to data                         </span><br><span class="line">//  x1 is the length and is reused as `end`           </span><br><span class="line">//  x2 is the sum                                  </span><br><span class="line">//  x3 is the current dereferenced value                    </span><br><span class="line"></span><br><span class="line">Sum:                                                     </span><br><span class="line">    mov     x2, xzr              // x2 = 0                     </span><br><span class="line">    add     x1, x0, x1, lsl 3    //  x1 = x0+x1*8              </span><br><span class="line">    b       2f                                   </span><br><span class="line"></span><br><span class="line">1:  ldr     x3, [x0], 8                          </span><br><span class="line">    add     x2, x2, x3                             </span><br><span class="line">2:  cmp     x0, x1                               </span><br><span class="line">    blt     1b                                        </span><br><span class="line"></span><br><span class="line">    mov     x0, x2                                  </span><br><span class="line">    ret                                             </span><br><span class="line"></span><br><span class="line">    .end</span><br></pre></td></tr></table></figure>
<h4 id="faster-memory-copy"><a href="#faster-memory-copy" class="headerlink" title="faster memory copy"></a>faster memory copy</h4><p>Suppose you needed to <strong>copy 16 bytes of memory</strong> from one place to another. You might do it like this:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">SillyCopy16</span><span class="params">(<span class="type">uint8_t</span> * dest, <span class="type">uint8_t</span> * src)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">        *(dest++) = *(src++);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is especially silly as why would you go through 16 loops when you could have simply:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">SillyCopy16</span><span class="params">(<span class="type">uint64_t</span> * dest, <span class="type">uint64_t</span> * src)</span></span><br><span class="line">&#123;</span><br><span class="line">    *(dest++) = *(src++); <span class="comment">// 3</span></span><br><span class="line">    *dest = *src;         <span class="comment">// 4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>in aarch64</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SillyCopy16:              // 1</span><br><span class="line">    ldr    x2, [x0], 8    // 2</span><br><span class="line">    str    x2, [x1], 8    // 3</span><br><span class="line">    ldr    x2, [x0]       // 4</span><br><span class="line">    str    x2, [x1]       // 5</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>using ldp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SillyCopy16:</span><br><span class="line">    ldp    x2, x3, [x0]</span><br><span class="line">    stp    x2, x3, [x1]</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>using q register</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SillyCopy16:</span><br><span class="line">    ldr    q2, [x0]</span><br><span class="line">    str    q2, [x1]</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<h4 id="indexing-through-an-array-of-struct"><a href="#indexing-through-an-array-of-struct" class="headerlink" title="indexing through an array of struct"></a>indexing through an array of struct</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>                                       </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span>                                       </span></span><br><span class="line"><span class="class">&#123;</span>                                                   </span><br><span class="line">    <span class="type">char</span> * fname;                                </span><br><span class="line">    <span class="type">char</span> * lname;                                      </span><br><span class="line">    <span class="type">int</span> age;                                        </span><br><span class="line">&#125;;                                                         </span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">rand</span><span class="params">()</span>;                                          </span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">struct</span> Person * <span class="title function_">FindOldestPerson</span><span class="params">(<span class="keyword">struct</span> Person *, <span class="type">int</span>)</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> Person * <span class="title function_">OriginalFindOldestPerson</span><span class="params">(<span class="keyword">struct</span> Person * people, <span class="type">int</span> length)</span></span><br><span class="line">&#123;                                                     </span><br><span class="line">    <span class="type">int</span> oldest_age = <span class="number">0</span>;                        </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Person</span> * <span class="title">oldest_ptr</span> =</span> <span class="literal">NULL</span>;               </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (people)                                        </span><br><span class="line">    &#123;                                                     </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Person</span> * <span class="title">end_ptr</span> =</span> people + length;       </span><br><span class="line">        <span class="keyword">while</span> (people &lt; end_ptr)                           </span><br><span class="line">        &#123;                                                   </span><br><span class="line">            <span class="keyword">if</span> (people-&gt;age &gt; oldest_age)             </span><br><span class="line">            &#123;                                      </span><br><span class="line">                oldest_age = people-&gt;age;            </span><br><span class="line">                oldest_ptr = people;                   </span><br><span class="line">            &#125;                               </span><br><span class="line">            people++;                          </span><br><span class="line">        &#125;                                         </span><br><span class="line">    &#125;                                             </span><br><span class="line">    <span class="keyword">return</span> oldest_ptr;                             </span><br><span class="line">&#125;                                                  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LENGTH  20                                </span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>                                            </span><br><span class="line">&#123;                                                   </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Person</span> <span class="title">array</span>[<span class="title">LENGTH</span>];</span>                          </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; LENGTH; i++)                     </span><br><span class="line">    &#123;                                               </span><br><span class="line">        <span class="built_in">array</span>[i].age = rand() % <span class="number">5000</span>;                   </span><br><span class="line">    &#125;                                                       </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Person</span> * <span class="title">oldest</span> =</span> FindOldestPerson(<span class="built_in">array</span>, LENGTH);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; LENGTH; i++)                  </span><br><span class="line">    &#123;                                                   </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, <span class="built_in">array</span>[i].age);               </span><br><span class="line">        <span class="keyword">if</span> (oldest == &amp;<span class="built_in">array</span>[i])                </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;*&quot;</span>);                           </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);                                 </span><br><span class="line">    &#125;                                                  </span><br><span class="line">&#125;                                                           </span><br></pre></td></tr></table></figure>
<p><code>Line 11</code> tells us that somewhere else, there is a function called <code>FindOldestPerson</code>. That function must have a <code>.global</code> specifying the same name so that the linker can reconcile the reference to <code>FindOldestPerson</code>.</p>
<p><code>gcc</code> with <code>-O2</code> or <code>-O3</code> optimization rendered <code>OriginalFindOldestPerson()</code> into 18 lines of assembly language.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">        .global FindOldestPerson                                        // 1 </span><br><span class="line">        .text                                                           // 2 </span><br><span class="line">        .align  2                                                       // 3 </span><br><span class="line">                                                                        // 4 </span><br><span class="line">//  x0  has struct Person * people                                      // 5 </span><br><span class="line">//      will be used for oldest_ptr as this is the return value         // 6 </span><br><span class="line">//  w1  has int length                                                  // 7 </span><br><span class="line">//  w2  used for oldest_age                                             // 8 </span><br><span class="line">//  x3  used for Person *                                               // 9 </span><br><span class="line">//  x4  used for end_ptr                                                // 10 </span><br><span class="line">//  w5  used for scratch                                                // 11 </span><br><span class="line">                                                                        // 12 </span><br><span class="line">FindOldestPerson:                                                       // 13 </span><br><span class="line">        cbz     x0, 99f             // short circuit                    // 14 </span><br><span class="line">        mov     w2, wzr             // initial oldest age is 0          // 15 </span><br><span class="line">        mov     x3, x0              // initialize loop pointer          // 16 </span><br><span class="line">        mov     x0, xzr             // initialize return value          // 17 </span><br><span class="line">        mov     w5, 24              // struct is 24 bytes wide          // 18 </span><br><span class="line">        smaddl  x4, w1, w5, x3      // initialize end_ptr               // 19 </span><br><span class="line">        b       10f                 // enter loop                       // 20 </span><br><span class="line">                                                                        // 21 </span><br><span class="line">1:      ldr     w5, [x3, p.age]     // fetch loop ptr -&gt; age            // 22 </span><br><span class="line">        cmp     w2, w5              // compare to oldest_age            // 23 </span><br><span class="line">        csel    w2, w2, w5, gt      // update based on cmp              // 24 </span><br><span class="line">        csel    x0, x0, x3, gt      // update based on cmp              // 25 </span><br><span class="line">        add     x3, x3, 24          // increment loop ptr               // 26 </span><br><span class="line">10:     cmp     x3, x4              // has loop ptr reached end_ptr?    // 27 </span><br><span class="line">        blt     1b                  // no, not yet                      // 28 </span><br><span class="line">                                                                        // 29 </span><br><span class="line">99:     ret                                                             // 30 </span><br><span class="line">                                                                        // 31 </span><br><span class="line">        .data                                                           // 32 </span><br><span class="line">        .struct 0                                                       // 33 </span><br><span class="line">p.fn:   .skip   8                                                       // 34 </span><br><span class="line">p.ln:   .skip   8                                                       // 35 </span><br><span class="line">p.age:  .skip   4                                                       // 36 </span><br><span class="line">p.pad:  .skip   4                                                       // 37 </span><br><span class="line">                                                                        // 38 </span><br><span class="line">        .end                                                            // 39 </span><br></pre></td></tr></table></figure>
<h2 id="control-flow"><a href="#control-flow" class="headerlink" title="control flow"></a>control flow</h2><h3 id="cmp"><a href="#cmp" class="headerlink" title="cmp"></a>cmp</h3><blockquote>
<p><strong>compare</strong></p>
</blockquote>
<p>discards the result of the subtraction but keeps a record of whether or not the result was less than, equal to or greater than zero. It sets the condition bits</p>
<h3 id="br"><a href="#br" class="headerlink" title="br"></a>br</h3><blockquote>
<p>Branch to Register</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">br &lt;register&gt;</span><br></pre></td></tr></table></figure>
<p>无条件跳转，类似于</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">goto</span> *(ptr)</span><br></pre></td></tr></table></figure>
<h3 id="ble"><a href="#ble" class="headerlink" title="ble"></a>ble</h3><blockquote>
<p><strong>Branch less or equal</strong></p>
</blockquote>
<h3 id="bl"><a href="#bl" class="headerlink" title="bl"></a>bl</h3><blockquote>
<p><strong>Branch with Link</strong></p>
</blockquote>
<p>跳转到一个函数（子程序）地址，并且保存返回地址到 <code>x30</code> 寄存器中（也叫 <code>lr</code>，Link Register）</p>
<h3 id="cbz"><a href="#cbz" class="headerlink" title="cbz"></a>cbz</h3><blockquote>
<p>Compare and Branch if Zero</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cbz &lt;register&gt;, &lt;label&gt;</span><br></pre></td></tr></table></figure>
<p>如果 <code>&lt;register&gt;</code> 中的值为 0，就跳转到 <code>&lt;label&gt;</code>。</p>
<p>否则继续执行下一条指令。</p>
<h3 id="csel"><a href="#csel" class="headerlink" title="csel"></a>csel</h3><blockquote>
<p>Conditional Select</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">csel &lt;dest&gt;, &lt;src1&gt;, &lt;src2&gt;, &lt;condition&gt;</span><br></pre></td></tr></table></figure>
<p>如果满足 <code>&lt;condition&gt;</code>，则将 <code>&lt;src1&gt;</code> 的值赋给 <code>&lt;dest&gt;</code>；</p>
<p>否则将 <code>&lt;src2&gt;</code> 的值赋给 <code>&lt;dest&gt;</code>。</p>
<p>examples:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmp w2, w5</span><br><span class="line">csel w2, w2, w5, gt    // 如果 w2 &gt; w5，则 w2 保持不变；否则更新为 w5</span><br></pre></td></tr></table></figure>
<p>这是<strong>无分支的条件赋值</strong>，比 <code>if-else</code> 更高效。</p>
<p>this is equal to </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w2 = (w2 &gt; w5) ? w2 : w5;</span><br></pre></td></tr></table></figure>
<h3 id="calculate"><a href="#calculate" class="headerlink" title="calculate"></a>calculate</h3><h2 id="shift-Opertations"><a href="#shift-Opertations" class="headerlink" title="shift Opertations"></a>shift Opertations</h2><h3 id="lsl"><a href="#lsl" class="headerlink" title="lsl"></a>lsl</h3><blockquote>
<p>Logical Shift Left</p>
</blockquote>
<p>The LSL instruction performs multiplication by a power of 2.</p>
<h3 id="lsr"><a href="#lsr" class="headerlink" title="lsr"></a>lsr</h3><blockquote>
<p>Logical Shift Right</p>
</blockquote>
<p>The LSR instruction performs division by a power of 2.</p>
<h3 id="asr"><a href="#asr" class="headerlink" title="asr"></a>asr</h3><blockquote>
<p>Arithmetic Shift Right</p>
</blockquote>
<p>The ASR instruction performs division by a power of 2, preserving the sign bit.</p>
<h3 id="ror"><a href="#ror" class="headerlink" title="ror"></a>ror</h3><blockquote>
<p>rotate right</p>
</blockquote>
<p>The ROR instruction performs a bitwise rotation, wrapping the bits rotated from the LSB into the MSB.<br>即：<code>ROR</code> 指令执行<strong>按位右旋转</strong>操作：<strong>从最低有效位（LSB）被旋转出来的位，会重新被放入到最高有效位（MSB）的位置中。</strong></p>
<h2 id="bit-manipulation"><a href="#bit-manipulation" class="headerlink" title="bit manipulation"></a>bit manipulation</h2><h3 id="mvn"><a href="#mvn" class="headerlink" title="mvn"></a>mvn</h3><p>mvn (Move Not) 作用是 将操作数按位取反（bitwise NOT）后，放入目标寄存器。</p>
<h3 id="orr"><a href="#orr" class="headerlink" title="orr"></a>orr</h3><p>orr (bitwise inclusive OR) 对两个操作数执行<strong>按位或（bitwise OR）</strong>运算，然后将结果写入目标寄存器</p>
<h3 id="bfi"><a href="#bfi" class="headerlink" title="bfi"></a>bfi</h3><p>bfi (Bit Field Insert) 即“位字段插入”。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bfi &lt;Xd&gt;, &lt;Xn&gt;, #&lt;lsb&gt;, #&lt;width&gt;</span><br></pre></td></tr></table></figure></p>
<p><Xd>：目标寄存器（结果写到这里）</p>
<p><Xn>：源寄存器（从这里取低位的值）</p>
<p><lsb>：目标寄存器中开始插入的起始位（least significant bit 起始位）</p>
<p><width>：要插入多少位（宽度）</p>
<p>假设：</p>
<p>Xd = 0b1111 0000<br>Xn = 0b1011 (只用低4位)<br>lsb=1<br>width=3</p>
<p>执行：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bfi Xd, Xn, #1, #3</span><br></pre></td></tr></table></figure><br>结果：<br>将 Xn 的低3位 011 插入 Xd 的位1~3上，替换原值<br>结果是 Xd = 1111 0110 </p>
<h3 id="ubfm"><a href="#ubfm" class="headerlink" title="ubfm"></a>ubfm</h3><p>ubfm = Unsigned BitField Move</p>
<p>基本格式：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubfm &lt;dst&gt;, &lt;src&gt;, #lsb, #msb</span><br></pre></td></tr></table></figure></p>
<p><dst>：目标寄存器</p>
<p><src>：源寄存器<br>lsb：起始位（low bit index）<br>msb：结束位（high bit index）<br>这条指令从 src 中 提取一个无符号位字段（即一段连续的比特位），把它放到 dst 的低位（bit 0 开始），其他位清零或忽略<br>也就是说：</p>
<ol>
<li>从 src 的第 lsb 位开始，取到 msb 位</li>
<li>将这段 bit 字段提取出来</li>
<li>右对齐放到 dst 的低位（bit 0）<br>其他位全部清零<br>实例：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubfm    w1, w2, #8, #15</span><br></pre></td></tr></table></figure>
<ol>
<li>从 w2 中提取 bit 8 到 bit 15（共 8 位）</li>
<li>把它放到 w1 的 bit 0~7</li>
</ol>
<h3 id="ubfiz"><a href="#ubfiz" class="headerlink" title="ubfiz"></a>ubfiz</h3><p>ubfiz (Unsigned Bit Field Insert Zeroed) 将一个无符号数的低位字段插入到另一个寄存器的指定位置，但目标寄存器在插入之前会被清零。<br>它其实是 ubfm（Unsigned Bit Field Move）的一个特化形式，和 UBFM 的语义类似。</p>
<p>指令格式：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubfiz  &lt;dst&gt;, &lt;src&gt;, #lsb, #width</span><br></pre></td></tr></table></figure><br>简单来讲就是：ubfiz = 把 src 的低 width 位 插入到 dst 的 bit lsb 开始的位置，其余位置全部清零。</p>
<p>其中：</p>
<p><src>：来源寄存器（如 w1）</p>
<p><dst>：目标寄存器（如 w2），最终结果放在这里<br>lsb：目标中插入位置的起始 bit 位（从0开始）<br>width：要插入的位数（从 <src> 的最低位开始数）</p>
<p>目标寄存器其他位都会被清零。</p>
<p>举例说明：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubfiz   w1, w1, #3, #5</span><br></pre></td></tr></table></figure><br>含义如下：</p>
<ol>
<li>从 w1 的 最低 5 位（bit 0 到 bit 4）提取出来</li>
<li>插入到目标（w1）寄存器的 bit 3 到 bit 7</li>
<li>w1 的其他所有位（02 和 831）清零</li>
</ol>
<h2 id="other"><a href="#other" class="headerlink" title="other"></a>other</h2><h3 id="adr"><a href="#adr" class="headerlink" title="adr"></a>adr</h3><blockquote>
<p>Address</p>
</blockquote>
<h3 id="adrp"><a href="#adrp" class="headerlink" title="adrp"></a>adrp</h3><blockquote>
<p>Address of page</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    .section .rodata</span><br><span class="line">fmt:</span><br><span class="line">    .asciz &quot;%p a: 0x%lx b: %x c: %x\n&quot;</span><br><span class="line"></span><br><span class="line">    .text</span><br><span class="line"></span><br><span class="line">	adrp x0, fmt</span><br><span class="line">	add  x0, x0, :lo12:fmt    // 汇编器会自动提取 fmt 的低12位作为立即数,计算页偏移</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>作用</strong>：把符号 <code>fmt</code> 所在的 <strong>4KB 对齐页的页地址</strong>加载到 <code>x0</code> 中。</li>
<li><code>adrp</code> = <em>Address of Page</em>。</li>
<li>它会忽略符号地址的低 12 位，只保留高位。</li>
<li>举例：如果 <code>fmt</code> 地址是 <code>0x400123</code>，那么 <code>adrp x0, fmt</code> 会将 <code>0x400000</code> 加载到 <code>x0</code>。</li>
<li><code>adrp x0, fmt</code> 会将 <code>fmt</code> 地址向下取整到最近的 <strong>4KB 边界</strong>（即清除低12位）</li>
</ul>
<blockquote>
<p>为什么不直接用 <code>ldr x0, =fmt</code>？</p>
</blockquote>
<ul>
<li>在 ARM64 下，使用 <code>ldr x0, =fmt</code> 可能隐式引入 <strong>文字常量池（literal pool）</strong>，不利于可重定位代码，尤其是在动态链接或 PIE (Position Independent Executable) 环境下。</li>
<li><code>adrp</code> + <code>add</code> 是 <strong>推荐的可重定位代码写法（relocatable and PIC-compliant）</strong>。</li>
<li>Linux 下的动态链接器（ld.so）支持这种模式更好。</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>指令</th>
<th>含义</th>
<th>支持的偏移范围</th>
<th>常用于</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>adr</code></td>
<td>获取<strong>当前指令附近</strong>的地址</td>
<td>±1MB</td>
<td>局部跳转、临时变量等</td>
</tr>
<tr>
<td><code>adrp</code></td>
<td>获取<strong>4KB 页对齐的高地址部分</strong></td>
<td>±4GB（页对齐偏移）</td>
<td>获取全局变量地址、字符串、常量表地址等</td>
</tr>
</tbody>
</table>
</div>
<h3 id="smaddl"><a href="#smaddl" class="headerlink" title="smaddl"></a>smaddl</h3><blockquote>
<p>Signed Multiply Add Long</p>
<p>两个 <strong>32位整数（有符号）</strong> 相乘后，加上一个 <strong>64位整数</strong>，结果保存在一个 <strong>64位寄存器</strong>中。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smaddl &lt;Xd&gt;, &lt;Wn&gt;, &lt;Wm&gt;, &lt;Xa&gt;</span><br></pre></td></tr></table></figure>
<p>执行如下操作：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Xd = (<span class="type">int64_t</span>)(<span class="type">int32_t</span>)Wn * (<span class="type">int64_t</span>)(<span class="type">int32_t</span>)Wm + Xa;</span><br></pre></td></tr></table></figure></p>
<h1 id="programming"><a href="#programming" class="headerlink" title="programming"></a>programming</h1><h2 id="if-statement"><a href="#if-statement" class="headerlink" title="if statement"></a>if statement</h2><h3 id="if"><a href="#if" class="headerlink" title="if"></a>if</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (a &gt; b)                                                              </span><br><span class="line">&#123;                                                                       </span><br><span class="line">    <span class="comment">// CODE BLOCK                                                       </span></span><br><span class="line">&#125;                                                                       </span><br></pre></td></tr></table></figure>
<p>in aarch64</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    // Assume value of a is in x0                                       </span><br><span class="line">    // Assume value of b is in x1                                       </span><br><span class="line">    cmp     x0, x1                                                      </span><br><span class="line">    ble     1f                                                          </span><br><span class="line">    // CODE BLOCK                                                       </span><br><span class="line">1:                                                                     </span><br></pre></td></tr></table></figure>
<p>If <code>a &gt; b</code> then <code>x0 - x1</code> will be <em>greater than zero</em>.</p>
<p>If <code>a == b</code> then <code>x0 - x1</code> will be <em>equal to zero</em>.</p>
<p>If <code>a &lt; b</code> then <code>x0 - x1</code> will be <em>less than zero</em>.</p>
<p><strong>ble</strong> means <strong>branch (a jump or goto) if the previous computation shows <code>less than or equal to</code> zero</strong></p>
<h4 id="a-rule-of-thumb"><a href="#a-rule-of-thumb" class="headerlink" title="a rule of thumb"></a>a rule of thumb</h4><ul>
<li><p><strong>In the higher level language, you want to <em>enter</em> the following code block if the condition is true. </strong></p>
</li>
<li><p><strong>In assembly language, you want to <em>avoid</em> the following code block if the condition is false.</strong></p>
</li>
</ul>
<h4 id="temporary-label"><a href="#temporary-label" class="headerlink" title="temporary label"></a>temporary label</h4><p>The target of the branch instruction is given as <code>1f</code>. This is an example of a <strong><em>temporary label</em></strong>.</p>
<p><strong>There are a lot of braces used in C and C++. Since labels frequently function as equivalents to <code>&#123;</code> and <code>&#125;</code>, there can be a lot of labels used in assembly language. But label is only a position label, it is not a scope </strong></p>
<p>A temporary label is a label made using just a number. Such labels can appear over and over again (i.e. they can be reused). They are made unique by virtue of their placement relative to where they are being used. </p>
<ul>
<li><code>1f</code> looks <code>f</code>orward in the code for the next label <code>1</code>. </li>
<li><code>1b</code> looks in the <code>b</code>ackward direction for the most recent label <code>1</code>.</li>
</ul>
<h3 id="if-else"><a href="#if-else" class="headerlink" title="if / else"></a>if / else</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (a &gt; b)                                                          </span><br><span class="line">&#123;                                                                   </span><br><span class="line">    <span class="comment">// CODE BLOCK IF TRUE                                           </span></span><br><span class="line">&#125;                                                          </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">&#123;                                                                   </span><br><span class="line">    <span class="comment">// CODE BLOCK IF FALSE                                         </span></span><br><span class="line">&#125;                                                                   </span><br></pre></td></tr></table></figure>
<p><strong>There are two branches built into this code!</strong></p>
<p>in aarch64:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    // Assume value of a is in x0                                       </span><br><span class="line">    // Assume value of b is in x1                                       </span><br><span class="line">    cmp     x0, x1                                                      </span><br><span class="line">    ble     1f                                                          </span><br><span class="line">    // CODE BLOCK IF TRUE                                               </span><br><span class="line">    b       2f                                                         </span><br><span class="line">1:                                                                      </span><br><span class="line">    // CODE BLOCK IF FALSE                                             </span><br><span class="line">2:                                                                     </span><br></pre></td></tr></table></figure>
<h4 id="a-complete-example"><a href="#a-complete-example" class="headerlink" title="a complete example"></a>a complete example</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    .global main                                                       </span><br><span class="line">    .text                                                               </span><br><span class="line">                                                                       </span><br><span class="line">main:                                                                   </span><br><span class="line">    stp     x29, x30, [sp, -16]!                                       </span><br><span class="line">    mov     x1, 10                                                     </span><br><span class="line">    mov     x0, 5                                                       </span><br><span class="line">    cmp     x0, x1                                                     </span><br><span class="line">    ble     1f                                                         </span><br><span class="line">    ldr     x0, =T                     //Pseudo Instruction 伪指令</span><br><span class="line">    bl      puts                                                       </span><br><span class="line">    b       2f                                                         </span><br><span class="line"></span><br><span class="line">1:  ldr     x0, =F                                                     </span><br><span class="line">    bl      puts                                                       </span><br><span class="line">                                                                       </span><br><span class="line">2:  ldp     x29, x30, [sp], 16                                         </span><br><span class="line">    mov     x0, xzr                                                     </span><br><span class="line">    ret                                                                 </span><br><span class="line">                                                                    </span><br><span class="line">    .data                                                               </span><br><span class="line">F:  .asciz  &quot;FALSE&quot;                                                     </span><br><span class="line">T:  .asciz  &quot;TRUE&quot;                                                     </span><br><span class="line">    .end                                                               </span><br></pre></td></tr></table></figure>
<p><code>Line 11</code> is one way of loading the address represented by a label. In this case, the label <code>T</code> corresponds to the address to the first letter of the C string “TRUE”. <code>Line 15</code> loads the address of the C string containing “FALSE”.</p>
<p>The occurrences of <code>.asciz</code> on <code>line 23</code> and <code>line 24</code> are invocations of an <em>assembler directive</em> the creates a C string. Recall that <strong>C strings are NULL terminated</strong>. The NULL termination is indicated by the <code>z</code> which ends <code>.asciz</code>.</p>
<p>There is a similar directive <code>.ascii</code> that <em>does not NULL terminate</em> the string.</p>
<h2 id="loop"><a href="#loop" class="headerlink" title="loop"></a>loop</h2><h3 id="while-loop"><a href="#while-loop" class="headerlink" title="while loop"></a>while loop</h3><p><img src="https://raw.githubusercontent.com/even629/myPicGo/main/while.jpeg" alt="while loop"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (a &gt;= b) &#123;</span><br><span class="line">    <span class="comment">// CODE BLOCK</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>aarch64:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    // Assume value of a is in x0                                       </span><br><span class="line">    // Assume value of b is in x1                                       </span><br><span class="line">                                                                        </span><br><span class="line"> 1: cmp     x0, x1                                                     </span><br><span class="line">    blt     2f                                                          </span><br><span class="line">    // CODE BLOCK                                                       </span><br><span class="line">    b       1b                                                          </span><br><span class="line"></span><br><span class="line">2:                                                                     </span><br></pre></td></tr></table></figure>
<h3 id="for-loop"><a href="#for-loop" class="headerlink" title="for loop"></a>for loop</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="built_in">set</span> up; decision; post step)                                   </span><br><span class="line">&#123;                                                                    </span><br><span class="line">    <span class="comment">// CODE BLOCK                                                   </span></span><br><span class="line">&#125;                                                                   </span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/even629/myPicGo/main/for.jpeg" alt="for"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">long</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)                                     </span><br><span class="line">&#123;                                                                  </span><br><span class="line">    <span class="comment">// CODE BLOCK                                                    </span></span><br><span class="line">&#125;                                                                   </span><br></pre></td></tr></table></figure>
<p>aarch64 (the flow chart on the left)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Assume i is implemented using x0                                                                                        </span></span><br><span class="line">    mov     x0, xzr                                                     </span><br><span class="line">                                                                      </span><br><span class="line"><span class="number">1</span>:  cmp     x0, <span class="number">10</span>                                                     </span><br><span class="line">    bge     <span class="number">2f</span>                                                         </span><br><span class="line">                                                                       </span><br><span class="line">    <span class="comment">// CODE BLOCK                                                       </span></span><br><span class="line">                                                                       </span><br><span class="line">    add     x0, x0, <span class="number">1</span>                                                   </span><br><span class="line">    b       <span class="number">1b</span>                                                         </span><br><span class="line">                                                                       </span><br><span class="line"><span class="number">2</span>:                                                                     </span><br></pre></td></tr></table></figure>
<p>aarch64 (the flow chart on the right)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    // Assume i is implemented using x0                                 </span><br><span class="line">                                                                       </span><br><span class="line">    mov     x0, xzr                                                     </span><br><span class="line">    b       2f</span><br><span class="line">                                                                       </span><br><span class="line">1:                                                                     </span><br><span class="line">                                                                       </span><br><span class="line">    // CODE BLOCK                                                       </span><br><span class="line">                                                                       </span><br><span class="line">    add     x0, x0, 1                                                   </span><br><span class="line">2:  cmp     x0, 10                                                     </span><br><span class="line">    blt     1b                                                         </span><br></pre></td></tr></table></figure>
<h4 id="continue"><a href="#continue" class="headerlink" title="continue"></a>continue</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">long</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// CODE BLOCK &quot;A&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">5</span>)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    <span class="comment">// CODE BLOCK &quot;B&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>in aarch64</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    // Assume i is implemented using x0                                 </span><br><span class="line">                                                                       </span><br><span class="line">    mov x0, xzr                                                         </span><br><span class="line"></span><br><span class="line">1:  cmp x0, 10                                                         </span><br><span class="line">    bge 3f                                                                                                                      </span><br><span class="line">    // CODE BLOCK &quot;A&quot;.                                                              </span><br><span class="line">    // if (i == 5)                                                     </span><br><span class="line">    //      continue                                                   </span><br><span class="line">    </span><br><span class="line">    cmp x0, 5                                                           </span><br><span class="line">    beq 2f                                                                                                                      </span><br><span class="line">    // CODE BLOCK &quot;B&quot;                                                   </span><br><span class="line">                                                                       </span><br><span class="line">2:  add x0, x0, 1                                                       </span><br><span class="line">    b   1b                                                             </span><br><span class="line"></span><br><span class="line">3:                                                                     </span><br></pre></td></tr></table></figure>
<p>another one</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    // Assume i is implemented using x0                                 </span><br><span class="line">                                                                       </span><br><span class="line">    mov x0, xzr                                                         </span><br><span class="line">    b   3f                                                             </span><br><span class="line">                                                                       </span><br><span class="line">1:                                                                     </span><br><span class="line">                                                                       </span><br><span class="line">    // CODE BLOCK &quot;A&quot;                                                   </span><br><span class="line">                                                                       </span><br><span class="line">    // if (i == 5)                                                     </span><br><span class="line">    //      continue                                                   </span><br><span class="line">                                                                       </span><br><span class="line">    cmp x0, 5                                                           </span><br><span class="line">    beq 2f                                                             </span><br><span class="line">                                                                       </span><br><span class="line">    // CODE BLOCK &quot;B&quot;                                                   </span><br><span class="line">                                                                       </span><br><span class="line">2:  add x0, x0, 1                                                       </span><br><span class="line">3:  cmp x0, 10                                                         </span><br><span class="line">    blt 1b                                                             </span><br></pre></td></tr></table></figure>
<h4 id="break"><a href="#break" class="headerlink" title="break"></a>break</h4><p>The implementation of <code>break</code> is very similar to that of <code>continue</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">long</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// CODE BLOCK &quot;A&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">5</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// CODE BLOCK &quot;B&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>aarch64:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    // Assume i is implemented using x0                                 </span><br><span class="line">                                                                       </span><br><span class="line">    mov x0, xzr                                                         </span><br><span class="line">    b   3f                                                             </span><br><span class="line"> </span><br><span class="line">1:                                                                     </span><br><span class="line">                                                                       </span><br><span class="line">    // CODE BLOCK &quot;A&quot;                                                   </span><br><span class="line">                                                                       </span><br><span class="line">    // if (i == 5)                                                     </span><br><span class="line">    //      break;                                                   </span><br><span class="line">                                                                       </span><br><span class="line">    cmp x0, 5                                                           </span><br><span class="line">    beq 4f                                                             </span><br><span class="line">                                                                       </span><br><span class="line">    // CODE BLOCK &quot;B&quot;                                                   </span><br><span class="line">                                                                       </span><br><span class="line">2:  add x0, x0, 1                                                       </span><br><span class="line">3:  cmp x0, 10                                                         </span><br><span class="line">    blt 1b                                                             </span><br><span class="line">                                                                       </span><br><span class="line">4:                                                                     </span><br></pre></td></tr></table></figure>
<h2 id="structs"><a href="#structs" class="headerlink" title="structs"></a>structs</h2><h3 id="alignment"><a href="#alignment" class="headerlink" title="alignment"></a>alignment</h3><p><em>Data members exhibit <strong>natural alignment</strong>.</em></p>
<p>That is:</p>
<ul>
<li>a <code>long</code> will be found at addresses which are a multiple of 8.</li>
<li>an <code>int</code> will be found at addresses which are a multiple of 4.</li>
<li>a <code>short</code> will be found at addresses which are even.</li>
<li>a <code>char</code> can be found anywhere.</li>
</ul>
<h4 id="example"><a href="#example" class="headerlink" title="example"></a>example</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> a;</span><br><span class="line">    <span class="type">short</span> b;</span><br><span class="line">    <span class="type">int</span> c;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>布局：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Offset</th>
<th>Width</th>
<th>Member</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>8byte</td>
<td>a</td>
</tr>
<tr>
<td>8</td>
<td>2byte</td>
<td>b</td>
</tr>
<tr>
<td>10</td>
<td>2</td>
<td>— gap —</td>
</tr>
<tr>
<td>12</td>
<td>4byte</td>
<td>c</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> a;</span><br><span class="line">    <span class="type">short</span> b;</span><br><span class="line">    <span class="type">int</span> c;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span> <span class="title">Bar</span> =</span> &#123; <span class="number">0xaaaaaaaaaaaaaaaa</span>, <span class="number">0xbbbb</span>, <span class="number">0xcccccccc</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>A hex dump will show:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaaa aaaa aaaa aaaa bbbb 0000 cccc cccc</span><br></pre></td></tr></table></figure>
<p>Notice the gap filled in which zeros. Note, if this were a local variable, the zeros might be garbage.</p>
<p>change the order:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span> &#123;</span></span><br><span class="line">    <span class="type">short</span> a;</span><br><span class="line">    <span class="type">char</span> b;</span><br><span class="line">    <span class="type">int</span> c;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span> <span class="title">Bar</span> =</span> &#123; <span class="number">0xaaaa</span>, <span class="number">0xbb</span>, <span class="number">0xcccccccc</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>A hex dump will show:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaaa 00bb cccc cccc</span><br></pre></td></tr></table></figure>
<p>Notice there is only one byte of gap before the <code>int c</code> starts.</p>
<p><em>why are the zeros to the left of the b’s?</em></p>
<p>This ARM processor is running as a <em>little endian</em> machine.</p>
<h3 id="defining-structs"><a href="#defining-structs" class="headerlink" title="defining structs"></a>defining structs</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span> &#123;</span></span><br><span class="line">    <span class="type">short</span> a;</span><br><span class="line">    <span class="type">char</span> b;</span><br><span class="line">    <span class="type">int</span> c;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span> <span class="title">Bar</span> =</span> &#123; <span class="number">0xaaaa</span>, <span class="number">0xbb</span>, <span class="number">0xcccccccc</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>Here is one way of defining and accessing the struct:</p>
<p><strong>硬编码字段偏移量</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">    .section .rodata</span><br><span class="line">fmt:</span><br><span class="line">    .asciz &quot;%p a: 0x%lx b: %x c: %x\n&quot;</span><br><span class="line"></span><br><span class="line">    .data</span><br><span class="line">bar:</span><br><span class="line">    .short 0xaaaa        // a: short 2 byte</span><br><span class="line">    .byte  0xbb          // b: char  1 byte</span><br><span class="line">    .byte  0x00          // padding</span><br><span class="line">    .word  0xcccccccc    // c: int   4 byte</span><br><span class="line"></span><br><span class="line">    .text</span><br><span class="line">    .global main</span><br><span class="line">    .align 2</span><br><span class="line">main:</span><br><span class="line">    stp x29, x30, [sp, -16]!    // 保存栈帧</span><br><span class="line">    mov x29, sp</span><br><span class="line"></span><br><span class="line">    adrp x0, fmt</span><br><span class="line">    add  x0, x0, :lo12:fmt      // printf 格式字符串地址</span><br><span class="line"></span><br><span class="line">    adrp x1, bar</span><br><span class="line">    add  x1, x1, :lo12:bar      // bar 的地址</span><br><span class="line"></span><br><span class="line">    ldrh w2, [x1, 0]            // short a</span><br><span class="line">    ldrb w3, [x1, 2]            // char b</span><br><span class="line">    ldr  w4, [x1, 4]            // int  c</span><br><span class="line"></span><br><span class="line">    bl printf                   // 调用 printf(&amp;bar, a, b, c)</span><br><span class="line">    </span><br><span class="line">    // 显式退出系统调用</span><br><span class="line">    mov     x8, #93       // syscall number for exit</span><br><span class="line">    mov     x0, xzr       // exit code 0</span><br><span class="line">    svc     0             // make syscall</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>:lo12:fmt</code> 会被汇编器替换成 <code>fmt</code> 地址的低 12 位。</p>
<p><code>adrp x0, fmt</code> 会将 <code>fmt</code> 地址向下取整到最近的 <strong>4KB 边界</strong>（即清除低12位），然后加载这个“页基址”到 <code>x0</code>。</p>
<p>例如：<br> 如果 <code>fmt = 0x12345678</code>，那么：</p>
<ul>
<li><code>adrp x0, fmt</code> 会得到 <code>0x12345000</code>（低 12 位清零）</li>
</ul>
<p>another way to define a structs is </p>
<p><strong>使用 <code>.equ</code> 伪指令定义符号常量</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">    .global main                // main 函数声明</span><br><span class="line">    .text</span><br><span class="line">    .p2align 2</span><br><span class="line"></span><br><span class="line">    .equ foo_a, 0               // like #define foo_a 0</span><br><span class="line">    .equ foo_b, 2               // like #define foo_b 2</span><br><span class="line">    .equ foo_c, 4               // like #define foo_c 4</span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">    stp     x29, x30, [sp, -16]!  // 保存 x29, x30 到栈上</span><br><span class="line">    mov     x29, sp               // 设置新的帧指针</span><br><span class="line"></span><br><span class="line">    // 加载 fmt 和 bar 的地址</span><br><span class="line">    ldr     x0, =fmt              // fmt 字符串的地址</span><br><span class="line">    ldr     x1, =bar              // bar 的地址</span><br><span class="line">    ldrh    w2, [x1, foo_a]       // 加载 bar.a 到 w2</span><br><span class="line">    ldrb    w3, [x1, foo_b]       // 加载 bar.b 到 w3</span><br><span class="line">    ldr     w4, [x1, foo_c]       // 加载 bar.c 到 w4</span><br><span class="line"></span><br><span class="line">    // 调用 printf，传递参数</span><br><span class="line">    mov     x0, x0               // 第一个参数：fmt 地址</span><br><span class="line">    mov     x1, w2               // 第二个参数：a 的值</span><br><span class="line">    mov     x2, w3               // 第三个参数：b 的值</span><br><span class="line">    mov     x3, w4               // 第四个参数：c 的值</span><br><span class="line">    bl      printf               // 调用 printf</span><br><span class="line"></span><br><span class="line">    // 恢复栈和寄存器</span><br><span class="line">    ldp     x29, x30, [sp], #16  // 恢复 x29 和 x30</span><br><span class="line">    ret                          // 返回</span><br><span class="line"></span><br><span class="line">    .data</span><br><span class="line">fmt:    </span><br><span class="line">	.asciz      &quot;%p a: 0x%lx b: %x c: %x\n&quot;   // printf 格式字符串</span><br><span class="line">bar:    </span><br><span class="line">	.short      0xaaaa                        // a</span><br><span class="line">    .byte       0xbb                          // b</span><br><span class="line">    .byte       0                               // padding</span><br><span class="line">    .word       0xcccccccc                    // c</span><br><span class="line"></span><br><span class="line">    .end</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>the third way:(<strong>Linux only</strong>)</p>
<p> <strong>使用 <code>.struct</code> 和字段标签自动推导偏移</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    .section .rodata</span><br><span class="line">fmt:</span><br><span class="line">    .asciz &quot;%p a: 0x%lx b: %x c: %x\n&quot;</span><br><span class="line"></span><br><span class="line">    // 用 .struct 模拟 struct Foo 的字段偏移</span><br><span class="line">    .set  Foo, 0</span><br><span class="line">    .struct 0</span><br><span class="line">Foo_a:  .struct Foo_a + 2      // short a: 2字节</span><br><span class="line">Foo_b:  .struct Foo_b + 1      // char b: 1字节</span><br><span class="line">        .struct Foo_b + 1      // padding: 1字节</span><br><span class="line">Foo_c:  .struct Foo_b + 2      // int c: 从 offset 4 开始</span><br><span class="line">    // 现在 Foo_c 是偏移量 4</span><br><span class="line"></span><br><span class="line">    .data</span><br><span class="line">bar:</span><br><span class="line">    .short 0xaaaa              // a: short 2 byte</span><br><span class="line">    .byte  0xbb                // b: char  1 byte</span><br><span class="line">    .byte  0x00                // padding</span><br><span class="line">    .word  0xcccccccc          // c: int   4 byte</span><br><span class="line"></span><br><span class="line">    .text</span><br><span class="line">    .global main</span><br><span class="line">    .align 2</span><br><span class="line">main:</span><br><span class="line">    stp x29, x30, [sp, -16]!   // 保存栈帧</span><br><span class="line">    mov x29, sp</span><br><span class="line"></span><br><span class="line">    adrp x0, fmt</span><br><span class="line">    add  x0, x0, :lo12:fmt     // printf 格式字符串地址</span><br><span class="line"></span><br><span class="line">    adrp x1, bar</span><br><span class="line">    add  x1, x1, :lo12:bar     // bar 的地址</span><br><span class="line"></span><br><span class="line">    ldrh w2, [x1, Foo_a]       // 加载 bar.a（short）</span><br><span class="line">    ldrb w3, [x1, Foo_b]       // 加载 bar.b（char）</span><br><span class="line">    ldr  w4, [x1, Foo_c]       // 加载 bar.c（int）</span><br><span class="line"></span><br><span class="line">    bl printf                  // printf(bar, a, b, c)</span><br><span class="line"></span><br><span class="line">    // 显式退出</span><br><span class="line">    mov     x8, #93            // syscall number for exit</span><br><span class="line">    mov     x0, xzr            // exit code 0</span><br><span class="line">    svc     0                  // syscall</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="using-structs"><a href="#using-structs" class="headerlink" title="using structs"></a>using structs</h4><p>To summarize using <code>structs</code>:</p>
<ul>
<li>All <code>structs</code> have a base address</li>
<li><strong>The base address corresponds to the beginning of the first data member</strong></li>
<li>All subsequent data members are offsets relative to the first</li>
<li>In order to use a <code>struct</code> correctly, you must have first calculated the offsets of each data member</li>
<li>Sometimes there will be padding between data members due to the need to align all data members on natural boundaries.</li>
</ul>
<h4 id="this-pointer-in-c"><a href="#this-pointer-in-c" class="headerlink" title="this pointer in c++"></a>this pointer in c++</h4><ul>
<li><strong>Every non-static method call employs a hidden first parameter. That’s it. That’s the slight of hand. The hidden argument is the this pointer.</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TestClass tc;</span><br><span class="line">tc.<span class="built_in">SetString</span>(test_string);</span><br></pre></td></tr></table></figure>
<p>看起来我们只传入了一个参数 test_string。但实际上编译器传入了两个参数：</p>
<ol>
<li><p>第一个是 this 指针：也就是 tc 的地址，传给寄存器 x0</p>
</li>
<li><p>第二个是 test_string，传给寄存器 x1</p>
</li>
</ol>
<p>在汇编里看到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adrp x1, _test_string</span><br><span class="line">adrp x0, _tc         // 把 tc 对象地址放到 x0 —— 也就是 this 指针</span><br><span class="line">bl __ZN9TestClass9SetStringEPc</span><br></pre></td></tr></table></figure>
<h2 id="const"><a href="#const" class="headerlink" title="const"></a>const</h2><blockquote>
<p>The meaning and function of <code>const</code> only <code>partially</code> translates to assembly language.</p>
</blockquote>
<ul>
<li><code>const</code> local variables and <code>const</code> parameters are just like any other data to assembly language. </li>
<li><p>The constant nature of <code>const</code> local variables and parameters is implemented solely in the compiler.</p>
</li>
<li><p><strong><code>const</code> globals are made constant by the hardware</strong>. Attempting to modify a variable protected in this manner will be like poking a dragon. Best not to poke dragons.</p>
</li>
</ul>
<h2 id="switch-and-jump-table"><a href="#switch-and-jump-table" class="headerlink" title="switch and jump table"></a>switch and jump table</h2><blockquote>
<p>When the C++ optimizer is enabled, it will look at your cases and choose between three different constructs for implementing your <code>switch</code>.</p>
<p>And, it can use any combination of the following! Compiler writers are smart!</p>
</blockquote>
<ol>
<li>It may emit a long string of <code>if / else</code> constructs.</li>
<li>It may find the right <code>case</code> using a <em>binary search</em>.</li>
<li>Finally, it might use a <strong>jump table</strong>.</li>
</ol>
<p>Suppose our cases are largely consecutive. Given that all branch instructions are the same length in bytes, we can do math on the switch variable to somehow derive the address of the case we want.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span>                                              </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>                                                </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span>                                                 </span></span><br><span class="line">                                                                   </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>                                                        </span><br><span class="line">&#123;                                                                   </span><br><span class="line">    <span class="type">int</span> r;                                                         </span><br><span class="line">                                                                    </span><br><span class="line">    srand(time(<span class="number">0</span>));                                                </span><br><span class="line">    r = rand() &amp; <span class="number">7</span>;                                                 </span><br><span class="line">    <span class="keyword">switch</span> (r)                                                      </span><br><span class="line">    &#123;                                                              </span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:                                                    </span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;0 returned&quot;</span>);                                    </span><br><span class="line">            <span class="keyword">break</span>;                                                 </span><br><span class="line">                                                                 </span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:                                                  </span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;1 returned&quot;</span>);                                   </span><br><span class="line">            <span class="keyword">break</span>;                                                  </span><br><span class="line">                                                                    </span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:                                                     </span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;2 returned&quot;</span>);                                     </span><br><span class="line">            <span class="keyword">break</span>;                                                 </span><br><span class="line">                                                                    </span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:                                                   </span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;3 returned&quot;</span>);                                  </span><br><span class="line">            <span class="keyword">break</span>;                                                </span><br><span class="line">                                                                   </span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:                                                    </span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;4 returned&quot;</span>);                                     </span><br><span class="line">            <span class="keyword">break</span>;                                                 </span><br><span class="line">                                                                   </span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:                                                     </span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;5 returned&quot;</span>);                                  </span><br><span class="line">            <span class="keyword">break</span>;                                             </span><br><span class="line">                                                                    </span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:                                                    </span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;6 returned&quot;</span>);                                    </span><br><span class="line">            <span class="keyword">break</span>;                                                  </span><br><span class="line">                                                                  </span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:                                                     </span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;7 returned&quot;</span>);                                     </span><br><span class="line">            <span class="keyword">break</span>;                                                  </span><br><span class="line">    &#125;                                                               </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;                                                     </span><br><span class="line">&#125;                                                                  </span><br></pre></td></tr></table></figure>
<p>Notice that the <code>case</code> values are all, in this case, consecutive.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jt:     b       0f</span><br><span class="line">        b       1f</span><br><span class="line">        b       2f</span><br><span class="line">        b       3f</span><br><span class="line">        b       4f</span><br><span class="line">        b       5f</span><br><span class="line">        b       6f</span><br><span class="line">        b       7f</span><br></pre></td></tr></table></figure>
<p><code>f</code> means forward, <code>b</code> means backward</p>
<p>At address <code>jt</code> there are a sequence of branch statements… jumps if you will. Being in a sequence, this is an example of a jump table. We’ll compute the index into this <em>array of instructions</em> and then branch to it.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lsl     x0, x0, 2     </span><br><span class="line">ldr     x1, =jt          </span><br><span class="line">add     x1, x1, x0        </span><br><span class="line">br      x1                    </span><br></pre></td></tr></table></figure>
<ul>
<li><p>Line 2 loads the base address of the “instruction array” starting at address <code>jt</code>.</p>
<p>complete example</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">        .text</span><br><span class="line">        .align  4</span><br><span class="line">        .global main</span><br><span class="line"></span><br><span class="line">main:   str     x30, [sp, -16]!</span><br><span class="line">        mov     x0, xzr             // set up call to time(nullptr)</span><br><span class="line">        bl      time                // call time setting up srand</span><br><span class="line">        bl      srand               // call srand setting up rand</span><br><span class="line">        bl      rand                // get a random number</span><br><span class="line">        and     x0, x0, 7           // ensure its range is 0 to 7</span><br><span class="line">                                    // note use of x register is on purpose</span><br><span class="line">        lsl     x0, x0, 2           // multiply by 4</span><br><span class="line">        ldr     x1, =jt             // load base address of jump table</span><br><span class="line">        add     x1, x1, x0          // add offset to base address</span><br><span class="line">        br      x1</span><br><span class="line"></span><br><span class="line">// If, as in this case, all the &quot;cases&quot; have the same number of </span><br><span class="line">// instructions then this intermediate jump table can be omitted saving</span><br><span class="line">// some space and a tiny amount of time. To omit the intermediate jump</span><br><span class="line">// table, you&#x27;d multiply by 12 above and not 4. Twelve because each </span><br><span class="line">// &quot;case&quot; has 3 instructions (3 x 4 == 12).</span><br><span class="line"></span><br><span class="line">// Question for you: If you did omit the jump table, relative to what</span><br><span class="line">// would you jump (since &quot;jt&quot; would be gone).</span><br><span class="line"></span><br><span class="line">jt:     b       0f</span><br><span class="line">        b       1f</span><br><span class="line">        b       2f</span><br><span class="line">        b       3f</span><br><span class="line">        b       4f</span><br><span class="line">        b       5f</span><br><span class="line">        b       6f</span><br><span class="line">        b       7f</span><br><span class="line"></span><br><span class="line">0:      ldr     x0, =ZR</span><br><span class="line">        bl      puts</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">1:      ldr     x0, =ON</span><br><span class="line">        bl      puts</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">2:      ldr     x0, =TW</span><br><span class="line">        bl      puts</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">3:      ldr     x0, =TH</span><br><span class="line">        bl      puts</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">4:      ldr     x0, =FR</span><br><span class="line">        bl      puts</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">5:      ldr     x0, =FV</span><br><span class="line">        bl      puts</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">6:      ldr     x0, =SX</span><br><span class="line">        bl      puts</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">7:      ldr     x0, =SV</span><br><span class="line">        bl      puts</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">99:     mov     w0, wzr</span><br><span class="line">        ldr     x30, [sp], 16</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">        .data</span><br><span class="line">        .section    .rodata</span><br><span class="line"></span><br><span class="line">ZR:     .asciz      &quot;0 returned&quot;</span><br><span class="line">ON:     .asciz      &quot;1 returned&quot;</span><br><span class="line">TW:     .asciz      &quot;2 returned&quot;</span><br><span class="line">TH:     .asciz      &quot;3 returned&quot;</span><br><span class="line">FR:     .asciz      &quot;4 returned&quot;</span><br><span class="line">FV:     .asciz      &quot;5 returned&quot;</span><br><span class="line">SX:     .asciz      &quot;6 returned&quot;</span><br><span class="line">SV:     .asciz      &quot;7 returned&quot;</span><br><span class="line"></span><br><span class="line">        .end</span><br></pre></td></tr></table></figure>
<h3 id="implement-falling-through"><a href="#implement-falling-through" class="headerlink" title="implement falling through"></a>implement falling through</h3><p>If there is no break falling the code for a case, control will simply fall through to the next case</p>
<p>Here is a snippet from the program linked just above</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0:      ldr     x0, =ZR  </span><br><span class="line">        bl      puts   </span><br><span class="line">        b       99f </span><br><span class="line">                  </span><br><span class="line">1:      ldr     x0, =ON </span><br><span class="line">        bl      puts    </span><br><span class="line">        b       99f     </span><br></pre></td></tr></table></figure>
<h3 id="implementing-gaps"><a href="#implementing-gaps" class="headerlink" title="implementing gaps"></a>implementing gaps</h3><p>The example above present shows 8 consecutive cases. What if there was no code for case 4? In other words,  what if case 4 didn’t exit?</p>
<p>Here is the result:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2:      ldr     x0, =TW</span><br><span class="line">        bl      puts</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">3:      ldr     x0, =TH</span><br><span class="line">        bl      puts</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">4:      b       99f</span><br><span class="line"></span><br><span class="line">5:      ldr     x0, =FV</span><br><span class="line">        bl      puts</span><br><span class="line">        b       99f</span><br></pre></td></tr></table></figure>
<h3 id="other-strategies-for-implementing-switch"><a href="#other-strategies-for-implementing-switch" class="headerlink" title="other strategies for implementing switch"></a>other strategies for implementing switch</h3><p>As indicated above, an optimizer has at least three tools available to it to implement complex <code>switch</code> statements. And, it can combine these tools.</p>
<ol>
<li>For example, suppose your cases boil down to two ranges of fairly consecutive values. For example, you have cases 0 to 9 and also cases 50 to 59. You can implement this as <strong>two jump tables with an <code>if / else</code> to select</strong> which one you use.</li>
</ol>
<p>假设你的 <code>switch</code> 语句中，<code>case</code> 值主要集中在<strong>两个小的连续范围内</strong>，例如：一组是 <code>case 0</code> 到 <code>case 9</code>,另一组是 <code>case 50</code> 到 <code>case 59</code>,那么可以用 <strong>两个跳转表</strong> 来处理这两个范围，再用一个 <code>if / else</code> 来决定使用哪一个跳转表。</p>
<ol>
<li>Suppose you have a large <code>switch</code> statement with widely ranging <code>case</code> values. In this case, you can implement a binary search to narrow down to a small range in which another technique becomes viable to narrow down to a single <code>case</code>.</li>
</ol>
<p>假设你有一个包含很多 <code>case</code> 分支的 <code>switch</code> 语句，而且这些 <code>case</code> 值之间的<strong>数值范围差异很大</strong>,比如 case 10, case 1000, case 50000…，那么可以<strong>先用二分查找法缩小查找范围</strong>，把目标值限制在一个<strong>较小的范围内</strong>，然后在这个范围内再用其他技术（比如跳转表、线性比较等）来确定最终对应哪个 <code>case</code> 分支。</p>
<ol>
<li>You might have need to implement <strong>hierarchical jump tables（分层跳转表）</strong>, for example.</li>
</ol>
<p>“分层跳转表”是一种优化结构，适用于以下情况：</p>
<ul>
<li><code>case</code> 值非常<strong>稀疏</strong>、<strong>范围极广</strong>（例如 <code>case 0, case 1000, case 2000...</code>)</li>
<li>但它们在<strong>局部范围内是稠密的</strong>（比如 <code>1000~1009</code>, <code>2000~2009</code>）</li>
</ul>
<p>你可以：</p>
<ol>
<li><strong>先用一个“一级跳转表”根据高位或区段跳转</strong>到一个子跳转表（子范围）。</li>
<li><strong>再在子跳转表中做具体跳转</strong>。<br> 这就构成了一个“分层结构”——像树一样的跳转过程。</li>
</ol>
<h3 id="strategies-for-implementing-if-else"><a href="#strategies-for-implementing-if-else" class="headerlink" title="strategies for implementing if-else"></a>strategies for implementing if-else</h3><p>If you do choose to implement a long chain of <code>if / else</code> statements, consider how frequently a given case might be chosen. <strong>Put the most common cases at the top of the <code>if / else</code> sequence</strong>.</p>
<p><strong>This is known as making the common case fast.</strong></p>
<p>Making the common case fast is one of the Great Ideas in Computer Science. One, you would do well to remember no matter what language you’re working with.</p>
<h2 id="fucntions"><a href="#fucntions" class="headerlink" title="fucntions"></a>fucntions</h2><h3 id="bottom-line-concept"><a href="#bottom-line-concept" class="headerlink" title="bottom line concept"></a>bottom line concept</h3><p>The <code>bl</code> instruction is stands for Branch with Link. The Link concept is what enables a function (or method) to return to the instruction after the call.</p>
<p>Branch-with-link computes the address of the instruction following it.</p>
<blockquote>
<p>It places this address into register <code>x30</code> and then branches to the label provided. It makes one link of a trail of breadcrumbs to follow to get back following a <code>ret</code>.</p>
</blockquote>
<p><strong>This is why it is absolutely essential to backup <code>x30</code> inside your functions if they call other functions themselves.</strong></p>
<h4 id="a-example"><a href="#a-example" class="headerlink" title="a example"></a>a example</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">        .text                                      </span><br><span class="line">        .global main                       </span><br><span class="line">        .align  2                           </span><br><span class="line">                                 </span><br><span class="line">main:   ldr     x0, =hw                </span><br><span class="line">        bl      puts             </span><br><span class="line">        ret</span><br><span class="line">                      </span><br><span class="line">        .data                        </span><br><span class="line">hw:     .asciz  &quot;Hello World!&quot;               </span><br><span class="line">                                                 </span><br><span class="line">        .end  </span><br></pre></td></tr></table></figure>
<p><strong>The program hung and had to be killed with ^C.</strong> </p>
<p>Somebody called <code>main()</code> - it’s a function and someone called it with a <code>bl</code> instruction. At the moment <code>main()</code> entered, the address to which it needed to return was sitting in <code>x30</code>.</p>
<p>Then, <code>main()</code> called a function - in this case <code>puts()</code> but which function is called doesn’t matter - it called a function. In doing so, it overwrote the address to which <code>main()</code> needed to return with the address of line 7 in the code. That is where <code>puts()</code> needs to return.</p>
<p>So, when line 7 executes it puts the contents of <code>x30</code> into the program counter and branches to it.</p>
<p>Here is a fixed version of the code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">        .text                                   </span><br><span class="line">        .global main                           </span><br><span class="line">        .align  2                         </span><br><span class="line">                                          </span><br><span class="line">main:   str     x30, [sp, -16]!            </span><br><span class="line">        ldr     x0, =hw                     </span><br><span class="line">        bl      puts                 </span><br><span class="line">        ldr     x30, [sp], 16         </span><br><span class="line">        ret                             </span><br><span class="line">                        </span><br><span class="line">        .data                       </span><br><span class="line">hw:     .asciz  &quot;Hello World!&quot;                   </span><br><span class="line">                                             </span><br><span class="line">        .end</span><br></pre></td></tr></table></figure>
<p>In the AARCH64 Linux style calling convention, values are returned in <code>x0</code> and sometimes also returned in other scratch registers though this is uncommon.(Note that <code>x0</code> could also be <code>w0</code> or the first floating point register if the function is returning a <code>float</code> or <code>double</code>.)</p>
<p>If your functions call <em>any</em> other functions, <code>x30</code> must be backed up on the stack and then restored into <code>x30</code> before returning.</p>
<p>A function with more than one return value is not supported by C or C++ but they can be written in assembly language where the rules are yours to break.</p>
<h3 id="inline-functions"><a href="#inline-functions" class="headerlink" title="inline functions"></a>inline functions</h3><p>Functions that are declared as <em>inline</em> don’t actually make function calls. Instead, the code from the function is type checked and inserted directly where the “call” is made after adjusting for parameter names.</p>
<h3 id="passing-parameters-to-functions"><a href="#passing-parameters-to-functions" class="headerlink" title="passing parameters to functions"></a>passing parameters to functions</h3><p><strong>How parameters are passed to functions can be different from OS to OS.</strong> This chapter is written to the standard implemented for Linux. </p>
<p>For the purposes of the present discussion, we assume all parameters are <code>long int</code> and are therefore stored in <code>x</code> registers.</p>
<ul>
<li><p><strong>Up to 8 parameters can be passed directly via scratch registers.</strong>（These are <code>x0</code> through <code>x7</code>） Each parameter can be up to the size of an address, long or double (8 bytes).</p>
<ul>
<li><p><strong><em>Scratch</em> means the value of the register can be changed at will without any need to backup or restore their values across function calls.</strong></p>
</li>
<li><p><strong>This means that you cannot count on the contents of the scratch registers maintaining their value if your function makes any function calls.</strong></p>
</li>
</ul>
</li>
</ul>
<h4 id="a-example-1"><a href="#a-example-1" class="headerlink" title="a example"></a>a example</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">func</span><span class="params">(<span class="type">long</span> p1, <span class="type">long</span> p2)</span>              </span><br><span class="line">&#123;                                              </span><br><span class="line">    <span class="keyword">return</span> p1 + p2;                           </span><br><span class="line">&#125;                                              </span><br></pre></td></tr></table></figure>
<p>is implemented as:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">func:   add x0, x0, x1  </span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>
<p>If you are the author of both the caller and the callee and both are in assembly language, you can play loosey goosey with how you return values. Specifically, you can return more than one value. <strong>But</strong> if you do so, you give up the possibility of calling these functions from C or C++.</p>
<h3 id="const-1"><a href="#const-1" class="headerlink" title="const"></a>const</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">func</span><span class="params">(<span class="type">const</span> <span class="type">long</span> p1, <span class="type">const</span> <span class="type">long</span> p2)</span>              </span><br><span class="line">&#123;                                  </span><br><span class="line">    <span class="keyword">return</span> p1 + p2;</span><br><span class="line">&#125;                                                 </span><br></pre></td></tr></table></figure>
<p>how would the assembly language change?</p>
<p>Answer: no change at all!</p>
<p><code>const</code> is an instruction to the compiler ordering it to prohibit changing the values of <code>p1</code> and <code>p2</code>. We’re smart humans and realize that our assembly language makes no attempt to change <code>p1</code> and <code>p2</code> so no changes are warranted.</p>
<h3 id="passing-pointers"><a href="#passing-pointers" class="headerlink" title="passing pointers"></a>passing pointers</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">long</span> * p1, <span class="type">long</span> * p2)</span>               </span><br><span class="line">&#123;                                                </span><br><span class="line">    *p1 = *p1 + *p2;                           </span><br><span class="line">&#125;                                         </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func:   ldr x2, [x0]                     </span><br><span class="line">        ldr x3, [x1]                            </span><br><span class="line">        add x2, x2, x3                       </span><br><span class="line">        str x2, [x0]                            </span><br><span class="line">        ret                                   </span><br></pre></td></tr></table></figure>
<p>The value of <code>x0</code> on return is, in the general sense, undefined because this is a <code>void</code> function.</p>
<h3 id="passing-reference"><a href="#passing-reference" class="headerlink" title="passing reference"></a>passing reference</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">long</span> <span class="title">func</span><span class="params">(<span class="type">long</span> &amp; p1, <span class="type">long</span> &amp; p2)</span>                     </span></span><br><span class="line"><span class="function"></span>&#123;                                              </span><br><span class="line">    <span class="keyword">return</span> p1 + p2;                               </span><br><span class="line">&#125;                                      </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func:   ldr x0, [x0]                     </span><br><span class="line">        ldr x1, [x1]                </span><br><span class="line">        add x0, x0, x1      </span><br><span class="line">        ret                </span><br></pre></td></tr></table></figure>
<p>Passing by reference is also an instruction to the compiler to treat pointers a little differently - the differences don’t show up here so there the only change to our pointer passing version is how we return the answer.</p>
<h3 id="more-than-eight-parameters"><a href="#more-than-eight-parameters" class="headerlink" title="more than eight parameters"></a>more than eight parameters</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">SillyFunction</span><span class="params">(<span class="type">long</span> p1, <span class="type">long</span> p2, <span class="type">long</span> p3, <span class="type">long</span> p4, </span></span><br><span class="line"><span class="params">                   <span class="type">long</span> p5, <span class="type">long</span> p6, <span class="type">long</span> p7, <span class="type">long</span> p8, </span></span><br><span class="line"><span class="params">                   <span class="type">long</span> p9)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This example hurts: %ld %ld\n&quot;</span>, p8, p9);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    SillyFunction(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">        .text                                                            </span><br><span class="line">        .global    main                                                </span><br><span class="line">                                                                        </span><br><span class="line">/*  Demonstration of using  more than 8 arguments to  a function.  This  </span><br><span class="line">    demo is LINUX only as APPLE will put all arguments beyond the first  </span><br><span class="line">    one on the stack anyway.                                             </span><br><span class="line">                                                                         </span><br><span class="line">    On LINUX, all parameters to a function beyond  the  eight go on the </span><br><span class="line">    stack.  The first 8 go in registers  x0  through  x7 as normal (for </span><br><span class="line">    LINUX).                                                              </span><br><span class="line">*/                                                                    </span><br><span class="line">                                                                       </span><br><span class="line">SillyFunction:                                                        </span><br><span class="line">        stp        x29, x30, [sp, -16]!    // Changes sp.               </span><br><span class="line">        mov        x29, sp                 // set new sp                    </span><br><span class="line">        ldr        x0, =fmt                                 </span><br><span class="line">        mov        x1, x7                  // 第八个参数</span><br><span class="line">        ldr        x2, [sp, 16]            // This does not alter the sp，第九个参数</span><br><span class="line">        bl         printf                                                </span><br><span class="line">        ldp        x29, x30, [sp], 16      // Undoes change to sp.     </span><br><span class="line">        ret                                                          </span><br><span class="line">                                                                          </span><br><span class="line">main:                                                                   </span><br><span class="line">        stp        x29, x30, [sp, -16]!    // sp down total of 16.      </span><br><span class="line">        mov        x29, sp                                                </span><br><span class="line">        mov        x0, 9                                                </span><br><span class="line">        str        x0, [sp, -16]!          // sp down total of 32.     </span><br><span class="line">        mov        x0, 1                                                </span><br><span class="line">        mov        x1, 2                                                  </span><br><span class="line">        mov        x2, 3                                            </span><br><span class="line">        mov        x3, 4                                               </span><br><span class="line">        mov        x4, 5                                              </span><br><span class="line">        mov        x5, 6                                                  </span><br><span class="line">        mov        x6, 7                                                   </span><br><span class="line">        mov        x7, 8                                                   </span><br><span class="line">        bl         SillyFunction                                           </span><br><span class="line">        add        sp, sp, 16           // undoes change of sp by 16 due   </span><br><span class="line">                                        // to function call.              </span><br><span class="line">        ldp        x29, x30, [sp], 16   // undoes change to sp of 16.    </span><br><span class="line">        ret                                                             </span><br><span class="line">                                                                        </span><br><span class="line">        .data                                                            </span><br><span class="line">fmt:    .asciz    &quot;This example hurts my brain: %ld %ld\n&quot;           </span><br><span class="line">                                                                       </span><br><span class="line">        .end                                                         </span><br></pre></td></tr></table></figure>
<p>After executing <code>Line 24</code>, the stack will have:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sp + 0    former contents of frame pointer</span><br><span class="line">sp + 8    return address for main</span><br></pre></td></tr></table></figure>
<p>After executing <code>Line 27</code>, the stack will have:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sp + 0    9</span><br><span class="line">sp + 8    garbage</span><br><span class="line">sp + 16   former contents of frame pointer</span><br><span class="line">sp + 24   return address for main</span><br></pre></td></tr></table></figure>
<p>After executing <code>Line 14</code>, the stack will have:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sp + 0    return address for SillyFunction</span><br><span class="line">sp + 8    garbage</span><br><span class="line">sp + 16   9</span><br><span class="line">sp + 24   garbage</span><br><span class="line">sp + 32   former contents of frame pointer</span><br><span class="line">sp + 40   return address for main</span><br></pre></td></tr></table></figure>
<p>This means that <code>Line 18</code> fetches <code>p9</code> from memory and puts its value into x2 (where it becomes the third argument to <code>printf()</code>).</p>
<blockquote>
<p>在 AArch64 中，栈空间常常是 <strong>以 16 字节为单位对齐</strong>分配的，但你可能 <strong>只写了其中的一部分数据</strong>，剩下的就没有被初始化，于是我们称它为 <strong>“garbage”（未定义的内容）</strong>。</p>
</blockquote>
<p><strong>The stack pointer in ARM V8 can only be manipulated in multiples of 16.</strong></p>
<p><strong>The stack pointer in ARM V8 can only be manipulated in multiples of 16.</strong></p>
<p><strong>The stack pointer in ARM V8 can only be manipulated in multiples of 16.</strong></p>
<h3 id="examples-of-calling-some-common-C-runtime-functions"><a href="#examples-of-calling-some-common-C-runtime-functions" class="headerlink" title="examples of calling some common C runtime functions"></a>examples of calling some common C runtime functions</h3><p>There are, by the way, two broad types of functions within the C runtime. </p>
<ul>
<li><p>Some are implemented largely in the C runtime itself. </p>
</li>
<li><p>Others that exist in the C runtime act as wrappers for functions implemented within the OS itself. These are called “system calls”.</p>
</li>
</ul>
<p>For the purposes of calling functions in the C runtime, there is no practical difference between these two types. Note however, there are ways of calling system calls directly using the <code>svc</code> instruction.</p>
<p>“C runtime”（<strong>C 运行时</strong>）指的是一组在程序运行时提供支持的函数、变量和基础机制，<strong>主要用于支持 C 语言标准库和程序的初始化/终止</strong>。这套系统通常被称为 <strong>C runtime library（C 运行时库）</strong>，在不同平台中常见的实现有：</p>
<ul>
<li>GNU/Linux 下的 <strong>glibc</strong></li>
<li>Windows 下的 <strong>MSVCRT</strong></li>
<li>macOS 下的 <strong>libSystem.dylib（包含 libc）</strong></li>
</ul>
<p>C runtime 做了哪些事？</p>
<ol>
<li><strong>程序初始化</strong><ul>
<li>在 <code>main()</code> 执行之前，C runtime 会设置好堆栈、初始化全局变量、调用构造函数等。</li>
<li>典型入口点是 <code>_start</code> → <code>__libc_start_main()</code> → <code>main()</code>。</li>
</ul>
</li>
<li><strong>提供标准库函数</strong><ul>
<li>如 <code>printf()</code>, <code>malloc()</code>, <code>exit()</code>, <code>fopen()</code> 等，这些函数由 C runtime 实现或封装。</li>
</ul>
</li>
<li><strong>管理资源</strong><ul>
<li>比如内存分配、文件句柄、线程等的生命周期管理。</li>
</ul>
</li>
<li><strong>提供系统调用封装</strong><ul>
<li>比如你调用 <code>write()</code>，它其实是调用了一个 <strong>C runtime 提供的 wrapper</strong>，最终通过 <code>syscall</code> 或 <code>svc</code> 指令访问内核。</li>
</ul>
</li>
</ol>
<h3 id="system-calls"><a href="#system-calls" class="headerlink" title="system calls"></a>system calls</h3><p>Many C runtime functions are just wrappers for system calls. For example if you call open() from the C runtime, the function will perform a few bookkeeping operations and then make the actual system call.</p>
<h4 id="What-IS-a-system-call"><a href="#What-IS-a-system-call" class="headerlink" title="What IS a system call?"></a>What IS a system call?</h4><p>The short answer is a system call is a sort-of function call that is serviced by the operating system itself, within its own private region of memory and with access to internal features and data structures.</p>
<p>Our programs run in “userland”. The technical name for userland on the ARM64 processor is EL0 (Exception Level 0).</p>
<p>We can operate within the kernel’s space only through carefully controlled mechanisms - such as system calls. The technical name for where the kernel (or system) generally operates is called EL1.</p>
<p>There are two higher Exception Levels (EL2 and EL3) which are beyond the scope of this book.</p>
<h4 id="Mechanism-of-making-a-system-call"><a href="#Mechanism-of-making-a-system-call" class="headerlink" title="Mechanism of making a system call"></a>Mechanism of making a system call</h4><p>First, like any function call, parameters need to be set up. The first parameter goes in the first register, etc.</p>
<p>Second, a number associated with the specific system call we wish to make is loaded in a specific register (w8).</p>
<p>Finally, a special instruction svc causes a trap which elevates us out of userland into kernel space. Said differently, svc causes a transition from EL0 to EL1. There, various checks are done and the actual code for the system call is run.</p>
<p>A description of returning from a system call is beyond the scope of this book. Hint: just as there’s a special instruction that escalates from EL0 to EL1, there is a special instruction that does the reverse.</p>
<h4 id="the-number-associated-with-a-particular-system-call"><a href="#the-number-associated-with-a-particular-system-call" class="headerlink" title="the number associated with a particular system call"></a>the number associated with a particular system call</h4><p>reference:</p>
   <div class="tag link"><a class="link-card" title="syscalls" target="_blank" rel="noopener external nofollow noreferrer" href="https://gpages.juszkiewicz.com.pl/syscalls-table/syscalls.html"><div class="left"><img src="/img/avatar.jpg"/></div><div class="right"><p class="text">syscalls</p><p class="url">https://gpages.juszkiewicz.com.pl/syscalls-table/syscalls.html</p></div></a></div>
<h4 id="example-getpid"><a href="#example-getpid" class="headerlink" title="example getpid()"></a>example getpid()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>                                                </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>                                               </span></span><br><span class="line">                                                                  </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;                                                      </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Greetings from: %d\n&quot;</span>, getpid());                     </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;                                                     </span><br><span class="line">&#125;                                                                 </span><br></pre></td></tr></table></figure>
<p>Written in assembly language using C runtime<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">        .global main                                              </span><br><span class="line">        .text                                                     </span><br><span class="line">        .align  2                                                 </span><br><span class="line">                                                                  </span><br><span class="line">main:   stp     x29, x30, [sp, -16]!                              </span><br><span class="line">        bl      getpid                                            </span><br><span class="line">        mov     w1, w0                                            </span><br><span class="line">        ldr     x0, =fmt                                          </span><br><span class="line">        bl      printf                                            </span><br><span class="line">        ldp     x29, x30, [sp], 16                                </span><br><span class="line">        mov     w0, wzr                                           </span><br><span class="line">        ret                                                       </span><br><span class="line">                                                                  </span><br><span class="line">        .data                                                     </span><br><span class="line">fmt:    .asciz  &quot;Greetings from: %d\n&quot;                            </span><br><span class="line">                                                                  </span><br><span class="line">        .end                                                      </span><br></pre></td></tr></table></figure><br>And finally: calling the system call directly<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">        .global main                                              </span><br><span class="line">        .text                                                     </span><br><span class="line">        .align  2                                                 </span><br><span class="line">                                                                  </span><br><span class="line">main:   stp     x29, x30, [sp, -16]!                              </span><br><span class="line">        mov     x8, 172                 // getpid on ARM64        </span><br><span class="line">        svc     0                       // trap to EL1            </span><br><span class="line">        mov     w1, w0                                            </span><br><span class="line">        ldr     x0, =fmt                                          </span><br><span class="line">        bl      printf                                            </span><br><span class="line">        ldp     x29, x30, [sp], 16                                </span><br><span class="line">        mov     w0, wzr                                           </span><br><span class="line">        ret                                                       </span><br><span class="line">                                                                  </span><br><span class="line">        .data                                                     </span><br><span class="line">fmt:    .asciz  &quot;Greetings from: %d\n&quot;                            </span><br><span class="line">                                                                  </span><br><span class="line">        .end                                                      </span><br></pre></td></tr></table></figure><br>We chose getpid() because it doesn’t require any parameters. Using the C runtime, we simply bl to it. <strong>Calling the system call directly is different in that we must first load x8 with the number that corresponds to getpid() for the AARCH64 architecture</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line">/*  Perry Kivolowitz</span><br><span class="line">    Example of file operations.</span><br><span class="line">*/</span><br><span class="line">        .text</span><br><span class="line">        .global main</span><br><span class="line">        .align  2</span><br><span class="line"></span><br><span class="line">/*  This program will</span><br><span class="line">    * open() a file in the current directory,</span><br><span class="line">    * write() some text to it, </span><br><span class="line">    * seek back to the beginning of the file,</span><br><span class="line">    * read() each line, printing it</span><br><span class="line">    * close() the file</span><br><span class="line">*/</span><br><span class="line">// 使用 .req 给寄存器取别名，便于阅读。例如，fd 其实就是 w28，代表文件描述符。</span><br><span class="line">retval  .req    w27</span><br><span class="line">fd 		.req	w28</span><br><span class="line"></span><br><span class="line">main:   stp     x29, x30, [sp, -16]!</span><br><span class="line">        stp     x27, x28, [sp, -16]!</span><br><span class="line">        bl      open_file</span><br><span class="line"></span><br><span class="line">        // w0 will contain either the file descriptor of the new</span><br><span class="line">        // file or -1 for a failure. Note that the value in w0</span><br><span class="line">        // has also been copied to &quot;fd&quot; - a register alias.</span><br><span class="line">        cmp 	w0, wzr</span><br><span class="line">        bge 	1f</span><br><span class="line"></span><br><span class="line">        // If we get here, the open has failed. Use perror() to</span><br><span class="line">        // print a meaningful error and branch to exit. The return</span><br><span class="line">        // code of the program will be set to non-zero inside fail.</span><br><span class="line">        ldr     x0, =fname</span><br><span class="line">        bl      fail</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">1:		// When we get here, the file is open. Write some data to it.</span><br><span class="line">        // If write_file returns non-zero, it signifies an error. If</span><br><span class="line">        // so, branch to the file closing code since the file is open</span><br><span class="line">        // after printing an error message.</span><br><span class="line">        bl		write_data</span><br><span class="line">        cbz	    w0, 10f</span><br><span class="line"></span><br><span class="line">        // If we get here, there was an error in write_data. Print</span><br><span class="line">        // a reasonable error message then branch to the clean usleep</span><br><span class="line">        // code.</span><br><span class="line">        ldr     x0, =wf     // load legend</span><br><span class="line">        bl      fail        // print error</span><br><span class="line">        b       50f         // branch to clean up.</span><br><span class="line"></span><br><span class="line">        // Seek back to position zero preparing to read the file back.</span><br><span class="line">        // The return value in x0 (off_t) is the return value of</span><br><span class="line">        // lseek(). </span><br><span class="line">10:     bl      seek_zero</span><br><span class="line">        cbz     x0, 20f</span><br><span class="line"></span><br><span class="line">        // If we get here, the seek failed. Cause a reasonable</span><br><span class="line">        // message to be printed then branch to the clean up code.</span><br><span class="line">        ldr     x0, =sf</span><br><span class="line">        bl      fail</span><br><span class="line">        b       50f</span><br><span class="line"></span><br><span class="line">20:     // When we get here, we have to read from the file and print</span><br><span class="line">        // the results. To ignore the complexity of memory allocation</span><br><span class="line">        // and buffer overrun potential, we&#x27;ll read one character at a </span><br><span class="line">        // time looking the end-of-file.</span><br><span class="line"></span><br><span class="line">        // ssize_t read(int fildes, void *buf, size_t nbyte);</span><br><span class="line">        mov     w0, fd</span><br><span class="line">        ldr     x1, =buffer</span><br><span class="line">        mov     x2, 1</span><br><span class="line">        bl      read</span><br><span class="line">        // Check the return value - should be 1.</span><br><span class="line">        cbz     x0,50f      // zero means EOF - that&#x27;s OK.</span><br><span class="line">        // If x0 is negative, that IS a problem.</span><br><span class="line">        cmp     x0, xzr</span><br><span class="line">        bge     25f</span><br><span class="line">        // The return value is negative - this is an error.</span><br><span class="line">        ldr     x0, =rf</span><br><span class="line">        bl      fail</span><br><span class="line">        b       99f</span><br><span class="line"></span><br><span class="line">25:     // Write the character sitting in buffer to the console.</span><br><span class="line">        mov     w0, 1</span><br><span class="line">        ldr     x1, =buffer</span><br><span class="line">        mov     x2, 1</span><br><span class="line">        bl      write</span><br><span class="line">        // We will ignore the return value for the sake of brevity.</span><br><span class="line">        // There are plenty of examples of handling a potential error</span><br><span class="line">        // elsewhere in this code.</span><br><span class="line">        // --</span><br><span class="line">        b       20b</span><br><span class="line"></span><br><span class="line">        // When we get here, we are done. Close the file.</span><br><span class="line">50:		mov		w0, fd</span><br><span class="line">        bl 		close</span><br><span class="line">        mov 	retval, wzr</span><br><span class="line"></span><br><span class="line">99:     ldp     x27, x28, [sp], 16</span><br><span class="line">        ldp     x29, x30, [sp], 16</span><br><span class="line">        mov     w0, retval</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">/*	open_file()</span><br><span class="line">    This function attempts to open a file for both reading and</span><br><span class="line">    writing. Return values will be checked to ensure the file is</span><br><span class="line">    opened. If successful, the fd is returned (and is squirreled</span><br><span class="line">    away in register &quot;fd&quot;). If unsuccessful, the -1 returned by</span><br><span class="line">    open() is passed back to the caller.</span><br><span class="line"></span><br><span class="line">    Explanation of the magic numbers:</span><br><span class="line"></span><br><span class="line">    int open(const char *pathname, int flags, mode_t mode);</span><br><span class="line"></span><br><span class="line">    octal 102 for flags is O_RDRW | O_CREAT</span><br><span class="line">    octal 600 for mode is rw------- i.e. read and write for</span><br><span class="line">        the owner but no permissions for anyone else.</span><br><span class="line"></span><br><span class="line">	There is a version of open() that takes two parameters. However,</span><br><span class="line">	if O_CREAT is specified, the three parameter version is required.</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">        .equ    O_FLAGS, 0102</span><br><span class="line">        .equ    O_MODE, 0600</span><br><span class="line"></span><br><span class="line">open_file:</span><br><span class="line">        stp      x29, x30, [sp, -16]!</span><br><span class="line">        ldr      x0, =fname</span><br><span class="line">        mov      w1, O_FLAGS</span><br><span class="line">        mov      w2, O_MODE</span><br><span class="line">        bl       open</span><br><span class="line">        mov      fd, w0</span><br><span class="line">        ldp      x29, x30, [sp], 16</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*  This function uses perror() to print a meaningful error</span><br><span class="line">    message in the event of a failure. The string value</span><br><span class="line">    passed to perror() arrives to us as a pointer in x0.</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">        stp     x29, x30, [sp, -16]!</span><br><span class="line">        bl 		perror</span><br><span class="line">        mov		retval, 1</span><br><span class="line">        ldp     x29, x30, [sp], 16</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">/*  ssize_t write(int fd, const void *buf, size_t count);</span><br><span class="line"></span><br><span class="line">	This function will write a string to the file descriptor contained</span><br><span class="line">	in &quot;fd&quot; (a register alias).</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">write_data:</span><br><span class="line">        stp     x29, x30, [sp, -16]!</span><br><span class="line">        str     x20, [sp, -16]!</span><br><span class="line">        mov     w0, fd              // file descriptor</span><br><span class="line">        ldr     x1, =txt            // address to print from</span><br><span class="line">        ldr     x2, =txt_s          // load pointer to size</span><br><span class="line">        ldr     x2, [x2]            // dereference the pointer</span><br><span class="line">        mov     w20, w2             // need this value for error check.</span><br><span class="line">        bl      write</span><br><span class="line">        cmp     x0, x20             // Did we write the expected amount?</span><br><span class="line">        bne     90f</span><br><span class="line">        // successful write - return 0</span><br><span class="line">        mov     x0, xzr</span><br><span class="line">        b       99f</span><br><span class="line">90:     // failure - ensure we return non-zero!</span><br><span class="line">        mov     x0, 1</span><br><span class="line">99:     ldr     x20, [sp], 16</span><br><span class="line">        ldp     x29, x30, [sp], 16</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">/*  off_t lseek(int fd, off_t offset, int whence);</span><br><span class="line">*/</span><br><span class="line">seek_zero:</span><br><span class="line">        stp     x29, x30, [sp, -16]!</span><br><span class="line">        mov     w0, fd          // file descriptor</span><br><span class="line">        mov     x1, xzr         // beginning of file</span><br><span class="line">        mov     w2, wzr         // SEEK_SET - absolute offset</span><br><span class="line">        bl      lseek</span><br><span class="line">        ldp     x29, x30, [sp], 16</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">        .data</span><br><span class="line">prog:	.asciz	&quot;file_ops&quot;</span><br><span class="line">wf:     .asciz  &quot;write failed&quot;</span><br><span class="line">rf:     .asciz  &quot;read failed&quot;</span><br><span class="line">sf:     .asciz  &quot;lseek failed&quot;</span><br><span class="line">fname:	.asciz	&quot;test.txt&quot;</span><br><span class="line">txt:	.asciz	&quot;some data\n&quot;</span><br><span class="line">txt_s:	.word	txt_s - txt - 1		// strlen(txt)，txt：“some data”的总长度</span><br><span class="line">buffer: .word   0</span><br><span class="line">        .end</span><br></pre></td></tr></table></figure>
<h2 id="floating-point"><a href="#floating-point" class="headerlink" title="floating point"></a>floating point</h2><h3 id="what-are-floating-points-numbers"><a href="#what-are-floating-points-numbers" class="headerlink" title="what are floating points numbers?"></a>what are floating points numbers?</h3><p>reference<br>   <div class="tag link"><a class="link-card" title="CSAPP DataLab" href="https://even629.com/posts/42856/"><div class="left"><img src="https://even629.com/img/favicon.ico"/></div><div class="right"><p class="text">CSAPP DataLab</p><p class="url">https://even629.com/posts/42856/</p></div></a></div></p>
<p><strong>IEEE 754</strong></p>
<h3 id="register-1"><a href="#register-1" class="headerlink" title="register"></a>register</h3><p>There are four highest level ideas relating to floating point operations on AARCH64.</p>
<ul>
<li>There is another complete register set for floating point values.</li>
<li>There are alternative instructions just for floating point values.</li>
<li>There are exotic instructions that operate on sets of floating point values (SIMD).</li>
<li>There are instructions to go back and forth to and from the integer registers.</li>
</ul>
<p><img src="https://raw.githubusercontent.com/even629/myPicGo/main/simdlanes.jpg" alt="regs"></p>
<p>上图展示了 <strong>ARM64 架构中 SIMD（Single Instruction, Multiple Data）寄存器 V0 的不同视图与访问方式</strong>，包括<strong>不同位宽的排列方式（Arrangement Specifiers）与 Lane（通道）索引</strong>。</p>
<p> <strong>图解说明</strong></p>
<p>这个图以 <strong>V0 寄存器为例</strong>，展示了 <strong>如何用不同的排列方式访问其内容</strong>：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>层级</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>最底层</td>
<td><code>V0</code></td>
<td>整个 128-bit 的 V0 寄存器</td>
</tr>
<tr>
<td>向上</td>
<td><code>V0.2D</code>, <code>V0.4S</code>, <code>V0.8H</code>, <code>V0.16B</code></td>
<td>以不同大小的数据视图访问 V0：<br/>- D = 64-bit（2 × 64bit）<br/>- S = 32-bit（4 × 32bit）<br/>- H = 16-bit（8 × 16bit）<br/>- B = 8-bit（16 × 8bit）</td>
</tr>
<tr>
<td>再上</td>
<td><code>V0.2D[0]</code>, <code>V0.4S[0]</code> 等</td>
<td>每个 lane 的索引，比如：<br/>- <code>V0.4S[2]</code> 表示第 3 个 32-bit 单元<br/>- <code>V0.16B[15]</code> 表示第 16 个 8-bit 字节</td>
</tr>
<tr>
<td>最上层</td>
<td><code>B0</code>, <code>H0</code>, <code>S0</code>, <code>D0</code></td>
<td>是对 <code>V0</code> 的 alias，按位宽访问（只访问最低位的数据）</td>
</tr>
</tbody>
</table>
</div>
<h3 id="truncation-towards-zero"><a href="#truncation-towards-zero" class="headerlink" title="truncation towards zero"></a>truncation towards zero</h3><p>truncate(截断)</p>
<p>In C and C++, truncation is what we get from:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">integer_variable = <span class="type">int</span>(floating_variable);  <span class="comment">// C++</span></span><br><span class="line">integer_variable = (<span class="type">int</span>) floating_variable; <span class="comment">// C</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>The instruction is <strong>fcvtz</strong> - convert towards zero. Then, the choice as to whether to produce a signed or unsigned result is defined by the final letterL u or s.</p>
</blockquote>
<div class="table-container">
<table>
<thead>
<tr>
<th>Mnemonic</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>fcvtzu</td>
<td>Truncate (always towards 0) producing an unsigned int</td>
</tr>
<tr>
<td>fcvtzs</td>
<td>Truncate (always towards 0) producing a signed int</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>fcvtzu: <strong>F</strong>loat <strong>C</strong>onvert to <strong>U</strong>nsigned integer, with truncation toward zero</li>
<li>fcvtzs: <strong>F</strong>loat <strong>C</strong>onvert to <strong>S</strong>igned integer, with truncation toward zero</li>
</ul>
<p>this instruction which completely discards the fractional value is said by the ARM documentation as doing rounding not truncating.</p>
<p>The the choice of source register defined whether you are converting a double or single precision floating point value.</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Source Register</th>
<th>Converts a</th>
</tr>
</thead>
<tbody>
<tr>
<td>dX</td>
<td><code>double</code> to an integer</td>
</tr>
<tr>
<td>sX</td>
<td><code>float</code> to an integer</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>Destination Register</th>
<th>Converts a</th>
</tr>
</thead>
<tbody>
<tr>
<td>xX</td>
<td>64 bit integer</td>
</tr>
<tr>
<td>wX</td>
<td>32 bit or less integer</td>
</tr>
</tbody>
</table>
</div>
<p>Examples where <code>d</code> is a <code>double</code> and <code>f</code> is a <code>float</code>:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>C++</th>
<th>Instruction</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>int32_t(d)</code></td>
<td><code>fcvtzs    w0, d0</code></td>
</tr>
<tr>
<td><code>uint32_t(d)</code></td>
<td><code>fcvtzu    w0, d0</code></td>
</tr>
<tr>
<td><code>int64_t(d)</code></td>
<td><code>fcvtzs    x0, d0</code></td>
</tr>
<tr>
<td><code>uint64_t(d)</code></td>
<td><code>fcvtzu    x0, d0</code></td>
</tr>
</tbody>
</table>
</div>
<h4 id="example-1"><a href="#example-1" class="headerlink" title="example"></a>example</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">    .section .text</span><br><span class="line">    .global main</span><br><span class="line">    .type main, @function // 表示 告诉汇编器和链接器：main 是一个函数符号（symbol）</span><br><span class="line">    //.type &lt;symbol&gt;, @&lt;type&gt; 是 GAS（GNU Assembler）的一条伪指令，用于给符号指定类型。</span><br><span class="line">    // &lt;symbol&gt;：符号名，比如 main</span><br><span class="line">    // @&lt;type&gt;：符号类型，这里是 @function，表示这是一个函数，而不是变量或标签</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">    stp     x29, x30, [sp, -16]!     // 保存 frame pointer 和 link register</span><br><span class="line">    mov     x29, sp</span><br><span class="line"></span><br><span class="line">    // 保存浮点寄存器</span><br><span class="line">    stp     d20, d21, [sp, -16]!</span><br><span class="line">    stp     d22, d23, [sp, -16]!</span><br><span class="line"></span><br><span class="line">    // 加载提示信息</span><br><span class="line">    ldr     x0, =leg</span><br><span class="line">    bl      printf</span><br><span class="line"></span><br><span class="line">    // 加载 vless 数据到 d20-d23</span><br><span class="line">    ldr     x0, =vless</span><br><span class="line">    ldr     d20, [x0]            // dless = 5.49</span><br><span class="line">    ldr     d21, [x0, #8]        // dmore = 5.51</span><br><span class="line">    ldr     d22, [x0, #16]       // ndless = -5.49</span><br><span class="line">    ldr     d23, [x0, #24]       // ndmore = -5.51</span><br><span class="line"></span><br><span class="line">    // fcvtps: 向上取整（+∞）</span><br><span class="line">    fcvtps  x1, d20</span><br><span class="line">    fcvtps  x2, d21</span><br><span class="line">    ldr     x0, =fmt1</span><br><span class="line">    bl      printf</span><br><span class="line"></span><br><span class="line">    fcvtps  x1, d22</span><br><span class="line">    fcvtps  x2, d23</span><br><span class="line">    ldr     x0, =fmt1</span><br><span class="line">    bl      printf</span><br><span class="line"></span><br><span class="line">    // fcvtns: 四舍五入 (tie to even)</span><br><span class="line">    fcvtns  x1, d20</span><br><span class="line">    fcvtns  x2, d21</span><br><span class="line">    ldr     x0, =fmt2</span><br><span class="line">    bl      printf</span><br><span class="line"></span><br><span class="line">    fcvtns  x1, d22</span><br><span class="line">    fcvtns  x2, d23</span><br><span class="line">    ldr     x0, =fmt2</span><br><span class="line">    bl      printf</span><br><span class="line"></span><br><span class="line">    // fcvtzs: 向 0 取整</span><br><span class="line">    fcvtzs  x1, d20</span><br><span class="line">    fcvtzs  x2, d21</span><br><span class="line">    ldr     x0, =fmt4</span><br><span class="line">    bl      printf</span><br><span class="line"></span><br><span class="line">    fcvtzs  x1, d22</span><br><span class="line">    fcvtzs  x2, d23</span><br><span class="line">    ldr     x0, =fmt4</span><br><span class="line">    bl      printf</span><br><span class="line"></span><br><span class="line">    // fcvtas: 四舍五入 (tie away from zero)</span><br><span class="line">    fcvtas  x1, d20</span><br><span class="line">    fcvtas  x2, d21</span><br><span class="line">    ldr     x0, =fmt3</span><br><span class="line">    bl      printf</span><br><span class="line"></span><br><span class="line">    fcvtas  x1, d22</span><br><span class="line">    fcvtas  x2, d23</span><br><span class="line">    ldr     x0, =fmt3</span><br><span class="line">    bl      printf</span><br><span class="line"></span><br><span class="line">    // 恢复浮点寄存器和返回地址</span><br><span class="line">    ldp     d22, d23, [sp], #16</span><br><span class="line">    ldp     d20, d21, [sp], #16</span><br><span class="line">    ldp     x29, x30, [sp], #16</span><br><span class="line">    mov     w0, wzr</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">    .section .rodata</span><br><span class="line">vless:</span><br><span class="line">    .double 5.49</span><br><span class="line">    .double 5.51</span><br><span class="line">    .double -5.49</span><br><span class="line">    .double -5.51</span><br><span class="line"></span><br><span class="line">fmt1:</span><br><span class="line">    .asciz &quot;fcvtps less: %ld more: %ld\n&quot;</span><br><span class="line">fmt2:</span><br><span class="line">    .asciz &quot;fcvtns less: %ld more: %ld\n&quot;</span><br><span class="line">fmt3:</span><br><span class="line">    .asciz &quot;fcvtas less: %ld more: %ld\n&quot;</span><br><span class="line">fmt4:</span><br><span class="line">    .asciz &quot;fcvtzs less: %ld more: %ld\n&quot;</span><br><span class="line">leg:</span><br><span class="line">    .asciz &quot;less values are +/- 5.49. more values are +/- 5.51.\n&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Notice all the values were truncated to the whole number that is closer to zero.</p>
<h3 id="Truncation-Away-From-Zero"><a href="#Truncation-Away-From-Zero" class="headerlink" title="Truncation Away From Zero"></a>Truncation Away From Zero</h3><p>Truncation away from zero is not as easy. In fact, it cannot be performed with a single instruction.</p>
<p>In C (and C++):<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iv = (<span class="type">int</span>(fv) == fv) ? <span class="type">int</span>(fv) : <span class="type">int</span>(fv) + ((fv &lt; <span class="number">0</span>) ? <span class="number">-1</span> : <span class="number">1</span>);</span><br></pre></td></tr></table></figure><br>If the fv is already equal to a whole number, the integer value will be that whole number. Other wise the iv is the whole number further away from zero.</p>
<p>In C++, a more sophisticated version would require <cmath> and could look like:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MyTruncate</span><span class="params">(T x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>((x &lt; <span class="number">0</span>) ? <span class="built_in">floor</span>(x) : <span class="built_in">ceil</span>(x));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>floor() always truncates downward (towards more negative).<br>ceil() always truncates upwards (towards more positive).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">RoundAwayFromZero:</span><br><span class="line">        fcmp    d0, 0</span><br><span class="line">        ble     1f</span><br><span class="line">        // Value is positive, truncate towards positive infinity (ceil)</span><br><span class="line">        frintp  d0, d0</span><br><span class="line">        b       2f</span><br><span class="line">1:      // Value is negative, truncate towards negative infinity (floor)</span><br><span class="line">        frintm  d0, d0</span><br><span class="line">2:      fcvtzs  x0, d0</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>
<ul>
<li><p>frintp（<strong>R</strong>ound toward +∞）</p>
</li>
<li><p>frintm（<strong>R</strong>ound toward -∞）</p>
</li>
<li><p>frintz（<strong>R</strong>ound toward 0）</p>
</li>
<li><p>frinta（<strong>R</strong>ound to nearest, tie away from 0）</p>
</li>
<li><p>frintn（<strong>R</strong>ound to nearest, tie to even）</p>
</li>
</ul>
<h3 id="rounding-conversion"><a href="#rounding-conversion" class="headerlink" title="rounding conversion"></a>rounding conversion</h3><p>rounding(四舍五入)<br>An instruction which does what we normally think of as rounding is frinta. This is the conversion “to nearest with ties going away.” So, 5.5 goes to 6 as one would expect from “rounding.”</p>
<h3 id="converting-an-integer-to-a-float-point-value"><a href="#converting-an-integer-to-a-float-point-value" class="headerlink" title="converting an integer to a float point value"></a>converting an integer to a float point value</h3><p>In C / C++:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">double_var = <span class="built_in">double</span>(integer_var); <span class="comment">// C++</span></span><br><span class="line">double_var = (<span class="type">double</span>)integer_var; <span class="comment">// C</span></span><br></pre></td></tr></table></figure><br>Is handled by two instructions:</p>
<ul>
<li><strong>scvtf</strong> converts a signed integer to a floating point value</li>
<li><strong>ucvtf</strong> converts an unsigned integer to a floating point value<br>The name of the destination register controls which kind of floating point value is made. For example, specifying dX makes a double etc.</li>
</ul>
<p>The name of the destination register controls which kind of floating point value is made. For example, specifying dX makes a double etc.</p>
<h3 id="floating-point-literals"><a href="#floating-point-literals" class="headerlink" title="floating point literals"></a>floating point literals</h3><p>Recall that all AARCH64 instructions are 4 bytes long. Recall also that this means that there are constraints on what can be specified as a literal since the literal must be encoded into the 4 byte instruction. If the literal is too large, an assembler error will result.</p>
<p>Given that floating point values are always at least 4 bytes long themselves, using floating point literals is extremely constrained. For example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fmov    d0, 1     // 1</span><br><span class="line">fmov    d0, 1.1   // 2</span><br></pre></td></tr></table></figure>
<p>Line 1 will pass muster but Line 2 will cause an error.</p>
<p>To load a float, you could translate the value to binary and do as the following:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">        .text                                                   </span><br><span class="line">        .global main                                            </span><br><span class="line">        .align    2                                             </span><br><span class="line">                                                                </span><br><span class="line">main:   str        x30, [sp, -16]!                              </span><br><span class="line">        ldr        s0, =0x3fc00000                              </span><br><span class="line">        fcvt       d0, s0                                       </span><br><span class="line">        ldr        x0, =fmt                                     </span><br><span class="line">        bl         printf                                       </span><br><span class="line">        ldr        x30, [sp], 16                                </span><br><span class="line">        mov        w0, wzr                                      </span><br><span class="line">        ret                                                     </span><br><span class="line">                                                                </span><br><span class="line">        .data                                                   </span><br><span class="line">fmt:    .asciz    &quot;%f\n&quot;                                        </span><br><span class="line">        .end                                                    </span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>printf() only knows how to print double precision values. When you specify a float, it will convert it to a double before emitting it.</p>
</blockquote>
<p>Translating floats and doubles by hand isn’t a common practice for humans, though compilers are happy to do so.</p>
<p>Instead for us humans, the assembler directives .float and .double are used more frequently to specify float and double values putting them into RAM.<br>a example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">        .global main                                            </span><br><span class="line">        .text                                                   </span><br><span class="line">        .align  2                                               </span><br><span class="line">                                                                </span><br><span class="line">counter .req    x20                                             </span><br><span class="line">dptr    .req    x21                                             </span><br><span class="line">fptr    .req    x22                                             </span><br><span class="line">        .equ    max, 4                                              </span><br><span class="line">                                                                    </span><br><span class="line">main:   stp     counter, x30, [sp, -16]!                            </span><br><span class="line">        stp     dptr, fptr, [sp, -16]!                              </span><br><span class="line">        ldr     dptr, =d                                            </span><br><span class="line">        ldr     fptr, =f                                            </span><br><span class="line">        mov     counter, xzr                                        </span><br><span class="line">                                                                    </span><br><span class="line">1:      cmp     counter, max                                        </span><br><span class="line">        beq     2f                                                  </span><br><span class="line">                                                                    </span><br><span class="line">        ldr     d0, [dptr, counter, lsl 3]                          </span><br><span class="line">        ldr     s1, [fptr, counter, lsl 2]                          </span><br><span class="line">        fcvt    d1, s1                                              </span><br><span class="line">        ldr     x0, =fmt                                            </span><br><span class="line">        add     counter, counter, 1                                 </span><br><span class="line">        mov     x1, counter                                         </span><br><span class="line">        bl      printf                                              </span><br><span class="line">        b       1b                                                  </span><br><span class="line">                                                                    </span><br><span class="line">2:      ldp     dptr, fptr, [sp], 16                                </span><br><span class="line">        ldp     counter, x30, [sp], 16                              </span><br><span class="line">        mov     w0, wzr                                             </span><br><span class="line">        ret                                                         </span><br><span class="line">                                                                    </span><br><span class="line">        .data                                                       </span><br><span class="line">fmt:    .asciz  &quot;%d %f %f\n&quot;                                       </span><br><span class="line">d:      .double 1.111111, 2.222222, 3.333333, 4.444444              </span><br><span class="line">f:      .float  1.111111, 2.222222, 3.333333, 4.444444             </span><br><span class="line">                                                                    </span><br><span class="line">        .end                                                        </span><br></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th>指令</th>
<th>全称/缩写</th>
<th>作用</th>
<th>常见用法示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.req</code></td>
<td><strong>register require</strong>（非官方缩写）</td>
<td>给<strong>寄存器起别名</strong></td>
<td><code>foo .req x0</code> 表示以后写 <code>foo</code> 就等于 <code>x0</code></td>
</tr>
<tr>
<td><code>.equ</code></td>
<td><strong>equate</strong></td>
<td>定义一个<strong>常量符号</strong></td>
<td><code>BUF_SIZE .equ 64</code> 表示 <code>BUF_SIZE = 64</code></td>
</tr>
</tbody>
</table>
</div>
<p>On Linux, just as w/x0 through w/x7 are scratch registers and used to pass parameters, s/d0 and s/d7 are as well beginning with the 0 register.</p>
<p>即：</p>
<p>📥 整数参数传递：<br>x0 ~ x7（或 32 位的 w0 ~ w7）用于传递前 8 个整数类参数（int、pointer、long 等）。</p>
<p>超过 8 个就通过栈传递。</p>
<p>📥 浮点参数传递：<br>d0 ~ d7（64 位 double 类型）或 s0 ~ s7（32 位 float 类型）用于传递前 8 个浮点参数。</p>
<p>超过 8 个浮点参数也是通过栈传递。</p>
<h4 id="Fitting-32-bits-into-a-32-bit-bag"><a href="#Fitting-32-bits-into-a-32-bit-bag" class="headerlink" title="Fitting 32 bits into a 32 bit bag"></a>Fitting 32 bits into a 32 bit bag</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldr s0, =0x3fc00000  // 伪指令！我们以为它直接把 0x3fc00000 加载进 s0</span><br></pre></td></tr></table></figure>
<p>编译器不能直接把任意 32 位值硬编码进指令中（因为一条 ARM 指令本身就只有 32 位）。</p>
<p>所以它实际上是：</p>
<ol>
<li>将字面量值 0x3fc00000 写到内存的某个地方（通常靠近当前函数底部）。</li>
<li>生成一条 ldr 指令，用 PC-relative load 的方式从这个地址加载该值。<br>这块被称为一个 literal pool，它是一些常量的集合。</li>
</ol>
<p>We expected line 6 to read:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldr        s0, =0x3fc00000</span><br></pre></td></tr></table></figure><br>Instead we find:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b+ 0x784 &lt;main+4&gt;          ldr     s0, 0x7a0 &lt;main+32&gt;</span><br></pre></td></tr></table></figure><br>Scan downward to find 0x7a0:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x7a0 &lt;main+32&gt;         .inst   0x3fc00000 ; undefined  </span><br></pre></td></tr></table></figure></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>伪指令</th>
<th>实际效果</th>
<th>GDB中看到的实际汇编</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ldr s0, =0x3fc00000</code></td>
<td>把常量加载进 <code>s0</code> 寄存器</td>
<td><code>ldr s0, #literal_addr</code><br><code>literal_addr: .inst 0x3fc00000</code></td>
</tr>
<tr>
<td><code>ldr x0, =fmt</code></td>
<td>加载字符串指针地址</td>
<td><code>ldr x0, #literal_addr</code><br><code>literal_addr: .inst 地址值</code></td>
</tr>
<tr>
<td><code>.inst 0x3fc00000</code></td>
<td>手动插入一个 32 位数据（不一定是有效指令）</td>
<td>存放常量（不是执行）</td>
</tr>
</tbody>
</table>
</div>
<p>.inst 的含义<br>全称：.inst = insert instruction<br>用途：直接插入一条 ARM 指令的机器码（通常是 32 位十六进制值）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.inst 0xd65f03c0   // 实际是 ret 指令</span><br></pre></td></tr></table></figure>
<p>这个例子中，.inst 后的机器码 0xd65f03c0 是 ret 指令的 32 位编码。也就是说：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>等价于：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.inst 0xd65f03c0</span><br></pre></td></tr></table></figure><br>在上面的例子中，可以用.inst定义一个地址，从该地址中加载</p>
<p>为什么不用 mov reg, #imm ？</p>
<ul>
<li>mov 有立即数编码限制，不能加载任意 32 位值。</li>
<li>超过范围时，必须用 ldr 从内存加载。<h3 id="fmov"><a href="#fmov" class="headerlink" title="fmov"></a>fmov</h3><blockquote>
<p>The fmov instruction is used to move floating point values in and out of floating point registers and to some degree, moving data between integer and floating point registers.</p>
</blockquote>
</li>
</ul>
<p><strong>loading floating point numbers as immediate values</strong></p>
<p>Just as we saw with integer registers, some values can be used as immediate values and some cannot. It comes down to how many bits are necessary to encode the value. Too many bits… not enough room to fit in a 4 byte instruction plus the opcode.</p>
<p>For example, this works:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov    x0, 65535</span><br></pre></td></tr></table></figure><br>but this does not:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov    x0, 65537</span><br></pre></td></tr></table></figure></p>
<p>The constraints placed on immediate values for fmov are much tighter because floating point numbers are far more complex than integers.</p>
<p>fmov d0, #imm 能否工作，取决于该浮点数是否能在8位编码空间内被精确表示：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>结构</th>
<th>位数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>符号位</td>
<td>1 bit</td>
<td>表示正或负</td>
</tr>
<tr>
<td>指数部分</td>
<td>3 bits</td>
<td>控制大小（乘以 2 的幂）</td>
</tr>
<tr>
<td>尾数部分</td>
<td>4 bits</td>
<td>仅能由 1/2、1/4、1/8、1/16 组合构成</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fmov d0, 1.0        // ✅ OK：整数 1 是 2⁰，指数可编码</span><br><span class="line">fmov d0, 1.5        // ✅ OK：1 + 0.5 = 2⁰ + 2⁻¹，指数/尾数都能编码</span><br><span class="line">fmov d0, 1.75       // ✅ OK：1 + 0.5 + 0.25 = 2⁰ + 2⁻¹ + 2⁻²</span><br><span class="line">fmov d0, 1.875      // ✅ OK：+ 2⁻³</span><br><span class="line">fmov d0, 1.9375     // ✅ OK：+ 2⁻⁴</span><br><span class="line">fmov d0, 1.96875    // ❌ 不行：需要 2⁻⁵，尾数超出 4 位</span><br></pre></td></tr></table></figure>
<p>大浮点不能用 fmov，改用 ldr。</p>
<p>fmov 是“位复制器”，不是“精度转换器”。你要改数值精度，就必须用 fcvt 系列。</p>
<h3 id="half-precision"><a href="#half-precision" class="headerlink" title="half precision"></a>half precision</h3><blockquote>
<p>Support for half precision (16 bit) floating point values does exist but there is no complete agreement on how different compilers support them. Indeed, there are not one but two competing half precision formats out there. These are the IEEE and GOOGLE types. Further still, many open source developers have created their own implementations with potentially clashing naming conventions.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__fp16 <span class="title function_">Foo</span><span class="params">(__fp16 g, __fp16 f)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> g + f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>compiles to:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fcvt    s1, h1</span><br><span class="line">fcvt    s0, h0</span><br><span class="line">fadd    s0, s0, s1</span><br><span class="line">fcvt    h0, s0</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>Notice each half precision value is converted to single precision. So, from C and C++ working with half precision values can be inefficient.</p>
<p>On the other hand, if you are willing to use intrinsics and one of the SIMD instruction sets offered by ARM, then knock yourself out. Be aware that doing so ties your code to the ARM processor in ways which you might regret later.</p>
<h3 id="bit-manipulation-1"><a href="#bit-manipulation-1" class="headerlink" title="bit manipulation"></a>bit manipulation</h3><p>Bit fields are a feature of the C and C++ language which completely hide what is often called “bit bashing”.</p>
<blockquote>
<p>the ordering of bits in a bit field is not guaranteed to be the same on different platforms and even between different compilers on the same platform.</p>
</blockquote>
<p>位域是一种用来在结构体内 精确控制成员所占二进制位数 的语法，通常用于硬件寄存器、协议头等空间敏感的场景。<br>语法格式<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> 结构体名 &#123;</span></span><br><span class="line">    类型 成员名 : 位宽;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>example:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BF</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> a : <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> b : <span class="number">2</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> c : <span class="number">5</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>a 用 1 位，能表示 0 或 1</li>
<li>b 用 2 位，能表示 0 ~ 3</li>
<li>c 用 5 位，能表示 0 ~ 31<br>三个成员总共占 1 + 2 + 5 = 8 位，即 1 字节</li>
</ul>
<ol>
<li>虽然每个成员是个位宽，但整体大小通常向整型对齐（这里是 1 字节，因为 8 位正好一字节）。</li>
<li>不同编译器对位域对齐和填充细节可能略有差异。</li>
<li>访问时可以像普通成员一样：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BF</span> <span class="title">bf</span>;</span></span><br><span class="line">bf.a = <span class="number">1</span>;</span><br><span class="line">bf.b = <span class="number">3</span>;</span><br><span class="line">bf.c = <span class="number">31</span>;</span><br></pre></td></tr></table></figure>
<p>编译器会自动对位域进行掩码和移位处理。</p>
<p>Consider a data structure for which there will be potentially millions of instances in RAM. Or, perhaps billions of instances on disc. Suppose you need 8 boolean members in every instance. The C++ standard does not define the size of a bool instead leaving it to be implementation dependent. Some implementations equate bool to int, four bytes in length. Some implement bool with a char, or 1 byte in length.</p>
<p>Let’s assume the smallest case and equate a bool with char. Our struct, for which there may be millions or billions of instances requires 8 bool so therefore 8 bytes. Times millions or billions.</p>
<p>Bit fields can come to your aid here by using a single bit per boolean value. In the best case, 8 bytes collapse to 1 byte. In a worse case, 8 x 4 = 32 bytes collapsed into 1.</p>
<p>假设使用最小单位，即每个 bool 是 1 字节：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S</span> &#123;</span></span><br><span class="line">    <span class="type">bool</span> b0;</span><br><span class="line">    <span class="type">bool</span> b1;</span><br><span class="line">    <span class="type">bool</span> b2;</span><br><span class="line">    <span class="type">bool</span> b3;</span><br><span class="line">    <span class="type">bool</span> b4;</span><br><span class="line">    <span class="type">bool</span> b5;</span><br><span class="line">    <span class="type">bool</span> b6;</span><br><span class="line">    <span class="type">bool</span> b7;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个结构体大小为 8 字节（1 字节 × 8 个 bool）。<br>如果有百万个实例，占用的内存就是 8MB，如果有十亿个实例，则是 8GB。<br>对于 4 字节的 bool 实现，则大小直接变成 32 字节，每亿实例就是 3.2GB。</p>
<p>解决方案：使用位域压缩布尔值<br>用位域，将 8 个布尔值定义为 1 位大小：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> b0 : <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> b1 : <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> b2 : <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> b3 : <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> b4 : <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> b5 : <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> b6 : <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> b7 : <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>8 个 1-bit 成员 合起来正好占 1 字节。</p>
<p>这样 8 字节压缩成 1 字节，节省了大量空间。</p>
<p>In Computer Science there is an eternal tension between space and time. The following is a law:</p>
<p>If you want something to go faster, it will cost more memory.</p>
<p>If you want to save memory, what you’re doing will take more time.</p>
<p>This law shows up here… recall the example of where we wanted to save memory by collapsing 8 bool into 1 byte? To save that memory we will slow down because accessing the right bits takes a couple of instructions where overwriting a bool implemented as an int takes just one instruction.</p>
<p>As for the assembly language that bit field will produce, it depends upon optimization level. Unoptimized, the code produced will be much longer and cumbersome than the “sophisticated” assembly language.</p>
<h3 id="endian"><a href="#endian" class="headerlink" title="endian"></a>endian</h3><p>the ARM swing both ways: the litte-endian and the big-endian. But:</p>
<p>The standard toolchain emits little endian code. It is a big task to install the big-endian version of the toolchain.</p>
<p>Here is a quote from Wikipedia:<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ARM, C-Sky, <span class="keyword">and </span>RISC-V have no relevant <span class="keyword">big-endian </span>deployments, <span class="keyword">and </span>can <span class="keyword">be </span>considered little-endian in practice.</span><br></pre></td></tr></table></figure><br>The common Intel processors are also little-endian.</p>
<h2 id="assembly-macros"><a href="#assembly-macros" class="headerlink" title="assembly macros"></a>assembly macros</h2><p>An early innovation in assemblers was the introduction of a macro capability. Given what could be considered a certain amount of tedium in coding in asm, macros provide a simple form of meta programming where a series of statements can be encapsulated by a single macro. Think of a macro as an early form of C++ templated function (kinda but not really).</p>
<p>Here’s an example of an assembly language macro:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.macro LLD_ADDR xreg, label </span><br><span class="line">        adrp    \xreg, \label@PAGE</span><br><span class="line">        add     \xreg, \xreg, \label@PAGEOFF</span><br><span class="line">.endm</span><br><span class="line">```asm</span><br><span class="line">Here&#x27;s how it might be used:</span><br><span class="line">```asm</span><br><span class="line">        LLD_ADDR x0, fmt</span><br></pre></td></tr></table></figure><br>This gets expanded to:<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adrp    <span class="keyword">x</span><span class="number">0</span><span class="punctuation">,</span> fmt<span class="title">@PAGE</span></span><br><span class="line"><span class="keyword">add</span>     <span class="keyword">x</span><span class="number">0</span><span class="punctuation">,</span> <span class="keyword">x</span><span class="number">0</span><span class="punctuation">,</span> fmt<span class="title">@PAGEOFF</span></span><br></pre></td></tr></table></figure></p>
<p>gcc on Linux does not run assembly language files through the C pre-processor if the asm file ends in .s but WILL if the file ends in .S</p>
<h3 id="Genaral-Use"><a href="#Genaral-Use" class="headerlink" title="Genaral Use"></a>Genaral Use</h3><h4 id="AASCIZ"><a href="#AASCIZ" class="headerlink" title="AASCIZ"></a>AASCIZ</h4><p>AASCIZ    label, string</p>
<p>This macro invokes .asciz with the string set to string and the label set to label. In addition, this macro ensures that the string begins on a 4-byte-aligned boundary.</p>
<h4 id="PUSH-P-PUSH-R-POP-P-and-POP-R"><a href="#PUSH-P-PUSH-R-POP-P-and-POP-R" class="headerlink" title="PUSH_P, PUSH_R, POP_P and POP_R"></a>PUSH_P, PUSH_R, POP_P and POP_R</h4><p>These macros save some repetitive typing. For example:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUSH_P  x29, x30</span><br></pre></td></tr></table></figure><br>resolves to:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stp     x29, x30, [sp, -16]!</span><br></pre></td></tr></table></figure></p>
<h4 id="START-PROC-and-END-PROC"><a href="#START-PROC-and-END-PROC" class="headerlink" title="START_PROC and END_PROC"></a>START_PROC and END_PROC</h4><p>Place START_PROC after the label introducing a function.</p>
<p>Place END_PROC after the last ret of the function.</p>
<p>These resolve to: .cfi_startproc and .cfi_endproc respectively.</p>
<h4 id="MIN-and-MAX"><a href="#MIN-and-MAX" class="headerlink" title="MIN and MAX"></a>MIN and MAX</h4><p>Handy more readable macros for determining minima and maxima. Note that the macro performs a cmp which subtracts src_b from src_a (discarding the results) in order to set the flags to be interpreted by the following csel.</p>
<p>Signature:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MIN     src_a, src_b, dest</span><br></pre></td></tr></table></figure><br>The smaller of src_a and src_b is put into dest.</p>
<p>Signature:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MAX     src_a, src_b, dest</span><br></pre></td></tr></table></figure><br>The larger of src_a and src_b is put into dest.</p>
<h4 id="MOD"><a href="#MOD" class="headerlink" title="MOD"></a>MOD</h4><p>MOD macro used above is defined as:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.macro  MOD         src_a, src_b, dest, scratch</span><br><span class="line">        sdiv        \scratch, \src_a, \src_b</span><br><span class="line">        msub        \dest, \scratch, \src_b, \src_a</span><br><span class="line">.endm</span><br></pre></td></tr></table></figure></p>
<h4 id="GLABEL"><a href="#GLABEL" class="headerlink" title="GLABEL"></a>GLABEL</h4><p>Mark a label as global, Makes a label available externally.</p>
<p>Signature:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GLABEL label</span><br></pre></td></tr></table></figure><br>An underscore is prepended.</p>
<h4 id="CRT"><a href="#CRT" class="headerlink" title="CRT"></a>CRT</h4><p>Calling CRT(C runtime) functions<br>If you create your own function without an underscore, just call it as usual.<br>If you need to call a function such as those found in the C runtime library, use this macro in this way:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CRT     strlen</span><br></pre></td></tr></table></figure>
<h4 id="MAIN"><a href="#MAIN" class="headerlink" title="MAIN"></a>MAIN</h4><p>Declaring main()<br>Put MAIN on a line by itself. Notice there is no colon.</p>
<h4 id="errno"><a href="#errno" class="headerlink" title="errno"></a>errno</h4><p>The externally defined errno is accessed via a CRT function which isn’t seen when coding in C and C++. The function is named differently on Mac versus Linux. To get the address of errno use:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERRNO_ADDR</span><br></pre></td></tr></table></figure><br>This macro makes the correct CRT call and leaves the address of errno in x0.</p>
<h3 id="Loads-and-Stores"><a href="#Loads-and-Stores" class="headerlink" title="Loads and Stores"></a>Loads and Stores</h3><h4 id="GLD-PTR"><a href="#GLD-PTR" class="headerlink" title="GLD_PTR"></a>GLD_PTR</h4><p>Loads the address of a label and then dereferences it where, on Apple the label is in the global space and on Linux is a relatively close label.</p>
<p>Signature:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GLD_PTR     xreg, label</span><br></pre></td></tr></table></figure><br>When this macro finishes, the specified x register contains what 64 bit value lives at the specified label.</p>
<h4 id="GLD-ADDR"><a href="#GLD-ADDR" class="headerlink" title="GLD_ADDR"></a>GLD_ADDR</h4><p>Loads the address of the label into the specified x register. No dereferencing takes place. On Apple machines, the label will be found in the global space.</p>
<p>Signature:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GLD_ADDR    xreg, label</span><br></pre></td></tr></table></figure><br>When this macro completes, the address of the label is in the x register.</p>
<h4 id="LLD-ADDR"><a href="#LLD-ADDR" class="headerlink" title="LLD_ADDR"></a>LLD_ADDR</h4><p>Similar to GLD_ADDR this macro loads the address of a “local” label.</p>
<p>Signature:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LLD_ADDR xreg, label</span><br></pre></td></tr></table></figure><br>When this macro completes, the address of the label is in the x register.</p>
<h4 id="LLD-DBL"><a href="#LLD-DBL" class="headerlink" title="LLD_DBL"></a>LLD_DBL</h4><p>Signature:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LLD_DBL xreg, dreg, label</span><br></pre></td></tr></table></figure><br>When this macro completes, a double that lives at the specified local label will sit in the specified double register.</p>
<h4 id="LLD-FLT"><a href="#LLD-FLT" class="headerlink" title="LLD_FLT"></a>LLD_FLT</h4><p>Signature:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LLD_FLT xreg, sreg, label</span><br></pre></td></tr></table></figure><br>When this macro completes, a float that lives at the specified local label will sit in the specified single precision register.</p>
<h2 id="performance"><a href="#performance" class="headerlink" title="performance"></a>performance</h2><h3 id="Undoing-Stack-Pointer-Changes"><a href="#Undoing-Stack-Pointer-Changes" class="headerlink" title="Undoing Stack Pointer Changes"></a>Undoing Stack Pointer Changes</h3><p>A small tip concerning undoing changes to the stack pointer. You might think that changes to the stack made by str or stp and their cousins must be undone with ldr or ldp and their cousins.</p>
<p>This depends.</p>
<p>If you need to get back the original contents of a register pushed onto the stack, then an ldr or ldp is appropriate. However, if you don’t need to get the original contents of a register back, then it is faster to undo a change to the stack using addition.</p>
<p>Take for example the use of printf(). On Apple Silicon systems, you must send arguments to printf() by pushing them onto the stack. However, when printf() completes, you have no need for the values that you pushed. As shown above, simply add the right (multiple of 16) to the stack pointer. This is faster as the addition makes no reference to RAM (or caches) as the ldr would.</p>
<h3 id="other-stuff"><a href="#other-stuff" class="headerlink" title="other stuff"></a>other stuff</h3><h4 id="let-the-assembler-itself-calculate-the-length-for-you"><a href="#let-the-assembler-itself-calculate-the-length-for-you" class="headerlink" title="let the assembler itself calculate the length for you"></a>let the assembler itself calculate the length for you</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">        .global        main                                             </span><br><span class="line">        .align         2                                                </span><br><span class="line">        .text                                                           </span><br><span class="line">                                                                        </span><br><span class="line">main:   str            x30, [sp, -16]!                                  </span><br><span class="line">        mov            w0, 1             // stdout                      </span><br><span class="line">        ldr            x1, =s            // pointer to string           </span><br><span class="line">        ldr            x2, =ssize        // pointer to computed length  </span><br><span class="line">        ldr            w2, [x2]          // actual length of string     </span><br><span class="line">        bl             write                                            </span><br><span class="line">                                                                        </span><br><span class="line">        ldr            x0, =fmt                                         </span><br><span class="line">        ldr            x1, =s                                           </span><br><span class="line">        ldr            x2, =ssize                                       </span><br><span class="line">        ldr            w2, [x2]                                         </span><br><span class="line">        bl             printf                                           </span><br><span class="line">                                                                        </span><br><span class="line">        ldr            x30, [sp], 16                                    </span><br><span class="line">        mov            w0, wzr                                          </span><br><span class="line">        ret                                                             </span><br><span class="line">                                                                        </span><br><span class="line">        .data                                                           </span><br><span class="line">                                                                        </span><br><span class="line">s:      .asciz         &quot;Hello, World!\n&quot;                                </span><br><span class="line">ssize:  .word          ssize - s - 1        // accounts for null at end </span><br><span class="line">fmt:    .asciz         &quot;str: %slen: %d\n&quot;   // accounts for newline     </span><br><span class="line">                                                                        </span><br><span class="line">        .end                                                            </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="atomic-operations"><a href="#atomic-operations" class="headerlink" title="atomic operations"></a>atomic operations</h2><h3 id="Load-Linked-Store-Condition"><a href="#Load-Linked-Store-Condition" class="headerlink" title="Load Linked, Store Condition"></a>Load Linked, Store Condition</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">        .text                                                 </span><br><span class="line">        .p2align    2                                         </span><br><span class="line">                                                              </span><br><span class="line">#if defined(__APPLE__)                                        </span><br><span class="line">        .global     _LoadLinkedStoreConditional               </span><br><span class="line">_LoadLinkedStoreConditional:                                  </span><br><span class="line">#else                                                         </span><br><span class="line">        .global     LoadLinkedStoreConditional                </span><br><span class="line">LoadLinkedStoreConditional:                                   </span><br><span class="line">#endif                                                        </span><br><span class="line">1:      ldaxr       w1, [x0]                                  </span><br><span class="line">        add         w1, w1, 1                                 </span><br><span class="line">        stlxr       w2, w1, [x0]                              </span><br><span class="line">        cbnz        w2, 1b                                    </span><br><span class="line">        ret                                                   </span><br></pre></td></tr></table></figure>
<p>LL/SC 是一种乐观并发控制机制。它大致逻辑是：</p>
<ul>
<li><p>Load-Linked（LDAXR）：加载一个地址的值，并“观察”该地址是否被改动。<br>你可以修改这个值（如加1）。</p>
</li>
<li><p>Store-Conditional（STLXR）：尝试写回这个新值，如果在这之间地址内容没有被别人改过，则写入成功；否则失败。<br>成功与否会通过 STLXR 的返回值告诉你（0 表示成功，非 0 表示失败）。</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/even629/myPicGo/main/llsc.png" alt="llsc"></p>
<p>Implementations of operations on atomic variables were improved in the second version of ARMv8, called ARMv8.1. The load linked and store conditional instructions are still available but several new instructions were added which perform certain operations such as addition, subtraction and various bitwise operations in a single atomic instruction.</p>
<p>For example:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    mov       w1, 1</span><br><span class="line">    ldaddal   w1, w0, [x0]</span><br><span class="line">``</span><br><span class="line">does the same work of atomically adding one to the value in memory pointed to by x0.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##### spin-lock</span><br><span class="line"></span><br><span class="line">Here is the source code to the spin-lock for ARM V8.</span><br><span class="line"></span><br><span class="line">Lock</span><br><span class="line"></span><br><span class="line">```asm</span><br><span class="line">Lock:                                                              </span><br><span class="line">        START_PROC                                                 </span><br><span class="line">        mov         w3, 1           // 准备存储的值：1 表示“加锁”  </span><br><span class="line">1:      ldaxr       w1, [x0]        // 原子加载并标记 exclusive 访问                      </span><br><span class="line">        cbnz        w1, 1b          // 如果锁不为 0（被别人持有），继续自旋           </span><br><span class="line">        stlxr       w2, w3, [x0]    // 尝试原子写入，成功则 w2=0                  </span><br><span class="line">        cbnz        w2, 1b          // 如果失败（有竞争），继续自旋</span><br><span class="line">        ret                                                        </span><br><span class="line">        END_PROC                                                   </span><br></pre></td></tr></table></figure><br>stlxr: 如果 exclusive tag 还有效（没人抢走锁），那么将 w3 的值写入 *x0，并将结果放入 w2（0 表示成功）</p>
<ol>
<li>ldaxr dereferencing the lock itself (once again an int32_t) and marks the location of the lock as being hopefully, exclusive.</li>
<li>Having gotten the value of the lock, its value is inspected and if found to be non-zero, we branch back to attempting to get it again - this is the spin.</li>
<li>If the contents of the lock is 0, its value in w1 is changed to non-zero. Note, this could be made a bit better if a value of 1 was stored in another w register and simply used directly on line 10.</li>
<li><code>stlxr w2, w3, [x0]</code> conditionally stores the changed value back to the location of the lock. If the stlxr returns 0, we got the lock. If not, we start over - somebody else got in there ahead of us. Perhaps this happened because we were descheduled. Perhaps we lost the lock to another thread running on a different core.</li>
</ol>
<p>unlock<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Unlock:                                                           </span><br><span class="line">        START_PROC                                                </span><br><span class="line">        str         wzr, [x0]       // 写 0 表示释放锁                            </span><br><span class="line">        dmb         ish             // 内存屏障，跨核同步                    </span><br><span class="line">        ret                                              </span><br><span class="line">        END_PROC                       </span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>All it does is set to value of the lock to zero. The correct operation of the lock requires that no bad actor simply stomps on the lock by calling Unlock without first owning the lock. Just say no to lock stompers.</p>
</li>
<li><p><code>dmb ish</code> sets up a data memory barrier across each processor - it makes sure threads running on different cores see the update correctly. This code seemed to work without this line but intuition suggests it could be important. In Lock() the stlxr instruction has an implied data memory barrier.</p>
</li>
</ol>
<p>总结（伪代码角度）<br>🔒 Lock(x0):<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    w1 = *x0;      <span class="comment">// atomic exclusive load</span></span><br><span class="line">    <span class="keyword">if</span> (w1 != <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">    result = atomic_store_exclusive(x0, <span class="number">1</span>);  <span class="comment">// try to set lock</span></span><br><span class="line">&#125; <span class="keyword">while</span> (result != <span class="number">0</span>);  <span class="comment">// someone else beat us</span></span><br></pre></td></tr></table></figure><br>🔓 Unlock(x0):<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*x0 = <span class="number">0</span>;       <span class="comment">// unlock</span></span><br><span class="line">dmb(ISH);      <span class="comment">// ensure all cores see the update</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><div class="reference-source"><span class="hidden-anchor" id="referfrom_[1]"></span><a class="reference-anchor" href="#referto_[1]">[1]<div class="reference-anchor-up fa-solid fa-angles-up"></div></a><a class="reference-link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/pkivolowitz/asm_book">asm_book</a></div>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://even629.github.io/">even629</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://even629.com/posts/42868/">https://even629.com/posts/42868/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://even629.com" target="_blank">even629的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/asm/">asm</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/42869/" title="最小Linux系统编译与运行"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">最小Linux系统编译与运行</div></div><div class="info-2"><div class="info-item-1">编译aarch64的Linux内核和busybox根文件系统，并用qemu跑</div></div></div></a><a class="pagination-related" href="/posts/42857/" title="基础算法 入门篇"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">基础算法 入门篇</div></div><div class="info-2"><div class="info-item-1">刷题日记</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center" id="my-custom-card-author"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">even629</div><div class="author-info-description">live a meaningful life</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/even629"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/even629" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:zhaohang731005515@proton.me" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告：欢迎留言~</span></div><div class="announcement_content">--- ZH ❤️ YW ---</div><div class="xpand" style="height:200px;"><canvas class="illo" width="800" height="800" style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas></div></div><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople1.js"></script><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/zdog.dist.js"></script><script id="rendered-js" src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople.js"></script><style>.card-widget.card-announcement {
margin: 0;
align-items: center;
justify-content: center;
text-align: center;
}
canvas {
display: block;
margin: 0 auto;
cursor: move;
}</style><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#preknowledge"><span class="toc-number">1.</span> <span class="toc-text">preknowledge</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#register"><span class="toc-number">2.</span> <span class="toc-text">register</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#register-access-speed"><span class="toc-number">2.1.</span> <span class="toc-text">register access speed</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#register-type"><span class="toc-number">2.2.</span> <span class="toc-text">register type</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#register-and-C-type"><span class="toc-number">2.3.</span> <span class="toc-text">register and C type</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Integers"><span class="toc-number">2.3.1.</span> <span class="toc-text">Integers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pointers"><span class="toc-number">2.3.2.</span> <span class="toc-text">Pointers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Floating-Point"><span class="toc-number">2.3.3.</span> <span class="toc-text">Floating Point</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#instructions"><span class="toc-number">3.</span> <span class="toc-text">instructions</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#preknowledge-1"><span class="toc-number">3.1.</span> <span class="toc-text">preknowledge</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#memory-access"><span class="toc-number">3.2.</span> <span class="toc-text">memory access</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ldr"><span class="toc-number">3.2.1.</span> <span class="toc-text">ldr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#str"><span class="toc-number">3.2.2.</span> <span class="toc-text">str</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ldp"><span class="toc-number">3.2.3.</span> <span class="toc-text">ldp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stp"><span class="toc-number">3.2.4.</span> <span class="toc-text">stp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#three-patterns"><span class="toc-number">3.2.5.</span> <span class="toc-text">three patterns</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pseudo-instruction"><span class="toc-number">3.2.6.</span> <span class="toc-text">pseudo instruction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#literal-pool"><span class="toc-number">3.2.7.</span> <span class="toc-text">literal pool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#relocation-of-address-when-executing"><span class="toc-number">3.2.8.</span> <span class="toc-text">relocation of address when executing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#examples"><span class="toc-number">3.2.9.</span> <span class="toc-text">examples</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#loading-storing-various-sizes-of-integers"><span class="toc-number">3.2.9.1.</span> <span class="toc-text">loading (storing) various sizes of integers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#array-indexing"><span class="toc-number">3.2.9.2.</span> <span class="toc-text">array indexing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#faster-memory-copy"><span class="toc-number">3.2.9.3.</span> <span class="toc-text">faster memory copy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#indexing-through-an-array-of-struct"><span class="toc-number">3.2.9.4.</span> <span class="toc-text">indexing through an array of struct</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#control-flow"><span class="toc-number">3.3.</span> <span class="toc-text">control flow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cmp"><span class="toc-number">3.3.1.</span> <span class="toc-text">cmp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#br"><span class="toc-number">3.3.2.</span> <span class="toc-text">br</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ble"><span class="toc-number">3.3.3.</span> <span class="toc-text">ble</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bl"><span class="toc-number">3.3.4.</span> <span class="toc-text">bl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cbz"><span class="toc-number">3.3.5.</span> <span class="toc-text">cbz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#csel"><span class="toc-number">3.3.6.</span> <span class="toc-text">csel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#calculate"><span class="toc-number">3.3.7.</span> <span class="toc-text">calculate</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shift-Opertations"><span class="toc-number">3.4.</span> <span class="toc-text">shift Opertations</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lsl"><span class="toc-number">3.4.1.</span> <span class="toc-text">lsl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lsr"><span class="toc-number">3.4.2.</span> <span class="toc-text">lsr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#asr"><span class="toc-number">3.4.3.</span> <span class="toc-text">asr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ror"><span class="toc-number">3.4.4.</span> <span class="toc-text">ror</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bit-manipulation"><span class="toc-number">3.5.</span> <span class="toc-text">bit manipulation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mvn"><span class="toc-number">3.5.1.</span> <span class="toc-text">mvn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#orr"><span class="toc-number">3.5.2.</span> <span class="toc-text">orr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bfi"><span class="toc-number">3.5.3.</span> <span class="toc-text">bfi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ubfm"><span class="toc-number">3.5.4.</span> <span class="toc-text">ubfm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ubfiz"><span class="toc-number">3.5.5.</span> <span class="toc-text">ubfiz</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#other"><span class="toc-number">3.6.</span> <span class="toc-text">other</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#adr"><span class="toc-number">3.6.1.</span> <span class="toc-text">adr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#adrp"><span class="toc-number">3.6.2.</span> <span class="toc-text">adrp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#smaddl"><span class="toc-number">3.6.3.</span> <span class="toc-text">smaddl</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#programming"><span class="toc-number">4.</span> <span class="toc-text">programming</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#if-statement"><span class="toc-number">4.1.</span> <span class="toc-text">if statement</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#if"><span class="toc-number">4.1.1.</span> <span class="toc-text">if</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-rule-of-thumb"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">a rule of thumb</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#temporary-label"><span class="toc-number">4.1.1.2.</span> <span class="toc-text">temporary label</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#if-else"><span class="toc-number">4.1.2.</span> <span class="toc-text">if &#x2F; else</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-complete-example"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">a complete example</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#loop"><span class="toc-number">4.2.</span> <span class="toc-text">loop</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#while-loop"><span class="toc-number">4.2.1.</span> <span class="toc-text">while loop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#for-loop"><span class="toc-number">4.2.2.</span> <span class="toc-text">for loop</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#continue"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">continue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#break"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">break</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#structs"><span class="toc-number">4.3.</span> <span class="toc-text">structs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#alignment"><span class="toc-number">4.3.1.</span> <span class="toc-text">alignment</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#example"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#defining-structs"><span class="toc-number">4.3.2.</span> <span class="toc-text">defining structs</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#using-structs"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">using structs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#this-pointer-in-c"><span class="toc-number">4.3.2.2.</span> <span class="toc-text">this pointer in c++</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#const"><span class="toc-number">4.4.</span> <span class="toc-text">const</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#switch-and-jump-table"><span class="toc-number">4.5.</span> <span class="toc-text">switch and jump table</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#implement-falling-through"><span class="toc-number">4.5.1.</span> <span class="toc-text">implement falling through</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#implementing-gaps"><span class="toc-number">4.5.2.</span> <span class="toc-text">implementing gaps</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#other-strategies-for-implementing-switch"><span class="toc-number">4.5.3.</span> <span class="toc-text">other strategies for implementing switch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#strategies-for-implementing-if-else"><span class="toc-number">4.5.4.</span> <span class="toc-text">strategies for implementing if-else</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fucntions"><span class="toc-number">4.6.</span> <span class="toc-text">fucntions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bottom-line-concept"><span class="toc-number">4.6.1.</span> <span class="toc-text">bottom line concept</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-example"><span class="toc-number">4.6.1.1.</span> <span class="toc-text">a example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inline-functions"><span class="toc-number">4.6.2.</span> <span class="toc-text">inline functions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#passing-parameters-to-functions"><span class="toc-number">4.6.3.</span> <span class="toc-text">passing parameters to functions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-example-1"><span class="toc-number">4.6.3.1.</span> <span class="toc-text">a example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#const-1"><span class="toc-number">4.6.4.</span> <span class="toc-text">const</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#passing-pointers"><span class="toc-number">4.6.5.</span> <span class="toc-text">passing pointers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#passing-reference"><span class="toc-number">4.6.6.</span> <span class="toc-text">passing reference</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#more-than-eight-parameters"><span class="toc-number">4.6.7.</span> <span class="toc-text">more than eight parameters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#examples-of-calling-some-common-C-runtime-functions"><span class="toc-number">4.6.8.</span> <span class="toc-text">examples of calling some common C runtime functions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#system-calls"><span class="toc-number">4.6.9.</span> <span class="toc-text">system calls</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#What-IS-a-system-call"><span class="toc-number">4.6.9.1.</span> <span class="toc-text">What IS a system call?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mechanism-of-making-a-system-call"><span class="toc-number">4.6.9.2.</span> <span class="toc-text">Mechanism of making a system call</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#the-number-associated-with-a-particular-system-call"><span class="toc-number">4.6.9.3.</span> <span class="toc-text">the number associated with a particular system call</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example-getpid"><span class="toc-number">4.6.9.4.</span> <span class="toc-text">example getpid()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#floating-point"><span class="toc-number">4.7.</span> <span class="toc-text">floating point</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#what-are-floating-points-numbers"><span class="toc-number">4.7.1.</span> <span class="toc-text">what are floating points numbers?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#register-1"><span class="toc-number">4.7.2.</span> <span class="toc-text">register</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#truncation-towards-zero"><span class="toc-number">4.7.3.</span> <span class="toc-text">truncation towards zero</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#example-1"><span class="toc-number">4.7.3.1.</span> <span class="toc-text">example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Truncation-Away-From-Zero"><span class="toc-number">4.7.4.</span> <span class="toc-text">Truncation Away From Zero</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rounding-conversion"><span class="toc-number">4.7.5.</span> <span class="toc-text">rounding conversion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#converting-an-integer-to-a-float-point-value"><span class="toc-number">4.7.6.</span> <span class="toc-text">converting an integer to a float point value</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#floating-point-literals"><span class="toc-number">4.7.7.</span> <span class="toc-text">floating point literals</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Fitting-32-bits-into-a-32-bit-bag"><span class="toc-number">4.7.7.1.</span> <span class="toc-text">Fitting 32 bits into a 32 bit bag</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fmov"><span class="toc-number">4.7.8.</span> <span class="toc-text">fmov</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#half-precision"><span class="toc-number">4.7.9.</span> <span class="toc-text">half precision</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bit-manipulation-1"><span class="toc-number">4.7.10.</span> <span class="toc-text">bit manipulation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#endian"><span class="toc-number">4.7.11.</span> <span class="toc-text">endian</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#assembly-macros"><span class="toc-number">4.8.</span> <span class="toc-text">assembly macros</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Genaral-Use"><span class="toc-number">4.8.1.</span> <span class="toc-text">Genaral Use</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AASCIZ"><span class="toc-number">4.8.1.1.</span> <span class="toc-text">AASCIZ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PUSH-P-PUSH-R-POP-P-and-POP-R"><span class="toc-number">4.8.1.2.</span> <span class="toc-text">PUSH_P, PUSH_R, POP_P and POP_R</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#START-PROC-and-END-PROC"><span class="toc-number">4.8.1.3.</span> <span class="toc-text">START_PROC and END_PROC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MIN-and-MAX"><span class="toc-number">4.8.1.4.</span> <span class="toc-text">MIN and MAX</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MOD"><span class="toc-number">4.8.1.5.</span> <span class="toc-text">MOD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GLABEL"><span class="toc-number">4.8.1.6.</span> <span class="toc-text">GLABEL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CRT"><span class="toc-number">4.8.1.7.</span> <span class="toc-text">CRT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MAIN"><span class="toc-number">4.8.1.8.</span> <span class="toc-text">MAIN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#errno"><span class="toc-number">4.8.1.9.</span> <span class="toc-text">errno</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Loads-and-Stores"><span class="toc-number">4.8.2.</span> <span class="toc-text">Loads and Stores</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GLD-PTR"><span class="toc-number">4.8.2.1.</span> <span class="toc-text">GLD_PTR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GLD-ADDR"><span class="toc-number">4.8.2.2.</span> <span class="toc-text">GLD_ADDR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LLD-ADDR"><span class="toc-number">4.8.2.3.</span> <span class="toc-text">LLD_ADDR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LLD-DBL"><span class="toc-number">4.8.2.4.</span> <span class="toc-text">LLD_DBL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LLD-FLT"><span class="toc-number">4.8.2.5.</span> <span class="toc-text">LLD_FLT</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#performance"><span class="toc-number">4.9.</span> <span class="toc-text">performance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Undoing-Stack-Pointer-Changes"><span class="toc-number">4.9.1.</span> <span class="toc-text">Undoing Stack Pointer Changes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#other-stuff"><span class="toc-number">4.9.2.</span> <span class="toc-text">other stuff</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#let-the-assembler-itself-calculate-the-length-for-you"><span class="toc-number">4.9.2.1.</span> <span class="toc-text">let the assembler itself calculate the length for you</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#atomic-operations"><span class="toc-number">4.10.</span> <span class="toc-text">atomic operations</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Load-Linked-Store-Condition"><span class="toc-number">4.10.1.</span> <span class="toc-text">Load Linked, Store Condition</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">5.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42871/" title="rust language">rust language</a><time datetime="2025-09-11T14:55:13.000Z" title="发表于 2025-09-11 22:55:13">2025-09-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42882/" title="C">C</a><time datetime="2025-07-19T12:12:13.000Z" title="发表于 2025-07-19 20:12:13">2025-07-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42881/" title="CSAPP BombLab AArch64">CSAPP BombLab AArch64</a><time datetime="2025-06-24T12:12:13.000Z" title="发表于 2025-06-24 20:12:13">2025-06-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42870/" title="GDB">GDB</a><time datetime="2025-06-24T12:12:13.000Z" title="发表于 2025-06-24 20:12:13">2025-06-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42869/" title="最小Linux系统编译与运行">最小Linux系统编译与运行</a><time datetime="2025-06-22T16:25:13.000Z" title="发表于 2025-06-23 00:25:13">2025-06-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42868/" title="AArch64 ASM">AArch64 ASM</a><time datetime="2025-06-22T02:25:13.000Z" title="发表于 2025-06-22 10:25:13">2025-06-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42857/" title="基础算法 入门篇">基础算法 入门篇</a><time datetime="2025-06-21T08:45:13.000Z" title="发表于 2025-06-21 16:45:13">2025-06-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42860/" title="SR-IOV原理与实现">SR-IOV原理与实现</a><time datetime="2025-05-22T13:12:13.000Z" title="发表于 2025-05-22 21:12:13">2025-05-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42858/" title="RustDesk远程桌面自建服务器">RustDesk远程桌面自建服务器</a><time datetime="2025-03-14T13:12:13.000Z" title="发表于 2025-03-14 21:12:13">2025-03-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42856/" title="CSAPP Data Lab">CSAPP Data Lab</a><time datetime="2025-03-07T12:12:13.000Z" title="发表于 2025-03-07 20:12:13">2025-03-07</time></div></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient(135deg, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 0) 70%);;"><div id="footer-wrap"><div class="footer-button"><a title="GitHub" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/even629"><i class="fab fa-regular fa-github"></i></a><a title="Mail" href="mailto:zhaohang731005515@proton.me" rel="external nofollow noreferrer"><i class="fas fa-regular fa-envelope"></i></a></div><div class="copyright">&copy;2014 - 2025 By even629</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my blog!</div><p><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" title="博客框架为 Hexo"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://butterfly.js.org/" rel="external nofollow noreferrer"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" title="主题采用 butterfly"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://github.com/" rel="external nofollow noreferrer"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" title="本站项目由 Github 托管"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议进行许可"/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="中英转换">中</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();" rel="external nofollow noreferrer"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();" rel="external nofollow noreferrer"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();" rel="external nofollow noreferrer"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span data-zh="复制" data-en="Copy"> </span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.google.com/search?q=&quot;+window.getSelection().toString());window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-search"></i><span data-zh="谷歌搜索" data-en="Google Search"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-link"></i><span data-zh="转到链接" data-en="Go to Link"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span data-zh="粘贴" data-en="Paste"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span data-zh="空降评论" data-en="Jump to Comment"></span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();" rel="external nofollow noreferrer"><i class="fa fa-book"></i><span data-zh="阅读模式" data-en="Reading Mode"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()" rel="external nofollow noreferrer"><i class="fa fa-window-restore"></i><span data-zh="新窗口打开" data-en="Open in New Window"></span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()" rel="external nofollow noreferrer"><i class="fa fa-link"></i><span data-zh="转到链接" data-en="Go to Link"></span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span data-zh="复制链接" data-en="Copy Link"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()" rel="external nofollow noreferrer"><i class="fa fa-download"></i><span data-zh="保存图片" data-en="Save Image"></span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()" rel="external nofollow noreferrer"><i class="fa fa-window-restore"></i><span data-zh="在新窗口打开" data-en="Open in New Tab"></span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span data-zh="复制图片链接" data-en="Copy Image Link"></span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:rmf.switchDarkmode();" rel="external nofollow noreferrer"><i class="fa fa-moon"></i><span data-zh="昼夜切换" data-en="Day/Night Mode"></span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();" rel="external nofollow noreferrer"><i class="fas fa-expand"></i><span data-zh="切换全屏" data-en="Toggle Full Screen"></span></a><a class="rightMenu-item" href="javascript:rmf.switchLanguageMode();" rel="external nofollow noreferrer"><i class="fas fa-language"></i><span data-zh="语言切换" data-en="Language Switch"></span></a><a class="rightMenu-item" href="/"><i class="fa fa-home"></i><span data-zh="回到首页" data-en="Go to Home"></span></a><a class="rightMenu-item" href="javascript:window.print();" rel="external nofollow noreferrer"><i class="fa-solid fa-print"></i><span data-zh="打印页面" data-en="Print Page"></span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/utils.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }
      
      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: 'Ov23liyQTymWpBETlDO8',
      clientSecret: '1512bfe449aac2a5ec3b416df1ce27fb5ddb5db0',
      repo: 'even629.github.io',
      owner: 'even629',
      admin: ['even629'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || '8d131a263c18bcaa33b441e8c3947b3c'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script>window.newestComments = {
  changeContent: content => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<code>.*?<\/code>/gi, '[代码]') // replace code      
    content = content.replace(/<[^>]+>/g, "") // remove html tag

    if (content.length > 150) {
      content = content.substring(0, 150) + '...'
    }
    return content
  },

  generateHtml: (array, ele) => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class="aside-list-item">'

        if (true && array[i].avatar) {
          const imgAttr = 'src'
          result += `<a href="${array[i].url}" class="thumbnail"><img ${imgAttr}="${array[i].avatar}" alt="${array[i].nick}"></a>`
        }

        result += `<div class="content">
        <a class="comment" href="${array[i].url}" title="${array[i].content}">${array[i].content}</a>
        <div class="name"><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '暂无评论'
    }

    ele.innerHTML = result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh(ele)
  },

  newestCommentInit: (name, getComment) => {
    const $dom = document.querySelector('#card-newest-comments .aside-list')
    if ($dom) {
      const data = btf.saveToLocal.get(name)
      if (data) {
        newestComments.generateHtml(JSON.parse(data), $dom)
      } else {
        getComment($dom)
      }
    }
  },

  run: (name, getComment) => {
    newestComments.newestCommentInit(name, getComment)
    btf.addGlobalFn('pjaxComplete', () => newestComments.newestCommentInit(name, getComment), name)
  }
}</script><script>window.addEventListener('load', () => {
  const keyName = 'github-newest-comments'
  const { changeContent, generateHtml, run } = window.newestComments

  const findTrueUrl = (array, ele) => {
    Promise.all(array.map(item =>
      fetch(item.url).then(resp => resp.json()).then(data => {
        let urlArray = data.body ? data.body.match(/(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?/ig) : []
        if (!Array.isArray(urlArray) || urlArray.length === 0) {
          urlArray = [`${data.html_url}`]
        }
        if (data.user.login === 'utterances-bot') {
          return urlArray.pop()
        } else {
          return urlArray.shift()
        }
      })
    )).then(res => {
        array = array.map((i,index)=> {
          return {
            ...i,
            url: res[index]
          }
        })

        btf.saveToLocal.set(keyName, JSON.stringify(array), 10/(60*24))
        generateHtml(array, ele)
    });
  }

  const getComment = ele => {
    fetch('https://api.github.com/repos/even629/even629.github.io/issues/comments?sort=updated&direction=desc&per_page=6&page=1',{
      "headers": {
        Accept: 'application/vnd.github.v3.html+json'
      }
    })
      .then(response => response.json())
      .then(data => {
        const githubArray = data.map(item => {
          return {
            'avatar': item.user.avatar_url,
            'content': changeContent(item.body_html || item.body),
            'nick': item.user.login,
            'url': item.issue_url,
            'date': item.updated_at
          }
        })
        findTrueUrl(githubArray, ele)
      }).catch(e => {
        console.error(e)
        ele.textContent= "无法获取评论，请确认相关配置是否正确"
      })
  }
  run(keyName, getComment)
})</script><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script defer src="/js/right_menu.js"></script><script async src="/js/fps.js"></script><script src="/js/pop-up-window.js"></script><script defer src="/js/light.js"></script><script src="/js/music.js"></script><script data-pjax src="/js/btf.js"></script><script data-pjax src="/js/ch_en.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404.html')
    }
  })
})()</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="search" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '800ms');
    arr[i].setAttribute('data-wow-delay', '0ms');
    arr[i].setAttribute('data-wow-offset', '0');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('category-bar');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '800ms');
    arr[i].setAttribute('data-wow-delay', '0ms');
    arr[i].setAttribute('data-wow-offset', '0');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('container');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '800ms');
    arr[i].setAttribute('data-wow-delay', '0ms');
    arr[i].setAttribute('data-wow-offset', '0');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="/js/wowjs/wow.min.js"></script><script defer src="/js/wowjs/wow_init.js"></script><!-- hexo injector body_end end --></body></html>