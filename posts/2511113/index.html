<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Linux字符设备基础 | 常想一二，不思八九</title><meta name="author" content="even629"><meta name="copyright" content="even629"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Linux字符设备基础">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux字符设备基础">
<meta property="og:url" content="https://even629.com/posts/2511113/index.html">
<meta property="og:site_name" content="常想一二，不思八九">
<meta property="og:description" content="Linux字符设备基础">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://even629.com/images/linux_cover.webp">
<meta property="article:published_time" content="2025-11-11T12:31:13.000Z">
<meta property="article:modified_time" content="2025-11-11T12:31:13.000Z">
<meta property="article:author" content="even629">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="GNU">
<meta property="article:tag" content="driver">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://even629.com/images/linux_cover.webp"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://even629.com/posts/2511113/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><meta name="baidu-site-verification" content="codeva-g8sPzVXu98"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://npm.elemecdn.com/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"中"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: even629","link":"链接: ","source":"来源: 常想一二，不思八九","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Linux字符设备基础',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><link rel='preload', href='/img/avatar.png', as='image'><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/custom_card_author.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/right_menu.css"><link rel="stylesheet" href="/css/nav.css"><link rel="stylesheet" href="/css/newYear.css"><link rel="stylesheet" href="/css/music.css"><link rel="stylesheet" href="/css/beautify_label_h.css"><link rel="stylesheet" href="/css/equipment.css"><link rel="stylesheet" href="/css/liquid_glass.css"><link rel="stylesheet" href="/css/tag_plugin_plus.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.0.6/swiper-bundle.min.css"><span id="fps"></span><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="/css/wow_animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="常想一二，不思八九" type="application/atom+xml">
</head><body><div class="float-box left top"></div><div class="float-box left bottom"></div><div class="float-box right top"></div><div class="float-box right bottom"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg" style="background-image: url(/img/12bb_background.png);"></div><div id="an_music_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/charts/"><i class="fa-fw fas fa-solid fa-chart-simple"></i><span> 统计</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 分享</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fa-solid fa-toolbox"></i><span> 装备</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-solid fa-link"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-solid fa-comments"></i><span> 留言</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/images/linux_top_image.jpg);"><nav class="liquidGlass-wrapper" id="nav" style="--glass-border-radius: 2rem;"><div class="liquidGlass-effect"></div><div class="liquidGlass-tint"></div><div class="liquidGlass-shine"></div><div class="liquidGlass-box" style="display:flex;align-items:center;justify-content:center;width:100%"><!-- 左侧博客信息区域--><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" alt="Logo"></a></span><!-- 新增的导航菜单容器（居中布局关键）--><div id="nav-menus-container"><!-- 菜单主体部分--><div id="menus"><!-- 菜单项--><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/charts/"><i class="fa-fw fas fa-solid fa-chart-simple"></i><span> 统计</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 分享</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fa-solid fa-toolbox"></i><span> 装备</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-solid fa-link"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-solid fa-comments"></i><span> 留言</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div><!-- 显示当前标题名称--><center id="name-container"><a id="page-name" href="javascript:rmf.scrollToTop()">常想一二，不思八九</a></center></div></div><!-- 右侧功能区域（新增容器）--><div id="nav-right-container"><!-- 搜索按钮（移动到右侧）--><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><!-- 移动端汉堡菜单按钮--><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></div></nav><div id="post-info"><h1 class="post-title">Linux字符设备基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-11-11T12:31:13.000Z" title="发表于 2025-11-11 20:31:13">2025-11-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-11T12:31:13.000Z" title="更新于 2025-11-11 20:31:13">2025-11-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">13.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>64分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/2511113/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><hr>
<div class="timeline blue"><div class='timeline-item headline'><div class='timeline-item-title'><div class='item-circle'><p>时间轴</p>
</div></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2025-11-11</p>
</div></div><div class='timeline-item-content'><p>init</p>
</div></div></div>

<hr>
<h2 id="设备号"><a href="#设备号" class="headerlink" title="设备号"></a>设备号</h2><p>在 Linux 系统中每一个设备都有相应的设备号，设备号有<strong>主设备号</strong>与<strong>次设备号</strong>之分：</p>
<ul>
<li><strong>主设备号</strong>：标识<strong>设备类型</strong>。</li>
<li><strong>次设备号</strong>：在<strong>同一个驱动管理的多个设备实例之间进行区分</strong></li>
</ul>
<blockquote>
<p>举例：</p>
<ul>
<li>主设备号 <strong>13</strong> 表示 <strong>input 子系统</strong>（处理输入设备）。<ul>
<li>次设备号 64 → <code>/dev/input/event0</code>（可能是 USB 键盘）</li>
<li>次设备号 65 → <code>/dev/input/event1</code>（可能是 USB 鼠标）</li>
</ul>
</li>
<li>主设备号 <strong>188</strong> 表示 <strong>USB 串行设备</strong>。<ul>
<li>次设备号 0 → <code>/dev/ttyUSB0</code></li>
<li>次设备号 1 → <code>/dev/ttyUSB1</code></li>
</ul>
</li>
</ul>
</blockquote>
<p>在<strong>注册字符设备驱动之前需要先申请设备号</strong>。</p>
<p><strong>include&#x2F;linux&#x2F;types.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> u32 <span class="type">__kernel_dev_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> __kernel_fd_set		fd_set;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">__kernel_dev_t</span>		<span class="type">dev_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">__kernel_ino_t</span>		<span class="type">ino_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">__kernel_mode_t</span>		<span class="type">mode_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">short</span>		<span class="type">umode_t</span>;</span><br></pre></td></tr></table></figure>

<p>设备号 dev_t 是 u32 类型，<strong>高 12 位为主设备号</strong>，<strong>低 20 位为次设备号</strong>。</p>
<h3 id="设备号操作宏"><a href="#设备号操作宏" class="headerlink" title="设备号操作宏"></a>设备号操作宏</h3><p><strong>include&#x2F;linux&#x2F;kdev_t.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MINORBITS	20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MINORMASK	((1U &lt;&lt; MINORBITS) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAJOR(dev)	((unsigned int) ((dev) &gt;&gt; MINORBITS))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MINOR(dev)	((unsigned int) ((dev) &amp; MINORMASK))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MKDEV(ma,mi)	(((ma) &lt;&lt; MINORBITS) | (mi))</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>MINORBITS</strong>表示次设备号的位数，一共 20 位</li>
<li><strong>MINORMASK</strong>用于计算次设备号</li>
<li><strong>MAJOR</strong>表示从 dev_t 中获取主设备号，本质是将 dev_t 右移 20 位</li>
<li><strong>MINOR</strong>表示从 dev_t 中获取次设备号，本质是取低 20 位的值</li>
<li><strong>MKDEV</strong>用于将主设备号和次设备号组成 dev_t 类型的设备号</li>
</ul>
<h3 id="设备号申请函数"><a href="#设备号申请函数" class="headerlink" title="设备号申请函数"></a>设备号申请函数</h3><p>在 Linux 驱动中可以使用以下两种方法进行设备号的申请。</p>
<p><strong>include&#x2F;linux&#x2F;fs.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">register_chrdev_region</span><span class="params">(<span class="type">dev_t</span>, <span class="type">unsigned</span>, <span class="type">const</span> <span class="type">char</span> *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">alloc_chrdev_region</span><span class="params">(<span class="type">dev_t</span> *, <span class="type">unsigned</span>, <span class="type">unsigned</span>, <span class="type">const</span> <span class="type">char</span> *)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="register-chrdev-region"><a href="#register-chrdev-region" class="headerlink" title="register_chrdev_region()"></a>register_chrdev_region()</h4><ol>
<li><p>通过 <code>register_chrdev_region(dev_t from, unsigned count, const char *name)</code> 函数进行静态申请设备号。</p>
<ul>
<li><strong>函数原型</strong>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">register_chrdev_region(<span class="type">dev_t</span> from, <span class="type">unsigned</span> count, <span class="type">const</span> <span class="type">char</span> *name)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>函数作用</strong>：静态申请设备号，对指定好的设备号进行申请。</li>
<li><strong>参数含义</strong>：<ul>
<li><code>from</code>: 自定义的 dev_t 类型设备号，比如 MKDEV(100,0)表示起始主设备号 100，起始次设备号为 0</li>
<li><code>count</code>: 次设备的数量，表示在主设备号相同的情况下有几个次设备号。</li>
<li><code>name</code>: 申请的设备名称</li>
</ul>
</li>
<li><strong>函数返回值</strong>：申请成功返回 0，申请失败返回负数</li>
</ul>
</li>
</ol>
<blockquote>
<p>注意，静态申请的设备号是有限制的：<code>include/linux/fs.h</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* fs/char_dev.c */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHRDEV_MAJOR_MAX 512</span></span><br><span class="line"><span class="comment">/* Marks the bottom of the first segment of free char majors */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHRDEV_MAJOR_DYN_END 234</span></span><br><span class="line"><span class="comment">/* Marks the top and bottom of the second segment of free char majors */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHRDEV_MAJOR_DYN_EXT_START 511</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHRDEV_MAJOR_DYN_EXT_END 384</span></span><br></pre></td></tr></table></figure></blockquote>
<h4 id="alloc-chrdev-region"><a href="#alloc-chrdev-region" class="headerlink" title="alloc_chrdev_region()"></a>alloc_chrdev_region()</h4><ol start="2">
<li>通过<code>alloc_chrdev_region(dev_t *dev, unsigned baseminor, unsigned count,const char* name)</code>函数进行动态申请设备号。</li>
</ol>
<ul>
<li><strong>函数原型</strong>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alloc_chrdev_region(<span class="type">dev_t</span> *dev, <span class="type">unsigned</span> baseminor, <span class="type">unsigned</span> count,<span class="type">const</span> <span class="type">char</span> *name)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>函数作用</strong>：动态申请设备号，内核会自动分配一个未使用的设备号，相较于静态申请设备号，动态申请会避免注册设备号相同引发冲突的问题。</p>
</li>
<li><p><strong>参数含义</strong>：</p>
<ul>
<li><code>dev *</code>: 会将申请完成的设备号保存在 dev 变量中</li>
<li><code>baseminor</code>: 次设备号的起始地址，次设备号一般从 0 开始，所以这个参数一般设置成 0</li>
<li><code>count</code>: 申请设备的数量</li>
<li><code>name</code>: 申请的设备名称</li>
</ul>
</li>
<li><p><strong>函数返回值</strong>：申请成功返回 0，申请失败返回负数</p>
</li>
</ul>
<h3 id="设备号释放函数"><a href="#设备号释放函数" class="headerlink" title="设备号释放函数"></a>设备号释放函数</h3><h4 id="unregister-chrdev-region"><a href="#unregister-chrdev-region" class="headerlink" title="unregister_chrdev_region()"></a>unregister_chrdev_region()</h4><p><strong>include&#x2F;linux&#x2F;fs.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">unregister_chrdev_region</span><span class="params">(<span class="type">dev_t</span>, <span class="type">unsigned</span>)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>函数功能：设备号释放函数，注销字符设备以后要释放掉设备号</li>
<li>函数参数：<ul>
<li><code>dev_t</code>类型：要释放的设备号</li>
<li><code>unsigned</code>类型：释放的设备号的数量</li>
</ul>
</li>
</ul>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a><strong>示例</strong></h3><p>my_driver.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/moduleparam.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> major = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> minor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">module_param(major, <span class="type">int</span>, S_IRUGO);</span><br><span class="line">module_param(minor, <span class="type">int</span>, S_IRUGO);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">dev_t</span> dev_id;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">my_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (major) &#123;</span><br><span class="line">		dev_id = MKDEV(major, minor);</span><br><span class="line"></span><br><span class="line">		printk(KERN_INFO <span class="string">&quot;major from module_param: %d&quot;</span>, MAJOR(dev_id));</span><br><span class="line">		printk(KERN_INFO <span class="string">&quot;minor from module_param: %d&quot;</span>, MINOR(dev_id));</span><br><span class="line"></span><br><span class="line">		ret = register_chrdev_region(dev_id, <span class="number">1</span>, <span class="string">&quot;my_driver device&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			printk(KERN_ERR <span class="string">&quot;register_chrdev_region error\n&quot;</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			printk(KERN_INFO <span class="string">&quot;register_chrdev_region ok\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ret = alloc_chrdev_region(&amp;dev_id, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;my_driver device&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			printk(KERN_ERR <span class="string">&quot;alloc_chrdev_region error\n&quot;</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			printk(KERN_INFO <span class="string">&quot;alloc_chrdev_region ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">			printk(KERN_INFO <span class="string">&quot;major allocated: %d&quot;</span>, MAJOR(dev_id));</span><br><span class="line">			printk(KERN_INFO <span class="string">&quot;minor allocated: %d&quot;</span>, MINOR(dev_id));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	printk(KERN_INFO <span class="string">&quot;my_driver: Module loaded\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">my_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	unregister_chrdev_region(dev_id, <span class="number">1</span>);</span><br><span class="line">	printk(KERN_INFO <span class="string">&quot;unregister_chrdev_region ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	printk(KERN_INFO <span class="string">&quot;my_driver: Module unloaded\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_driver_init);</span><br><span class="line">module_exit(my_driver_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Zhao Hang&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;my_driver Kernel Module&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">~ <span class="comment"># insmod my_driver.ko</span></span><br><span class="line">[   18.414274] my_driver: loading out-of-tree module taints kernel.</span><br><span class="line">[   18.421489] alloc_chrdev_region ok</span><br><span class="line">[   18.421652] major allocated: 511</span><br><span class="line">[   18.421667] minor allocated: 0</span><br><span class="line">[   18.421910] my_driver: Module loaded</span><br><span class="line">~ <span class="comment"># cat /proc/devices | grep my_driver</span></span><br><span class="line">511 my_driver device</span><br><span class="line">~ <span class="comment"># rmmod my_driver.ko</span></span><br><span class="line">[   27.856484] unregister_chrdev_region ok</span><br><span class="line">[   27.856638] my_driver: Module unloaded</span><br><span class="line">~ <span class="comment">#  cat /proc/devices | grep my_driver</span></span><br><span class="line">~ <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">~ <span class="comment"># insmod my_driver.ko major=512 minor=0</span></span><br><span class="line">[   16.721502] my_driver: loading out-of-tree module taints kernel.</span><br><span class="line">[   16.728530] major from module_param: 512</span><br><span class="line">[   16.728574] minor from module_param: 0</span><br><span class="line">[   16.728753] CHRDEV <span class="string">&quot;my_driver device&quot;</span> major requested (512) is greater than the maximum (511)</span><br><span class="line">[   16.729588] register_chrdev_region error</span><br><span class="line">[   16.729760] my_driver: Module loaded</span><br><span class="line">~ <span class="comment"># rmmod my_driver.ko</span></span><br><span class="line">[   36.863583] unregister_chrdev_region ok</span><br><span class="line">[   36.864560] my_driver: Module unloaded</span><br><span class="line">~ <span class="comment"># insmod my_driver.ko major=500 minor=0</span></span><br><span class="line">[   40.101231] major from module_param: 500</span><br><span class="line">[   40.101265] minor from module_param: 0</span><br><span class="line">[   40.101430] register_chrdev_region ok</span><br><span class="line">[   40.101657] my_driver: Module loaded</span><br><span class="line">~ <span class="comment"># rmmod my_driver.ko</span></span><br><span class="line">[   50.626705] unregister_chrdev_region ok</span><br><span class="line">[   50.626876] my_driver: Module unloaded</span><br></pre></td></tr></table></figure>

<h2 id="注册字符类设备"><a href="#注册字符类设备" class="headerlink" title="注册字符类设备"></a>注册字符类设备</h2><p><strong>include&#x2F;linux&#x2F;cdev.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPDX-License-Identifier: GPL-2.0 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _LINUX_CDEV_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _LINUX_CDEV_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kobject.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/list.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">	<span class="type">dev_t</span> dev;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cdev_init</span><span class="params">(<span class="keyword">struct</span> cdev *, <span class="type">const</span> <span class="keyword">struct</span> file_operations *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> cdev *<span class="title function_">cdev_alloc</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cdev_put</span><span class="params">(<span class="keyword">struct</span> cdev *p)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">cdev_add</span><span class="params">(<span class="keyword">struct</span> cdev *, <span class="type">dev_t</span>, <span class="type">unsigned</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cdev_set_parent</span><span class="params">(<span class="keyword">struct</span> cdev *p, <span class="keyword">struct</span> kobject *kobj)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">cdev_device_add</span><span class="params">(<span class="keyword">struct</span> cdev *cdev, <span class="keyword">struct</span> device *dev)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">cdev_device_del</span><span class="params">(<span class="keyword">struct</span> cdev *cdev, <span class="keyword">struct</span> device *dev)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cdev_del</span><span class="params">(<span class="keyword">struct</span> cdev *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cd_forget</span><span class="params">(<span class="keyword">struct</span> inode *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 C 语言中，如果你只需要使用某个结构体的 <strong>指针</strong>，而不需要知道它的内部成员（即不进行解引用或 sizeof），就可以只做 <strong>前置声明</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>;</span>  <span class="comment">// 告诉编译器：存在一个叫 file_operations 的 struct 类型</span></span><br></pre></td></tr></table></figure>

<p>这样你就可以定义指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">fops</span>;</span></span><br></pre></td></tr></table></figure>

<p>但不能访问成员（因为编译器还不知道结构体内容）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fops-&gt;read(...);  <span class="comment">// ❌ 编译错误：不完整类型</span></span><br></pre></td></tr></table></figure>

<p>这在头文件中非常常见，用于 <strong>解耦依赖</strong> 和 <strong>加快编译速度</strong>。</p>
<p>而<code>extern</code> 是 <strong>存储类说明符（storage class specifier）</strong>，用于声明 <strong>变量</strong> 或 <strong>函数</strong> 的外部链接属性。它的作用是告诉编译器：“这个变量&#x2F;函数在别处定义，这里只是声明”。</p>
</blockquote>
<blockquote>
<p>GCC&#x2F;Clang attribute（<code>__randomize_layout</code>），<br>用于内核的 <strong>结构体布局随机化（struct layout randomization）</strong>，增加攻击者预测结构偏移的难度，提高内核安全性。</p>
</blockquote>
<h3 id="cdev-结构体"><a href="#cdev-结构体" class="headerlink" title="cdev 结构体"></a>cdev 结构体</h3><table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>kobj</code></td>
<td>继承自 <code>struct kobject</code>，使字符设备能挂在 sysfs 下（即 <code>/sys/class/...</code> 等路径）。</td>
</tr>
<tr>
<td><code>owner</code></td>
<td>指向拥有该设备的模块（<code>THIS_MODULE</code>），防止模块卸载时设备仍在使用。</td>
</tr>
<tr>
<td><code>ops</code></td>
<td><strong>指向设备操作函数表（<code>struct file_operations</code>），定义 read&#x2F;write&#x2F;ioctl 等行为。</strong></td>
</tr>
<tr>
<td><code>list</code></td>
<td>内部链表，<strong>将所有共享该 <code>cdev</code> 的 inode（即 <code>/dev/xxx</code> 文件）通过 <code>inode-&gt;i_devices</code> 链接到一起，形成一个“反向引用链表”。</strong></td>
</tr>
<tr>
<td><code>dev</code></td>
<td>设备号，类型是 <code>dev_t</code>（包含主设备号 major 和次设备号 minor）。</td>
</tr>
<tr>
<td><code>count</code></td>
<td>表示这个 <code>cdev</code> 控制的连续设备编号数量（常为 1）。</td>
</tr>
</tbody></table>
<h3 id="cdev-init"><a href="#cdev-init" class="headerlink" title="cdev_init"></a>cdev_init</h3><p><strong>fs&#x2F;char_dev.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * cdev_init() - initialize a cdev structure</span></span><br><span class="line"><span class="comment"> * @cdev: the structure to initialize</span></span><br><span class="line"><span class="comment"> * @fops: the file_operations for this device</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Initializes @cdev, remembering @fops, making it ready to add to the</span></span><br><span class="line"><span class="comment"> * system with cdev_add().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cdev_init</span><span class="params">(<span class="keyword">struct</span> cdev *cdev, <span class="type">const</span> <span class="keyword">struct</span> file_operations *fops)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">memset</span>(cdev, <span class="number">0</span>, <span class="keyword">sizeof</span> *cdev);</span><br><span class="line">	INIT_LIST_HEAD(&amp;cdev-&gt;<span class="built_in">list</span>);</span><br><span class="line">	kobject_init(&amp;cdev-&gt;kobj, &amp;ktype_cdev_default);</span><br><span class="line">	cdev-&gt;ops = fops;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>作用</strong>：初始化一个静态分配的 <code>struct cdev</code>。建立 cdev 和 file_operations 之间的联系</li>
</ul>
<blockquote>
<p>注意: 调用<code>cdev_init</code>后最好调用<code>cdev_test.owner = THIS_MODULE;</code> 将 owner 字段指向本模块，可以避免在模块的操作正在被使用时卸载该模块</p>
</blockquote>
<h3 id="cdev-add"><a href="#cdev-add" class="headerlink" title="cdev_add"></a>cdev_add</h3><p><strong>fs&#x2F;char_dev.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * cdev_add() - add a char device to the system</span></span><br><span class="line"><span class="comment"> * @p: the cdev structure for the device</span></span><br><span class="line"><span class="comment"> * @dev: the first device number for which this device is responsible</span></span><br><span class="line"><span class="comment"> * @count: the number of consecutive minor numbers corresponding to this</span></span><br><span class="line"><span class="comment"> *         device</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * cdev_add() adds the device represented by @p to the system, making it</span></span><br><span class="line"><span class="comment"> * live immediately.  A negative error code is returned on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cdev_add</span><span class="params">(<span class="keyword">struct</span> cdev *p, <span class="type">dev_t</span> dev, <span class="type">unsigned</span> count)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> error;</span><br><span class="line"></span><br><span class="line">	p-&gt;dev = dev;</span><br><span class="line">	p-&gt;count = count;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON(dev == WHITEOUT_DEV))</span><br><span class="line">		<span class="keyword">return</span> -EBUSY;</span><br><span class="line"></span><br><span class="line">	error = kobj_map(cdev_map, dev, count, <span class="literal">NULL</span>,</span><br><span class="line">			 exact_match, exact_lock, p);</span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">return</span> error;</span><br><span class="line"></span><br><span class="line">	kobject_get(p-&gt;kobj.parent);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>作用</strong>：向系统添加一个 cdev 结构体，也就是添加一个字符设备</li>
</ul>
<blockquote>
<ul>
<li><code>cdev_map</code>：全局 <code>kobj_map</code> 结构（哈希表）</li>
<li><code>p</code>：指向 <code>struct cdev</code></li>
<li>注意：<code>cdev</code> 内嵌了 <code>struct kobject kobj</code>，所以 <code>cdev</code> 可以被视为一个 <code>kobject</code></li>
</ul>
</blockquote>
<h3 id="cdev-del"><a href="#cdev-del" class="headerlink" title="cdev_del"></a>cdev_del</h3><p><strong>fs&#x2F;char_dev.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * cdev_del() - remove a cdev from the system</span></span><br><span class="line"><span class="comment"> * @p: the cdev structure to be removed</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * cdev_del() removes @p from the system, possibly freeing the structure</span></span><br><span class="line"><span class="comment"> * itself.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> This guarantees that cdev device will no longer be able to be</span></span><br><span class="line"><span class="comment"> * opened, however any cdevs already open will remain and their fops will</span></span><br><span class="line"><span class="comment"> * still be callable even after cdev_del returns.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cdev_del</span><span class="params">(<span class="keyword">struct</span> cdev *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	cdev_unmap(p-&gt;dev, p-&gt;count);</span><br><span class="line">	kobject_put(&amp;p-&gt;kobj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>作用：系统中删除一个字符设备</li>
</ul>
<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/moduleparam.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> major = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> minor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">module_param(major, <span class="type">int</span>, S_IRUGO);</span><br><span class="line">module_param(minor, <span class="type">int</span>, S_IRUGO);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">dev_t</span> dev_id;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev_test</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">cdev_test_ops</span> =</span> &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">my_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (major) &#123;</span><br><span class="line">		dev_id = MKDEV(major, minor);</span><br><span class="line"></span><br><span class="line">		pr_info( <span class="string">&quot;major from module_param: %d&quot;</span>, MAJOR(dev_id));</span><br><span class="line">		pr_info( <span class="string">&quot;minor from module_param: %d&quot;</span>, MINOR(dev_id));</span><br><span class="line"></span><br><span class="line">		ret = register_chrdev_region(dev_id, <span class="number">1</span>, <span class="string">&quot;my_driver device&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			pr_err( <span class="string">&quot;register_chrdev_region error\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			pr_info( <span class="string">&quot;register_chrdev_region ok\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ret = alloc_chrdev_region(&amp;dev_id, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;my_driver device&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			pr_err( <span class="string">&quot;alloc_chrdev_region error\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			pr_info( <span class="string">&quot;alloc_chrdev_region ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">			pr_info( <span class="string">&quot;major allocated: %d&quot;</span>, MAJOR(dev_id));</span><br><span class="line">			pr_info( <span class="string">&quot;minor allocated: %d&quot;</span>, MINOR(dev_id));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cdev_init(&amp;cdev_test, &amp;cdev_test_ops);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将 owner 字段指向本模块，可以避免在模块的操作正在被使用时卸载该模块</span></span><br><span class="line">	cdev_test.owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line">	ret = cdev_add(&amp;cdev_test, dev_id, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		pr_err( <span class="string">&quot;cdev_add error\n&quot;</span>);</span><br><span class="line">		unregister_chrdev_region(dev_id, <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		pr_info( <span class="string">&quot;cdev_add ok\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pr_info( <span class="string">&quot;my_driver: Module loaded\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">my_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	cdev_del(&amp;cdev_test);</span><br><span class="line">	unregister_chrdev_region(dev_id, <span class="number">1</span>);</span><br><span class="line">	pr_info( <span class="string">&quot;unregister_chrdev_region ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	pr_info( <span class="string">&quot;my_driver: Module unloaded\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_driver_init);</span><br><span class="line">module_exit(my_driver_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Zhao Hang&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;my_driver Kernel Module&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>注意先删除设备再释放设备号。</p>
<h2 id="file-operations-结构体"><a href="#file-operations-结构体" class="headerlink" title="file_operations 结构体"></a>file_operations 结构体</h2><p>Linux 有一个很重要的概念叫一切皆文件，也就是 Linux 中的设备就像普通的文件一样。访问一个设备好像是在访问一个文件。在应用程序中我们可以使用 open, read, write, close, ioctl 这几个系统调用来操作驱动。当我们在应用程序中调用 open 函数的时候，最终会去执行驱动中的 open 函数。所以 file_operations 将系统调用和驱动程序连接起来了。</p>
<p><strong>应用中调用 open 函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">&quot;/dev/hello&quot;</span>, O_RDWR);</span><br></pre></td></tr></table></figure>

<p><strong>驱动中执行 open 函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cdev_test_open</span><span class="params">(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file*)</span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;This is cdev_test open&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">cdev_test_ops</span>=</span>&#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = cdev_test_open,</span><br><span class="line">    .read = cdev_test_read,</span><br><span class="line">    .write = cdev_test_write,</span><br><span class="line">    .release = cdev_test_release</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>linux 中 file_operations 定义：</p>
<p><strong>include&#x2F;linux&#x2F;fs.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">	<span class="type">loff_t</span> (*llseek) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line">	<span class="type">ssize_t</span> (*read) (<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">	<span class="type">ssize_t</span> (*write) (<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">	<span class="type">ssize_t</span> (*read_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line">	<span class="type">ssize_t</span> (*write_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line">	<span class="type">int</span> (*iopoll)(<span class="keyword">struct</span> kiocb *kiocb, <span class="type">bool</span> spin);</span><br><span class="line">	<span class="type">int</span> (*iterate) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line">	<span class="type">int</span> (*iterate_shared) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line">	<span class="type">__poll_t</span> (*poll) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> poll_table_struct *);</span><br><span class="line">	<span class="type">long</span> (*unlocked_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">	<span class="type">long</span> (*compat_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">	<span class="type">int</span> (*mmap) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> vm_area_struct *);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> mmap_supported_flags;</span><br><span class="line">	<span class="type">int</span> (*open) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">	<span class="type">int</span> (*flush) (<span class="keyword">struct</span> file *, <span class="type">fl_owner_t</span> id);</span><br><span class="line">	<span class="type">int</span> (*release) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">	<span class="type">int</span> (*fsync) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">loff_t</span>, <span class="type">int</span> datasync);</span><br><span class="line">	<span class="type">int</span> (*fasync) (<span class="type">int</span>, <span class="keyword">struct</span> file *, <span class="type">int</span>);</span><br><span class="line">	<span class="type">int</span> (*lock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">	<span class="type">ssize_t</span> (*sendpage) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> page *, <span class="type">int</span>, <span class="type">size_t</span>, <span class="type">loff_t</span> *, <span class="type">int</span>);</span><br><span class="line">	<span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*get_unmapped_area)</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line">	<span class="type">int</span> (*check_flags)(<span class="type">int</span>);</span><br><span class="line">	<span class="type">int</span> (*flock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">	<span class="type">ssize_t</span> (*splice_write)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">	<span class="type">ssize_t</span> (*splice_read)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="keyword">struct</span> pipe_inode_info *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">	<span class="type">int</span> (*setlease)(<span class="keyword">struct</span> file *, <span class="type">long</span>, <span class="keyword">struct</span> file_lock **, <span class="type">void</span> **);</span><br><span class="line">	<span class="type">long</span> (*fallocate)(<span class="keyword">struct</span> file *file, <span class="type">int</span> mode, <span class="type">loff_t</span> offset,</span><br><span class="line">			  <span class="type">loff_t</span> len);</span><br><span class="line">	<span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> file *f);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line">	<span class="type">unsigned</span> (*mmap_capabilities)(<span class="keyword">struct</span> file *);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">ssize_t</span> (*copy_file_range)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="keyword">struct</span> file *,</span><br><span class="line">			<span class="type">loff_t</span>, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">	<span class="type">loff_t</span> (*remap_file_range)(<span class="keyword">struct</span> file *file_in, <span class="type">loff_t</span> pos_in,</span><br><span class="line">				   <span class="keyword">struct</span> file *file_out, <span class="type">loff_t</span> pos_out,</span><br><span class="line">				   <span class="type">loff_t</span> len, <span class="type">unsigned</span> <span class="type">int</span> remap_flags);</span><br><span class="line">	<span class="type">int</span> (*fadvise)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line">	<span class="type">bool</span> may_pollfree;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>常见字段解析：</p>
<table>
<thead>
<tr>
<th>函数指针</th>
<th>用户态调用</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>owner</code></td>
<td>—</td>
<td>通常写为 <code>THIS_MODULE</code>，防止模块被正在使用时卸载</td>
</tr>
<tr>
<td><code>open</code></td>
<td><code>open()</code></td>
<td>打开设备时调用，一般用于初始化或统计打开次数</td>
</tr>
<tr>
<td><code>release</code></td>
<td><code>close()</code></td>
<td>关闭设备时调用，用于释放资源</td>
</tr>
<tr>
<td><code>read</code></td>
<td><code>read()</code></td>
<td>用户读设备数据</td>
</tr>
<tr>
<td><code>write</code></td>
<td><code>write()</code></td>
<td>用户写数据到设备</td>
</tr>
<tr>
<td><code>unlocked_ioctl</code></td>
<td><code>ioctl()</code></td>
<td>用户发控制命令</td>
</tr>
<tr>
<td><code>poll</code></td>
<td><code>poll()</code>&#x2F;<code>select()</code></td>
<td>实现非阻塞 I&#x2F;O（epoll 机制）</td>
</tr>
<tr>
<td><code>mmap</code></td>
<td><code>mmap()</code></td>
<td>将物理内存映射到用户空间</td>
</tr>
<tr>
<td><code>llseek</code></td>
<td><code>lseek()</code></td>
<td>文件位置偏移</td>
</tr>
<tr>
<td><code>fasync</code></td>
<td><code>fcntl(F_SETFL, O_ASYNC)</code></td>
<td>支持异步通知</td>
</tr>
</tbody></table>
<p><strong>返回值约定</strong>：</p>
<ul>
<li><code>ssize_t</code>：&gt;&#x3D;0 成功字节数，&lt;0 errno</li>
<li><code>int</code> &#x2F; <code>long</code>：0 成功，&lt;0 errno</li>
<li>指针：成功返回指针，失败返回 <code>ERR_PTR(-errno)</code></li>
</ul>
<h3 id="llseek"><a href="#llseek" class="headerlink" title="llseek"></a><strong>llseek</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">loff_t</span> (*llseek)(<span class="keyword">struct</span> file *file, <span class="type">loff_t</span> offset, <span class="type">int</span> whence);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>作用</strong>：文件指针偏移操作（类似 lseek 系统调用）。</li>
<li><strong>参数</strong>：<ul>
<li><code>file</code>：文件对象。</li>
<li><code>offset</code>：偏移量。</li>
<li><code>whence</code>：<ul>
<li><code>SEEK_SET</code>：相对于文件开头</li>
<li><code>SEEK_CUR</code>：相对于当前文件指针</li>
<li><code>SEEK_END</code>：相对于文件末尾</li>
</ul>
</li>
</ul>
</li>
<li><strong>返回值</strong>：<ul>
<li>新的文件指针位置（<code>loff_t</code>）</li>
<li>出错返回负值（如 <code>-EINVAL</code>）</li>
</ul>
</li>
</ul>
<hr>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a><strong>read</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> (*read)(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf, <span class="type">size_t</span> count, <span class="type">loff_t</span> *pos);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>作用</strong>：从文件读数据到用户空间。</li>
<li><strong>参数</strong>：<ul>
<li><code>file</code>：文件对象。</li>
<li><code>buf</code>：用户空间缓冲区指针。</li>
<li><code>count</code>：希望读取的字节数。</li>
<li><code>pos</code>：文件指针位置，读完后需要更新。</li>
</ul>
</li>
<li><strong>返回值</strong>：<ul>
<li>成功：实际读取的字节数</li>
<li>出错：负数 errno</li>
</ul>
</li>
</ul>
<hr>
<h3 id="write"><a href="#write" class="headerlink" title="write"></a>write</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> (*write)(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> count, <span class="type">loff_t</span> *pos);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>作用</strong>：把用户数据写入文件&#x2F;设备。</li>
<li><strong>参数</strong>：<ul>
<li><code>file</code>：文件对象</li>
<li><code>buf</code>：用户缓冲区</li>
<li><code>count</code>：写入字节数</li>
<li><code>pos</code>：文件指针</li>
</ul>
</li>
<li><strong>返回值</strong>：<ul>
<li>成功：实际写入的字节数</li>
<li>出错：负数 errno</li>
</ul>
</li>
</ul>
<h3 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a><strong>mmap</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> (*mmap)(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> vm_area_struct *);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>作用</strong>：支持用户空间内存映射到设备。</li>
<li><strong>参数</strong>：<ul>
<li><code>file</code>：文件对象</li>
<li><code>vma</code>：虚拟内存区域结构</li>
</ul>
</li>
<li><strong>返回值</strong>：<ul>
<li>0 成功</li>
<li>&lt;0 错误</li>
</ul>
</li>
<li><code>mmap_supported_flags</code>：映射时支持的标志。</li>
</ul>
<h3 id="open"><a href="#open" class="headerlink" title="open"></a><strong>open</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> (*open)(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>作用</strong>：当用户态调用 <code>open()</code> 打开设备或文件时被调用。</li>
<li><strong>参数</strong>：<ul>
<li><code>inode</code>：指向设备对应的 inode 结构，包含文件系统层信息和设备号。</li>
<li><code>file</code>：指向文件对象（<code>struct file</code>），保存文件状态、偏移量、<code>private_data</code> 等。</li>
</ul>
</li>
<li><strong>返回值</strong>：<ul>
<li><code>0</code>：成功打开</li>
<li><code>&lt;0</code>：出错，返回对应 errno（如 <code>-EBUSY</code> 表示设备忙，<code>-ENOMEM</code> 内存不足）</li>
</ul>
</li>
<li><strong>典型用途</strong>：<ul>
<li>检查设备是否已经被占用</li>
<li>初始化 <code>file-&gt;private_data</code> 指针</li>
<li>增加模块引用计数（<code>THIS_MODULE</code>）</li>
</ul>
</li>
</ul>
<hr>
<h3 id="flush"><a href="#flush" class="headerlink" title="flush"></a><strong>flush</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> (*flush)(<span class="keyword">struct</span> file *file, <span class="type">fl_owner_t</span> id);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>作用</strong>：刷新文件缓冲区，确保用户态写入的数据在内核缓冲中被提交。</li>
<li><strong>参数</strong>：<ul>
<li><code>file</code>：文件对象</li>
<li><code>id</code>：文件句柄拥有者标识，一般是文件描述符对应的进程</li>
</ul>
</li>
<li><strong>返回值</strong>：<ul>
<li><code>0</code>：成功</li>
<li><code>&lt;0</code>：出错</li>
</ul>
</li>
<li><strong>说明</strong>：<ul>
<li>对于大多数字符设备驱动，<code>flush</code> 不需要特殊实现，直接返回 0 即可</li>
<li>在块设备或网络设备中，<code>flush</code> 可能用于提交缓存数据</li>
</ul>
</li>
</ul>
<hr>
<h3 id="release"><a href="#release" class="headerlink" title="release"></a><strong>release</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> (*release)(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>作用</strong>：当用户态调用 <code>close()</code> 关闭设备或文件时被调用。</li>
<li><strong>参数</strong>：<ul>
<li><code>inode</code>：设备对应 inode</li>
<li><code>file</code>：文件对象</li>
</ul>
</li>
<li><strong>返回值</strong>：<ul>
<li><code>0</code>：成功关闭</li>
<li><code>&lt;0</code>：出错</li>
</ul>
</li>
<li><strong>典型用途</strong>：<ul>
<li>释放在 <code>open()</code> 时分配的资源</li>
<li>恢复设备状态（如标记为未被占用）</li>
<li>减少模块引用计数</li>
</ul>
</li>
</ul>
<h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> major = <span class="number">0</span>;</span><br><span class="line">module_param(major, <span class="type">int</span>, S_IRUGO);</span><br><span class="line">MODULE_PARM_DESC(major, <span class="string">&quot;cdev_test sample, major device number&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> minor = <span class="number">0</span>;</span><br><span class="line">module_param(minor, <span class="type">int</span>, S_IRUGO);</span><br><span class="line">MODULE_PARM_DESC(minor, <span class="string">&quot;cdev_test sample, minor device number&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">dev_t</span> dev_num;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">cdev_test_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span>&#123;</span><br><span class="line">	pr_info(<span class="string">&quot;cdev_test open&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">cdev_test_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span>&#123;</span><br><span class="line">	pr_info(<span class="string">&quot;cdev_test read\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">cdev_test_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span>, <span class="type">loff_t</span> *offset)</span>&#123;</span><br><span class="line">	pr_info(<span class="string">&quot;cdev_test write\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">fops</span> =</span> &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">	.open = cdev_test_open,</span><br><span class="line">	.read = cdev_test_read,</span><br><span class="line">	.write = cdev_test_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">cdev_test_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> err;</span><br><span class="line">        <span class="keyword">if</span> (major) &#123;</span><br><span class="line">                dev_num = MKDEV(major, minor);</span><br><span class="line">                err = register_chrdev_region(dev_num, <span class="number">1</span>, <span class="string">&quot;cdev test dev num&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        pr_err(<span class="string">&quot;register_chrdev_region error\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">goto</span> chrdev_region_err;</span><br><span class="line">                &#125;</span><br><span class="line">                pr_info(<span class="string">&quot;register_chrdev_region success\n&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                err = alloc_chrdev_region(&amp;dev_num, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;cdev test dev num&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        pr_err(<span class="string">&quot;alloc_chrdev_region error\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">goto</span> chrdev_region_err;</span><br><span class="line">                &#125;</span><br><span class="line">                pr_info(<span class="string">&quot;alloc_chrdev_region success\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">	pr_info(<span class="string">&quot;dev_num: major[%d] minor[%d]&quot;</span>, MAJOR(dev_num), MINOR(dev_num));</span><br><span class="line"></span><br><span class="line">        cdev_init(&amp;cdev, &amp;fops);</span><br><span class="line">        pr_info(<span class="string">&quot;cdev_init success\n&quot;</span>);</span><br><span class="line">        cdev.owner = THIS_MODULE; <span class="comment">// 将owner指向本模块，防止cdev操作时卸载模块</span></span><br><span class="line"></span><br><span class="line">        err = cdev_add(&amp;cdev, dev_num, <span class="number">1</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;cdev_add success\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;cdev_add error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> cdev_add_err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">cdev_add_err:</span><br><span class="line">        unregister_chrdev_region(dev_num, <span class="number">1</span>);</span><br><span class="line">chrdev_region_err:</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">cdev_test_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        cdev_del(&amp;cdev);</span><br><span class="line">        pr_info(<span class="string">&quot;cdev is deleted\n&quot;</span>);</span><br><span class="line">        unregister_chrdev_region(dev_num, <span class="number">1</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;chrdev_region unregister success\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(cdev_test_init);</span><br><span class="line">module_exit(cdev_test_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;even629&lt;asqwgo@163.com&gt;&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;This is just a cdev test sample&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="设备结点"><a href="#设备结点" class="headerlink" title="设备结点"></a>设备结点</h2><p>在 Linux 操作系统中一切皆文件，对于<strong>用来进行设备访问的文件称之为设备节点</strong>。程序通过操作这个”设备文件”，便可以操作对应的硬件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">&quot;/dev/hello&quot;</span>, O_RDWR);</span><br></pre></td></tr></table></figure>

<p>这个“设备文件”就是设备结点。所以 Linux 设备结点是应用程序和驱动程序沟通的一个桥梁。设备节点被创建在&#x2F;dev 目录下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[zhaohang@cyberboy linux_driver_learning]$ ll /dev</span><br><span class="line">crw-------   4,15 root 11 Nov 10:05  tty15</span><br><span class="line">crw-------   4,16 root 11 Nov 10:05  tty16</span><br><span class="line">crw-------   4,17 root 11 Nov 10:05  tty17</span><br><span class="line">crw-------   4,18 root 11 Nov 10:05  tty18</span><br><span class="line">crw-------   4,19 root 11 Nov 10:05  tty19</span><br><span class="line">crw-------   4,20 root 11 Nov 10:05  tty20</span><br><span class="line">crw-------   4,21 root 11 Nov 10:05  tty21</span><br><span class="line">crw-------   4,22 root 11 Nov 10:05  tty22</span><br><span class="line">crw-------   4,23 root 11 Nov 10:05  tty23</span><br><span class="line">crw-------   4,24 root 11 Nov 10:05  tty24</span><br><span class="line">crw-------   4,25 root 11 Nov 10:05  tty25</span><br><span class="line">crw-------   4,26 root 11 Nov 10:05  tty26</span><br><span class="line">crw-------   4,27 root 11 Nov 10:05  tty27</span><br><span class="line">crw-------   4,28 root 11 Nov 10:05  tty28</span><br><span class="line">crw-------   4,29 root 11 Nov 10:05  tty29</span><br></pre></td></tr></table></figure>

<p><code>4,15</code>表示主设备号和次设备号。crw 中 c 表示字符设备。</p>
<p>根据设备节点的创建方式不同，分为了<strong>手动创建设备节点</strong>和<strong>自动创建设备节点</strong>。</p>
<h3 id="Linux-下创建结点的方式"><a href="#Linux-下创建结点的方式" class="headerlink" title="Linux 下创建结点的方式"></a>Linux 下创建结点的方式</h3><h4 id="手动创建设备结点"><a href="#手动创建设备结点" class="headerlink" title="手动创建设备结点"></a>手动创建设备结点</h4><p>使用 mknod 命令手动创建设备节点，mknod 命令格式为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mknod</span> NAME TYPE MAJOR MINOR</span><br></pre></td></tr></table></figure>

<p>参数含义：</p>
<ul>
<li><code>NAME</code>: 要创建的节点名称</li>
<li><code>TYPE</code>: b 表示块设备，c 表示字符设备，p 表示管道</li>
<li><code>MAJOR</code>：要链接设备的主设备号</li>
<li><code>MINOR</code>: 要链接设备的从设备号</li>
</ul>
<p>例如: 使用以下命令创建一个名为 device_test 的字符设备节点，设备的主设备号和从设备号分别为 236 和 0。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mknod</span> /dev/device_test c 236 0</span><br></pre></td></tr></table></figure>

<p>对于上面 file_operations 的示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ insmod cdev_test.ko</span><br><span class="line">[   43.969734] cdev_test: loading out-of-tree module taints kernel.</span><br><span class="line">[   43.979783] alloc_chrdev_region success</span><br><span class="line">[   43.980242] dev_num: major[241] minor[0]</span><br><span class="line">[   43.980277] cdev_init success</span><br><span class="line">[   43.981192] cdev_add success</span><br><span class="line">$ <span class="built_in">mknod</span> /dev/cdev_test c 241 0</span><br><span class="line">$ <span class="built_in">ls</span> /dev/cdev_test</span><br><span class="line">/dev/cdev_test</span><br><span class="line">$ <span class="built_in">cat</span> /dev/cdev_test</span><br><span class="line">[   68.723315] cdev_test open</span><br><span class="line">[   68.723900] cdev_test <span class="built_in">read</span></span><br></pre></td></tr></table></figure>

<h4 id="自动创建设备结点"><a href="#自动创建设备结点" class="headerlink" title="自动创建设备结点"></a>自动创建设备结点</h4><p>自动创建设备节点是利用 <strong>udev</strong> 机制来实现的。</p>
<p><strong>udev 是一个用户程序</strong>，通过检测系统中硬件设备状态，可以<strong>根据系统中硬件设备状态来创建或者删除设备文件</strong>。</p>
<p>自动创建设备节点<strong>需要在驱动中首先使用 class_create()函数创建一个类，创建的类位于于&#x2F;sys&#x2F;class&#x2F; 目录下</strong>，<strong>之后使用 device_create()函数在这个类下创建相应的设备</strong>，在加载驱动模块时，用户空间中的 udev 会自动响应根据并&#x2F;sys&#x2F;class&#x2F; 下的信息创建设备节点。</p>
<p>在嵌入式 Linux 中我们使用的是 mdev，<strong>mdev 是 udev 的简化版本</strong>。在使用 busybox 构建的跟文件系统的时候，busybox 会自动创建 mdev。</p>
<h5 id="class-create-函数"><a href="#class-create-函数" class="headerlink" title="class_create 函数"></a>class_create 函数</h5><p><strong>linux&#x2F;device&#x2F;class.h</strong></p>
<p>引用头文件使用 linux&#x2F;device&#x2F;device.h 因为 device.h 引用了 class.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This is a #define to keep the compiler from merging different</span></span><br><span class="line"><span class="comment"> * instances of the __key variable */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> class_create(owner, name)		\</span></span><br><span class="line"><span class="meta">(&#123;						\</span></span><br><span class="line"><span class="meta">	static struct lock_class_key __key;	\</span></span><br><span class="line"><span class="meta">	__class_create(owner, name, &amp;__key);	\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>函数作用</strong>：用于动态创建设备类。</li>
<li><strong>参数含义</strong>：<ul>
<li><code>owner</code>：struct module 结构体类型的指针。一般赋值为 THIS_MODULE。</li>
<li><code>name</code>：char 类型的指针，代表即将创建的 struct class 变量的名字。</li>
</ul>
</li>
<li><strong>返回值</strong>：<code>struct class *</code> 类型的结构体</li>
</ul>
<h5 id="class-destroy-函数"><a href="#class-destroy-函数" class="headerlink" title="class_destroy 函数"></a>class_destroy 函数</h5><p><strong>linux&#x2F;device&#x2F;class.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">class_destroy</span><span class="params">(<span class="keyword">struct</span> class *cls)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>函数作用：用于删除设备类。</li>
<li>参数含义：<ul>
<li><code>cls</code>：调用<code>class_create()</code>函数返回的<code>struct class</code>结构体的指针。</li>
</ul>
</li>
</ul>
<h5 id="device-create-函数"><a href="#device-create-函数" class="headerlink" title="device_create 函数"></a>device_create 函数</h5><p><strong>linux&#x2F;device&#x2F;device.h</strong></p>
<p>使用 class_create 创建好类以后，还需要使用 device_create 函数在类下面创建一个设备。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__printf(<span class="number">5</span>, <span class="number">6</span>) <span class="keyword">struct</span> device *</span><br><span class="line"><span class="title function_">device_create</span><span class="params">(<span class="keyword">struct</span> class *cls, <span class="keyword">struct</span> device *parent, <span class="type">dev_t</span> devt,</span></span><br><span class="line"><span class="params">	      <span class="type">void</span> *drvdata, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>函数作用：用来在 class 类下创建一个设备文件。</li>
<li>参数含义：<ul>
<li><code>cls</code>：指定所要创建的设备所从属的类。</li>
<li><code>parent</code>:指定该设备的父设备，如果没有就指定为 NULL。</li>
<li><code>devt</code>:指定创建设备的设备号。</li>
<li><code>drvdata</code>:被添加到该设备回调的数据，没有则指定为 NULL。</li>
<li><code>fmt</code>：添加到系统的设备节点名称。</li>
</ul>
</li>
<li>返回值：<code>struct device *</code> 类型结构体</li>
</ul>
<h5 id="device-destroy-函数"><a href="#device-destroy-函数" class="headerlink" title="device_destroy 函数"></a>device_destroy 函数</h5><p><strong>linux&#x2F;device&#x2F;device.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">device_destroy</span><span class="params">(<span class="keyword">struct</span> class *cls, <span class="type">dev_t</span> devt)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>函数作用</strong>：用来删除 class 类中的设备。</li>
<li>参数含义：<ul>
<li><code>cls</code>：指定所要创建的设备所从属的类。</li>
<li><code>devt</code>:指定创建设备的设备号。</li>
</ul>
</li>
</ul>
<h4 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> major = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">module_param(major, <span class="type">int</span>, S_IRUGO);</span><br><span class="line">MODULE_PARM_DESC(major, <span class="string">&quot;mknod_test dev major num&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> minor = <span class="number">0</span>;</span><br><span class="line">module_param(minor, <span class="type">int</span>, S_IRUGO);</span><br><span class="line">MODULE_PARM_DESC(minor, <span class="string">&quot;mknod_test dev minor num&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">dev_t</span> dev_num;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mknod_test_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span>&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;This is mknod_test open\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">mknod_test_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span>&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;This is mknod test read\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mknod_test_release</span> <span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span>&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;This is mknod test release\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">fops</span> =</span> &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .open = mknod_test_open,</span><br><span class="line">        .read = mknod_test_read,</span><br><span class="line">        .release = mknod_test_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">mknod_test_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">        pr_info(<span class="string">&quot;mknod_test module init\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (major) &#123;</span><br><span class="line">                dev_num = MKDEV(major, minor);</span><br><span class="line">                err = register_chrdev_region(dev_num, <span class="number">1</span>, <span class="string">&quot;mknod test device num&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        pr_err(<span class="string">&quot;register_chrdev_region error\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">goto</span> chrdev_region_err;</span><br><span class="line">                &#125;</span><br><span class="line">                pr_info(<span class="string">&quot;register_chrdev_region success\n&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                err = alloc_chrdev_region(&amp;dev_num, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;mknod test device num&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        pr_err(<span class="string">&quot;alloc_chrdev_region error\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">goto</span> chrdev_region_err;</span><br><span class="line">                &#125;</span><br><span class="line">                pr_info(<span class="string">&quot;alloc_chrdev_region success\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        pr_info(<span class="string">&quot;dev_t dev_num: major[%d], minor[%d]\n&quot;</span>, MAJOR(dev_num), MINOR(dev_num));</span><br><span class="line"></span><br><span class="line">        cdev_init(&amp;cdev, &amp;fops);</span><br><span class="line">        cdev.owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line">        err = cdev_add(&amp;cdev, dev_num, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;cdev add error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> cdev_add_err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">class</span> =</span> class_create(THIS_MODULE, <span class="string">&quot;chrdev&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(class)) &#123;</span><br><span class="line">                err = PTR_ERR(class);</span><br><span class="line">                pr_err(<span class="string">&quot;class_create error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> class_create_err;</span><br><span class="line">        &#125;</span><br><span class="line">        dev = device_create(class, <span class="literal">NULL</span>, dev_num, <span class="literal">NULL</span>, <span class="string">&quot;mknod_test_device&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(IS_ERR(dev))&#123;</span><br><span class="line">                err = PTR_ERR(dev);</span><br><span class="line">                pr_err(<span class="string">&quot;device create error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> device_create_err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> device_create_err:</span><br><span class="line">        class_destroy(class);</span><br><span class="line">class_create_err:</span><br><span class="line">        cdev_del(&amp;cdev);</span><br><span class="line">cdev_add_err:</span><br><span class="line">        unregister_chrdev_region(dev_num, <span class="number">1</span>);</span><br><span class="line">chrdev_region_err:</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">mknod_test_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        device_destroy(class, dev_num);</span><br><span class="line">        class_destroy(class);</span><br><span class="line">        cdev_del(&amp;cdev);</span><br><span class="line">        unregister_chrdev_region(dev_num, <span class="number">1</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;mknod_test module exit\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(mknod_test_init);</span><br><span class="line">module_exit(mknod_test_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;even629&lt;asqwgo@163.com&gt;&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;This is just mknod test sample&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ insmod mknod_test.ko</span><br><span class="line">[   11.793662] mknod_test: loading out-of-tree module taints kernel.</span><br><span class="line">[   11.803110] mknod_test module init</span><br><span class="line">[   11.803371] alloc_chrdev_region success</span><br><span class="line">[   11.804103] dev_t dev_num: major[241], minor[0]</span><br><span class="line">$ <span class="built_in">ls</span> /dev/mknod_test_device</span><br><span class="line">/dev/mknod_test_device</span><br><span class="line">$ <span class="built_in">cat</span> /dev/mknod_test_device</span><br><span class="line">[   22.546620] This is mknod_test open</span><br><span class="line">[   22.547827] This is <span class="built_in">mknod</span> <span class="built_in">test</span> <span class="built_in">read</span></span><br><span class="line">[   22.548435] This is <span class="built_in">mknod</span> <span class="built_in">test</span> release</span><br><span class="line">$ rmmod mknod_test.ko</span><br><span class="line">[   28.103036] mknod_test module <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h2 id="用户空间和内核空间的数据交换"><a href="#用户空间和内核空间的数据交换" class="headerlink" title="用户空间和内核空间的数据交换"></a>用户空间和内核空间的数据交换</h2><p>内核空间和用户空间的内存是不能互相访问的。但是很多应用程序都需要和内核进行数据的交换，例如应用程序使用 <code>read()</code>函数从驱动中读取数据，使用 <code>write()</code>函数向驱动中写数据，上述功能就需要使用 <code>copy_from_user()</code>和 <code>copy_to_user()</code>俩个函数来完成。</p>
<ul>
<li><code>copy_from_user()</code>函数是将用户空间的数据拷贝到内核空间。</li>
<li><code>copy_to_user()</code>函数是将内核空间的数据拷贝到用户空间。</li>
</ul>
<blockquote>
<p>用户空间—-&gt;内核空间</p>
<ul>
<li>系统调用</li>
<li>软中断</li>
<li>硬件中断</li>
</ul>
</blockquote>
<p><strong>include&#x2F;linux&#x2F;uaccess.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Architectures should provide two primitives (raw_copy_&#123;to,from&#125;_user())</span></span><br><span class="line"><span class="comment"> * and get rid of their private instances of copy_&#123;to,from&#125;_user() and</span></span><br><span class="line"><span class="comment"> * __copy_&#123;to,from&#125;_user&#123;,_inatomic&#125;().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * raw_copy_&#123;to,from&#125;_user(to, from, size) should copy up to size bytes and</span></span><br><span class="line"><span class="comment"> * return the amount left to copy.  They should assume that access_ok() has</span></span><br><span class="line"><span class="comment"> * already been checked (and succeeded); they should *not* zero-pad anything.</span></span><br><span class="line"><span class="comment"> * No KASAN or object size checks either - those belong here.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Both of these functions should attempt to copy size bytes starting at from</span></span><br><span class="line"><span class="comment"> * into the area starting at to.  They must not fetch or store anything</span></span><br><span class="line"><span class="comment"> * outside of those areas.  Return value must be between 0 (everything</span></span><br><span class="line"><span class="comment"> * copied successfully) and size (nothing copied).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If raw_copy_&#123;to,from&#125;_user(to, from, size) returns N, size - N bytes starting</span></span><br><span class="line"><span class="comment"> * at to must become equal to the bytes fetched from the corresponding area</span></span><br><span class="line"><span class="comment"> * starting at from.  All data past to + size - N must be left unmodified.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If copying succeeds, the return value must be 0.  If some data cannot be</span></span><br><span class="line"><span class="comment"> * fetched, it is permitted to copy less than had been fetched; the only</span></span><br><span class="line"><span class="comment"> * hard requirement is that not storing anything at all (i.e. returning size)</span></span><br><span class="line"><span class="comment"> * should happen only when nothing could be copied.  In other words, you don&#x27;t</span></span><br><span class="line"><span class="comment"> * have to squeeze as much as possible - it is allowed, but not necessary.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For raw_copy_from_user() to always points to kernel memory and no faults</span></span><br><span class="line"><span class="comment"> * on store should happen.  Interpretation of from is affected by set_fs().</span></span><br><span class="line"><span class="comment"> * For raw_copy_to_user() it&#x27;s the other way round.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Both can be inlined - it&#x27;s up to architectures whether it wants to bother</span></span><br><span class="line"><span class="comment"> * with that.  They should not be used directly; they are used to implement</span></span><br><span class="line"><span class="comment"> * the 6 functions (copy_&#123;to,from&#125;_user(), __copy_&#123;to,from&#125;_user_inatomic())</span></span><br><span class="line"><span class="comment"> * that are used instead.  Out of those, __... ones are inlined.  Plain</span></span><br><span class="line"><span class="comment"> * copy_&#123;to,from&#125;_user() might or might not be inlined.  If you want them</span></span><br><span class="line"><span class="comment"> * inlined, have asm/uaccess.h define INLINE_COPY_&#123;TO,FROM&#125;_USER.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> only copy_from_user() zero-pads the destination in case of short copy.</span></span><br><span class="line"><span class="comment"> * Neither __copy_from_user() nor __copy_from_user_inatomic() zero anything</span></span><br><span class="line"><span class="comment"> * at all; their callers absolutely must check the return value.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Biarch ones should also provide raw_copy_in_user() - similar to the above,</span></span><br><span class="line"><span class="comment"> * but both source and destination are __user pointers (affected by set_fs()</span></span><br><span class="line"><span class="comment"> * as usual) and both source and destination can trigger faults.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline __must_check <span class="type">unsigned</span> <span class="type">long</span></span><br><span class="line">__copy_from_user_inatomic(<span class="type">void</span> *to, <span class="type">const</span> <span class="type">void</span> __user *from, <span class="type">unsigned</span> <span class="type">long</span> n)</span><br><span class="line">&#123;</span><br><span class="line">	instrument_copy_from_user(to, from, n);</span><br><span class="line">	check_object_size(to, n, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">return</span> raw_copy_from_user(to, from, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline __must_check <span class="type">unsigned</span> <span class="type">long</span></span><br><span class="line">__copy_from_user(<span class="type">void</span> *to, <span class="type">const</span> <span class="type">void</span> __user *from, <span class="type">unsigned</span> <span class="type">long</span> n)</span><br><span class="line">&#123;</span><br><span class="line">	might_fault();</span><br><span class="line">	<span class="keyword">if</span> (should_fail_usercopy())</span><br><span class="line">		<span class="keyword">return</span> n;</span><br><span class="line">	instrument_copy_from_user(to, from, n);</span><br><span class="line">	check_object_size(to, n, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">return</span> raw_copy_from_user(to, from, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * __copy_to_user_inatomic: - Copy a block of data into user space, with less checking.</span></span><br><span class="line"><span class="comment"> * @to:   Destination address, in user space.</span></span><br><span class="line"><span class="comment"> * @from: Source address, in kernel space.</span></span><br><span class="line"><span class="comment"> * @n:    Number of bytes to copy.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Context: User context only.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Copy data from kernel space to user space.  Caller must check</span></span><br><span class="line"><span class="comment"> * the specified block with access_ok() before calling this function.</span></span><br><span class="line"><span class="comment"> * The caller should also make sure he pins the user space address</span></span><br><span class="line"><span class="comment"> * so that we don&#x27;t result in page fault and sleep.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> __always_inline __must_check <span class="type">unsigned</span> <span class="type">long</span></span><br><span class="line">__copy_to_user_inatomic(<span class="type">void</span> __user *to, <span class="type">const</span> <span class="type">void</span> *from, <span class="type">unsigned</span> <span class="type">long</span> n)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (should_fail_usercopy())</span><br><span class="line">		<span class="keyword">return</span> n;</span><br><span class="line">	instrument_copy_to_user(to, from, n);</span><br><span class="line">	check_object_size(from, n, <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">return</span> raw_copy_to_user(to, from, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline __must_check <span class="type">unsigned</span> <span class="type">long</span></span><br><span class="line">__copy_to_user(<span class="type">void</span> __user *to, <span class="type">const</span> <span class="type">void</span> *from, <span class="type">unsigned</span> <span class="type">long</span> n)</span><br><span class="line">&#123;</span><br><span class="line">	might_fault();</span><br><span class="line">	<span class="keyword">if</span> (should_fail_usercopy())</span><br><span class="line">		<span class="keyword">return</span> n;</span><br><span class="line">	instrument_copy_to_user(to, from, n);</span><br><span class="line">	check_object_size(from, n, <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">return</span> raw_copy_to_user(to, from, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> INLINE_COPY_FROM_USER</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> __must_check <span class="type">unsigned</span> <span class="type">long</span></span><br><span class="line">_copy_from_user(<span class="type">void</span> *to, <span class="type">const</span> <span class="type">void</span> __user *from, <span class="type">unsigned</span> <span class="type">long</span> n)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> res = n;</span><br><span class="line">	might_fault();</span><br><span class="line">	<span class="keyword">if</span> (!should_fail_usercopy() &amp;&amp; likely(access_ok(from, n))) &#123;</span><br><span class="line">		instrument_copy_from_user(to, from, n);</span><br><span class="line">		res = raw_copy_from_user(to, from, n);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(res))</span><br><span class="line">		<span class="built_in">memset</span>(to + (n - res), <span class="number">0</span>, res);</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">extern</span> __must_check <span class="type">unsigned</span> <span class="type">long</span></span><br><span class="line">_copy_from_user(<span class="type">void</span> *, <span class="type">const</span> <span class="type">void</span> __user *, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> INLINE_COPY_TO_USER</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> __must_check <span class="type">unsigned</span> <span class="type">long</span></span><br><span class="line">_copy_to_user(<span class="type">void</span> __user *to, <span class="type">const</span> <span class="type">void</span> *from, <span class="type">unsigned</span> <span class="type">long</span> n)</span><br><span class="line">&#123;</span><br><span class="line">	might_fault();</span><br><span class="line">	<span class="keyword">if</span> (should_fail_usercopy())</span><br><span class="line">		<span class="keyword">return</span> n;</span><br><span class="line">	<span class="keyword">if</span> (access_ok(to, n)) &#123;</span><br><span class="line">		instrument_copy_to_user(to, from, n);</span><br><span class="line">		n = raw_copy_to_user(to, from, n);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">extern</span> __must_check <span class="type">unsigned</span> <span class="type">long</span></span><br><span class="line">_copy_to_user(<span class="type">void</span> __user *, <span class="type">const</span> <span class="type">void</span> *, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">unsigned</span> <span class="type">long</span> __must_check</span><br><span class="line"><span class="title function_">copy_from_user</span><span class="params">(<span class="type">void</span> *to, <span class="type">const</span> <span class="type">void</span> __user *from, <span class="type">unsigned</span> <span class="type">long</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (likely(check_copy_size(to, n, <span class="literal">false</span>)))</span><br><span class="line">		n = _copy_from_user(to, from, n);</span><br><span class="line">	<span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">unsigned</span> <span class="type">long</span> __must_check</span><br><span class="line"><span class="title function_">copy_to_user</span><span class="params">(<span class="type">void</span> __user *to, <span class="type">const</span> <span class="type">void</span> *from, <span class="type">unsigned</span> <span class="type">long</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (likely(check_copy_size(from, n, <span class="literal">true</span>)))</span><br><span class="line">		n = _copy_to_user(to, from, n);</span><br><span class="line">	<span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">unsigned</span> <span class="type">long</span> __must_check</span><br><span class="line"><span class="title function_">copy_in_user</span><span class="params">(<span class="type">void</span> __user *to, <span class="type">const</span> <span class="type">void</span> __user *from, <span class="type">unsigned</span> <span class="type">long</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	might_fault();</span><br><span class="line">	<span class="keyword">if</span> (access_ok(to, n) &amp;&amp; access_ok(from, n))</span><br><span class="line">		n = raw_copy_in_user(to, from, n);</span><br><span class="line">	<span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> copy_mc_to_kernel</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Without arch opt-in this generic copy_mc_to_kernel() will not handle</span></span><br><span class="line"><span class="comment"> * #MC (or arch equivalent) during source read.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">long</span> __must_check</span><br><span class="line"><span class="title function_">copy_mc_to_kernel</span><span class="params">(<span class="type">void</span> *dst, <span class="type">const</span> <span class="type">void</span> *src, <span class="type">size_t</span> cnt)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">memcpy</span>(dst, src, cnt);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>整体调用链如下</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">copy_from_user</span>(to, from, n)</span><br><span class="line"> └─ <span class="built_in">check_copy_size</span>(to, n, false)   <span class="comment">// 编译时对象大小检查（FORTIFY_SOURCE）</span></span><br><span class="line">    └─ <span class="built_in">_copy_from_user</span>(to, from, n)</span><br><span class="line">       ├─ <span class="built_in">might_fault</span>()               <span class="comment">// 标记可能引起页错误（调度点）</span></span><br><span class="line">       ├─ <span class="built_in">should_fail_usercopy</span>()      <span class="comment">// 故障注入（用于测试）</span></span><br><span class="line">       ├─ <span class="built_in">access_ok</span>(from, n)          <span class="comment">// 检查用户指针是否合法（关键！）</span></span><br><span class="line">       ├─ <span class="built_in">instrument_copy_from_user</span>() <span class="comment">// KASAN / UBSAN 检测</span></span><br><span class="line">       ├─ <span class="built_in">raw_copy_from_user</span>(...)     <span class="comment">// 实际拷贝（arch-specific）</span></span><br><span class="line">       └─ if (res) <span class="built_in">memset</span>(..., <span class="number">0</span>, res) <span class="comment">// **Zero-padding!**</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p><strong>Zero-padding</strong>: 如果只拷贝了部分数据（比如因为页错误），<strong>剩余未拷贝的部分会被清零</strong>。这是为了防止内核信息泄露（例如栈上未初始化内存被用户读到）。</p>
</li>
<li><p><code>access_ok()</code>：确保 <code>from</code> 指向用户空间且长度合法（防止访问内核地址）</p>
</li>
<li><p><code>check_object_size()</code>：防止缓冲区溢出（配合 FORTIFY_SOURCE）</p>
</li>
<li><p><code>instrument_*</code>：KASAN 检测越界访问</p>
</li>
</ul>
<p>即使拷贝失败，也不会 panic，而是返回未拷贝字节数，驱动可据此处理。</p>
</blockquote>
<h3 id="copy-to-user-函数"><a href="#copy-to-user-函数" class="headerlink" title="copy_to_user()函数"></a>copy_to_user()函数</h3><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">unsigned</span> <span class="type">long</span> __must_check</span><br><span class="line"><span class="title function_">copy_to_user</span><span class="params">(<span class="type">void</span> __user *to, <span class="type">const</span> <span class="type">void</span> *from, <span class="type">unsigned</span> <span class="type">long</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (likely(check_copy_size(from, n, <span class="literal">true</span>)))</span><br><span class="line">		n = _copy_to_user(to, from, n);</span><br><span class="line">	<span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>函数作用：把内核空间的数据复制到用户空间。</li>
<li>参数含义：<ul>
<li><code>*to</code> 是用户空间的指针</li>
<li><code>from</code> 是内核空间的指针</li>
<li><code>n</code> 是从内核空间向用户空间拷贝的字节数</li>
</ul>
</li>
<li>返回值：等于 0 表示成功，其他表示失败</li>
</ul>
<h3 id="copy-from-user-函数"><a href="#copy-from-user-函数" class="headerlink" title="copy_from_user()函数"></a>copy_from_user()函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">unsigned</span> <span class="type">long</span> __must_check</span><br><span class="line"><span class="title function_">copy_from_user</span><span class="params">(<span class="type">void</span> *to, <span class="type">const</span> <span class="type">void</span> __user *from, <span class="type">unsigned</span> <span class="type">long</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (likely(check_copy_size(to, n, <span class="literal">false</span>)))</span><br><span class="line">		n = _copy_from_user(to, from, n);</span><br><span class="line">	<span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>函数作用：把用户空间的数据复制到内核空间。</li>
<li>参数含义<ul>
<li><code>*to</code> 是内核空间的指针</li>
<li><code>from</code> 是用户空间的指针</li>
<li><code>n</code> 是从用户空间向内核空间拷贝的字节数</li>
</ul>
</li>
<li>返回值：等于 0 表示成功，其他表示失败</li>
</ul>
<h3 id="示例-4"><a href="#示例-4" class="headerlink" title="示例"></a>示例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;linux/printk.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/moduleparam.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> major = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> minor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">module_param(major, <span class="type">int</span>, S_IRUGO);</span><br><span class="line">module_param(minor, <span class="type">int</span>, S_IRUGO);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">dev_t</span> dev_id;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev_test</span>;</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cdev_test_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">	pr_info(<span class="string">&quot;cdev_test_open was called&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">cdev_test_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">		       <span class="type">loff_t</span> *off)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> kbuf[] = <span class="string">&quot;This is my_driver read\n&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(buf, kbuf, <span class="built_in">strlen</span>(kbuf)) != <span class="number">0</span>) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;copy kbuf to buf from kernel error\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	pr_info(<span class="string">&quot;copy kbuf to buf from kernel ok\n&quot;</span>);</span><br><span class="line">	pr_info(<span class="string">&quot;cdev_test_read was called&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">cdev_test_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">			<span class="type">loff_t</span> *off)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> kbuf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(kbuf, buf, size) != <span class="number">0</span>) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;copy buf to kbuf from kernel error\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	printk(<span class="string">&quot;read from user: %s&quot;</span>, kbuf);</span><br><span class="line">	pr_info(<span class="string">&quot;cdev_test_write was called&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">cdev_test_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">	pr_info(<span class="string">&quot;cdev_test_release was called&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">cdev_test_ops</span> =</span> &#123; .owner = THIS_MODULE,</span><br><span class="line">						.open = cdev_test_open,</span><br><span class="line">						.read = cdev_test_read,</span><br><span class="line">						.write = cdev_test_write,</span><br><span class="line">						.release = cdev_test_release &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">my_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (major) &#123;</span><br><span class="line">		dev_id = MKDEV(major, minor);</span><br><span class="line"></span><br><span class="line">		pr_info(<span class="string">&quot;major from module_param: %d&quot;</span>, MAJOR(dev_id));</span><br><span class="line">		pr_info(<span class="string">&quot;minor from module_param: %d&quot;</span>, MINOR(dev_id));</span><br><span class="line"></span><br><span class="line">		ret = register_chrdev_region(dev_id, <span class="number">1</span>, <span class="string">&quot;my_driver device&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			pr_err(<span class="string">&quot;register_chrdev_region error\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			pr_info(<span class="string">&quot;register_chrdev_region ok\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ret = alloc_chrdev_region(&amp;dev_id, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;my_driver device&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			pr_err(<span class="string">&quot;alloc_chrdev_region error\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			pr_info(<span class="string">&quot;alloc_chrdev_region ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">			pr_info(<span class="string">&quot;major allocated: %d&quot;</span>, MAJOR(dev_id));</span><br><span class="line">			pr_info(<span class="string">&quot;minor allocated: %d&quot;</span>, MINOR(dev_id));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cdev_init(&amp;cdev_test, &amp;cdev_test_ops);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将 owner 字段指向本模块，可以避免在模块的操作正在被使用时卸载该模块</span></span><br><span class="line">	cdev_test.owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line">	ret = cdev_add(&amp;cdev_test, dev_id, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;cdev_add error\n&quot;</span>);</span><br><span class="line">		unregister_chrdev_region(dev_id, <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		pr_info(<span class="string">&quot;cdev_add ok\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> =</span> class_create(THIS_MODULE, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">	<span class="comment">// /dev/my_driver</span></span><br><span class="line">	device = device_create(class, <span class="literal">NULL</span>, dev_id, <span class="literal">NULL</span>, <span class="string">&quot;my_driver&quot;</span>);</span><br><span class="line">	pr_info(<span class="string">&quot;my_driver: Module loaded\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">my_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 删除设备结点</span></span><br><span class="line">	device_destroy(class, dev_id);</span><br><span class="line">	<span class="comment">// 删除该设备结点的class</span></span><br><span class="line">	class_destroy(class);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 删除cdev</span></span><br><span class="line">	cdev_del(&amp;cdev_test);</span><br><span class="line">	<span class="comment">// 释放设备号</span></span><br><span class="line">	unregister_chrdev_region(dev_id, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;unregister_chrdev_region ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;my_driver: Module unloaded\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_driver_init);</span><br><span class="line">module_exit(my_driver_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Zhao Hang&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;my_driver Kernel Module&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<p>测试代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret, fd;</span><br><span class="line"></span><br><span class="line">	fd = open(<span class="string">&quot;/dev/my_driver&quot;</span>, O_RDWR);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;open /dev/my_driver error\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> rbuf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	ret = read(fd, rbuf, <span class="keyword">sizeof</span>(rbuf));</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;read error\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;read from driver:%s\n&quot;</span>, rbuf);</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> wbuf[<span class="number">32</span>] = <span class="string">&quot;hello world\n&quot;</span>;</span><br><span class="line">	ret = write(fd, wbuf, <span class="keyword">sizeof</span>(wbuf));</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;write error\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line">success:</span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>makefile</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">TARGET_EXEC := test</span><br><span class="line">SRC_DIRS := ./</span><br><span class="line">BUILD_DIR := ./build</span><br><span class="line"></span><br><span class="line">CC = aarch64-linux-gnu-gcc</span><br><span class="line">CFLAGS = -g -Wall</span><br><span class="line"></span><br><span class="line"><span class="comment"># 源文件收集</span></span><br><span class="line">SRCS := <span class="variable">$(<span class="built_in">shell</span> find <span class="variable">$(SRC_DIRS)</span> -name &#x27;*.c&#x27; -<span class="built_in">or</span> -name &#x27;*.s&#x27; -<span class="built_in">or</span> -name &#x27;*.S&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标文件映射</span></span><br><span class="line">OBJS := <span class="variable">$(<span class="built_in">patsubst</span> %.c,<span class="variable">$(BUILD_DIR)</span>/%.o,<span class="variable">$(SRCS)</span>)</span></span><br><span class="line">OBJS := <span class="variable">$(<span class="built_in">patsubst</span> %.s,<span class="variable">$(BUILD_DIR)</span>/%.o,<span class="variable">$(OBJS)</span>)</span></span><br><span class="line">OBJS := <span class="variable">$(<span class="built_in">patsubst</span> %.S,<span class="variable">$(BUILD_DIR)</span>/%.o,<span class="variable">$(OBJS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含路径</span></span><br><span class="line">INC_DIRS := <span class="variable">$(<span class="built_in">shell</span> find <span class="variable">$(SRC_DIRS)</span> -type d)</span></span><br><span class="line">INC_FLAGS := <span class="variable">$(<span class="built_in">addprefix</span> -I,<span class="variable">$(INC_DIRS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动生成依赖文件</span></span><br><span class="line">CPPFLAGS := <span class="variable">$(INC_FLAGS)</span> -MMD -MP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接最终可执行文件</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/<span class="variable">$(TARGET_EXEC)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line">	@mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(OBJS)</span> -o <span class="variable">$@</span> <span class="variable">$(LDFLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译规则 (C)</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.o: %.c</span><br><span class="line">	@mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CPPFLAGS)</span> <span class="variable">$(CFLAGS)</span> -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译规则 (汇编)</span></span><br><span class="line"><span class="comment"># 不需要预处理的汇编代码</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.o: %.s</span><br><span class="line">	@mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CPPFLAGS)</span> <span class="variable">$(CFLAGS)</span> -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要预处理的汇编代码</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.o: %.S</span><br><span class="line">	@mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CPPFLAGS)</span> <span class="variable">$(CFLAGS)</span> -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean deploy</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf <span class="variable">$(BUILD_DIR)</span></span><br><span class="line"><span class="section">deploy:</span></span><br><span class="line">	cp <span class="variable">$(BUILD_DIR)</span>/<span class="variable">$(TARGET_EXEC)</span> ~/tftp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动依赖包含</span></span><br><span class="line"><span class="keyword">-include</span> $(OBJS:.o=.d)</span><br></pre></td></tr></table></figure>

<p>测试输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~ <span class="comment"># insmod my_driver.ko</span></span><br><span class="line">[    7.250701] my_driver: loading out-of-tree module taints kernel.</span><br><span class="line">[    7.257204] alloc_chrdev_region ok</span><br><span class="line">[    7.257387] major allocated: 511</span><br><span class="line">[    7.257406] minor allocated: 0</span><br><span class="line">[    7.257563] cdev_add ok</span><br><span class="line">[    7.258587] my_driver: Module loaded</span><br><span class="line">~ <span class="comment"># mdev -s</span></span><br><span class="line">~ <span class="comment"># ./test</span></span><br><span class="line">[   18.006803] cdev_test_open was called</span><br><span class="line">[   18.007016] copy kbuf to buf from kernel ok</span><br><span class="line"><span class="built_in">read</span> from driver:This is my_driver <span class="built_in">read</span></span><br><span class="line"></span><br><span class="line">[   18.007275] cdev_test_read was called</span><br><span class="line">[   18.010813] <span class="built_in">read</span> from user: hello world</span><br><span class="line">[   18.011205] cdev_test_write was called</span><br></pre></td></tr></table></figure>

<h2 id="文件私有数据"><a href="#文件私有数据" class="headerlink" title="文件私有数据"></a>文件私有数据</h2><blockquote>
<p>通常在驱动开发中会<strong>为设备自定义设备结构体</strong>并<strong>将设备结构体设置为文件私有数据</strong>。设备结构体用来存放硬件相关信息，如设备号、类、设备名称等。</p>
</blockquote>
<p><strong>Linux 中并没有明确规定要必须要使用文件私有数据</strong>，但是在 linux 驱动源码中随处可见文件私有数据，因此可以认为使用文件私有数据是 Linux 驱动遵循的“潜规则”，实际上文件私有数据也体现了 Linux 面向对象的思想。</p>
<p>文件私有数据就是将私有数据 private_data 指向设备结构体。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_test</span> <span class="title">dev1</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cdev_test_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span>&#123;</span><br><span class="line">    file-&gt;private_data = &amp;dev1;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 read, write 等函数中通过 private_data 访问设备结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">cdev_test_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *<span class="type">off_t</span>)</span>&#123;</span><br><span class="line">    	<span class="class"><span class="keyword">struct</span> <span class="title">device_test</span> *<span class="title">test_dev</span> =</span> (<span class="keyword">struct</span> device_test *)file-&gt;private_data;</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>用全局变量也可以实现这样的功能，但是随着驱动代码复杂度增多，使用 private_data 更利于管理</p>
</blockquote>
<h3 id="示例-5"><a href="#示例-5" class="headerlink" title="示例"></a>示例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> major = <span class="number">0</span>;</span><br><span class="line">module_param(major, <span class="type">int</span>, S_IRUGO);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;device num: major&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> minor = <span class="number">0</span>;</span><br><span class="line">module_param(minor, <span class="type">int</span>, S_IRUGO);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;device num: minor&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> buf[] = <span class="string">&quot;Hello World from kernel\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">test_data</span> &#123;</span></span><br><span class="line">        <span class="type">dev_t</span> dev_num;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">        <span class="type">char</span> kbuf[<span class="number">32</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">test_data</span> *<span class="title">dat</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">file_private_test_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;file_private_test_open is called\n&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置私有数据</span></span><br><span class="line">        file-&gt;private_data = dat;</span><br><span class="line">        pr_info(<span class="string">&quot;file-&gt;private_data is set\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">file_private_test_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">test_data</span> *<span class="title">data</span>;</span></span><br><span class="line">        <span class="type">size_t</span> len;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*offset != <span class="number">0</span>) &#123; <span class="comment">// EOF</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        data = file-&gt;private_data;</span><br><span class="line">        len = min(size, <span class="built_in">strlen</span>(dat-&gt;kbuf));</span><br><span class="line"></span><br><span class="line">        pr_info(<span class="string">&quot;file_private_test_read is called\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(buf, data-&gt;kbuf, len) != <span class="number">0</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;copy_to_user error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *offset += len;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">sizeof</span>(data-&gt;kbuf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">file_private_test_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;file_private_test_release is called\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">fops</span> =</span> &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .open = file_private_test_open,</span><br><span class="line">        .read = file_private_test_read,</span><br><span class="line">        .release = file_private_test_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">file_private_test_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">        pr_info(<span class="string">&quot;file_private_test init\n&quot;</span>);</span><br><span class="line">        dat = (<span class="keyword">struct</span> test_data *)kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> test_data), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dat == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;no memory\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> kmalloc_fail;</span><br><span class="line">        &#125;</span><br><span class="line">        strscpy(dat-&gt;kbuf, buf, <span class="keyword">sizeof</span>(dat-&gt;kbuf));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 申请设备号</span></span><br><span class="line">        <span class="keyword">if</span> (major) &#123;</span><br><span class="line">                dat-&gt;dev_num = MKDEV(major, minor);</span><br><span class="line">                err = register_chrdev_region(dat-&gt;dev_num, <span class="number">1</span>, <span class="string">&quot;file_private_test chrdev region&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        pr_err(<span class="string">&quot;register_chrdev_region error\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">goto</span> chrdev_region_fail;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                err = alloc_chrdev_region(&amp;dat-&gt;dev_num, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;file_private_test chrdev region&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        pr_err(<span class="string">&quot;register_chrdev_region error\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">goto</span> chrdev_region_fail;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 添加cdev</span></span><br><span class="line">        cdev_init(&amp;dat-&gt;cdev, &amp;fops);</span><br><span class="line">        err = cdev_add(&amp;dat-&gt;cdev, dat-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;cdev_add error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> cdev_add_fail;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建设备节点</span></span><br><span class="line">        dat-&gt;<span class="class"><span class="keyword">class</span> =</span> class_create(THIS_MODULE, <span class="string">&quot;char_test&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(dat-&gt;class)) &#123;</span><br><span class="line">                err = PTR_ERR(dat-&gt;class);</span><br><span class="line">                pr_err(<span class="string">&quot;create class error&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> class_create_fail;</span><br><span class="line">        &#125;</span><br><span class="line">        dat-&gt;dev = device_create(dat-&gt;class, <span class="literal">NULL</span>, dat-&gt;dev_num, <span class="literal">NULL</span>, <span class="string">&quot;char_test_dev&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(dat-&gt;dev)) &#123;</span><br><span class="line">                err = PTR_ERR(dat-&gt;dev);</span><br><span class="line">                pr_err(<span class="string">&quot;create device error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> device_create_fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">device_create_fail:</span><br><span class="line">        class_destroy(dat-&gt;class);</span><br><span class="line">class_create_fail:</span><br><span class="line">        cdev_del(&amp;dat-&gt;cdev);</span><br><span class="line">cdev_add_fail:</span><br><span class="line">        unregister_chrdev_region(dat-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">chrdev_region_fail:</span><br><span class="line">        kfree(dat);</span><br><span class="line">kmalloc_fail:</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">file_private_test_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        device_destroy(dat-&gt;class, dat-&gt;dev_num);</span><br><span class="line">        class_destroy(dat-&gt;class);</span><br><span class="line">        cdev_del(&amp;dat-&gt;cdev);</span><br><span class="line">        unregister_chrdev_region(dat-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">        kfree(dat);</span><br><span class="line">        pr_info(<span class="string">&quot;file_private_test exit\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(file_private_test_init);</span><br><span class="line">module_exit(file_private_test_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;even629&lt;asqwgo@163.com&gt;&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;This is a test sample for file private data&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ insmod file_private_data_test.ko</span><br><span class="line">[    8.022277] file_private_data_test: loading out-of-tree module taints kernel.</span><br><span class="line">[    8.032581] file_private_test init</span><br><span class="line">$ <span class="built_in">cat</span> /dev/char_test_dev</span><br><span class="line">[   14.998329] file_private_test_open is called</span><br><span class="line">[   14.998580] file-&gt;private_data is <span class="built_in">set</span></span><br><span class="line">[   14.999659] file_private_test_read is called</span><br><span class="line">Hello World from kernel</span><br><span class="line">[   15.000469] file_private_test_release is called</span><br></pre></td></tr></table></figure>

<h3 id="使用文件私有数据的场景"><a href="#使用文件私有数据的场景" class="headerlink" title="使用文件私有数据的场景"></a>使用文件私有数据的场景</h3><p>在 Linux 中，使用主设备号来表示对应的某一类驱动。用次设备号表示这类驱动下的各个设备。</p>
<p>假如现在我们的驱动<strong>要支持主设备相同，但是次设备号不同的设备</strong>。我们的驱动就可以利用文件私有数据来写。</p>
<h4 id="container-of-宏"><a href="#container-of-宏" class="headerlink" title="container_of 宏"></a>container_of 宏</h4><p><strong>include&#x2F;linux&#x2F;kernel.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> container_of(ptr, type, member) (&#123;				\</span></span><br><span class="line"><span class="meta">	void *__mptr = (void *)(ptr);					\</span></span><br><span class="line"><span class="meta">	BUILD_BUG_ON_MSG(!__same_type(*(ptr), ((type *)0)-&gt;member) &amp;&amp;	\</span></span><br><span class="line"><span class="meta">			 !__same_type(*(ptr), void),			\</span></span><br><span class="line"><span class="meta">			 <span class="string">&quot;pointer type mismatch in container_of()&quot;</span>);	\</span></span><br><span class="line"><span class="meta">	((type *)(__mptr - offsetof(type, member))); &#125;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>ptr</code> 指向结构体中某个成员的指针。</p>
</li>
<li><p><code>type</code> 目标结构体类型。</p>
</li>
<li><p><code>member</code> 成员在结构体中的名字。</p>
</li>
<li><p><code>BUILD_BUG_ON_MSG(...)</code> 编译期类型检查，保证 ptr 和结构体成员类型一致，避免类型错误。</p>
</li>
<li><p><code>__mptr - offsetof(type, member)</code> 核心公式：用成员指针减去该成员在结构体中的偏移，得到结构体起始地址。</p>
</li>
<li><p><code>offsetof(type, member)</code> 标准宏，计算成员在结构体内的字节偏移。</p>
</li>
</ul>
<h4 id="示例-6"><a href="#示例-6" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KBUF_SIZE 32</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">container_data</span> &#123;</span></span><br><span class="line">        <span class="type">dev_t</span> dev_num;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">        <span class="type">char</span> kbuf[KBUF_SIZE];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">container_data</span> *<span class="title">dat1</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">container_data</span> *<span class="title">dat2</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">container_of_test_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">container_data</span> *<span class="title">dat</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过container_of获取特定的container_data</span></span><br><span class="line">        dat = container_of(inode-&gt;i_cdev, <span class="keyword">struct</span> container_data, cdev);</span><br><span class="line">        file-&gt;private_data = dat;</span><br><span class="line"></span><br><span class="line">        pr_info(<span class="string">&quot;container_of_test_open is called, dev major: %d, dev minor: %d\n&quot;</span>,</span><br><span class="line">                MAJOR(dat-&gt;dev_num), MINOR(dat-&gt;dev_num));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">container_of_test_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">container_data</span> *<span class="title">dat</span> =</span> file-&gt;private_data;</span><br><span class="line">        <span class="type">size_t</span> kbuf_len = <span class="built_in">strlen</span>(dat-&gt;kbuf);</span><br><span class="line">        <span class="type">size_t</span> len = min(size, (<span class="type">size_t</span>)(kbuf_len - *offset));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*offset &gt;= kbuf_len)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(buf, dat-&gt;kbuf + *offset, len))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">        *offset += len;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">container_of_test_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">                                <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">container_data</span> *<span class="title">dat</span> =</span> file-&gt;private_data;</span><br><span class="line">        <span class="type">size_t</span> bytes = min(size, (<span class="type">size_t</span>)(KBUF_SIZE - <span class="number">1</span> - *offset));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*offset &gt;= KBUF_SIZE - <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span> -ENOSPC;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(dat-&gt;kbuf + *offset, buf, bytes) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">        *offset += bytes;</span><br><span class="line">        dat-&gt;kbuf[*offset] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">container_of_test_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;container_of_test_release is called\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">fops</span> =</span> &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .open = container_of_test_open,</span><br><span class="line">        .read = container_of_test_read,</span><br><span class="line">        .write = container_of_test_write,</span><br><span class="line">        .release = container_of_test_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">container_of_test_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> err;</span><br><span class="line">        dat1 = (<span class="keyword">struct</span> container_data *)kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> container_data), GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (dat1 == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;no memory dat1&quot;</span>);</span><br><span class="line">                err = -ENOMEM;</span><br><span class="line">                <span class="keyword">goto</span> kmalloc_dat1_fail;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(dat1, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> container_data));</span><br><span class="line"></span><br><span class="line">        dat2 = (<span class="keyword">struct</span> container_data *)kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> container_data), GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (dat2 == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;no memory dat2&quot;</span>);</span><br><span class="line">                err = -ENOMEM;</span><br><span class="line">                <span class="keyword">goto</span> kmalloc_dat2_fail;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(dat2, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> container_data));</span><br><span class="line"></span><br><span class="line">        err = alloc_chrdev_region(&amp;dat1-&gt;dev_num, <span class="number">0</span>, <span class="number">2</span>, <span class="string">&quot;container_of_test chrdev region&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;alloc_chrdev_region error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> alloc_chrdev_region_fail;</span><br><span class="line">        &#125;</span><br><span class="line">        dat2-&gt;dev_num = MKDEV(MAJOR(dat1-&gt;dev_num), MINOR(dat1-&gt;dev_num) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        cdev_init(&amp;dat1-&gt;cdev, &amp;fops);</span><br><span class="line">        err = cdev_add(&amp;dat1-&gt;cdev, dat1-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;cdev_add dat1 error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> cdev_add_dat1_fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cdev_init(&amp;dat2-&gt;cdev, &amp;fops);</span><br><span class="line">        err = cdev_add(&amp;dat2-&gt;cdev, dat2-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;cdev_add dat2 error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> cdev_add_dat2_fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">class</span> =</span> class_create(THIS_MODULE, <span class="string">&quot;chrdev&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(class)) &#123;</span><br><span class="line">                err = PTR_ERR(class);</span><br><span class="line">                <span class="keyword">goto</span> class_create_fail;</span><br><span class="line">        &#125;</span><br><span class="line">        dat1-&gt;dev = device_create(class, <span class="literal">NULL</span>, dat1-&gt;dev_num, <span class="literal">NULL</span>, <span class="string">&quot;container_of_test_dev%d&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(dat1-&gt;dev)) &#123;</span><br><span class="line">                err = PTR_ERR(dat1-&gt;dev);</span><br><span class="line">                <span class="keyword">goto</span> device_create_dat1_fail;</span><br><span class="line">        &#125;</span><br><span class="line">        dat2-&gt;dev = device_create(class, <span class="literal">NULL</span>, dat2-&gt;dev_num, <span class="literal">NULL</span>, <span class="string">&quot;container_of_test_dev%d&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(dat2-&gt;dev)) &#123;</span><br><span class="line">                err = PTR_ERR(dat2-&gt;dev);</span><br><span class="line">                <span class="keyword">goto</span> device_create_dat2_fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">device_create_dat2_fail:</span><br><span class="line">        device_destroy(class, dat1-&gt;dev_num);</span><br><span class="line">device_create_dat1_fail:</span><br><span class="line">        class_destroy(class);</span><br><span class="line">class_create_fail:</span><br><span class="line">        cdev_del(&amp;dat2-&gt;cdev);</span><br><span class="line">cdev_add_dat2_fail:</span><br><span class="line">        cdev_del(&amp;dat1-&gt;cdev);</span><br><span class="line">cdev_add_dat1_fail:</span><br><span class="line">        unregister_chrdev_region(dat1-&gt;dev_num, <span class="number">2</span>);</span><br><span class="line">alloc_chrdev_region_fail:</span><br><span class="line">        kfree(dat2);</span><br><span class="line">kmalloc_dat2_fail:</span><br><span class="line">        kfree(dat1);</span><br><span class="line">kmalloc_dat1_fail:</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">container_of_test_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        device_destroy(class, dat1-&gt;dev_num);</span><br><span class="line">        device_destroy(class, dat2-&gt;dev_num);</span><br><span class="line">        class_destroy(class);</span><br><span class="line">        cdev_del(&amp;dat2-&gt;cdev);</span><br><span class="line">        cdev_del(&amp;dat1-&gt;cdev);</span><br><span class="line">        unregister_chrdev_region(dat1-&gt;dev_num, <span class="number">2</span>);</span><br><span class="line">        kfree(dat2);</span><br><span class="line">        kfree(dat1);</span><br><span class="line">        pr_info(<span class="string">&quot;container_of_test exit\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(container_of_test_init);</span><br><span class="line">module_exit(container_of_test_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;even629&lt;asqwgo@163.com&gt;&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;This is a test sample for container_of&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="杂项设备驱动"><a href="#杂项设备驱动" class="headerlink" title="杂项设备驱动"></a>杂项设备驱动</h2><p>杂项设备属于<strong>特殊的一种字符型设备</strong>，是对字符设备的一种封装，本质也是字符设备。</p>
<p>在 Linux 中，把无法归类的五花八门的设备定义成杂项设备。相较于字符设备，杂项设备有以下两个优点:</p>
<ol>
<li><strong>节省主设备号</strong>: <strong>杂项设备的主设备号固定为 10</strong>，当系统中注册了多个杂项设备驱动时，只需使用子设备号进行区分即可。而字符设备不管是动态分配还是静态分配设备号，都会消耗一个主设备号，进而造成了主设备号浪费。</li>
<li><strong>使用简单</strong>：<strong>杂项设备驱动本身包含创建设备节点操作，不需要额外使用 class_create()函数和 device_create()函数</strong>实现自动创建设备节点操作。只需要填充驱动中的 file_operations 结构体中的成员即可。</li>
</ol>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p><strong>include&#x2F;linux&#x2F;miscdevice.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span>  &#123;</span></span><br><span class="line">	<span class="type">int</span> minor;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">fops</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">parent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">this_device</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">groups</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *nodename;</span><br><span class="line">	<span class="type">umode_t</span> mode;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">misc_register</span><span class="params">(<span class="keyword">struct</span> miscdevice *misc)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">misc_deregister</span><span class="params">(<span class="keyword">struct</span> miscdevice *misc)</span>;</span><br></pre></td></tr></table></figure>

<p>定义一个杂项设备，一般只需要填充 miscdevice 结构体中 minor、name、fops 这三个成员变量。</p>
<ul>
<li><code>minor</code> 杂项指次设备号，可以从内核源码<code>include/linux/miscdevice.h</code> 文件中预定义的次设备号挑选，也可以自行定义子设备号（没有被其他设备使用即可），通常情况下将该参数设置为 <strong>MISC_DYNAMIC_MINOR</strong>，表示自动分配子设备号。</li>
<li><code>name</code> 表示杂项设备的名字。也就是杂项设备驱动注册成功之后，会在 dev 目录下生成名为 name 的设备节点。</li>
<li><code>fops</code>指向了 file_operations 的结构体，表示文件操作集。</li>
</ul>
<h3 id="misc-register"><a href="#misc-register" class="headerlink" title="misc_register"></a>misc_register</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">misc_register</span><span class="params">(<span class="keyword">struct</span> miscdevice *misc)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>函数作用</strong>：基于 misc_class 构造一个设备，将 miscdevice 结构挂载到 misc_list 列表上，并初始化与 linux 设备模型相关的结构。进而起到杂项设备注册的作用。</p>
</li>
<li><p><strong>参数含义</strong>：</p>
<ul>
<li><strong>misc</strong>: 杂项设备的结构体指针</li>
</ul>
</li>
<li><p><strong>函数返回值</strong>：申请成功返回 0，申请失败返回负数</p>
</li>
</ul>
<h3 id="misc-deregister"><a href="#misc-deregister" class="headerlink" title="misc_deregister"></a>misc_deregister</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">misc_deregister</span><span class="params">(<span class="keyword">struct</span> miscdevice *misc)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>函数作用</strong>：从 mist_list 中删除 miscdevice，进而起到杂项设备卸载的作用。</li>
<li><strong>参数含义</strong>：<ul>
<li><strong>misc</strong>: 杂项设备的结构体指针</li>
</ul>
</li>
</ul>
<h3 id="示例-7"><a href="#示例-7" class="headerlink" title="示例"></a>示例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">fops</span> =</span> &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">miscdev</span>=</span>&#123;</span><br><span class="line">        .minor=MISC_DYNAMIC_MINOR,<span class="comment">// 动态申请次设备号</span></span><br><span class="line">        .name=<span class="string">&quot;miscdev&quot;</span>,</span><br><span class="line">        .fops = &amp;fops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">misc_device_test_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        misc_register(&amp;miscdev);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">misc_device_test_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        misc_deregister(&amp;miscdev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(misc_device_test_init);</span><br><span class="line">module_exit(misc_device_test_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;even629&lt;asqwgo@163.com&gt;&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;This is a misc device sample&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Linux-驱动错误处理"><a href="#Linux-驱动错误处理" class="headerlink" title="Linux 驱动错误处理"></a>Linux 驱动错误处理</h2><h3 id="goto-逆序释放"><a href="#goto-逆序释放" class="headerlink" title="goto 逆序释放"></a>goto 逆序释放</h3><p><strong>逆序释放</strong>：后申请的先释放</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">my_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = alloc_chrdev_region(&amp;dev1.dev_num, <span class="number">0</span>, <span class="number">2</span>, <span class="string">&quot;my_driver&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail_alloc;</span><br><span class="line"></span><br><span class="line">    cdev_init(&amp;dev1.cdev_test, &amp;cdev_test_fops);</span><br><span class="line">    dev1.cdev_test.owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line">    ret = cdev_add(&amp;dev1.cdev_test, dev1.dev_num, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail_cdev_add;</span><br><span class="line"></span><br><span class="line">    dev1.class = class_create(THIS_MODULE, <span class="string">&quot;test1&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(dev1.class)) &#123;</span><br><span class="line">        ret = PTR_ERR(dev1.class);</span><br><span class="line">        <span class="keyword">goto</span> fail_class_create;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dev1.device = device_create(dev1.class, <span class="literal">NULL</span>, dev1.dev_num, <span class="literal">NULL</span>, <span class="string">&quot;test1&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(dev1.device)) &#123;</span><br><span class="line">        ret = PTR_ERR(dev1.device);</span><br><span class="line">        <span class="keyword">goto</span> fail_device_create;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;my_driver initialized successfully\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">fail_device_create:</span><br><span class="line">    class_destroy(dev1.class);</span><br><span class="line">fail_class_create:</span><br><span class="line">    cdev_del(&amp;dev1.cdev_test);</span><br><span class="line">fail_cdev_add:</span><br><span class="line">    unregister_chrdev_region(dev1.dev_num, <span class="number">1</span>);</span><br><span class="line">fail_alloc:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>标签顺序是“逆序释放”，即 <strong>后申请的先释放</strong>。</li>
<li><code>PTR_ERR()</code> + <code>IS_ERR()</code> 用于判断 <code>class_create()</code> 和 <code>device_create()</code> 的错误。</li>
<li><code>PTR_ERR()</code> 将错误指针转换为错误码，并进行错误码的返回</li>
<li><code>goto</code> 能避免重复写多次 <code>if</code> 检查和清理代码，使代码简洁。</li>
</ul>
<h3 id="IS-ERR"><a href="#IS-ERR" class="headerlink" title="IS_ERR()"></a>IS_ERR()</h3><p>如果一个函数返回值是指针类型，在调用出错的情况下会返回 NULL 指针，但是返回 NULL 不能知道问题的确切性，一些函数需要返回一个实际的错误码以便于工程师能够基于返回值作出正确的判断。<br>对于任何一个指针来说，必然存在三种情况:</p>
<ul>
<li>合法指针</li>
<li>NULL(也就是空指针)</li>
<li>错误指针(也就是无效指针)</li>
</ul>
<p>在 Linux 内核中，所谓的<strong>错误指针指向了内核空间的最后一页</strong>，例如，对于一个 64 位系统来说，最后一页的地址是 0xfffffffffffff000~0xffffffffffffffff，<br>最后一页地址是被保留的，并这段地址与内核定义的错误码相关联，因此可以使用错误码用来指明对应出错的情况，如果一个指针指向了该页的地址范围就被定义为错误指针。<br>在 Linux 内核源码中提供了错误指针相关的 API 函数，主要有 IS_ERR()、PTR_ERR()、ERR_PTR()函数等，其函数的源码在 <code>include/linux/err.h</code> 文件中。</p>
<p><strong>include&#x2F;linux&#x2F;err.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPDX-License-Identifier: GPL-2.0 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _LINUX_ERR_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _LINUX_ERR_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/compiler.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Kernel pointers have redundant information, so we can use a</span></span><br><span class="line"><span class="comment"> * scheme where we can return either an error code or a normal</span></span><br><span class="line"><span class="comment"> * pointer with the same return value.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This should be a per-architecture thing, to allow different</span></span><br><span class="line"><span class="comment"> * error and pointer decisions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ERRNO	4095</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __ASSEMBLY__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_ERR_VALUE(x) unlikely((unsigned long)(void *)(x) &gt;= (unsigned long)-MAX_ERRNO)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> * __must_check <span class="title function_">ERR_PTR</span><span class="params">(<span class="type">long</span> error)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="type">void</span> *) error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">long</span> __must_check <span class="title function_">PTR_ERR</span><span class="params">(__force <span class="type">const</span> <span class="type">void</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="type">long</span>) ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> __must_check <span class="title function_">IS_ERR</span><span class="params">(__force <span class="type">const</span> <span class="type">void</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> IS_ERR_VALUE((<span class="type">unsigned</span> <span class="type">long</span>)ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> __must_check <span class="title function_">IS_ERR_OR_NULL</span><span class="params">(__force <span class="type">const</span> <span class="type">void</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> unlikely(!ptr) || IS_ERR_VALUE((<span class="type">unsigned</span> <span class="type">long</span>)ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ERR_CAST - Explicitly cast an error-valued pointer to another pointer type</span></span><br><span class="line"><span class="comment"> * @ptr: The pointer to cast.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Explicitly cast an error-valued pointer to another pointer type in such a</span></span><br><span class="line"><span class="comment"> * way as to make it clear that&#x27;s what&#x27;s going on.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> * __must_check <span class="title function_">ERR_CAST</span><span class="params">(__force <span class="type">const</span> <span class="type">void</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* cast away the const */</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="type">void</span> *) ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> __must_check <span class="title function_">PTR_ERR_OR_ZERO</span><span class="params">(__force <span class="type">const</span> <span class="type">void</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(ptr))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(ptr);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* _LINUX_ERR_H */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="PTR-ERR"><a href="#PTR-ERR" class="headerlink" title="PTR_ERR()"></a>PTR_ERR()</h3><p>把错误指针转成错误码</p>
<p><strong>include&#x2F;linux&#x2F;err.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">long</span> __must_check <span class="title function_">PTR_ERR</span><span class="params">(__force <span class="type">const</span> <span class="type">void</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="type">long</span>) ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="错误码"><a href="#错误码" class="headerlink" title="错误码"></a>错误码</h3><p><strong>include&#x2F;uapi&#x2F;asm-generic&#x2F;errno-base.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPDX-License-Identifier: GPL-2.0 WITH Linux-syscall-note */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ASM_GENERIC_ERRNO_BASE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ASM_GENERIC_ERRNO_BASE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EPERM		 1	<span class="comment">/* Operation not permitted */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ENOENT		 2	<span class="comment">/* No such file or directory */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ESRCH		 3	<span class="comment">/* No such process */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EINTR		 4	<span class="comment">/* Interrupted system call */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EIO		 5	<span class="comment">/* I/O error */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ENXIO		 6	<span class="comment">/* No such device or address */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	E2BIG		 7	<span class="comment">/* Argument list too long */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ENOEXEC		 8	<span class="comment">/* Exec format error */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EBADF		 9	<span class="comment">/* Bad file number */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ECHILD		10	<span class="comment">/* No child processes */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EAGAIN		11	<span class="comment">/* Try again */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ENOMEM		12	<span class="comment">/* Out of memory */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EACCES		13	<span class="comment">/* Permission denied */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EFAULT		14	<span class="comment">/* Bad address */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ENOTBLK		15	<span class="comment">/* Block device required */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EBUSY		16	<span class="comment">/* Device or resource busy */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EEXIST		17	<span class="comment">/* File exists */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EXDEV		18	<span class="comment">/* Cross-device link */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ENODEV		19	<span class="comment">/* No such device */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ENOTDIR		20	<span class="comment">/* Not a directory */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EISDIR		21	<span class="comment">/* Is a directory */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EINVAL		22	<span class="comment">/* Invalid argument */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ENFILE		23	<span class="comment">/* File table overflow */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EMFILE		24	<span class="comment">/* Too many open files */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ENOTTY		25	<span class="comment">/* Not a typewriter */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ETXTBSY		26	<span class="comment">/* Text file busy */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EFBIG		27	<span class="comment">/* File too large */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ENOSPC		28	<span class="comment">/* No space left on device */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ESPIPE		29	<span class="comment">/* Illegal seek */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EROFS		30	<span class="comment">/* Read-only file system */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EMLINK		31	<span class="comment">/* Too many links */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EPIPE		32	<span class="comment">/* Broken pipe */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	EDOM		33	<span class="comment">/* Math argument out of domain of func */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ERANGE		34	<span class="comment">/* Math result not representable */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (IS_ERR(dev1.class)) &#123;</span><br><span class="line">    ret = PTR_ERR(dev1.class);</span><br><span class="line">    <span class="keyword">goto</span> fail_class_create;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RK3568-点亮-LED-灯"><a href="#RK3568-点亮-LED-灯" class="headerlink" title="RK3568 点亮 LED 灯"></a>RK3568 点亮 LED 灯</h2><h3 id="原理图"><a href="#原理图" class="headerlink" title="原理图"></a>原理图</h3><p>topeet RK3568 Working LED原理图如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20260109162418692.png" alt="topeet RK3568 Working LED原理图" loading="lazy"></p>
<p>可以看到LED灯接在了<strong>GPIO0_B7</strong>这个GPIO口上。当 GPIO0_B7 为高电平时，三极管 Q16导通，LED9 点亮。当 GPIO0_B7 为低电平时，三极管 Q16 截止，LED9 不亮。</p>
<h3 id="查询寄存器地址"><a href="#查询寄存器地址" class="headerlink" title="查询寄存器地址"></a>查询寄存器地址</h3><h4 id="GPIO0B-的引脚复用"><a href="#GPIO0B-的引脚复用" class="headerlink" title="GPIO0B 的引脚复用"></a>GPIO0B 的引脚复用</h4><p>首先我们得设置GPIO0B的引脚复用，从PMU_GRF查找</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20260109163713068.png" alt="GPIO0B复用寄存器地址偏移" loading="lazy"></p>
<p>搜索GPIO0B7可以看到其对应寄存器为<code>PMU_GRF_GPIO0B_IOMUX_H</code>的14:12位的设置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20260109163831112.png" alt="GPIOB7引脚复用" loading="lazy"></p>
<p>而PMU_GRF寄存器地址从下面可以看到是0xFDC20000</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20260109164524922.png" alt="PMU_GRF" loading="lazy"></p>
<p>所以复用寄存器地址&#x3D;基地址+偏移地址&#x3D;0xFDC20000+0xC&#x3D;0xFDC2000C。</p>
<p>使用 io 命令查看此寄存器的地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io -r -4 0xFDC2000C</span><br></pre></td></tr></table></figure>





<h4 id="GPIO-寄存器"><a href="#GPIO-寄存器" class="headerlink" title="GPIO 寄存器"></a>GPIO 寄存器</h4><p>由TRM中的Address Mapping可知GPIO0地址位0xFDD60000</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20260109170159367.png" alt="Address Mapping" loading="lazy"></p>
<p>RK3568 TRM中GPIO章节介绍：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20260109162836242.png" alt="3568 TRM" loading="lazy"></p>
<p>可知RK3568寄存器分为：</p>
<ul>
<li><p><strong>方向寄存器（DDR）</strong></p>
<ul>
<li>GPIO_SWPORT_DR_L</li>
<li>GPIO_SWPORT_DR_H</li>
</ul>
</li>
<li><p><strong>数据寄存器（DR）</strong></p>
<ul>
<li>GPIO_SWPORT_DDR_L</li>
<li>GPIO_SWPORT_DDR_H</li>
</ul>
</li>
<li><p><strong>外部输入寄存器（EXT_PORT）</strong></p>
<ul>
<li>GPIO_EXT_PORT</li>
</ul>
</li>
</ul>
<p>即</p>
<ul>
<li><strong>GPIO_SWPORT_DDR_L&#x2F;H</strong> 决定 <strong>引脚是输入还是输出</strong></li>
<li><strong>GPIO_SWPORT_DR_L&#x2F;H</strong> 决定 <strong>输出引脚时输出的电平</strong></li>
<li><strong>GPIO_EXT_PORT</strong> 反映 <strong>引脚当前的实际电平（只读）</strong></li>
</ul>
<blockquote>
<p>数据寄存器和方向寄存器分为L和H</p>
<ul>
<li>GPIOA和GPIOB地址落在L上</li>
<li>GPIOC和GPIOD地址落在H上</li>
</ul>
</blockquote>
<p>又：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20260109165521837.png" alt="five GPIOs&#39;s register group have five different base addresses" loading="lazy"></p>
<p>可知GPIO0~GPIO4这五组的寄存器是不同的。</p>
<p>我们需要先设置GPIO方向寄存器为输出，然后设置输出电平为高电平。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20260109163435369.png" alt="寄存器偏移地址" loading="lazy"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20260109184434234.png" alt="GPIO_EXT_PORT" loading="lazy"></p>
<p>GPIO 有四组 GPIO，分别是 GPIOA，GPIOB，GPIOC，GPIOD。每组又以 A0 ~ A7, B0 ~ B7, C0 ~ C7, D0 ~ D7 作为编号区分。</p>
<p>GPIO0B7 在L上，所以方向寄存器的偏移地址为 0x0008，数据寄存器偏移为0x0000。</p>
<p>GPIO0 的基地址为 0xFDD60000。因此</p>
<ul>
<li><p>方向寄存器的地址&#x3D;基地址+偏移地址&#x3D;0xFDD60000+0x0008&#x3D;0xFDD60008</p>
</li>
<li><p>数据寄存器的地址&#x3D;基地址+偏移地址&#x3D;0xFDD60000+0x0000&#x3D;0xFDD60000</p>
</li>
<li><p>外部输入寄存器地址&#x3D;基地址+偏移地址&#x3D;0xFDD60000+0x0070&#x3D;0xFDD60070</p>
</li>
</ul>
<p><strong>方向寄存器</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20260109165109745.png" alt="GPIO_SWPORT_DDR_L" loading="lazy"></p>
<p>可知31:16为可写位，因此GPIOB7应该是16+8+8-1&#x3D;31，即<strong>bit 31设置write access</strong>。</p>
<p>而0+8+8-1&#x3D;15，即<strong>bit 15对应设置GPIO0B7的方向为input或output</strong></p>
<p><strong>数据寄存器</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20260109165045249.png" alt="GPIO_SWPORT_DR_L" loading="lazy"></p>
<p>同理16+8+8-1&#x3D;31，即<strong>bit 31设置write access</strong>。</p>
<p>而0+8+8-1&#x3D;15, 即<strong>bit 15对应设置GPIO0B7输出高电平或低电平</strong>。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li><strong>复用关系寄存器</strong>的基地址为 0xFDC20000 <ul>
<li>GPIO0B_IOMUX_H偏移地址为 000C ，所以要操作的地址为基地址+偏移地址&#x3D;0xFDC2000C<ul>
<li>GPIO0B_IOMUX_H的 bit 28 ~ bit 30 为bit write access, 0 为disable, 1为enable</li>
<li>GPIO0B_IOMUX_H的 bit 12 ~ bit 14 设置为0为GPIO0_B7，1为PWM0_M0，2为CPU_AVS</li>
</ul>
</li>
</ul>
</li>
<li>GPIO0 的基地址为 0xFDD60000<ul>
<li><strong>方向寄存器</strong>地址&#x3D;基地址+偏移地址&#x3D;0xFDD60008<ul>
<li>bit 31 对应GPIO0_B7的方向write access，0为disable，1为enable</li>
<li>bit 15 对应GPIO0_B7的方向，0为input，1为output</li>
</ul>
</li>
<li><strong>数据寄存器</strong>地址&#x3D;基地址+偏移地址&#x3D;0xFDD60000<ul>
<li>bit 31 对应GPIO0_B7的数据write access，0为disable，1为enable</li>
<li>bit 15 对应GPIO0_B7的数据，0为输出low，1为输出high</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>使用io命令测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">su root</span><br><span class="line"><span class="comment"># 复用关系寄存器</span></span><br><span class="line"><span class="built_in">sudo</span> io -4 -w 0xFDC2000C 0x70001000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证是否写入成功，读</span></span><br><span class="line"><span class="built_in">sudo</span> io -4 -r 0xFDC2000C</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置输出</span></span><br><span class="line"><span class="built_in">sudo</span> io -4 -w 0xFDD60008 0x80008000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line"><span class="built_in">sudo</span> io -4 -r 0xFDD60008</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读当前值</span></span><br><span class="line"><span class="built_in">sudo</span> io -4 -r 0xFDD60000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开灯</span></span><br><span class="line"><span class="built_in">sudo</span> io -4 -w 0xFDD60000 0x8000C000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关灯</span></span><br><span class="line"><span class="built_in">sudo</span> io -4 -w 0xFDD60000 0x80004000</span><br></pre></td></tr></table></figure>





<h3 id="示例-8"><a href="#示例-8" class="headerlink" title="示例"></a>示例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 复用寄存器 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PMU_GRF_BASE 0xFDC20000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO0B_IOMUX_OFFSET 0xC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO0B_IOMUX PMU_GRF_BASE + GPIO0B_IOMUX_OFFSET</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 数据寄存器与方向寄存器 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO0_BASE 0xFDD60000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_SWPORT_DDR_L_OFFSET 0x8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_SWPORT_DR_L_OFFSET 0x0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_EXT_PORT_OFFSET 0x70</span></span><br><span class="line"><span class="comment">// 方向寄存器</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO0_SWPORT_DDR_L GPIO0_BASE + GPIO_SWPORT_DDR_L_OFFSET</span></span><br><span class="line"><span class="comment">// 数据寄存器</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO0_SWPORT_DR_L GPIO0_BASE + GPIO_SWPORT_DR_L_OFFSET</span></span><br><span class="line"><span class="comment">// 外部输入寄存器,readonly</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO0_EXT_PORT GPIO0_BASE + GPIO_EXT_PORT_OFFSET</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">led_drv_data</span> &#123;</span></span><br><span class="line">        <span class="type">dev_t</span> dev_num;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">        <span class="type">void</span> __iomem *gpio0b_iomux;</span><br><span class="line">        <span class="type">void</span> __iomem *gpio0_swport_ddr_l;</span><br><span class="line">        <span class="type">void</span> __iomem *gpio0_swport_dr_l;</span><br><span class="line">        <span class="type">void</span> __iomem *gpio0_ext_port;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">led_drv_data</span> *<span class="title">led_drv_data</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">light_up_led_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">        file-&gt;private_data = led_drv_data;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">light_up_led_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">led_drv_data</span> *<span class="title">drv_data</span> =</span> file-&gt;private_data;</span><br><span class="line">        u32 val;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size != <span class="keyword">sizeof</span>(u32)) &#123;</span><br><span class="line">                pr_info(<span class="string">&quot;read need 4 bytes\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        val = readl(drv_data-&gt;gpio0_ext_port);</span><br><span class="line">        val &amp;= <span class="number">1</span> &lt;&lt; <span class="number">15</span>;<span class="comment">// gpio0_b7</span></span><br><span class="line">        val = val &gt;&gt; <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (copy_to_user(buf, &amp;val, <span class="keyword">sizeof</span>(u32)) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">sizeof</span>(u32);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">light_up_led_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">led_drv_data</span> *<span class="title">drv_data</span> =</span> file-&gt;private_data;</span><br><span class="line">        u32 val;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size != <span class="keyword">sizeof</span>(u32)) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;write need 4 bytes\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(&amp;val, buf, <span class="keyword">sizeof</span>(u32)) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (val &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 配置为GPIO输出</span></span><br><span class="line">                val = readl(drv_data-&gt;gpio0_swport_ddr_l);</span><br><span class="line">                val |= <span class="number">0x80008000</span>;</span><br><span class="line">                writel(val, drv_data-&gt;gpio0_swport_ddr_l);</span><br><span class="line">				<span class="comment">// 打开</span></span><br><span class="line">                val = readl(drv_data-&gt;gpio0_swport_dr_l);</span><br><span class="line">                val |= <span class="number">0x80008000</span>;</span><br><span class="line">                writel(val, drv_data-&gt;gpio0_swport_dr_l);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 配置为GPIO输出</span></span><br><span class="line">                val = readl(drv_data-&gt;gpio0_swport_ddr_l);</span><br><span class="line">                val |= <span class="number">0x80008000</span>;</span><br><span class="line">                writel(val, drv_data-&gt;gpio0_swport_ddr_l);</span><br><span class="line">                <span class="comment">// 关闭</span></span><br><span class="line">                val = readl(drv_data-&gt;gpio0_swport_dr_l);</span><br><span class="line">                val |= <span class="number">0x80000000</span>;</span><br><span class="line">                val &amp;= <span class="number">0xffff7fff</span>;</span><br><span class="line">                writel(val, drv_data-&gt;gpio0_swport_dr_l);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">sizeof</span>(u32);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">light_up_led_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">fops</span> =</span> &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .open = light_up_led_open,</span><br><span class="line">        .read = light_up_led_read,</span><br><span class="line">        .write = light_up_led_write,</span><br><span class="line">        .release = light_up_led_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">light_up_led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> err;</span><br><span class="line">        u32 val;</span><br><span class="line"></span><br><span class="line">        led_drv_data = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> led_drv_data), GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (led_drv_data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                err = -ENOMEM;</span><br><span class="line">                <span class="keyword">goto</span> kzalloc_fail;</span><br><span class="line">        &#125;</span><br><span class="line">        err = alloc_chrdev_region(&amp;led_drv_data-&gt;dev_num, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;led chrdev region&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> alloc_chrdev_region_fail;</span><br><span class="line"></span><br><span class="line">        cdev_init(&amp;led_drv_data-&gt;cdev, &amp;fops);</span><br><span class="line">        led_drv_data-&gt;cdev.owner = THIS_MODULE;</span><br><span class="line">        err = cdev_add(&amp;led_drv_data-&gt;cdev, led_drv_data-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> cdev_add_fail;</span><br><span class="line"></span><br><span class="line">        led_drv_data-&gt;<span class="class"><span class="keyword">class</span> =</span> class_create(THIS_MODULE, <span class="string">&quot;test_led&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(led_drv_data-&gt;class)) &#123;</span><br><span class="line">                err = PTR_ERR(led_drv_data-&gt;class);</span><br><span class="line">                <span class="keyword">goto</span> create_class_fail;</span><br><span class="line">        &#125;</span><br><span class="line">        led_drv_data-&gt;dev = device_create(led_drv_data-&gt;class, <span class="literal">NULL</span>, led_drv_data-&gt;dev_num, <span class="literal">NULL</span>,</span><br><span class="line">                                          <span class="string">&quot;test_led%d&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(led_drv_data-&gt;dev)) &#123;</span><br><span class="line">                err = PTR_ERR(led_drv_data-&gt;dev);</span><br><span class="line">                <span class="keyword">goto</span> device_create_fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        led_drv_data-&gt;gpio0b_iomux = ioremap(GPIO0B_IOMUX, <span class="number">4</span>);</span><br><span class="line">        led_drv_data-&gt;gpio0_swport_ddr_l = ioremap(GPIO0_SWPORT_DDR_L, <span class="number">4</span>);</span><br><span class="line">        led_drv_data-&gt;gpio0_swport_dr_l = ioremap(GPIO0_SWPORT_DR_L, <span class="number">4</span>);</span><br><span class="line">        led_drv_data-&gt;gpio0_ext_port = ioremap(GPIO0_EXT_PORT, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置引脚复用为GPIO</span></span><br><span class="line">        val = readl(led_drv_data-&gt;gpio0b_iomux);</span><br><span class="line">        val |= <span class="number">0x70000000</span>; <span class="comment">// write access</span></span><br><span class="line">        val &amp;= <span class="number">0xFFFF8FFF</span>; <span class="comment">// gpio0_b7</span></span><br><span class="line">        writel(val, led_drv_data-&gt;gpio0b_iomux);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">device_create_fail:</span><br><span class="line">        class_destroy(led_drv_data-&gt;class);</span><br><span class="line">create_class_fail:</span><br><span class="line">        cdev_del(&amp;led_drv_data-&gt;cdev);</span><br><span class="line">cdev_add_fail:</span><br><span class="line">        unregister_chrdev_region(led_drv_data-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">alloc_chrdev_region_fail:</span><br><span class="line">        kfree(led_drv_data);</span><br><span class="line">kzalloc_fail:</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">light_up_led_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        iounmap(led_drv_data-&gt;gpio0_ext_port);</span><br><span class="line">        iounmap(led_drv_data-&gt;gpio0b_iomux);</span><br><span class="line">        iounmap(led_drv_data-&gt;gpio0_swport_ddr_l);</span><br><span class="line">        iounmap(led_drv_data-&gt;gpio0_swport_dr_l);</span><br><span class="line"></span><br><span class="line">        device_destroy(led_drv_data-&gt;class, led_drv_data-&gt;dev_num);</span><br><span class="line">        class_destroy(led_drv_data-&gt;class);</span><br><span class="line">        cdev_del(&amp;led_drv_data-&gt;cdev);</span><br><span class="line">        unregister_chrdev_region(led_drv_data-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">        kfree(led_drv_data);</span><br><span class="line">&#125;</span><br><span class="line">module_init(light_up_led_init);</span><br><span class="line">module_exit(light_up_led_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;even629&lt;asqwgo@163.com&gt;&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;light up a led on topeet RK3568 board&quot;</span>);</span><br></pre></td></tr></table></figure>



<p>测试代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> fd, err;</span><br><span class="line">        <span class="type">uint32_t</span> val = <span class="number">0</span>;</span><br><span class="line">        fd = open(<span class="string">&quot;/dev/test_led0&quot;</span>, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (argc == <span class="number">1</span>) &#123; <span class="comment">// read</span></span><br><span class="line">                err = read(fd, &amp;val, <span class="number">4</span>);</span><br><span class="line">                <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">goto</span> fail;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;read:0x%08x\n&quot;</span>, val);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argc &gt;= <span class="number">2</span>) &#123; <span class="comment">// write</span></span><br><span class="line">                val = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">if</span> (val &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        perror(<span class="string">&quot;unsupported\n&quot;</span>);</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                &#125;</span><br><span class="line">                err = write(fd, &amp;val, <span class="number">4</span>);</span><br><span class="line">                <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">goto</span> fail;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;write val: %u success\n&quot;</span>, val);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                perror(<span class="string">&quot;argc error\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">fail:</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error:%s[errno:%d]&quot;</span>, strerror(errno), errno);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://even629.github.io/">even629</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://even629.com/posts/2511113/">https://even629.com/posts/2511113/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://even629.com" target="_blank">常想一二，不思八九</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/GNU/">GNU</a><a class="post-meta__tags" href="/tags/driver/">driver</a></div><div class="post-share"><div class="social-share" data-image="/images/linux_cover.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center liquidGlass-wrapper" id="my-custom-card-author"><div class="liquidGlass-effect"></div><div class="liquidGlass-tint"></div><div class="liquidGlass-shine"></div><div class="liquidGlass-box"><div class="card-info-avatar"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-status-box"><div class="author-status">🐟<span>认真摸鱼中</span></div></div></div><div><div class="author-info-name">even629</div><div class="author-info-description">常想一二，不思八九</div></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/even629" target="_blank" title="github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="/img/qq.jpg" target="_blank" title="qq"><i class="fa-brands fa-qq" style="color: #000000;"></i></a><a class="social-icon" href="mailto:zhaohang731005515@proton.me" target="_blank" title="email"><i class="fas fa-envelope" style="color: #000000;"></i></a><a class="social-icon" href="https://space.bilibili.com/519280138" target="_blank" title="bilibili"><i class="fa-brands fa-bilibili" style="color: #000000;"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="rss"><i class="fas fa-rss" style="color: #000000;"></i></a></div></div></div><div class="card-widget" id="newYear"><div class="item-headline"><i></i><span></span></div><div class="item-content"> <div class="newYear-slider"> <div class="swiper-wrapper"> <div class="swiper-slide" style="background-image:url(/img/happy_new_year1.jpg)"></div> <div class="swiper-slide" style="background-image:url(/img/happy_new_year2.jpg)"></div> <div class="swiper-slide" style="background-image:url(/img/happy_new_year3.webp)"></div> <div class="swiper-slide" style="background-image:url(/img/happy_new_year4.gif)"></div> </div> </div> <div id="newYear-main"> <div class="mask"></div> <p class="title"></p> <div class="newYear-time"></div> <p class="today" style="text-align: right;"></p> </div> </div></div><div class="sticky_layout"><div class="card-widget liquidGlass-wrapper" id="card-toc"><div class="liquidGlass-effect"></div><div class="liquidGlass-tint"></div><div class="liquidGlass-shine"></div><div class="liquidGlass-box"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E5%8F%B7"><span class="toc-text">设备号</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E5%8F%B7%E6%93%8D%E4%BD%9C%E5%AE%8F"><span class="toc-text">设备号操作宏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E5%8F%B7%E7%94%B3%E8%AF%B7%E5%87%BD%E6%95%B0"><span class="toc-text">设备号申请函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#register-chrdev-region"><span class="toc-text">register_chrdev_region()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#alloc-chrdev-region"><span class="toc-text">alloc_chrdev_region()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E5%8F%B7%E9%87%8A%E6%94%BE%E5%87%BD%E6%95%B0"><span class="toc-text">设备号释放函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#unregister-chrdev-region"><span class="toc-text">unregister_chrdev_region()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%AD%97%E7%AC%A6%E7%B1%BB%E8%AE%BE%E5%A4%87"><span class="toc-text">注册字符类设备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cdev-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">cdev 结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cdev-init"><span class="toc-text">cdev_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cdev-add"><span class="toc-text">cdev_add</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cdev-del"><span class="toc-text">cdev_del</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#file-operations-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">file_operations 结构体</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#llseek"><span class="toc-text">llseek</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#read"><span class="toc-text">read</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#write"><span class="toc-text">write</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmap"><span class="toc-text">mmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#open"><span class="toc-text">open</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flush"><span class="toc-text">flush</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#release"><span class="toc-text">release</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E7%BB%93%E7%82%B9"><span class="toc-text">设备结点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-%E4%B8%8B%E5%88%9B%E5%BB%BA%E7%BB%93%E7%82%B9%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-text">Linux 下创建结点的方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%88%9B%E5%BB%BA%E8%AE%BE%E5%A4%87%E7%BB%93%E7%82%B9"><span class="toc-text">手动创建设备结点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E8%AE%BE%E5%A4%87%E7%BB%93%E7%82%B9"><span class="toc-text">自动创建设备结点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#class-create-%E5%87%BD%E6%95%B0"><span class="toc-text">class_create 函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#class-destroy-%E5%87%BD%E6%95%B0"><span class="toc-text">class_destroy 函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#device-create-%E5%87%BD%E6%95%B0"><span class="toc-text">device_create 函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#device-destroy-%E5%87%BD%E6%95%B0"><span class="toc-text">device_destroy 函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-3"><span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E5%92%8C%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BA%A4%E6%8D%A2"><span class="toc-text">用户空间和内核空间的数据交换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#copy-to-user-%E5%87%BD%E6%95%B0"><span class="toc-text">copy_to_user()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#copy-from-user-%E5%87%BD%E6%95%B0"><span class="toc-text">copy_from_user()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-4"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%A7%81%E6%9C%89%E6%95%B0%E6%8D%AE"><span class="toc-text">文件私有数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-5"><span class="toc-text">示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E7%A7%81%E6%9C%89%E6%95%B0%E6%8D%AE%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-text">使用文件私有数据的场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#container-of-%E5%AE%8F"><span class="toc-text">container_of 宏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-6"><span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%82%E9%A1%B9%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8"><span class="toc-text">杂项设备驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#misc-register"><span class="toc-text">misc_register</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#misc-deregister"><span class="toc-text">misc_deregister</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-7"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-%E9%A9%B1%E5%8A%A8%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-text">Linux 驱动错误处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#goto-%E9%80%86%E5%BA%8F%E9%87%8A%E6%94%BE"><span class="toc-text">goto 逆序释放</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IS-ERR"><span class="toc-text">IS_ERR()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PTR-ERR"><span class="toc-text">PTR_ERR()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E7%A0%81"><span class="toc-text">错误码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RK3568-%E7%82%B9%E4%BA%AE-LED-%E7%81%AF"><span class="toc-text">RK3568 点亮 LED 灯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-text">原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%AF%84%E5%AD%98%E5%99%A8%E5%9C%B0%E5%9D%80"><span class="toc-text">查询寄存器地址</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GPIO0B-%E7%9A%84%E5%BC%95%E8%84%9A%E5%A4%8D%E7%94%A8"><span class="toc-text">GPIO0B 的引脚复用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GPIO-%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-text">GPIO 寄存器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-8"><span class="toc-text">示例</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post liquidGlass-wrapper"><div class="liquidGlass-effect"></div><div class="liquidGlass-tint"></div><div class="liquidGlass-shine"></div><div class="liquidGlass-box"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/2601133/" title="Linux 网络设备"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/linux_cover.webp" onerror="this.onerror=null;this.src='/img/404.svg'" alt="Linux 网络设备"/></a><div class="content"><a class="title" href="/posts/2601133/" title="Linux 网络设备">Linux 网络设备</a><time datetime="2026-01-13T14:00:00.000Z" title="发表于 2026-01-13 22:00:00">2026-01-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2601093/" title="Linux CAN"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/linux_cover.webp" onerror="this.onerror=null;this.src='/img/404.svg'" alt="Linux CAN"/></a><div class="content"><a class="title" href="/posts/2601093/" title="Linux CAN">Linux CAN</a><time datetime="2026-01-09T07:56:00.000Z" title="发表于 2026-01-09 15:56:00">2026-01-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2601063/" title="Linux Watchdog"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/linux_cover.webp" onerror="this.onerror=null;this.src='/img/404.svg'" alt="Linux Watchdog"/></a><div class="content"><a class="title" href="/posts/2601063/" title="Linux Watchdog">Linux Watchdog</a><time datetime="2026-01-06T05:09:00.000Z" title="发表于 2026-01-06 13:09:00">2026-01-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2601053/" title="Linux RTC"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/linux_cover.webp" onerror="this.onerror=null;this.src='/img/404.svg'" alt="Linux RTC"/></a><div class="content"><a class="title" href="/posts/2601053/" title="Linux RTC">Linux RTC</a><time datetime="2026-01-05T14:09:00.000Z" title="发表于 2026-01-05 22:09:00">2026-01-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2601043/" title="Linux PWM"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/linux_cover.webp" onerror="this.onerror=null;this.src='/img/404.svg'" alt="Linux PWM"/></a><div class="content"><a class="title" href="/posts/2601043/" title="Linux PWM">Linux PWM</a><time datetime="2026-01-04T10:59:00.000Z" title="发表于 2026-01-04 18:59:00">2026-01-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2512313/" title="Linux UART"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/linux_cover.webp" onerror="this.onerror=null;this.src='/img/404.svg'" alt="Linux UART"/></a><div class="content"><a class="title" href="/posts/2512313/" title="Linux UART">Linux UART</a><time datetime="2025-12-31T12:46:13.000Z" title="发表于 2025-12-31 20:46:13">2025-12-31</time></div></div></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient(135deg, rgba(146, 233, 227, 1) 0%, rgba(0, 0, 0, 0) 70%);;"><div id="footer-wrap"><div class="footer-button"><a target="_blank" rel="noopener" href="https://github.com/even629" title="github"><i class="fab fa-github"></i></a><a href="/img/qq.jpg" title="qq"><i class="fa-brands fa-qq"></i></a><a href="mailto:zhaohang731005515@proton.me" title="email"><i class="fas fa-envelope"></i></a><a target="_blank" rel="noopener" href="https://space.bilibili.com/519280138" title="bilibili"><i class="fa-brands fa-bilibili"></i></a><a href="/atom.xml" title="rss"><i class="fas fa-rss"></i></a></div><div class="copyright">&copy;2024 - 2026 By even629</div><p><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Frame-Hexo-blue.svg" title="博客框架为 Hexo"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Theme-Butterfly.svg" title="主题采用 butterfly"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Source-Github.svg" title="本站项目由 Github 托管"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Copyright-BY--NC--SA.4.svg" title="本站采用知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议进行许可"/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="中英转换">中</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span data-zh="新窗口打开" data-en="Open in New Window"></span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span data-zh="转到链接" data-en="Go to Link"></span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span data-zh="复制链接" data-en="Copy Link"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span data-zh="复制" data-en="Copy"> </span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.google.com/search?q=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span data-zh="谷歌搜索" data-en="Google Search"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span data-zh="转到链接" data-en="Go to Link"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span data-zh="粘贴" data-en="Paste"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span data-zh="空降评论" data-en="Jump to Comment"></span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();"><i class="fa fa-book"></i><span data-zh="阅读模式" data-en="Reading Mode"> </span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span data-zh="保存图片" data-en="Save Image"></span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span data-zh="在新窗口打开" data-en="Open in New Tab"></span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span data-zh="复制图片链接" data-en="Copy Image Link"></span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:rmf.switchDarkmode();"><i class="fa fa-moon"></i><span data-zh="昼夜切换" data-en="Day/Night Mode"></span></a><a class="rightMenu-item" href="javascript:rmf.stopSakura();"><i class="fa-solid fa-feather"></i><span data-zh="樱花特效" data-en="toggle sakura"></span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span data-zh="切换全屏" data-en="Toggle Full Screen"></span></a><a class="rightMenu-item" href="javascript:rmf.switchLanguageMode();"><i class="fas fa-language"></i><span data-zh="语言切换" data-en="Language Switch"></span></a><a class="rightMenu-item" href="/"><i class="fa fa-home"></i><span data-zh="回到首页" data-en="Go to Home"></span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span data-zh="打印页面" data-en="Print Page"></span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/utils.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }
      
      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: 'Ov23liyQTymWpBETlDO8',
      clientSecret: '1512bfe449aac2a5ec3b416df1ce27fb5ddb5db0',
      repo: 'even629.github.io',
      owner: 'even629',
      admin: ['even629'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || '275f9c099c346f374105e9e02c588cf3'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.0.6/swiper-bundle.min.js"></script><script src="/js/sakura.js"></script><script defer src="/js/right_menu.js"></script><script async src="/js/fps.js"></script><script src="/js/solarlunar.js"></script><script src="/js/newYear.js"></script><script src="/js/pop-up-window.js"></script><script data-pjax src="/js/nav.js"></script><script data-pjax src="/js/music.js"></script><script data-pjax src="/js/btf.js"></script><script data-pjax src="/js/ch_en.js"></script><svg style="display: none">
<filter
  id="glass-distortion"
  x="0%"
  y="0%"
  width="100%"
  height="100%"
  filterUnits="objectBoundingBox"
>
  <feTurbulence
    type="fractalNoise"
    baseFrequency="0.01 0.01"
    numOctaves="1"
    seed="5"
    result="turbulence"
  />
  <!-- Seeds: 14, 17,  -->

  <feComponentTransfer in="turbulence" result="mapped">
    <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5" />
    <feFuncG type="gamma" amplitude="0" exponent="1" offset="0" />
    <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5" />
  </feComponentTransfer>

  <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap" />

  <feSpecularLighting
    in="softMap"
    surfaceScale="5"
    specularConstant="1"
    specularExponent="100"
    lighting-color="white"
    result="specLight"
  >
    <fePointLight x="-200" y="-200" z="300" />
  </feSpecularLighting>

  <feComposite
    in="specLight"
    operator="arithmetic"
    k1="0"
    k2="1"
    k3="1"
    k4="0"
    result="litImage"
  />

  <feDisplacementMap
    in="SourceGraphic"
    in2="softMap"
    scale="150"
    xChannelSelector="R"
    yChannelSelector="G"
  />
  </filter>
</svg>
<script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="/css/APlayer.min.css" media="print" onload="this.media='all'"><script src="/js/APlayer.min.js"></script><script src="/js/meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404.html')
    }
  })
})()</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="search" type="text"/></div></div><hr class="custom-hr"/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/c/font_4847823_upluhme7cv.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('container');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '800ms');
    arr[i].setAttribute('data-wow-delay', '0ms');
    arr[i].setAttribute('data-wow-offset', '0');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="/js/wowjs/wow.min.js"></script><script defer src="/js/wowjs/wow_init.js"></script><!-- hexo injector body_end end --></body></html>