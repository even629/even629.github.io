<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Linux gpio子系统 | 常想一二，不思八九</title><meta name="author" content="even629"><meta name="copyright" content="even629"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Linux gpio子系统">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux gpio子系统">
<meta property="og:url" content="https://even629.com/posts/2512173/index.html">
<meta property="og:site_name" content="常想一二，不思八九">
<meta property="og:description" content="Linux gpio子系统">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://even629.com/images/linux_cover.webp">
<meta property="article:published_time" content="2025-12-17T12:31:13.000Z">
<meta property="article:modified_time" content="2025-12-17T12:31:13.000Z">
<meta property="article:author" content="even629">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="GNU">
<meta property="article:tag" content="driver">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://even629.com/images/linux_cover.webp"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://even629.com/posts/2512173/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><meta name="baidu-site-verification" content="codeva-g8sPzVXu98"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://npm.elemecdn.com/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"中"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Linux gpio子系统',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><link rel='preload', href='/img/avatar.png', as='image'><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/custom_card_author.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/right_menu.css"><link rel="stylesheet" href="/css/nav.css"><link rel="stylesheet" href="/css/newYear.css"><link rel="stylesheet" href="/css/music.css"><link rel="stylesheet" href="/css/beautify_label_h.css"><link rel="stylesheet" href="/css/equipment.css"><link rel="stylesheet" href="/css/liquid_glass.css"><link rel="stylesheet" href="/css/tag_plugin_plus.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.0.6/swiper-bundle.min.css"><span id="fps"></span><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="/css/wow_animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="常想一二，不思八九" type="application/atom+xml">
</head><body><div class="float-box left top"></div><div class="float-box left bottom"></div><div class="float-box right top"></div><div class="float-box right bottom"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg" style="background-image: url(/img/12bb_background.png);"></div><div id="an_music_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">90</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/charts/"><i class="fa-fw fas fa-solid fa-chart-simple"></i><span> 统计</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 分享</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fa-solid fa-toolbox"></i><span> 装备</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-solid fa-link"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-solid fa-comments"></i><span> 留言</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/images/linux_top_image.jpg);"><nav class="liquidGlass-wrapper" id="nav" style="--glass-border-radius: 2rem;"><div class="liquidGlass-effect"></div><div class="liquidGlass-tint"></div><div class="liquidGlass-shine"></div><div class="liquidGlass-box" style="display:flex;align-items:center;justify-content:center;width:100%"><!-- 左侧博客信息区域--><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" alt="Logo"></a></span><!-- 新增的导航菜单容器（居中布局关键）--><div id="nav-menus-container"><!-- 菜单主体部分--><div id="menus"><!-- 菜单项--><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/charts/"><i class="fa-fw fas fa-solid fa-chart-simple"></i><span> 统计</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 分享</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fa-solid fa-toolbox"></i><span> 装备</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-solid fa-link"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-solid fa-comments"></i><span> 留言</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div><!-- 显示当前标题名称--><center id="name-container"><a id="page-name" href="javascript:rmf.scrollToTop()">常想一二，不思八九</a></center></div></div><!-- 右侧功能区域（新增容器）--><div id="nav-right-container"><!-- 搜索按钮（移动到右侧）--><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><!-- 移动端汉堡菜单按钮--><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></div></nav><div id="post-info"><h1 class="post-title">Linux gpio子系统</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-12-17T12:31:13.000Z" title="发表于 2025-12-17 20:31:13">2025-12-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-17T12:31:13.000Z" title="更新于 2025-12-17 20:31:13">2025-12-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">12.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>53分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/2512173/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><hr>
<div class="timeline blue"><div class='timeline-item headline'><div class='timeline-item-title'><div class='item-circle'><p>时间轴</p>
</div></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2025-12-17</p>
</div></div><div class='timeline-item-content'><p>init</p>
</div></div></div>

<hr>
<h2 id="GPIO介绍"><a href="#GPIO介绍" class="headerlink" title="GPIO介绍"></a>GPIO介绍</h2><p>GPIO&#x3D;General-Purpose Input&#x2F;Output（通用输入输出），是一种软件运行期间能够动态配置和控制的通用引脚。</p>
<p><strong>所有的 GPIO 在上电后的初始状态都是输入模式，可以通过软件设为上拉或下拉，也可以输入中断信号，驱动强度都是可编程的</strong>。</p>
<h3 id="GPIO引脚分布"><a href="#GPIO引脚分布" class="headerlink" title="GPIO引脚分布"></a>GPIO引脚分布</h3><p>RK3568 有 5 组 GPIO：GPIO0 到 GPIO4。每组 GPIO 又以 A0 到 A7，B0 到 B7，C0 到C7，D0 到 D7，作为区分的编号。所以 RK3568 上的 GPIO 是不是应该有 5<em>4</em>8&#x3D;160 个呢？但实际在数据手册中只有 152 个 GPIO。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223194912131.png" alt="rk3568 block diagram" loading="lazy"></p>
<p>实 际 上 RK3568 一 共 有 152 个 GPIO ， 其 中 GPIO0_D2 ， GPIO0_D7 ， GPIO2_C7 ，GPIO4_D3~GPIO4_D7 是没有的，所以是 152 个 GPIO。</p>
<h3 id="GPIO电气属性"><a href="#GPIO电气属性" class="headerlink" title="GPIO电气属性"></a>GPIO电气属性</h3><p>我们以 RK3568 为例，以具体 CPU 的数据手册为准。RK3568 上的 GPIO 可以设置为 3.3V，也可以设置为 1.8V。在实际编程时，高电平（3.3V 或 1.8V）用 1 表示，低电平用 0 表示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223194918719.png" alt="DC Characteristics" loading="lazy"></p>
<p>如何确定 RK3568 的 GPIO 电平是 3.3V 还是 1.8V 呢？</p>
<p>看核心板原理图查找到引脚对应的 GPIO 和引脚所连接的电源域，如MIPI_CAM0_PDN_L_GPIO3_D5</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223194922087.png" alt="TOPEET_RK3568_LPDDR4_V1_1 底板原理图" loading="lazy"></p>
<p>可以看到接到该GPIO的是VCCIO6</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223194925512.png" alt="VCCIO6 可配置" loading="lazy"></p>
<h3 id="GPIO电气特性"><a href="#GPIO电气特性" class="headerlink" title="GPIO电气特性"></a>GPIO电气特性</h3><p>RK3568的TRM手册中提到</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223194930988.png" alt="Rockchip RK3568 TRM Part1 V1.1-20210301" loading="lazy"></p>
<p>GPIO 是可编程的 GPIO，GPIO 除了 IO 电平，还有驱动强度，上拉和下拉，这些概念解释如下：</p>
<ul>
<li><p><strong>驱动强度（Drive Strength）</strong>：GPIO 的驱动强度决定了<strong>它可以提供的输出电流</strong>。通过软件配置，您可以选择合适的驱动强度，以确保 GPIO 能够驱动所连接的外部设备或电路。</p>
</li>
<li><p><strong>上拉（Pull-up）和下拉（Pull-down）</strong>：GPIO 引脚可以通过上拉或下拉电阻来确定其默认电平状态。通过软件配置，您可以选择启用上拉或下拉电阻，以确保 <strong>GPIO 在未连接外部设备时保持稳定的默认状态</strong>。</p>
</li>
<li><p><strong>中断（Interrupt）</strong>：通过软件配置，您可以启用 GPIO 中断功能，以便<strong>在 GPIO 状态发生变化时及时获得通知</strong>。这对于实现事件驱动的应用程序非常有用，可以通过中断来处理 GPIO触发的事件。</p>
</li>
<li><p><strong>多功能引脚（Multipurpose Pins）</strong>：一些 GPIO 引脚可能具有多种功能，可以通过软件配置来选择不同的功能。例如，一个 GPIO 引脚可以配置为数字输入、数字输出、PWM 输出等。</p>
<p>比如：</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">sdmmc0 &#123;</span><br><span class="line">		/omit-<span class="keyword">if</span>-no-ref/</span><br><span class="line">		sdmmc0_bus4: sdmmc0-bus4 &#123;</span><br><span class="line">			rockchip,pins =</span><br><span class="line">				<span class="comment">/* sdmmc0_d0 */</span></span><br><span class="line">				&lt;<span class="number">1</span> RK_PD5 <span class="number">1</span> &amp;pcfg_pull_up_drv_level_2&gt;,</span><br><span class="line">				<span class="comment">/* sdmmc0_d1 */</span></span><br><span class="line">				&lt;<span class="number">1</span> RK_PD6 <span class="number">1</span> &amp;pcfg_pull_up_drv_level_2&gt;,</span><br><span class="line">				<span class="comment">/* sdmmc0_d2 */</span></span><br><span class="line">				&lt;<span class="number">1</span> RK_PD7 <span class="number">1</span> &amp;pcfg_pull_up_drv_level_2&gt;,</span><br><span class="line">				<span class="comment">/* sdmmc0_d3 */</span></span><br><span class="line">				&lt;<span class="number">2</span> RK_PA0 <span class="number">1</span> &amp;pcfg_pull_up_drv_level_2&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		/omit-<span class="keyword">if</span>-no-ref/</span><br><span class="line">		sdmmc0_clk: sdmmc0-clk &#123;</span><br><span class="line">			rockchip,pins =</span><br><span class="line">				<span class="comment">/* sdmmc0_clk */</span></span><br><span class="line">				&lt;<span class="number">2</span> RK_PA2 <span class="number">1</span> &amp;pcfg_pull_up_drv_level_2&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line">		...</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>节点中描述了引脚的配置，比如说<code>&lt;1 RK_PD5 1 &amp;pcfg_pull_up_drv_level_2&gt;</code>描述的是GPIO1_D5 引脚，复用模式为模式 1（复用模式可以查看 RK3568 的参考手册），GPIO 引脚的上拉驱动强度为 2。</p>
<h2 id="GPIO控制和操作"><a href="#GPIO控制和操作" class="headerlink" title="GPIO控制和操作"></a>GPIO控制和操作</h2><h3 id="使用命令通过sysfs控制GPIO"><a href="#使用命令通过sysfs控制GPIO" class="headerlink" title="使用命令通过sysfs控制GPIO"></a>使用命令通过sysfs控制GPIO</h3><p>首先需要底层驱动的支持，make menuconfig</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Device Drivers</span><br><span class="line">	-&gt;GPIO Support</span><br><span class="line">		-&gt;/sys/<span class="keyword">class</span>/<span class="symbol">gpio</span>/<span class="symbol">xxxx</span></span><br></pre></td></tr></table></figure>

<h4 id="gpio编号计算"><a href="#gpio编号计算" class="headerlink" title="gpio编号计算"></a>gpio编号计算</h4><p>iTOP-RK3568 有 5 组 GPIO bank：GPIO0<del>GPIO4，每组又以 A0</del>A7, B0<del>B7, C0</del>C7, D0~D7 作为编号区分,常用以下公式计算引脚：</p>
<p>GPIO pin 脚计算公式：<br>$$<br>\text{pin} &#x3D; \text{bank} \times 32 + \text{group} \times 8 + X<br>$$<br>以 GPIO0_PB7 为例，bank 为0，group 为B（A&#x3D;0, B&#x3D;1, C&#x3D;2, D&#x3D;3）， X为7，其中把 $\text{group} \times 8 + X$ 称为number</p>
<p><strong>举例</strong>： GPIO0_PB7 pin 脚计算方法：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">bank</span> = <span class="number">0</span>;  //GPIO0_B7=&gt; <span class="number">0</span>, bank ∈<span class="meta"> [0,4]</span></span><br><span class="line"><span class="attribute">group</span> = <span class="number">1</span>; //GPIO0_B7 =&gt; <span class="number">1</span>, group ∈ &#123;(A=<span class="number">0</span>), (B=<span class="number">1</span>), (C=<span class="number">2</span>), (D=<span class="number">3</span>)&#125;</span><br><span class="line"><span class="attribute">X</span> = <span class="number">7</span>;     //GPIO4_D7 =&gt; <span class="number">5</span>, X ∈<span class="meta"> [0,7]</span></span><br><span class="line"><span class="attribute">number</span> = group * <span class="number">8</span> + X = <span class="number">1</span> * <span class="number">8</span> + <span class="number">7</span> =<span class="number">15</span></span><br><span class="line"><span class="attribute">pin</span> = bank*<span class="number">32</span> + number= <span class="number">0</span> * <span class="number">32</span> + <span class="number">15</span> = <span class="number">15</span>;</span><br></pre></td></tr></table></figure>

<p>sysfs导出的内核对象</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223194937227.png" alt="&#x2F;sys&#x2F;class&#x2F;gpio" loading="lazy"></p>
<p><code>/sys/class/gpio/export</code>用 于 将 GPIO 控 制 从 内 核 空 间 导 出 到 用 户 空 间 。</p>
<p><code>/sys/class/gpio/unexport</code> 用于取消 GPIO 控制从内核空间到用户空间的导出。</p>
<p><code>gpiochipX</code> 代表 GPIO 控制器。</p>
<blockquote>
<p><code>export</code> 和<code>unexport</code>，他们都是<strong>只写的</strong>。</p>
</blockquote>
<h4 id="export"><a href="#export" class="headerlink" title="export"></a>export</h4><p>用于将指定编号的 GPIO 引脚导出。在使用 GPIO 引脚之前，需要将其导出，导出成功之后才能使用它。</p>
<p>注意 export 文件是只写文件，不能读取，将一个指定的gpio编号写入到 export 文件中即可将对应的 GPIO 引脚导出，以 GPIO0_PB7 为例（pin 计算值为 15）使用 export 文件进行导出:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 15 &gt; <span class="built_in">export</span></span><br></pre></td></tr></table></figure>

<p>会发现在<code>/sys/class/gpio</code> 目录下生成了一个名为 gpio15 的文件夹（gpioX，X 表示对应的编 号），该文件夹就是导出来的 GPIO 引脚对应的文件夹，用于管理、控制该 GPIO 引脚。</p>
<blockquote>
<p>需要注意的是，并不是所有 GPIO 引脚都可以成功导出，如果对应的 GPIO 已经被导出或者在内核中被使用了，那便无法成功导出，导出失败提示：Device or resource busy</p>
<p>出现上图报错的原因是该 GPIO 已经被其他 GPIO 使用，需要在内核中找到使用 GPIO 的驱动，并取消该驱动才可以正常使用 GPIO。</p>
</blockquote>
<p>gpio15 文件夹下分别有 <code>active_low</code>、<code>device</code>、<code>direction</code>、<code>edge</code>、<code>power</code>、<code>subsystem</code>、<code>uevent</code>、<code>value</code> 八个文件，需要关心的文件是 <code>active_low</code>、<code>direction</code>、<code>edge</code> 以及 <code>value</code> 这四个属性文件。</p>
<h5 id="direction"><a href="#direction" class="headerlink" title="direction"></a>direction</h5><p><strong>配置 GPIO 引脚为输入或输出模式</strong>。该文件<strong>可读、可写</strong>，读表示查看 GPIO 当前是输入还是输出模式，写表示将 GPIO 配置为输入或输出模式；</p>
<p>读取或写入操作可取的值为”out”（输出模式）和”in”（输入模式）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> direction</span><br><span class="line"><span class="built_in">echo</span> out &gt; direction</span><br></pre></td></tr></table></figure>

<h5 id="active-low"><a href="#active-low" class="headerlink" title="active_low"></a>active_low</h5><p>用于控制极性的属性文件，可读可写，默认情况下为 0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> active_low</span><br></pre></td></tr></table></figure>

<p>当 active_low 等于 0 时， value 值若为 1 则引脚输出高电平，value 值若为 0 则引脚输出低电平。</p>
<p>当 active_low 等于 1 时 ，value 值若为 0 则引脚输出高电平，value 值若为 1 则引脚输出低电平。</p>
<h5 id="edge"><a href="#edge" class="headerlink" title="edge"></a>edge</h5><p>控制中断的触发模式，该文件可读可写。</p>
<p>在配置 GPIO 引脚的中断触发模式之前，需将其设置为输入模式，四种触发模式的设置如下所示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 非中断引脚</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;none&quot;</span> &gt; edge</span><br><span class="line"><span class="comment"># 上升沿触发</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;rising&quot;</span> &gt; edge</span><br><span class="line"><span class="comment"># 下降沿触发</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;falling&quot;</span> &gt; edge</span><br><span class="line"><span class="comment"># 边沿触发</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;both&quot;</span> &gt; edge</span><br></pre></td></tr></table></figure>

<h5 id="value"><a href="#value" class="headerlink" title="value"></a>value</h5><p>设置高低电平，如果我们要把这个管脚设置成高电平，我们只需要给 value 设置成 1即可，反之，则设置成 0</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 设置高电平</span><br><span class="line">echo <span class="number">1</span> &gt; value</span><br><span class="line"># 设置低电平</span><br><span class="line">echo <span class="number">0</span> &gt; value</span><br></pre></td></tr></table></figure>



<h4 id="unexport"><a href="#unexport" class="headerlink" title="unexport"></a>unexport</h4><p>将导出的 GPIO 引脚删除。当使用完 GPIO 引脚之后，需要将导出的引脚删除，同样该文件也是只写文件、不可读，使用 unexport 文件进行删除 GPIO0_PB7：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 15 &gt; unexport</span><br></pre></td></tr></table></figure>





<h3 id="使用C程序通过sysfs控制GPIO"><a href="#使用C程序通过sysfs控制GPIO" class="headerlink" title="使用C程序通过sysfs控制GPIO"></a>使用C程序通过sysfs控制GPIO</h3><p>主要思路是通过文件IO API</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;              <span class="comment">// 文件描述符</span></span><br><span class="line"><span class="type">int</span> ret;             <span class="comment">// 返回值</span></span><br><span class="line"><span class="type">char</span> gpio_path[<span class="number">100</span>]; <span class="comment">// GPIO路径</span></span><br><span class="line"><span class="type">int</span> len;             <span class="comment">// 字符串长度</span></span><br><span class="line"><span class="type">char</span> file_path[<span class="number">100</span>]; <span class="comment">// 文件路径</span></span><br><span class="line"><span class="type">char</span> buf[<span class="number">2</span>];         <span class="comment">// 缓冲区</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">fds</span>[1];</span> <span class="comment">// poll结构体数组</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出GPIO引脚</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gpio_export</span><span class="params">(<span class="type">char</span> *argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    fd = open(<span class="string">&quot;/sys/class/gpio/export&quot;</span>, O_WRONLY); <span class="comment">// 打开export文件</span></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open /sys/class/gpio/export error \n&quot;</span>); <span class="comment">// 打开文件失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    len = <span class="built_in">strlen</span>(argv);         <span class="comment">// 获取字符串长度</span></span><br><span class="line">    ret = write(fd, argv, len); <span class="comment">// 写入引脚号到export文件</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;write /sys/class/gpio/export error \n&quot;</span>); <span class="comment">// 写入失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd); <span class="comment">// 关闭文件</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取消导出GPIO引脚</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gpio_unexport</span><span class="params">(<span class="type">char</span> *argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    fd = open(<span class="string">&quot;/sys/class/gpio/unexport&quot;</span>, O_WRONLY); <span class="comment">// 打开unexport文件</span></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open /sys/class/gpio/unexport error \n&quot;</span>); <span class="comment">// 打开文件失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    len = <span class="built_in">strlen</span>(argv);        <span class="comment">// 获取字符串长度</span></span><br><span class="line">    ret = write(fd, argv, len); <span class="comment">// 写入引脚号到unexport文件</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;write /sys/class/gpio/unexport error \n&quot;</span>); <span class="comment">// 写入失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd); <span class="comment">// 关闭文件</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制GPIO引脚的属性</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gpio_ctrl</span><span class="params">(<span class="type">char</span> *arg, <span class="type">char</span> *val)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(file_path, <span class="string">&quot;%s/%s&quot;</span>, gpio_path, arg); <span class="comment">// 构建属性文件的路径</span></span><br><span class="line">    fd = open(file_path, O_WRONLY);              <span class="comment">// 打开属性文件</span></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open file_path error \n&quot;</span>); <span class="comment">// 打开文件失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    len = <span class="built_in">strlen</span>(val);         <span class="comment">// 获取字符串长度</span></span><br><span class="line">    ret = write(fd, val, len); <span class="comment">// 写入属性值到属性文件</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;write file_path error\n&quot;</span>); <span class="comment">// 写入失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd); <span class="comment">// 关闭文件</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听GPIO引脚的中断事件</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gpio_interrupt</span><span class="params">(<span class="type">char</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(file_path, <span class="string">&quot;%s/%s&quot;</span>, gpio_path, arg); <span class="comment">// 构建文件路径</span></span><br><span class="line">    fd = open(file_path, O_RDONLY);              <span class="comment">// 打开文件</span></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open file_path error \n&quot;</span>); <span class="comment">// 打开文件失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">void</span> *)fds, <span class="number">0</span>, <span class="keyword">sizeof</span>(fds)); <span class="comment">// 清空poll结构体数组</span></span><br><span class="line">    fds[<span class="number">0</span>].fd = fd;                      <span class="comment">// 设置poll结构体的文件描述符</span></span><br><span class="line">    fds[<span class="number">0</span>].events = POLLPRI;             <span class="comment">// 设置poll结构体的事件类型为POLLPRI，表示有紧急数据可读</span></span><br><span class="line"></span><br><span class="line">    read(fd, buf, <span class="number">2</span>); <span class="comment">// 读取文件内容，清除中断事件</span></span><br><span class="line"></span><br><span class="line">    ret = poll(fds, <span class="number">1</span>, <span class="number">-1</span>); <span class="comment">// 调用poll函数等待中断事件发生，阻塞直到事件发生</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;poll error \n&quot;</span>); <span class="comment">// 调用poll失败或超时</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(fds[<span class="number">0</span>].revents &amp; POLLPRI)</span><br><span class="line">    &#123;</span><br><span class="line">        lseek(fd, <span class="number">0</span>, SEEK_SET); <span class="comment">// 重新定位文件指针到文件开头</span></span><br><span class="line">        read(fd, buf, <span class="number">2</span>);       <span class="comment">// 读取文件内容，获取中断事件的值</span></span><br><span class="line">        buf[<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;value is %s\n&quot;</span>, buf); <span class="comment">// 输出中断事件的值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取GPIO引脚的值</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gpio_read_value</span><span class="params">(<span class="type">char</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(file_path, <span class="string">&quot;%s/%s&quot;</span>, gpio_path, arg); <span class="comment">// 构建文件路径</span></span><br><span class="line">   fd = open(file_path, O_WRONLY); <span class="comment">// 打开文件，以只写模式打开是一个错误，应该使用只读模式</span></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open file_path error\n&quot;</span>); <span class="comment">// 打开文件失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = read(fd, buf, <span class="number">1</span>); <span class="comment">// 读取文件内容，获取引脚的值</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(buf, <span class="string">&quot;1&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The value is high\n&quot;</span>); <span class="comment">// 引脚值为高电平</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(buf, <span class="string">&quot;0&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The value is low\n&quot;</span>); <span class="comment">// 引脚值为低电平</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 这里应该返回读取到的引脚值（0或1），而不是返回固定的-1</span></span><br><span class="line">    close(fd); <span class="comment">// 关闭文件（这行代码无法执行到，应该放在read之前）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> <span class="comment">// 主函数</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> value;</span><br><span class="line">    <span class="built_in">sprintf</span>(gpio_path, <span class="string">&quot;/sys/class/gpio/gpio%s&quot;</span>, argv[<span class="number">1</span>]); <span class="comment">// 构建GPIO路径</span></span><br><span class="line">    <span class="keyword">if</span> (access(gpio_path, F_OK))                            <span class="comment">// 检查GPIO路径是否存在</span></span><br><span class="line">    &#123;</span><br><span class="line">        gpio_export(argv[<span class="number">1</span>]); <span class="comment">// 不存在则导出GPIO引脚</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        gpio_unexport(argv[<span class="number">1</span>]); <span class="comment">// 存在则取消导出GPIO引脚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gpio_ctrl(<span class="string">&quot;direction&quot;</span>, <span class="string">&quot;in&quot;</span>); <span class="comment">// 设置GPIO引脚为输入模式</span></span><br><span class="line">    gpio_ctrl(<span class="string">&quot;edge&quot;</span>, <span class="string">&quot;both&quot;</span>);    <span class="comment">// 设置GPIO引脚的中断触发方式为上升沿和下降沿</span></span><br><span class="line">    gpio_interrupt(<span class="string">&quot;value&quot;</span>);      <span class="comment">// 监听GPIO引脚的中断事件</span></span><br><span class="line"></span><br><span class="line">    gpio_unexport(argv[<span class="number">1</span>]); <span class="comment">// 最后取消导出GPIO引脚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 返回0表示程序正常退出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="通过IO命令操作寄存器控制GPIO"><a href="#通过IO命令操作寄存器控制GPIO" class="headerlink" title="通过IO命令操作寄存器控制GPIO"></a>通过IO命令操作寄存器控制GPIO</h3><h4 id="IO命令"><a href="#IO命令" class="headerlink" title="IO命令"></a>IO命令</h4><p>io 命令是一个用于 Linux 系统的命令行工具，用于读取和写入指定 I&#x2F;O 端口的值。它主要用于与硬件设备进行低级别的交互和调试，在内核阶段读写寄存器。</p>
<p>该命令的语法如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io <span class="selector-attr">[选项]</span> <span class="selector-attr">[地址]</span> <span class="selector-attr">[操作]</span> <span class="selector-attr">[数据]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>选项<ul>
<li><code>-b</code>：以字节为单位进行 I&#x2F;O 操作（默认为字）。</li>
<li><code>-w</code>：以字为单位进行 I&#x2F;O 操作。</li>
<li><code>-l</code>：以双字为单位进行 I&#x2F;O 操作。</li>
</ul>
</li>
<li>地址：<strong>要读取或写入的 I&#x2F;O 端口的十六进制值</strong></li>
<li>操作：<ul>
<li><code>-r</code>：读取 I&#x2F;O 端口的值。</li>
<li><code>-w</code>：写入数据到 I&#x2F;O 端口</li>
</ul>
</li>
<li>数据：<strong>要写入 I&#x2F;O 端口的十六进制值</strong>。</li>
</ul>
<p>例子：</p>
<ol>
<li>读取 I&#x2F;O 端口的值：<br><code>io -b -r 0x80</code><br>这将以字节为单位读取 I&#x2F;O 端口 0x80 的值，并将其显示在终端上。</li>
<li>向 I&#x2F;O 端口写入数据：<br><code>io -b -w 0x80 0xAB</code><br>这将向 I&#x2F;O 端口 0x80 写入十六进制值 0xAB。</li>
<li>以字为单位进行读取：<br><code>io -w -r 0x1000</code><br>这将以字为单位读取 I&#x2F;O 端口 0x1000 的值</li>
<li>以双字为单位进行写入：<br><code>io -l -w 0x2000 0xDEADBEEF</code><br>这将以双字为单位向 I&#x2F;O 端口 0x2000 写入十六进制值 0xDEADBEEF</li>
</ol>
<h4 id="LED引脚寄存器查找"><a href="#LED引脚寄存器查找" class="headerlink" title="LED引脚寄存器查找"></a>LED引脚寄存器查找</h4><p>控制 LED 灯的 GPIO 为 GPIO0_B7，我们需要对 GPIO 进行配置，一般情况下需要对 GPIO 的<strong>复用寄存器</strong>，<strong>方向寄存器</strong>，<strong>数据寄存器</strong>进行配置。</p>
<h5 id="复用寄存器"><a href="#复用寄存器" class="headerlink" title="复用寄存器"></a>复用寄存器</h5><p>RK3568 TRM-Part1 GPIO Interface Description中可以看出</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223194944566.png" alt="RK3568 TRM-Part1 GPIO Interface Description" loading="lazy"></p>
<p>PMU_GRF Register Description如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223194948096.png" alt="GRF Address Mapping Table" loading="lazy"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223194956751.png" alt="RK3568 TRM-Part1 PMU_GRF Register Description" loading="lazy"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195004557.png" alt="PMU_GRF_GPIO0B_IOMUX_H" loading="lazy"></p>
<p>所以复用寄存器地址&#x3D;基地址+偏移地址&#x3D;0xFDC2000C 。</p>
<p>使用 io 命令查看此寄存器的地址：<code>io -r -4 0xFDC2000C</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195008340.png" alt="io -r -4 0xFDC2000C" loading="lazy"></p>
<p>寄存器值为 00000001，[14:12]位为 000，所以默认设置的为 gpio 功能。</p>
<h5 id="方向寄存器"><a href="#方向寄存器" class="headerlink" title="方向寄存器"></a>方向寄存器</h5><p>RK3568 TRM-Part1 GPIO Interface Description中可以看出，方向寄存器应为GPIO_SWPORT_DDR_L或GPIO_SWPORT_DDR_H</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195012437.png" alt="RK3568 TRM-Part1 GPIO Interface Description" loading="lazy"></p>
<p>GPIO 有四组 GPIO，分别是 GPIOA，GPIOB，GPIOC，GPIOD。每组又以 A0<del>A7, B0</del>B7, C0<del>C7, D0</del>D7 作为编号区分。GPIO0B7 在 GPIO_SWPORT_DDR_L 上所以，方向寄存器的偏移地址为 0x0008。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195018919.png" alt="GPIO_SWPORT_DDR_L" loading="lazy"></p>
<p>[31:16]位属性是 WO，也就是只可写入。这[31:16]位是写标志位，是低 16 位的写使能。如果低 16 位中某一位要设置输入输入输出，则对应高位写标志也应该设置为 1。</p>
<p> [15：0] 是数据方向控制寄存器低位，如果要设置某个 GPIO 为输出，则对应位置 1，如果要设置某个 GPIO 为输入，则对应位置 0。那么 GPIO0 B7 ，我们要设置第 15 位为输入还是输出，那么对应的[31:16]位写使能也要置 1。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195022072.png" alt="Address Mapping" loading="lazy"></p>
<p>GPIO0 的基地址为 0xFDD60000。因此方向寄存器的地址&#x3D;基地址+偏移地址&#x3D;0xFDD60000+0x0008&#x3D;0xFDD60008</p>
<h5 id="数据寄存器"><a href="#数据寄存器" class="headerlink" title="数据寄存器"></a>数据寄存器</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195025447.png" alt="RK3568 TRM-Part1 GPIO Interface Description" loading="lazy"></p>
<p>所以数据寄存器的地址为基地址+偏移地址&#x3D;0xFDD60000。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195029822.png" alt="Detailed Register Description" loading="lazy"></p>
<p>上图的方法和在分析方向寄存器的方法同理，由上图可知，如果要控制第 15 位为高电平（置 1），还需要设置 31 位为 1，那么点亮灯，需要向数据寄存器写入 0x8000c040</p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><ul>
<li>复用关系寄存器的基地址为 0xFDC20000 ，偏移地址为 000C ，所以要操作的地址为基地址+偏移地址&#x3D;0xFDC2000C</li>
<li>GPIO 的基地址为 0xFDD60000，偏移地址为 0x0008，所以方向寄存器要操作的地址为基地址+偏移地址&#x3D;0xFDD60008，我们要给方向寄存器写入 0x80000044 设置为输出。</li>
<li>GPIO 的基地址为 0xFDD60000，偏移地址为 0x0000，所以数据寄存器要操作的地址为基地址+偏移地址&#x3D;0xFDD60000</li>
<li>默认的数据寄存器的值：0x8000c040 亮灯，0x80004040 灭灯</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认 GPIO0_B7 是 GPIO 模式，然后输入以下命令将方向寄存器设置为输出。</span></span><br><span class="line">io -w -4 0xFDD60008 0x80008044</span><br><span class="line"><span class="comment"># 接下来设置 GPIO 是输出高电平还是低电平，首先查看数据寄存器的值，输入以下命令：</span></span><br><span class="line">io -r -4 0xFDD60000</span><br><span class="line"><span class="comment"># 给数据寄存器写入 0x80008040 输出高电平，灯亮。</span></span><br><span class="line">io -w -4 0xFDD60000 0x8000c040</span><br><span class="line"><span class="comment"># 给数据寄存器写入 0x80008040 输出高电平，灯灭。</span></span><br><span class="line">io -w -4 0xFDD60000 0x80004040</span><br></pre></td></tr></table></figure>







<h3 id="通过mem设备和mmap控制GPIO"><a href="#通过mem设备和mmap控制GPIO" class="headerlink" title="通过mem设备和mmap控制GPIO"></a>通过mem设备和mmap控制GPIO</h3><p>通过打开<code>/dev/mem</code> 设备文件，并将其映射到用户空间的内存中，我们可以直接读写物理内存地址，从而实现对 GPIO 寄存器的控制。这种方法相对于 IO 命令更加灵活，可以使用更高级的编程语言（如 C&#x2F;C++）来编写控制逻辑。</p>
<h4 id="Linux系统用户态访问内核态的方式"><a href="#Linux系统用户态访问内核态的方式" class="headerlink" title="Linux系统用户态访问内核态的方式"></a>Linux系统用户态访问内核态的方式</h4><ol>
<li><p><strong>通过 read&#x2F;write&#x2F;ioctl</strong>：使用这种方式，用户态程序可以通过读写文件描述符或使用 ioctl 系统调用与内核进行通信。例如，可以通过读写特定文件描述符来控制设备或获取设备状态。</p>
</li>
<li><p><strong>通过 sysfs 虚拟文件系统</strong>：sysfs 是一种以文件的形式表示设备和内核信息的虚拟文件系统。通过在 sysfs 中的特定路径下读写文件，用户态程序可以与内核进行交互，例如控制 GPIO 引脚或获取系统信息。</p>
</li>
<li><p><strong>通过内存映射</strong>：内存映射是将用户空间的一段内存区域映射到内核空间的一种机制。通过内存映射，用户态程序可以直接修改内存区域的内容，从而与内核进行通信。这种方式可以实现高效的数据传输和共享。</p>
</li>
<li><p><strong>通过 Netlink</strong>：Netlink 是 Linux 内核提供的一种通信机制，用于用户态程序与内核之间的双向通信。通过创建 Netlink 套接字，用户态程序可以与内核进行交互，发送请求、接收事件通知等。这种方式适用于需要与内核进行复杂交互的场景，例如配置系统参数或发送命令。</p>
</li>
</ol>
<h4 id="dev-mem-设备"><a href="#dev-mem-设备" class="headerlink" title="/dev/mem 设备"></a><code>/dev/mem</code> 设备</h4><p><code>/dev/mem</code> 是 Linux 系统中的一个虚拟设备，通常与 mmap 结合使用，可以<strong>将设备的物理内存映射到用户态</strong>，以实现用户空间对内核态的直接访问。无论是标准 Linux 系统还是嵌入式Linux 系统，都支持使用<code>/dev/mem</code> 设备。</p>
<p>直接访问内核空间是一项潜在危险的操作，因此只有 root 用户才能访问<code>/dev/mem</code>设备。此外有些系统可能需要单独启动&#x2F;dev&#x2F;mem 设备的功能。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Device Drivers ---&gt;</span><br><span class="line">	Character devices---&gt;</span><br><span class="line">		[*] /dev/mem virtual device support</span><br></pre></td></tr></table></figure>

<p>IO 命令实际上就是基于<code>/dev/mem</code>设备实现的。如果 Linux 内核源码没有配置支持<code>/dev/mem</code>，IO 命令是不能使用的。</p>
<p>使用 <code>/dev/mem</code> 设备需要 <strong>root 权限</strong>，并且必须<strong>谨慎操作</strong>，因为直接访问物理内存（内核空间）是一项潜在的危险操作，可能导致系统崩溃或数据损坏。</p>
<p>以下是使用 <code>/dev/mem</code> 的基本步骤：</p>
<p><strong>步骤一：打开 <code>/dev/mem</code> 文件</strong></p>
<p>使用 <code>open()</code> 函数以适当的权限和模式打开 <code>/dev/mem</code>，获取文件描述符。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> fd = <span class="number">0</span>;</span><br><span class="line">fd = open(<span class="string">&quot;/dev/mem&quot;</span>, O_RDWR | O_NDELAY);  <span class="comment">/* 读写权限，非阻塞模式 */</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>访问权限选项</strong>：<ul>
<li><code>O_RDONLY</code>：只读</li>
<li><code>O_WRONLY</code>：只写</li>
<li><code>O_RDWR</code>：读写</li>
</ul>
</li>
<li><strong>阻塞模式选项</strong>：<ul>
<li>默认为阻塞</li>
<li><code>O_NDELAY</code> 或 <code>O_NONBLOCK</code>：非阻塞</li>
</ul>
</li>
</ul>
<blockquote>
<p>可以根据实际需求选择适当的访问权限和阻塞方式</p>
</blockquote>
<p><strong>步骤二：映射物理内存到用户空间</strong></p>
<p>使用 <code>mmap()</code> 将目标物理地址映射到进程的虚拟地址空间：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *mmap_addr = <span class="literal">NULL</span>;</span><br><span class="line">mmap_addr = (<span class="type">char</span> *)mmap(</span><br><span class="line">    <span class="literal">NULL</span>,                <span class="comment">// 让内核选择映射地址</span></span><br><span class="line">    MMAP_SIZE,           <span class="comment">// 映射区域大小（字节）</span></span><br><span class="line">    PROT_READ | PROT_WRITE,  <span class="comment">// 读写权限</span></span><br><span class="line">    MAP_SHARED,          <span class="comment">// 共享映射（对其他进程可见）</span></span><br><span class="line">    fd,                  <span class="comment">// /dev/mem 的文件描述符</span></span><br><span class="line">    MMAP_ADDR            <span class="comment">// 要映射的物理地址（需页对齐）</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>MMAP_ADDR</code>：目标物理地址（通常需按页对齐，如 4KB 对齐）</li>
<li><code>MMAP_SIZE</code>：映射长度（建议至少一个内存页，如 4096 字节）</li>
<li>若 <code>mmap()</code> 返回 <code>MAP_FAILED</code>，表示映射失败，应检查错误码（<code>errno</code>）</li>
</ul>
<p><strong>步骤三：读写映射的内存（寄存器操作）</strong></p>
<p>通过返回的指针直接访问硬件寄存器或物理内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">*(<span class="type">int</span> *)mmap_addr = <span class="number">0xff</span>;   <span class="comment">// 写操作：向映射地址写入 0xff</span></span><br><span class="line">a = *(<span class="type">int</span> *)mmap_addr;      <span class="comment">// 读操作：从映射地址读取值到变量 a</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>指针类型可根据寄存器宽度调整（如 <code>uint32_t*</code>、<code>volatile uint8_t*</code> 等）</p>
</li>
<li><p>建议使用 <code>volatile</code> 修饰符防止编译器优化导致访问异常：</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="type">uint32_t</span> *reg = (<span class="keyword">volatile</span> <span class="type">uint32_t</span> *)mmap_addr;</span><br><span class="line">*reg = <span class="number">0x12345678</span>;</span><br></pre></td></tr></table></figure>

<p><strong>注意事项</strong></p>
<ol>
<li><strong>权限要求</strong>：必须以 root 用户运行，或具备 <code>CAP_SYS_RAWIO</code> 能力。</li>
<li><strong>地址对齐</strong>：<code>mmap()</code> 要求偏移量（即物理地址）是页大小（通常 4096）的整数倍。</li>
<li><strong>安全风险</strong>：错误的读写可能引发系统崩溃、硬件异常或安全漏洞。</li>
<li><strong>资源释放</strong>：使用完毕后应调用 <code>munmap()</code> 解除映射，并 <code>close()</code> 文件描述符。</li>
</ol>
<h4 id="mmap-函数"><a href="#mmap-函数" class="headerlink" title="mmap()函数"></a>mmap()函数</h4><h4 id="mmap-函数总结"><a href="#mmap-函数总结" class="headerlink" title="mmap() 函数总结"></a><code>mmap()</code> 函数总结</h4><p><strong>功能</strong>：将文件或设备（如 <code>/dev/mem</code>）映射到进程的虚拟地址空间，实现直接内存访问。</p>
<p><strong>函数原型</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">mmap</span><span class="params">(<span class="type">void</span> *start, <span class="type">size_t</span> length, <span class="type">int</span> prot, <span class="type">int</span> flags, <span class="type">int</span> fd, <span class="type">off_t</span> offset)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>参数说明</strong>：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>start</code></td>
<td>建议映射的起始地址。通常设为 <code>NULL</code>，由内核自动选择。</td>
</tr>
<tr>
<td><code>length</code></td>
<td>要映射的字节数。</td>
</tr>
<tr>
<td><code>prot</code></td>
<td>内存保护标志（可组合）： • <code>PROT_READ</code>：可读 • <code>PROT_WRITE</code>：可写 • <code>PROT_EXEC</code>：可执行 • <code>PROT_NONE</code>：不可访问</td>
</tr>
<tr>
<td><code>flags</code></td>
<td>映射类型（必须指定其一）： • <code>MAP_SHARED</code>：修改对其他进程可见，会写回文件&#x2F;设备 • <code>MAP_PRIVATE</code>：写时复制，修改不共享 • <code>MAP_FIXED</code>：强制使用 <code>start</code> 地址（<strong>不推荐</strong>）</td>
</tr>
<tr>
<td><code>fd</code></td>
<td>文件描述符（由 <code>open()</code> 返回），若映射匿名内存可设为 <code>-1</code>（需配合 <code>MAP_ANONYMOUS</code>）。</td>
</tr>
<tr>
<td><code>offset</code></td>
<td>文件&#x2F;设备中的偏移量，<strong>必须是系统页大小（如 4096）的整数倍</strong>。</td>
</tr>
</tbody></table>
<p><strong>返回值</strong>：</p>
<ul>
<li>成功：返回指向映射区域的指针（<code>void*</code>）</li>
<li>失败：返回 <code>MAP_FAILED</code>（即 <code>(void*) -1</code>），并设置 <code>errno</code></li>
</ul>
<p><strong>典型用途</strong>：</p>
<ul>
<li>访问硬件寄存器（通过 <code>/dev/mem</code>）</li>
<li>高效文件 I&#x2F;O（避免 <code>read</code>&#x2F;<code>write</code> 系统调用开销）</li>
<li>进程间共享内存（配合 <code>MAP_SHARED</code>）</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>使用完毕应调用 <code>munmap()</code> 释放映射。</li>
<li><code>offset</code> 和映射长度需注意对齐和边界。</li>
<li>操作物理内存需 root 权限，存在安全风险。</li>
</ul>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_REG_BASE 0xFDD60000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_SWPORT_DDR_L_OFFSET 0x0008</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_SWPORT_DR_L_OFFSET 0x0000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE_MAP 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开LED灯</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_ON</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *base)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 设置LED灯的方向为输出</span></span><br><span class="line">    *(<span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> *)(base + GPIO_SWPORT_DDR_L_OFFSET) = <span class="number">0x80008044</span>;</span><br><span class="line">    <span class="comment">// 将LED灯打开</span></span><br><span class="line">    *(<span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> *)(base + GPIO_SWPORT_DR_L_OFFSET) = <span class="number">0x80008040</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭LED灯</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_OFF</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *base)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 设置LED灯的方向为输出</span></span><br><span class="line">    *(<span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> *)(base + GPIO_SWPORT_DDR_L_OFFSET) = <span class="number">0x80008044</span>;</span><br><span class="line">    <span class="comment">// 将LED灯关闭</span></span><br><span class="line">    *(<span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> *)(base + GPIO_SWPORT_DR_L_OFFSET) = <span class="number">0x80000040</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *map_base;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开/dev/mem设备</span></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open /dev/mem error \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将物理地址映射到用户空间</span></span><br><span class="line">    map_base = (<span class="type">unsigned</span> <span class="type">char</span> *)mmap(<span class="literal">NULL</span>, SIZE_MAP, PROT_READ | PROT_WRITE, MAP_SHARED, fd, GPIO_REG_BASE);</span><br><span class="line">    <span class="keyword">if</span> (map_base == MAP_FAILED)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;map_base error \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 打开LED灯</span></span><br><span class="line">        LED_ON(map_base);</span><br><span class="line">        <span class="comment">// 等待1秒</span></span><br><span class="line">        usleep(<span class="number">1000000</span>);</span><br><span class="line">        <span class="comment">// 关闭LED灯</span></span><br><span class="line">        LED_OFF(map_base);</span><br><span class="line">        <span class="comment">// 等待1秒</span></span><br><span class="line">        usleep(<span class="number">1000000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解除映射</span></span><br><span class="line">    munmap(map_base, SIZE_MAP);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭文件描述符</span></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 返回0表示程序正常退出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="GPIO调试"><a href="#GPIO调试" class="headerlink" title="GPIO调试"></a>GPIO调试</h2><h3 id="debugfs"><a href="#debugfs" class="headerlink" title="debugfs"></a>debugfs</h3><p>debugfs 是 Linux 内核提供的一个调试文件系统，可以用于查看和调试内核中的各种信息，包括 GPIO 的使用情况。通过挂载 debugfs 文件系统，并查看<code>/sys/kernel/debug/</code>目录下的相关文件，可以获取 GPIO 的状态，配置和其他调试信息，如图所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195038616.png" alt="&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;" loading="lazy"></p>
<p>如果上图目录<code>/sys/kernel/debug</code> 目录下没有文件，需要在 Linux 内核源码配置 debugfs，勾选<code>Debug Filesystem</code>配置好之后，重新编译内核源码，烧写内核镜像。</p>
<p>如果没有 debugfs，可以使用以下命令进行挂载:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t debugfs none /sys/kernel/debug/</span><br></pre></td></tr></table></figure>

<p>如果有 debugfs，可以使用以下命令查看 GPIO 的信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /sys/kernel/debug/gpio</span><br></pre></td></tr></table></figure>



<p>进入<code>/sys/kernel/debug/pinctrl</code> 目录时，你可以获取有关 GPIO 控制器的调试信息。在该目录下，通常会有以下文件和目录：</p>
<ol>
<li><code>/sys/kernel/debug/pinctrl/*/pinmux-pins</code>：这些文件列出了每个 GPIO 引脚的引脚复用配置。可以查看每个引脚的功能模式、引脚复用选择以及其他相关的配置信息。我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“cat pinmux-pins”，如下图所示：</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195041761.png" alt="cat pinmux-pins" loading="lazy"></p>
<ol start="2">
<li><code>/sys/kernel/debug/pinctrl/*/pins</code>：这些文件列出了 GPIO 的引脚编号，可以查看 GPIO 编号。我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“cat pins”，如下图所示：</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195045896.png" alt="cat pins" loading="lazy"></p>
<ol start="3">
<li><code>/sys/kernel/debug/pinctrl/*/gpio-ranges</code>：这些文件列出了每个 GPIO 控制器支持的 GPIO 范围。<br>你可以查看GPIO 编号的范围和对应的控制器名称 。我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“cat gpio-ranges”，如下图所示：</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195049529.png" alt="cat gpio-ranges" loading="lazy"></p>
<ol start="4">
<li><code>/sys/kernel/debug/pinctrl/*/pinmux-functions</code>：这些文件列出了每个功能模式的名称以及与之关联的 GPIO 引脚。你可以查看各个功能模式的名称和对应的引脚列表。我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“cat pinmux-functions”，如下图所示：</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195052740.png" alt="image-20251217183545784" loading="lazy"></p>
<ol start="5">
<li><code>/sys/kernel/debug/pinctrl/*/pingroups</code>：该路径提供有关用于配置和控制系统上的 GPIO 引脚的引脚组的信息。我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“cat pingroups”，如下图所示：</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195055693.png" alt="cat pingroups" loading="lazy"></p>
<ol start="6">
<li><code>/sys/kernel/debug/pinctrl/*/pinconf-pins</code>：这些文件包含了 GPIO 引脚的配置信息，如输入&#x2F;输出模式、上拉&#x2F;下拉设置等。你可以查看和修改 GPIO 的电气属性，以便进行 GPIO 的调试和配置。我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“cat pinconf-pins”，如下图所示：</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195058797.png" alt="cat pinconf-pins" loading="lazy"></p>
<h2 id="GPIO子系统API"><a href="#GPIO子系统API" class="headerlink" title="GPIO子系统API"></a>GPIO子系统API</h2><p>在目前的 Linux 内核主线中，GPIO（通用输入&#x2F;输出）子系统存在两个版本，这里将两个版本区分为新版本和旧版本。新版本 GPIO 子系统接口是基于描述符（descriptor-based）来实现的，而旧版本的 GPIO 子系统接口是基于整数（integer-based）来实现的，在 Linux 内核中为了保持向下的兼容性，旧版本的接口在最新的内核版本中仍然得到支持，而随着时间的推移，新版本的 GPIO 子系统接口会越来越完善，最终完全取代旧版本。</p>
<p>新的 GPIO 子系统接口需要与与设备树（Device Tree）结合使用。使用设备树和新的 GPIO接口可以更加灵活地配置和管理系统中的 GPIO 资源，提供了更好的可扩展性和可移植性。所以<strong>如果没有设备树，就无法使用新的 GPIO 接口</strong>。</p>
<p>一个明显的区别是新的 GPIO 子系统接口使用了以<code>gpiod_</code>作为前缀的函数命名约定，而旧的 GPIO 子系统接口使用了以<code>gpio_</code>作为前缀的函数命名约定。</p>
<h3 id="gpio-desc-结构体"><a href="#gpio-desc-结构体" class="headerlink" title="gpio_desc 结构体"></a>gpio_desc 结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_device</span>	*<span class="title">gdev</span>;</span> <span class="comment">// GPIO 设备结构体</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		flags; <span class="comment">// 标志位，用于表示不同的属性</span></span><br><span class="line"><span class="comment">/* flag symbols are bit numbers */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_REQUESTED	0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_IS_OUT	1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_EXPORT	2	<span class="comment">/* protected by sysfs_lock */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_SYSFS	3	<span class="comment">/* exported via /sys/class/gpio/control */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_ACTIVE_LOW	6	<span class="comment">/* value has active low */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_OPEN_DRAIN	7	<span class="comment">/* Gpio is open drain type */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_OPEN_SOURCE 8	<span class="comment">/* Gpio is open source type */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_USED_AS_IRQ 9	<span class="comment">/* GPIO is connected to an IRQ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_IRQ_IS_ENABLED 10	<span class="comment">/* GPIO is connected to an enabled IRQ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_IS_HOGGED	11	<span class="comment">/* GPIO is hogged */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_TRANSITORY 12	<span class="comment">/* GPIO may lose value in sleep or reset */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_PULL_UP    13	<span class="comment">/* GPIO has pull up enabled */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_PULL_DOWN  14	<span class="comment">/* GPIO has pull down enabled */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_BIAS_DISABLE    15	<span class="comment">/* GPIO has pull disabled */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_EDGE_RISING     16	<span class="comment">/* GPIO CDEV detects rising edge events */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_EDGE_FALLING    17	<span class="comment">/* GPIO CDEV detects falling edge events */</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Connection label */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>		*label; <span class="comment">// 表示 GPIO 的标签或名称</span></span><br><span class="line">	<span class="comment">/* Name of the GPIO */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>		*name; <span class="comment">// GPIO 的名称</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_OF_DYNAMIC</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span>	*<span class="title">hog</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_GPIO_CDEV</span></span><br><span class="line">	<span class="comment">/* debounce period in microseconds */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		debounce_period_us;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="gpio-device-结构体"><a href="#gpio-device-结构体" class="headerlink" title="gpio_device 结构体"></a>gpio_device 结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct gpio_device - internal state container for GPIO devices</span></span><br><span class="line"><span class="comment"> * @id: numerical ID number for the GPIO chip</span></span><br><span class="line"><span class="comment"> * @dev: the GPIO device struct</span></span><br><span class="line"><span class="comment"> * @chrdev: character device for the GPIO device</span></span><br><span class="line"><span class="comment"> * @mockdev: class device used by the deprecated sysfs interface (may be</span></span><br><span class="line"><span class="comment"> * NULL)</span></span><br><span class="line"><span class="comment"> * @owner: helps prevent removal of modules exporting active GPIOs</span></span><br><span class="line"><span class="comment"> * @chip: pointer to the corresponding gpiochip, holding static</span></span><br><span class="line"><span class="comment"> * data for this device</span></span><br><span class="line"><span class="comment"> * @descs: array of ngpio descriptors.</span></span><br><span class="line"><span class="comment"> * @ngpio: the number of GPIO lines on this GPIO device, equal to the size</span></span><br><span class="line"><span class="comment"> * of the @descs array.</span></span><br><span class="line"><span class="comment"> * @base: GPIO base in the DEPRECATED global Linux GPIO numberspace, assigned</span></span><br><span class="line"><span class="comment"> * at device creation time.</span></span><br><span class="line"><span class="comment"> * @label: a descriptive name for the GPIO device, such as the part number</span></span><br><span class="line"><span class="comment"> * or name of the IP component in a System on Chip.</span></span><br><span class="line"><span class="comment"> * @data: per-instance data assigned by the driver</span></span><br><span class="line"><span class="comment"> * @list: links gpio_device:s together for traversal</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This state container holds most of the runtime variable data</span></span><br><span class="line"><span class="comment"> * for a GPIO device and can hold references and live on after the</span></span><br><span class="line"><span class="comment"> * GPIO chip has been removed, if it is still being used from</span></span><br><span class="line"><span class="comment"> * userspace.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_device</span> &#123;</span></span><br><span class="line">	<span class="type">int</span>			id; <span class="comment">// GPIO 设备 ID。每个 GPIO 设备可以有一个唯一的 ID</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>		<span class="title">dev</span>;</span><span class="comment">// 对应的设备结构体指针</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cdev</span>		<span class="title">chrdev</span>;</span><span class="comment">// 字符设备结构体，用于实现 GPIO 设备的字符设备接口</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>		*<span class="title">mockdev</span>;</span><span class="comment">// 模拟设备结构体指针，用于表示 GPIO 设备的模拟设备结构体</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>		*<span class="title">owner</span>;</span><span class="comment">// 拥有该 GPIO 设备的内核模块指针</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_chip</span>	*<span class="title">chip</span>;</span><span class="comment">// 对应的 GPIO 芯片结构体指针，示与 GPIO 设备关联的 GPIO 芯片（GPIO 控制器）结构体</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span>	*<span class="title">descs</span>;</span><span class="comment">// GPIO 描述符数组指针。每个 GPIO 描述符用于描述 GPIO 的属性和状态</span></span><br><span class="line">	<span class="type">int</span>			base;<span class="comment">// GPIO 编号的起始值</span></span><br><span class="line">	u16			ngpio;<span class="comment">// GPIO 的数量</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>		*label;<span class="comment">// GPIO 设备的标签</span></span><br><span class="line">	<span class="type">void</span>			*data;<span class="comment">// 与 GPIO 设备相关的数据指针</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>        <span class="title">list</span>;</span><span class="comment">// 用于将 GPIO 设备结构体连接到链表中</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blocking_notifier_head</span> <span class="title">notifier</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PINCTRL</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If CONFIG_PINCTRL is enabled, then gpio controllers can optionally</span></span><br><span class="line"><span class="comment">	 * describe the actual pin range which they serve in an SoC. This</span></span><br><span class="line"><span class="comment">	 * information would be used by pinctrl subsystem to configure</span></span><br><span class="line"><span class="comment">	 * corresponding pins for gpio usage.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 如果启用了 CONFIG_PINCTRL 选项，GPIO 控制器可以选择描述它们在 SoC 中服务的实际引脚范围。</span></span><br><span class="line"><span class="comment">	* 此信息将由 pinctrl 子系统用于配置相应的 GPIO 引脚。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">pin_ranges</span>;</span><span class="comment">// 描述 GPIO 控制器引脚范围的链表</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面一系列的参数中，要重点关注的是 <code>struct gpio_chip *chip</code> 这一结构体，表示与 GPIO 设备关联的 GPIO 芯片（GPIO 控制器）结构体。</p>
<h3 id="gpio-chip结构体"><a href="#gpio-chip结构体" class="headerlink" title="gpio_chip结构体"></a>gpio_chip结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_chip</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>		*label;<span class="comment">// GPIO 芯片标签</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_device</span>	*<span class="title">gpiodev</span>;</span><span class="comment">// GPIO 设备</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>		*<span class="title">parent</span>;</span><span class="comment">// 父设备指针</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>		*<span class="title">owner</span>;</span><span class="comment">// 拥有者模块指针</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span>			(*request)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">int</span> offset);<span class="comment">// 请求 GPIO</span></span><br><span class="line">	<span class="type">void</span>			(*<span class="built_in">free</span>)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">int</span> offset);<span class="comment">// 释放 GPIO</span></span><br><span class="line">	<span class="type">int</span>			(*get_direction)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">int</span> offset);<span class="comment">// 获取 GPIO 方向</span></span><br><span class="line">	<span class="type">int</span>			(*direction_input)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">int</span> offset);<span class="comment">// 设置 GPIO 为输入</span></span><br><span class="line">	<span class="type">int</span>			(*direction_output)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">int</span> offset, <span class="type">int</span> value);<span class="comment">// 设置 GPIO 为输出</span></span><br><span class="line">	<span class="type">int</span>			(*get)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">int</span> offset);<span class="comment">// 获取 GPIO 值</span></span><br><span class="line">	<span class="type">int</span>			(*get_multiple)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">long</span> *mask,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">long</span> *bits);<span class="comment">// 获取多个 GPIO 的值</span></span><br><span class="line">	<span class="type">void</span>			(*<span class="built_in">set</span>)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">int</span> offset, <span class="type">int</span> value);<span class="comment">// 设置 GPIO 值</span></span><br><span class="line">	<span class="type">void</span>			(*set_multiple)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">long</span> *mask,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">long</span> *bits);<span class="comment">// 设置多个 GPIO</span></span><br><span class="line">	<span class="type">int</span>			(*set_config)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">					      <span class="type">unsigned</span> <span class="type">int</span> offset,</span><br><span class="line">					      <span class="type">unsigned</span> <span class="type">long</span> config);<span class="comment">// 设置 GPIO 配置</span></span><br><span class="line">	<span class="type">int</span>			(*to_irq)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">int</span> offset);<span class="comment">// 将 GPIO 转换为中断</span></span><br><span class="line"></span><br><span class="line">	<span class="type">void</span>			(*dbg_show)(<span class="keyword">struct</span> seq_file *s,</span><br><span class="line">						<span class="keyword">struct</span> gpio_chip *gc);<span class="comment">// 在调试信息中显示 GPIO</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span>			(*init_valid_mask)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">						   <span class="type">unsigned</span> <span class="type">long</span> *valid_mask,</span><br><span class="line">						   <span class="type">unsigned</span> <span class="type">int</span> ngpios);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span>			(*add_pin_ranges)(<span class="keyword">struct</span> gpio_chip *gc);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span>			base;<span class="comment">// GPIO 编号的基准值</span></span><br><span class="line">	u16			ngpio;<span class="comment">// GPIO 的数量</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>		*<span class="type">const</span> *names;<span class="comment">// GPIO 的名称数组</span></span><br><span class="line">	<span class="type">bool</span>			can_sleep;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> IS_ENABLED(CONFIG_GPIO_GENERIC)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*read_reg)</span><span class="params">(<span class="type">void</span> __iomem *reg)</span>;</span><br><span class="line">	<span class="type">void</span> (*write_reg)(<span class="type">void</span> __iomem *reg, <span class="type">unsigned</span> <span class="type">long</span> data);</span><br><span class="line">	<span class="type">bool</span> be_bits;</span><br><span class="line">	<span class="type">void</span> __iomem *reg_dat;</span><br><span class="line">	<span class="type">void</span> __iomem *reg_set;</span><br><span class="line">	<span class="type">void</span> __iomem *reg_clr;</span><br><span class="line">	<span class="type">void</span> __iomem *reg_dir_out;</span><br><span class="line">	<span class="type">void</span> __iomem *reg_dir_in;</span><br><span class="line">	<span class="type">bool</span> bgpio_dir_unreadable;</span><br><span class="line">	<span class="type">int</span> bgpio_bits;</span><br><span class="line">	<span class="type">spinlock_t</span> bgpio_lock;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bgpio_data;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bgpio_dir;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_GPIO_GENERIC */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_GPIOLIB_IRQCHIP</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * With CONFIG_GPIOLIB_IRQCHIP we get an irqchip inside the gpiolib</span></span><br><span class="line"><span class="comment">	 * to handle IRQs for most practical cases.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @irq:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Integrates interrupt chip functionality with the GPIO chip. Can be</span></span><br><span class="line"><span class="comment">	 * used to handle IRQs for most practical cases.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_irq_chip</span> <span class="title">irq</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_GPIOLIB_IRQCHIP */</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @valid_mask:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * If not %NULL holds bitmask of GPIOs which are valid to be used</span></span><br><span class="line"><span class="comment">	 * from the chip.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> *valid_mask;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_OF_GPIO)</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If CONFIG_OF is enabled, then all GPIO controllers described in the</span></span><br><span class="line"><span class="comment">	 * device tree automatically may have an OF translation</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @of_node:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Pointer to a device tree node representing this GPIO controller.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">of_node</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @of_gpio_n_cells:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Number of cells used to form the GPIO specifier.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> of_gpio_n_cells;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @of_xlate:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Callback to translate a device tree GPIO specifier into a chip-</span></span><br><span class="line"><span class="comment">	 * relative GPIO number and flags.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> (*of_xlate)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">			<span class="type">const</span> <span class="keyword">struct</span> of_phandle_args *gpiospec, u32 *flags);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_OF_GPIO */</span></span></span><br><span class="line"></span><br><span class="line">	ANDROID_KABI_RESERVE(<span class="number">1</span>);</span><br><span class="line">	ANDROID_KABI_RESERVE(<span class="number">2</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>struct gpio_chip *chip</code> 这一结构体用于描述 GPIO 芯片的属性和操作函数，可以通过函数指针调用相应的函数来请求、释放、设置、获取 GPIO 的状态和数值等操作，从而实现对 GPIO 的控制和管理，需要注意的是这个结构体中的一系列函数都不需要我们来填充，这些工作都是由芯片原厂工程师来完成的，我们只需要学会新 gpio 子系统相应 API 函数的使用即可。</p>
<h3 id="获取单个GPIO描述"><a href="#获取单个GPIO描述" class="headerlink" title="获取单个GPIO描述"></a>获取单个GPIO描述</h3><h4 id="gpiod-get"><a href="#gpiod-get" class="headerlink" title="gpiod_get()"></a>gpiod_get()</h4><p><strong>函数原型</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> gpio_desc *__must_check <span class="title function_">gpiod_get</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> device *dev,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">char</span> *con_id,</span></span><br><span class="line"><span class="params">    <span class="keyword">enum</span> gpiod_flags flags</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>头文件</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio/consumer.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p>根据设备和连接标识符（con_id）获取一个必需的 GPIO 描述符，并按指定标志配置其模式。</p>
<p><strong>参数</strong></p>
<ul>
<li><strong><code>dev</code></strong>：指向关联设备的 <code>struct device</code> 指针。</li>
<li><strong><code>con_id</code></strong>：连接标识符（connection ID），通常在设备树（Device Tree）中定义，用于匹配具体的 GPIO。</li>
<li><strong><code>flags</code></strong>：GPIO 配置标志，类型为 <code>enum gpiod_flags</code>，常用值包括：<ul>
<li><code>GPIOD_IN</code> 或 <code>GPIOD_INPUT</code>：配置为输入。</li>
<li><code>GPIOD_OUT_LOW</code> &#x2F; <code>GPIOD_OUT_HIGH</code>（旧版用 <code>GPIOD_OUTPUT</code>）：配置为输出，默认初始电平为低&#x2F;高。</li>
<li><code>GPIOD_ACTIVE_LOW</code>：逻辑高对应物理低电平（反相）。</li>
<li><code>GPIOD_OPEN_DRAIN</code>：开漏输出。</li>
<li><code>GPIOD_OPEN_SOURCE</code>：开源输出。</li>
</ul>
</li>
</ul>
<blockquote>
<p>⚠️ 注意：现代内核推荐使用 <code>GPIOD_OUT_LOW</code> &#x2F; <code>GPIOD_OUT_HIGH</code> 替代 <code>GPIOD_OUTPUT</code>，因为后者不指定初始电平。</p>
</blockquote>
<p><strong>示例设备树片段</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ &#123;</span><br><span class="line">    my_device: my-device@<span class="number">0</span> &#123;</span><br><span class="line">        compatible = <span class="string">&quot;myvendor,my-device&quot;</span>;</span><br><span class="line">        <span class="comment">/* 定义3个GPIO，分别对应 index 0, 1, 2 */</span></span><br><span class="line">        my-gpios = &lt;&amp;gpio1 <span class="number">5</span> GPIO_ACTIVE_HIGH&gt;,   <span class="comment">// index 0</span></span><br><span class="line">                   &lt;&amp;gpio1 <span class="number">6</span> GPIO_ACTIVE_LOW&gt;,    <span class="comment">// index 1</span></span><br><span class="line">                   &lt;&amp;gpio2 <span class="number">12</span> GPIO_ACTIVE_HIGH&gt;;  <span class="comment">// index 2</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>返回值</strong></p>
<ul>
<li>成功：返回指向 <code>struct gpio_desc</code> 的指针。</li>
<li>失败：返回 <code>ERR_PTR()</code> 编码的错误指针（如 <code>-ENOENT</code>, <code>-EPROBE_DEFER</code> 等），<strong>不是 NULL</strong>。</li>
</ul>
<blockquote>
<p>✅ 使用建议：应使用 <code>IS_ERR()</code> 判断返回值是否出错，而非检查 <code>NULL</code>。</p>
</blockquote>
<h4 id="gpiod-get-index"><a href="#gpiod-get-index" class="headerlink" title="gpiod_get_index()"></a>gpiod_get_index()</h4><p><strong>函数原型</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> gpio_desc *__must_check <span class="title function_">gpiod_get_index</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> device *dev,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">char</span> *con_id,</span></span><br><span class="line"><span class="params">    <span class="type">unsigned</span> <span class="type">int</span> idx,</span></span><br><span class="line"><span class="params">    <span class="keyword">enum</span> gpiod_flags flags</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p>获取与设备、连接标识符及索引 <code>idx</code> 对应的 GPIO 描述符。适用于一个 <code>con_id</code> 对应多个 GPIO（如 “leds”, “buttons” 等数组型 GPIO 组）。</p>
<p><strong>参数</strong></p>
<ul>
<li><strong><code>idx</code></strong>：GPIO 在该连接中的索引（从 0 开始）。</li>
</ul>
<p><strong>返回值</strong></p>
<ul>
<li>同 <code>gpiod_get</code>：成功返回 <code>gpio_desc*</code>，失败返回错误指针。</li>
</ul>
<h4 id="gpiod-get-optional"><a href="#gpiod-get-optional" class="headerlink" title="gpiod_get_optional()"></a>gpiod_get_optional()</h4><p>函数原型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> gpio_desc *__must_check <span class="title function_">gpiod_get_optional</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> device *dev,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">char</span> *con_id,</span></span><br><span class="line"><span class="params">    <span class="keyword">enum</span> gpiod_flags flags</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p>尝试获取指定的 GPIO，但如果设备树中未定义该 GPIO，则<strong>不视为错误</strong>，而是返回 <code>NULL</code>。</p>
<p><strong>适用场景</strong></p>
<p>用于可选 GPIO（例如某些硬件版本有，某些没有）。</p>
<p><strong>返回值</strong></p>
<ul>
<li>成功获取：返回 <code>struct gpio_desc*</code>。</li>
<li>未定义或不存在：返回 <code>NULL</code>。</li>
<li>其他错误（如 defer）：返回错误指针（需用 <code>IS_ERR()</code> 检查）。</li>
</ul>
<blockquote>
<p>✅ 安全使用方式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">desc = gpiod_get_optional(dev, <span class="string">&quot;reset&quot;</span>, GPIOD_OUT_HIGH);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(desc))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(desc);</span><br><span class="line"><span class="keyword">if</span> (!desc)</span><br><span class="line">dev_info(dev, <span class="string">&quot;No optional reset GPIO\n&quot;</span>);</span><br></pre></td></tr></table></figure></blockquote>
<h4 id="gpiod-get-index-optional"><a href="#gpiod-get-index-optional" class="headerlink" title="gpiod_get_index_optional()"></a>gpiod_get_index_optional()</h4><p><strong>函数原型</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> gpio_desc *__must_check <span class="title function_">gpiod_get_index_optional</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> device *dev,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">char</span> *con_id,</span></span><br><span class="line"><span class="params">    <span class="type">unsigned</span> <span class="type">int</span> idx,</span></span><br><span class="line"><span class="params">    <span class="keyword">enum</span> gpiod_flags flags</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p><code>gpiod_get_index</code> 的可选版本：若指定索引的 GPIO 不存在，不报错，返回 <code>NULL</code>。</p>
<p><strong>返回值</strong></p>
<ul>
<li>存在且成功：<code>gpio_desc*</code></li>
<li>不存在：<code>NULL</code></li>
<li>其他错误：错误指针（需 <code>IS_ERR()</code> 判断）</li>
</ul>
<h4 id="gpiod-put"><a href="#gpiod-put" class="headerlink" title="gpiod_put()"></a>gpiod_put()</h4><p><strong>函数原型</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">gpiod_put</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>头文件</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio/consumer.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p>释放一个通过 <code>gpiod_get()</code>、<code>gpiod_get_index()</code>、<code>gpiod_get_optional()</code> 或 <code>gpiod_get_index_optional()</code> 获取的 GPIO 描述符。</p>
<p>该函数会：</p>
<ul>
<li>释放对该 GPIO 的引用；</li>
<li>如果这是最后一个引用，则将 GPIO 恢复到未使用状态（如释放中断、取消映射等）；</li>
<li>不会自动改变 GPIO 的电平或方向（除非底层驱动实现特殊行为）。</li>
</ul>
<blockquote>
<p>⚠️ 注意：即使 GPIO 是“可选”的（通过 <code>_optional</code> 函数获取），只要返回值非 <code>NULL</code> 且非错误指针，就应调用 <code>gpiod_put()</code>。</p>
</blockquote>
<p><strong>参数</strong></p>
<ul>
<li><strong><code>desc</code></strong>：指向要释放的 <code>struct gpio_desc</code> 的指针。<ul>
<li>若为 <code>NULL</code>，函数安全地不做任何操作（<strong>允许传入 NULL</strong>）。</li>
<li>若为错误指针（如 <code>ERR_PTR(-ENOENT)</code>），<strong>不应调用 <code>gpiod_put()</code></strong>。</li>
</ul>
</li>
</ul>
<h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><p>新版本的 gpio 子系统 api 接口要与设备树结合才能使用，所以需要在设备树中将用于获取 GPIO 描述符的引脚复用为 GPIO 模式。这里选择 RK3568 开发板背面 20Pin GPIO 座子的 1 号引脚，右边对应的丝印为 I2C3_SDA_M0。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195106091.png" alt="J39 GPIO" loading="lazy"></p>
<p>可以看到 1 号管脚的网络标号为 I2C3_SDA_M0，然后打开核心板原理图，根据这个网络标号进行搜索，查找到的核心板内容如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251223195109079.png" alt="核心板原理图" loading="lazy"></p>
<p>首先根据上图中的复用功能查看设备树中是否已经对该引脚进行了复用，在确保该引脚无任何复用之后，对 topeet-rk3568-linux.dtsi 设备树进行内容的添加，在根节点的结尾添加以下内容：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">my_gpio:</span><span class="title class_">gpiol_a0</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;mygpio&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">my-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio1</span> RK_PA0 GPIO_ACTIVE_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;mygpio_ctrl</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>compatible</code>: 用于指定设备的兼容性字符串，与驱动程序中的值相匹配。</li>
<li><code>my-gpios</code>: 指定了与该设备相关联的 GPIO。&amp;gpiol 表示 GPIO 控制器的句柄（handle），RK_PA0 是与该 GPIO 相关的资源描述符（resource specifier），GPIO_ACTIVE_HIGH 表示 GPIO 的默认电平为高电平。</li>
</ul>
<blockquote>
<p>注意这里必须为my-gpios而不是gpios，必须有中间的”-“</p>
</blockquote>
<ul>
<li><code>pinctrl-names</code> 和 pinctrl-0: 用于指定引脚控制器（pinctrl）的配置。pinctrl-names 表示引脚控制器配置的名称，这里为 “default”。pinctrl-0 指定了与该配置相关联的引脚控制器句柄，这里为 &amp;mygpio_ctrl。</li>
</ul>
<p>然后找到pinctrl子节点</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">mygpio</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">	mygpio_ctrl:</span> <span class="title class_">my-gpio-ctrl</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">rockchip,pins</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1</span> RK_PA0 RK_FUNC_GPIO <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>1</code> 表示引脚索引</li>
<li>RK_PA0 表示资源描述符，用于标识与该引脚相关联的物理资源，表示引脚所属的功能组</li>
<li><code>RK _FUNC_GPIO</code> 表示将引脚的功能设置为 GPIO</li>
<li><code>&amp;pcfg_pull_none</code> 表示引脚配置为无上下拉。</li>
</ul>
<p>驱动程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mod_devicetable.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio/consumer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">mygpio1</span>;</span>  <span class="comment">// GPIO 描述符指针</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">mygpio2</span>;</span>  <span class="comment">// GPIO 描述符指针</span></span><br><span class="line"><span class="type">int</span> num;  <span class="comment">// GPIO 编号</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备初始化函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio/consumer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">mygpio1</span>, *<span class="title">mygpio2</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;This is my_platform_probe\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取可选 GPIO */</span></span><br><span class="line">    mygpio1 = gpiod_get_optional(&amp;pdev-&gt;dev, <span class="string">&quot;my&quot;</span>, GPIOD_IN);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(mygpio1)) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get optional &#x27;my&#x27; GPIO: %ld\n&quot;</span>, PTR_ERR(mygpio1));</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(mygpio1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mygpio1) &#123;</span><br><span class="line">        num = desc_to_gpio(mygpio1);</span><br><span class="line">        printk(<span class="string">&quot;Optional GPIO num is %d\n&quot;</span>, num);</span><br><span class="line">        gpiod_put(mygpio1);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        printk(<span class="string">&quot;Optional &#x27;my&#x27; GPIO not specified in DT\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取索引为 0 的必需 GPIO */</span></span><br><span class="line">    mygpio2 = gpiod_get_index(&amp;pdev-&gt;dev, <span class="string">&quot;my&quot;</span>, <span class="number">0</span>, GPIOD_IN);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(mygpio2)) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get indexed &#x27;my&#x27; GPIO[0]: %ld\n&quot;</span>, PTR_ERR(mygpio2));</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(mygpio2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    num = desc_to_gpio(mygpio2);</span><br><span class="line">    printk(<span class="string">&quot;Indexed GPIO num is %d\n&quot;</span>, num);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 注意：这里没有释放 mygpio2！通常应在 remove() 中释放 */</span></span><br><span class="line">    <span class="comment">/* 如果只是测试，至少在出错路径释放，或在此处释放（但无后续使用） */</span></span><br><span class="line">    gpiod_put(mygpio2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备的移除函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 实际驱动中，应在 remove 中释放所有获取的 GPIO */</span></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_remove: Removing platform device\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_match_table_id</span>[]  =</span> &#123;</span><br><span class="line">	&#123;.compatible=<span class="string">&quot;mygpio&quot;</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义平台驱动结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">my_platform_driver</span> =</span> &#123;</span><br><span class="line">    .probe = my_platform_probe,</span><br><span class="line">    .remove = my_platform_remove,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;my_platform_device&quot;</span>,</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">		.of_match_table =  of_match_table_id,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">my_platform_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册平台驱动</span></span><br><span class="line">    ret = platform_driver_register(&amp;my_platform_driver);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;Failed to register platform driver\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_driver: Platform driver initialized\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">my_platform_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注销平台驱动</span></span><br><span class="line">	gpiod_put(mygpio2);</span><br><span class="line">    platform_driver_unregister(&amp;my_platform_driver);</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_driver: Platform driver exited\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_platform_driver_init);</span><br><span class="line">module_exit(my_platform_driver_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="GPIO操作函数"><a href="#GPIO操作函数" class="headerlink" title="GPIO操作函数"></a>GPIO操作函数</h3><p><strong>头文件统一为：</strong> <code>#include &lt;linux/gpio/consumer.h&gt;</code></p>
<h4 id="获取-GPIO-方向"><a href="#获取-GPIO-方向" class="headerlink" title="获取 GPIO 方向"></a>获取 GPIO 方向</h4><p><strong>函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gpiod_get_direction</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p>查询 GPIO 当前配置为输入还是输出。</p>
<p><strong>返回值</strong></p>
<ul>
<li><code>GPIO_LINE_DIRECTION_IN</code>（0）：输入模式</li>
<li><code>GPIO_LINE_DIRECTION_OUT</code>（1）：输出模式</li>
<li>负数：错误码（如 <code>-EINVAL</code>）</li>
</ul>
<h4 id="配置-GPIO-方向"><a href="#配置-GPIO-方向" class="headerlink" title="配置 GPIO 方向"></a>配置 GPIO 方向</h4><h5 id="配置为输入"><a href="#配置为输入" class="headerlink" title="配置为输入"></a>配置为输入</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gpiod_direction_input</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc)</span>;</span><br></pre></td></tr></table></figure>

<h5 id="配置为输出（带初始电平）"><a href="#配置为输出（带初始电平）" class="headerlink" title="配置为输出（带初始电平）"></a>配置为输出（带初始电平）</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gpiod_direction_output</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc, <span class="type">int</span> value)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>value</code>：0（低电平）或 1（高电平）</li>
</ul>
<p><strong>返回值（两者相同）</strong></p>
<ul>
<li><code>0</code>：成功</li>
<li>负数：失败（如 <code>-EINVAL</code>, <code>-ENODEV</code>）</li>
</ul>
<p><strong>注意事项</strong></p>
<ul>
<li>必须在读写 GPIO 前正确设置方向。</li>
<li>输出模式需指定初始电平，避免毛刺。</li>
</ul>
<hr>
<h4 id="读取-GPIO-电平（输入）"><a href="#读取-GPIO-电平（输入）" class="headerlink" title="读取 GPIO 电平（输入）"></a>读取 GPIO 电平（输入）</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gpiod_get_value</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> gpio_desc *desc)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p>读取 GPIO 引脚当前物理电平（考虑 <code>ACTIVE_LOW</code> 映射后逻辑值）。</p>
<p><strong>返回值</strong></p>
<ul>
<li><code>0</code>：逻辑低电平</li>
<li><code>1</code>：逻辑高电平</li>
<li>负数：错误（罕见，通常仅在硬件异常时发生）</li>
</ul>
<p><strong>说明</strong></p>
<ul>
<li>即使 GPIO 配置为输出，也可读回其输出状态（部分控制器支持）。</li>
<li>返回的是<strong>逻辑值</strong>，已自动处理设备树中 <code>GPIO_ACTIVE_LOW</code> 的反转。</li>
</ul>
<h4 id="设置-GPIO-电平（输出）"><a href="#设置-GPIO-电平（输出）" class="headerlink" title="设置 GPIO 电平（输出）"></a>设置 GPIO 电平（输出）</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">gpiod_set_value</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc, <span class="type">int</span> value)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>参数</strong></p>
<ul>
<li><code>value</code>：0（逻辑低）或 1（逻辑高）</li>
</ul>
<p><strong>返回值</strong></p>
<ul>
<li>无（<code>void</code>）</li>
</ul>
<p><strong>关键前提</strong></p>
<ul>
<li><strong>必须先将 GPIO 配置为输出模式</strong>（通过 <code>gpiod_direction_output()</code>）。</li>
<li>同样使用<strong>逻辑值</strong>，内核自动处理 <code>ACTIVE_LOW</code> 反转。</li>
</ul>
<h4 id="将-GPIO-转换为中断号"><a href="#将-GPIO-转换为中断号" class="headerlink" title="将 GPIO 转换为中断号"></a>将 GPIO 转换为中断号</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gpiod_to_irq</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> gpio_desc *desc)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p>获取与该 GPIO 关联的 Linux 中断号（IRQ number），用于注册中断处理程序。</p>
<p><strong>返回值</strong></p>
<ul>
<li>≥ 0：有效的中断号</li>
<li>负数：不支持中断或转换失败（如 <code>-ENXIO</code></li>
</ul>
<h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mod_devicetable.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio/consumer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uapi/linux/gpio.h&gt;</span>  <span class="comment">// for GPIO_LINE_DIRECTION_*</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">mygpio1</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> dir, value, irq;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;This is my_platform_probe\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取可选 GPIO（配置为输出，初始低电平）</span></span><br><span class="line">    mygpio1 = gpiod_get_optional(&amp;pdev-&gt;dev, <span class="string">&quot;my&quot;</span>, GPIOD_OUT_LOW);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(mygpio1)) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get GPIO: %ld\n&quot;</span>, PTR_ERR(mygpio1));</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(mygpio1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mygpio1) &#123;</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Optional &#x27;my&#x27; GPIO not present\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置为高电平（可选，因为 GPIOD_OUT_LOW 初始为低）</span></span><br><span class="line">    gpiod_set_value(mygpio1, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取方向</span></span><br><span class="line">    dir = gpiod_get_direction(mygpio1);</span><br><span class="line">    <span class="keyword">if</span> (dir == GPIO_LINE_DIRECTION_IN) &#123;</span><br><span class="line">        printk(<span class="string">&quot;dir is INPUT\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dir == GPIO_LINE_DIRECTION_OUT) &#123;</span><br><span class="line">        printk(<span class="string">&quot;dir is OUTPUT\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get direction: %d\n&quot;</span>, dir);</span><br><span class="line">        gpiod_put(mygpio1);</span><br><span class="line">        <span class="keyword">return</span> dir;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取当前值</span></span><br><span class="line">    value = gpiod_get_value(mygpio1);</span><br><span class="line">    printk(<span class="string">&quot;value is %d\n&quot;</span>, value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取中断号</span></span><br><span class="line">    irq = gpiod_to_irq(mygpio1);</span><br><span class="line">    <span class="keyword">if</span> (irq &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;GPIO does not support IRQ (err=%d)\n&quot;</span>, irq);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        printk(<span class="string">&quot;irq is %d\n&quot;</span>, irq);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备的移除函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mygpio1 &amp;&amp; !IS_ERR(mygpio1)) &#123;</span><br><span class="line">        gpiod_put(mygpio1);</span><br><span class="line">        mygpio1 = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_remove: Platform device removed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备树匹配表</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">my_of_match</span>[] =</span> &#123;</span><br><span class="line">    &#123; .compatible = <span class="string">&quot;mygpio&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(of, my_of_match);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台驱动结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">my_platform_driver</span> =</span> &#123;</span><br><span class="line">    .probe = my_platform_probe,</span><br><span class="line">    .remove = my_platform_remove,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;my_platform_device&quot;</span>,</span><br><span class="line">        .of_match_table = my_of_match,</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块初始化与退出</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">my_platform_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = platform_driver_register(&amp;my_platform_driver);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;Failed to register platform driver\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_driver: Platform driver initialized\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">my_platform_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    platform_driver_unregister(&amp;my_platform_driver);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_driver: Platform driver exited\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_platform_driver_init);</span><br><span class="line">module_exit(my_platform_driver_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;My GPIO Platform Driver Example&quot;</span>);</span><br></pre></td></tr></table></figure>







<h3 id="三级节点操作函数"><a href="#三级节点操作函数" class="headerlink" title="三级节点操作函数"></a>三级节点操作函数</h3><p>在前面的示例中获取的都是二级节点的 GPIO 描述，那如果我们要如何获取下面 led1 和 led2 两个三级节点的 gpio 描述呢？</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">my_gpio:</span><span class="title class_">gpio1_a0</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;mygpio&quot;</span><span class="punctuation">;</span></span><br><span class="line">	</span><br><span class="line">	led1<span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">my-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio1</span> RK_PA0 GPIO_ACTIVE_HIGH&gt;</span>, <span class="params">&lt;<span class="variable">&amp;gpio1</span> RK_PB1 GPIO_ACTIVE_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">		pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;mygpio_ctrl</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line">	</span><br><span class="line">	led2<span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">my-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio1</span> RK_PB0 GPIO_ACTIVE_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h4 id="device-get-child-node-count"><a href="#device-get-child-node-count" class="headerlink" title="device_get_child_node_count()"></a>device_get_child_node_count()</h4><p><strong>功能：获取设备的子节点数量</strong></p>
<p><strong>函数原型</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">device_get_child_node_count</span><span class="params">(<span class="keyword">struct</span> device *dev)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>头文件</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>参数</strong></p>
<ul>
<li><code>dev</code>：指向父设备的 <code>struct device</code> 指针。</li>
</ul>
<p><strong>返回值</strong></p>
<ul>
<li><strong>成功</strong>：返回子节点数量（≥ 0 的无符号整数）。</li>
<li><strong>无子节点或失败</strong>：返回 <code>0</code>。</li>
</ul>
<p><strong>说明</strong></p>
<ul>
<li>用于判断设备在设备树中是否包含子节点（如 LED、按键等子设备）。</li>
<li>常用于动态分配资源或决定是否进入子节点遍历逻辑。</li>
</ul>
<p> <strong>示例</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (device_get_child_node_count(&amp;pdev-&gt;dev) == <span class="number">0</span>) &#123;</span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;No child nodes\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="fwnode-get-named-gpiod"><a href="#fwnode-get-named-gpiod" class="headerlink" title="fwnode_get_named_gpiod()"></a>fwnode_get_named_gpiod()</h4><p><strong>功能：从指定 firmware 节点（如设备树子节点）中获取命名 GPIO</strong></p>
<p><strong>函数原型</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> gpio_desc *<span class="title function_">fwnode_get_named_gpiod</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> fwnode_handle *fwnode,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">char</span> *propname,</span></span><br><span class="line"><span class="params">    <span class="type">int</span> index,</span></span><br><span class="line"><span class="params">    <span class="keyword">enum</span> gpiod_flags dflags,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">char</span> *label</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>头文件</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio/consumer.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>参数</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>fwnode</code></td>
<td>指向子节点的 <code>fwnode_handle</code>（通常来自 <code>device_get_next_child_node()</code>）</td>
</tr>
<tr>
<td><code>propname</code></td>
<td>GPIO 属性名（如 <code>&quot;led-gpios&quot;</code>、<code>&quot;enable-gpios&quot;</code>、<code>&quot;my-gpios&quot;</code>）</td>
</tr>
<tr>
<td><code>index</code></td>
<td>在属性中的索引（0 表示第一个 GPIO）</td>
</tr>
<tr>
<td><code>dflags</code></td>
<td>初始化标志： • <code>GPIOD_IN</code> • <code>GPIOD_OUT_LOW</code> • <code>GPIOD_OUT_HIGH</code> • <code>GPIOD_ASIS</code>（不配置方向）</td>
</tr>
<tr>
<td><code>label</code></td>
<td>GPIO 标签（用于调试，如 <code>&quot;my-led&quot;</code>）</td>
</tr>
</tbody></table>
<p>返回值</p>
<ul>
<li>成功：返回 <code>struct gpio_desc *</code></li>
<li>失败：返回 <code>ERR_PTR(...)</code>（注意：<strong>不是 NULL</strong>）</li>
</ul>
<blockquote>
<p>⚠️ <strong>重要</strong>：该函数返回的是 <strong>错误指针（ERR_PTR）</strong>，应使用 <code>IS_ERR()</code> 判断，而非检查 <code>NULL</code>。</p>
</blockquote>
<p><strong>使用场景</strong></p>
<ul>
<li><p>当设备树结构为“父设备 + 多个子节点”，每个子节点定义自己的 GPIO 时（如多个 LED）：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">my_device &#123;</span><br><span class="line">    compatible = <span class="string">&quot;myvendor,my-device&quot;</span>;</span><br><span class="line">    <span class="comment">#address-cells = &lt;1&gt;;</span></span><br><span class="line">    <span class="comment">#size-cells = &lt;0&gt;;</span></span><br><span class="line"></span><br><span class="line">    led<span class="meta">@0</span> &#123;</span><br><span class="line">        reg = <span class="variable">&lt;0&gt;</span>;</span><br><span class="line">        led-gpios = <span class="variable">&lt;&amp;gpio1 10 GPIO_ACTIVE_HIGH&gt;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    led<span class="meta">@1</span> &#123;</span><br><span class="line">        reg = <span class="variable">&lt;1&gt;</span>;</span><br><span class="line">        led-gpios = <span class="variable">&lt;&amp;gpio1 11 GPIO_ACTIVE_LOW&gt;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>驱动:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">desc = fwnode_get_named_gpiod(child, <span class="string">&quot;led-gpios&quot;</span>, <span class="number">0</span>, GPIOD_OUT_LOW, <span class="string">&quot;my-led&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(desc)) &#123;</span><br><span class="line">    dev_err(dev, <span class="string">&quot;Failed to get GPIO: %ld\n&quot;</span>, PTR_ERR(desc));</span><br><span class="line">    <span class="keyword">return</span> PTR_ERR(desc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="device-get-next-child-node"><a href="#device-get-next-child-node" class="headerlink" title="device_get_next_child_node()"></a>device_get_next_child_node()</h4><p><strong>功能：遍历设备的所有子节点</strong></p>
<p><strong>函数原型</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> fwnode_handle *<span class="title function_">device_get_next_child_node</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> device *dev,</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> fwnode_handle *child</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>头文件</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>参数</strong></p>
<ul>
<li><code>dev</code>：父设备指针。</li>
<li><code>child</code>：当前子节点指针；<strong>首次调用时传 <code>NULL</code></strong>。</li>
</ul>
<p><strong>返回值</strong></p>
<ul>
<li>成功：返回下一个子节点的 <code>fwnode_handle *</code></li>
<li>遍历结束：返回 <code>NULL</code></li>
</ul>
<p><strong>遍历模式（标准用法）</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fwnode_handle</span> *<span class="title">child</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((child = device_get_next_child_node(&amp;pdev-&gt;dev, child))) &#123;</span><br><span class="line">    <span class="comment">// 处理子节点，例如获取其 GPIO</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">desc</span> =</span> fwnode_get_named_gpiod(child, <span class="string">&quot;gpios&quot;</span>, <span class="number">0</span>, GPIOD_OUT_LOW, <span class="string">&quot;sub-gpio&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!IS_ERR(desc)) &#123;</span><br><span class="line">        <span class="comment">/* 使用 desc */</span></span><br><span class="line">        gpiod_put(desc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意：不需要手动释放 child，内核自动管理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>🔔 <strong>注意</strong>：</p>
<ul>
<li><code>fwnode_handle</code> 由内核管理，<strong>不要手动释放</strong>。</li>
<li>遍历结束后自动停止，无需额外清理。</li>
</ul>
</blockquote>
<h4 id="完整示例"><a href="#完整示例" class="headerlink" title="完整示例"></a>完整示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fwnode_handle</span> *<span class="title">child</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">    count = device_get_child_node_count(&amp;pdev-&gt;dev);</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;No child nodes\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;Found %u child nodes\n&quot;</span>, count);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((child = device_get_next_child_node(&amp;pdev-&gt;dev, child))) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">desc</span>;</span></span><br><span class="line"></span><br><span class="line">        desc = fwnode_get_named_gpiod(child, <span class="string">&quot;my-gpios&quot;</span>, <span class="number">0</span>,</span><br><span class="line">                                      GPIOD_OUT_LOW, <span class="string">&quot;child-enable&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(desc)) &#123;</span><br><span class="line">            dev_warn(&amp;pdev-&gt;dev, <span class="string">&quot;Skip child: failed to get GPIO (%ld)\n&quot;</span>, PTR_ERR(desc));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        gpiod_set_value(desc, <span class="number">1</span>); <span class="comment">// 启用子设备</span></span><br><span class="line">        msleep(<span class="number">10</span>);</span><br><span class="line">        gpiod_set_value(desc, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        gpiod_put(desc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GPIO子系统与pinctrl"><a href="#GPIO子系统与pinctrl" class="headerlink" title="GPIO子系统与pinctrl"></a>GPIO子系统与pinctrl</h3><p><strong>头文件统一为：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pinctrl/pinctrl.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<h4 id="获取-pinctrl-实例"><a href="#获取-pinctrl-实例" class="headerlink" title="获取 pinctrl 实例"></a>获取 pinctrl 实例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> pinctrl *<span class="title function_">pinctrl_get</span><span class="params">(<span class="keyword">struct</span> device *dev)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p>获取与设备 <code>dev</code> 关联的 pinctrl 控制器实例。</p>
<p><strong>参数</strong></p>
<ul>
<li><code>dev</code>：指向设备的 <code>struct device</code> 指针（通常为 <code>&amp;pdev-&gt;dev</code>）。</li>
</ul>
<p><strong>返回值</strong></p>
<ul>
<li>成功：返回 <code>struct pinctrl *</code></li>
<li>失败或设备无 pinctrl 支持：返回 <code>ERR_PTR(...)</code>（<strong>注意：不是 NULL</strong>）</li>
</ul>
<blockquote>
<p>⚠️ <strong>重要</strong>：该函数返回的是 <strong>错误指针（ERR_PTR）</strong>，应使用 <code>IS_ERR()</code> 判断！</p>
</blockquote>
<p><strong>用法示例</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p = pinctrl_get(&amp;pdev-&gt;dev);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(p)) &#123;</span><br><span class="line">    dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get pinctrl\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> PTR_ERR(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="释放-pinctrl-实例"><a href="#释放-pinctrl-实例" class="headerlink" title="释放 pinctrl 实例"></a>释放 pinctrl 实例</h4><p><strong>函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">pinctrl_put</span><span class="params">(<span class="keyword">struct</span> pinctrl *p)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p>释放由 <code>pinctrl_get()</code> 获取的 pinctrl 实例，减少引用计数，必要时释放资源。</p>
<p><strong>参数</strong></p>
<ul>
<li><code>p</code>：要释放的 <code>struct pinctrl *</code> 指针。</li>
</ul>
<p><strong>注意事项</strong></p>
<ul>
<li>允许传入 <code>NULL</code> 或 <code>ERR_PTR</code>（内部会安全处理）。</li>
<li>通常在驱动 <code>remove()</code> 或出错路径中调用。</li>
</ul>
<p><strong>示例</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!IS_ERR(p))</span><br><span class="line">    pinctrl_put(p);</span><br></pre></td></tr></table></figure>

<h4 id="查找-pinctrl-状态"><a href="#查找-pinctrl-状态" class="headerlink" title="查找 pinctrl 状态"></a>查找 pinctrl 状态</h4><p><strong>函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> pinctrl_state *<span class="title function_">pinctrl_lookup_state</span><span class="params">(<span class="keyword">struct</span> pinctrl *p, <span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p>在 pinctrl 实例 <code>p</code> 中查找名为 <code>name</code> 的状态（如 <code>&quot;default&quot;</code>、<code>&quot;sleep&quot;</code>）。</p>
<p><strong>参数</strong></p>
<ul>
<li><code>p</code>：有效的 pinctrl 实例指针。</li>
<li><code>name</code>：状态名称（字符串），必须与设备树中定义的 state 名称一致。</li>
</ul>
<p><strong>返回值</strong></p>
<ul>
<li>成功：返回 <code>struct pinctrl_state *</code></li>
<li>失败（未找到或错误）：返回 <code>ERR_PTR(...)</code></li>
</ul>
<blockquote>
<p>⚠️ 同样需用 <code>IS_ERR()</code> 判断！</p>
</blockquote>
<p><strong>示例</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">state = pinctrl_lookup_state(p, <span class="string">&quot;default&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(state)) &#123;</span><br><span class="line">    dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to lookup &#x27;default&#x27; state\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> PTR_ERR(state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="应用-pinctrl-状态到硬件"><a href="#应用-pinctrl-状态到硬件" class="headerlink" title="应用 pinctrl 状态到硬件"></a>应用 pinctrl 状态到硬件</h4><p><strong>函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pinctrl_select_state</span><span class="params">(<span class="keyword">struct</span> pinctrl *p, <span class="keyword">struct</span> pinctrl_state *s)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong></p>
<p>将指定的状态 <code>s</code> 配置到硬件引脚控制器上，实际生效引脚复用和电气设置。</p>
<p><strong>参数</strong></p>
<ul>
<li><code>p</code>：pinctrl 实例</li>
<li><code>s</code>：目标状态</li>
</ul>
<p><strong>返回值</strong></p>
<ul>
<li><code>0</code>：成功</li>
<li>负数：错误码（如 <code>-EINVAL</code>, <code>-ENODEV</code>）</li>
</ul>
<p><strong>示例</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ret = pinctrl_select_state(p, state);</span><br><span class="line"><span class="keyword">if</span> (ret) &#123;</span><br><span class="line">    dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to select pinctrl state: %d\n&quot;</span>, ret);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="完整使用流程示例"><a href="#完整使用流程示例" class="headerlink" title="完整使用流程示例"></a>完整使用流程示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pinctrl/pinctrl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">pinctrl</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">pins_default</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">pins_sleep</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_driver_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. 获取 pinctrl */</span></span><br><span class="line">    pinctrl = pinctrl_get(&amp;pdev-&gt;dev);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(pinctrl)) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get pinctrl\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(pinctrl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. 查找状态 */</span></span><br><span class="line">    pins_default = pinctrl_lookup_state(pinctrl, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(pins_default)) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to lookup &#x27;default&#x27; state\n&quot;</span>);</span><br><span class="line">        ret = PTR_ERR(pins_default);</span><br><span class="line">        <span class="keyword">goto</span> err_put_pinctrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pins_sleep = pinctrl_lookup_state(pinctrl, <span class="string">&quot;sleep&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(pins_sleep)) &#123;</span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;No &#x27;sleep&#x27; state defined\n&quot;</span>);</span><br><span class="line">        pins_sleep = <span class="literal">NULL</span>; <span class="comment">// 可选状态</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. 应用默认状态 */</span></span><br><span class="line">    ret = pinctrl_select_state(pinctrl, pins_default);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to select default state\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_put_pinctrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_put_pinctrl:</span><br><span class="line">    pinctrl_put(pinctrl);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_driver_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!IS_ERR(pinctrl))</span><br><span class="line">        pinctrl_put(pinctrl);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对应的设备树示例"><a href="#对应的设备树示例" class="headerlink" title="对应的设备树示例"></a>对应的设备树示例</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">my_device:</span> <span class="title class_">my-device@0</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;myvendor,my-device&quot;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span>, <span class="string">&quot;sleep&quot;</span><span class="punctuation">;</span></span><br><span class="line">    pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;my_pins_default</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    pinctrl<span class="number">-1</span> = <span class="params">&lt;<span class="variable">&amp;my_pins_sleep</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 其他属性 */</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;pinctrl</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">    my_pins_default:</span> <span class="title class_">my-pins-default</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">pinmux</span> <span class="operator">=</span> <span class="params">&lt;PIN_FUNC_3(PIN_X)&gt;</span>, <span class="comment">/* 复用为功能3 */</span></span><br><span class="line">                 <span class="params">&lt;PIN_FUNC_1(PIN_Y)&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">bias-pull-up</span><span class="punctuation">;</span>      <span class="comment">/* 上拉 */</span></span><br><span class="line">        <span class="attr">drive-strength</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">8</span>&gt;</span><span class="punctuation">;</span> <span class="comment">/* 8mA 驱动能力 */</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">    my_pins_sleep:</span> <span class="title class_">my-pins-sleep</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">pinmux</span> <span class="operator">=</span> <span class="params">&lt;PIN_FUNC_0(PIN_X)&gt;</span>, <span class="comment">/* 进入 GPIO 模式 */</span></span><br><span class="line">                 <span class="params">&lt;PIN_FUNC_0(PIN_Y)&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">bias-disable</span><span class="punctuation">;</span>      <span class="comment">/* 禁用上下拉 */</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>🔑 关键点：</p>
<ul>
<li><code>pinctrl-names</code> 定义状态名称列表</li>
<li><code>pinctrl-0</code>, <code>pinctrl-1</code> 对应索引 0、1 的状态</li>
<li>驱动中通过名称（如 <code>&quot;default&quot;</code>）查找状态</li>
</ul>
</blockquote>
<hr>
<h4 id="补充说明"><a href="#补充说明" class="headerlink" title="补充说明"></a>补充说明</h4><table>
<thead>
<tr>
<th>场景</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td><strong>仅需默认配置</strong></td>
<td>可不显式调用 pinctrl API，内核会在 probe 时自动应用 <code>pinctrl-0</code>（若 <code>pinctrl-names</code> 包含 <code>&quot;default&quot;</code>）</td>
</tr>
<tr>
<td><strong>动态切换状态</strong></td>
<td>如 suspend&#x2F;resume 时切换到 <code>&quot;sleep&quot;</code> 状态</td>
</tr>
<tr>
<td><strong>错误处理</strong></td>
<td>所有返回指针的函数都可能返回 <code>ERR_PTR</code>，务必用 <code>IS_ERR()</code> 检查</td>
</tr>
<tr>
<td><strong>资源释放</strong></td>
<td>在 <code>remove()</code> 中调用 <code>pinctrl_put()</code></td>
</tr>
</tbody></table>
<h3 id="实现动态切换引脚复用功能"><a href="#实现动态切换引脚复用功能" class="headerlink" title="实现动态切换引脚复用功能"></a>实现动态切换引脚复用功能</h3><p>这里仍使用 RK3568 底板背面的 20 pin GPIO 底座的 1 号管脚来完成本章节要进行的动态切换引脚复用的功能</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">my_gpio:</span><span class="title class_">gpio1_a0</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;mygpio&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">my-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio1</span> RK_PA0 GPIO_ACTIVE_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;mygpio_func1&quot;</span>, <span class="string">&quot;mygpio_func2&quot;</span><span class="punctuation">;</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;mygpio_ctrl</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	pinctrl<span class="number">-1</span> = <span class="params">&lt;<span class="variable">&amp;i2c3_sda</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>pinctrl-names</code> 表示引脚控制器配置的名称，这里有两个值，分别对应复用 1 和复用 2。</li>
<li><code>pinctrl-0</code> 指定了与该配置相关联的引脚控制器句柄，这里为 <code>&amp;mygpio_ctrl</code>，表示复用为 gpio 功能。</li>
<li><code>pinctrl-1</code> 指定了与该配置相关联的引脚控制器句柄，这里为 <code>&amp;i2c3_sda</code>，表示复用为<code>i2c3_sda</code> 功能。</li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">mygpio_func1</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">	mygpio_ctrl:</span> <span class="title class_">my-gpio-ctrl</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">rockchip,pins</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1</span> RK_PA0 RK_FUNC_GPIO <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">mygpio_func2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">	i2c3_sda:</span> <span class="title class_">i2c3_sda</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">rockchip,pins</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1</span> RK_PA0 <span class="number">1</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>驱动</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mod_devicetable.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio/consumer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">gpio_pinctrl</span>;</span>          <span class="comment">// GPIO pinctrl 实例指针</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">func1_state</span>;</span>     <span class="comment">// 功能1状态</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">func2_state</span>;</span>     <span class="comment">// 功能2状态</span></span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">selectmux_store</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr, <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> select;</span><br><span class="line">    select = simple_strtoul(buf, <span class="literal">NULL</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (select == <span class="number">1</span>) &#123;</span><br><span class="line">        pinctrl_select_state(gpio_pinctrl, func1_state);     <span class="comment">// 选择功能1状态</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (select == <span class="number">0</span>) &#123;</span><br><span class="line">        pinctrl_select_state(gpio_pinctrl, func2_state);     <span class="comment">// 选择功能2状态</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义可写的设备属性 selectmux</span></span><br><span class="line">DEVICE_ATTR_WO(selectmux);       </span><br><span class="line"><span class="comment">// 等价于</span></span><br><span class="line"><span class="comment">// static struct device_attribute dev_attr_selectmux = &#123;</span></span><br><span class="line"><span class="comment">//    .attr = &#123; .name = &quot;selectmux&quot;, .mode = S_IWUSR &#125;,  // 只写，权限 0200</span></span><br><span class="line"><span class="comment">//    .show = NULL,</span></span><br><span class="line"><span class="comment">//    .store = selectmux_store,   </span></span><br><span class="line"><span class="comment">//&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pinctrl_get_and_lookstate</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    gpio_pinctrl = pinctrl_get(dev);    <span class="comment">// 获取GPIO pinctrl实例</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(gpio_pinctrl)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;pinctrl_get is error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    func1_state = pinctrl_lookup_state(gpio_pinctrl, <span class="string">&quot;mygpio_func1&quot;</span>);    <span class="comment">// 查找功能1状态</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(func1_state)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;pinctrl_lookup_state is error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    func2_state = pinctrl_lookup_state(gpio_pinctrl, <span class="string">&quot;mygpio_func2&quot;</span>);    <span class="comment">// 查找功能2状态</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(func2_state)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;pinctrl_lookup_state is error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;This is mydriver_probe\n&quot;</span>);</span><br><span class="line">    pinctrl_get_and_lookstate(&amp;dev-&gt;dev);     <span class="comment">// 获取并查找GPIO pinctrl实例和状态</span></span><br><span class="line">    device_create_file(&amp;dev-&gt;dev, &amp;dev_attr_selectmux);    <span class="comment">// 在设备上创建属性文件</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备的移除函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_remove: Removing platform device\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理设备特定的操作</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_match_table_id</span>[]  =</span> &#123;</span><br><span class="line">	&#123;.compatible=<span class="string">&quot;mygpio&quot;</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义平台驱动结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">my_platform_driver</span> =</span> &#123;</span><br><span class="line">    .probe = my_platform_probe,</span><br><span class="line">    .remove = my_platform_remove,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;my_platform_device&quot;</span>,</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">		.of_match_table =  of_match_table_id,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">my_platform_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册平台驱动</span></span><br><span class="line">    ret = platform_driver_register(&amp;my_platform_driver);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;Failed to register platform driver\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_driver: Platform driver initialized\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">my_platform_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注销平台驱动</span></span><br><span class="line">    platform_driver_unregister(&amp;my_platform_driver);</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_driver: Platform driver exited\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_platform_driver_init);</span><br><span class="line">module_exit(my_platform_driver_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://even629.github.io/">even629</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://even629.com/posts/2512173/">https://even629.com/posts/2512173/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://even629.com" target="_blank">常想一二，不思八九</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/GNU/">GNU</a><a class="post-meta__tags" href="/tags/driver/">driver</a></div><div class="post-share"><div class="social-share" data-image="/images/linux_cover.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center liquidGlass-wrapper" id="my-custom-card-author"><div class="liquidGlass-effect"></div><div class="liquidGlass-tint"></div><div class="liquidGlass-shine"></div><div class="liquidGlass-box"><div class="card-info-avatar"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-status-box"><div class="author-status">🐟<span>认真摸鱼中</span></div></div></div><div><div class="author-info-name">even629</div><div class="author-info-description">常想一二，不思八九</div></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">90</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/even629" target="_blank" title="github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="/img/qq.jpg" target="_blank" title="qq"><i class="fa-brands fa-qq" style="color: #000000;"></i></a><a class="social-icon" href="mailto:zhaohang731005515@proton.me" target="_blank" title="email"><i class="fas fa-envelope" style="color: #000000;"></i></a><a class="social-icon" href="https://space.bilibili.com/519280138" target="_blank" title="bilibili"><i class="fa-brands fa-bilibili" style="color: #000000;"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="rss"><i class="fas fa-rss" style="color: #000000;"></i></a></div></div></div><div class="card-widget" id="newYear"><div class="item-headline"><i></i><span></span></div><div class="item-content"> <div class="newYear-slider"> <div class="swiper-wrapper"> <div class="swiper-slide" style="background-image:url(/img/happy_new_year1.jpg)"></div> <div class="swiper-slide" style="background-image:url(/img/happy_new_year2.jpg)"></div> <div class="swiper-slide" style="background-image:url(/img/happy_new_year3.webp)"></div> <div class="swiper-slide" style="background-image:url(/img/happy_new_year4.gif)"></div> </div> </div> <div id="newYear-main"> <div class="mask"></div> <p class="title"></p> <div class="newYear-time"></div> <p class="today" style="text-align: right;"></p> </div> </div></div><div class="sticky_layout"><div class="card-widget liquidGlass-wrapper" id="card-toc"><div class="liquidGlass-effect"></div><div class="liquidGlass-tint"></div><div class="liquidGlass-shine"></div><div class="liquidGlass-box"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#GPIO%E4%BB%8B%E7%BB%8D"><span class="toc-text">GPIO介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GPIO%E5%BC%95%E8%84%9A%E5%88%86%E5%B8%83"><span class="toc-text">GPIO引脚分布</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GPIO%E7%94%B5%E6%B0%94%E5%B1%9E%E6%80%A7"><span class="toc-text">GPIO电气属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GPIO%E7%94%B5%E6%B0%94%E7%89%B9%E6%80%A7"><span class="toc-text">GPIO电气特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GPIO%E6%8E%A7%E5%88%B6%E5%92%8C%E6%93%8D%E4%BD%9C"><span class="toc-text">GPIO控制和操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E9%80%9A%E8%BF%87sysfs%E6%8E%A7%E5%88%B6GPIO"><span class="toc-text">使用命令通过sysfs控制GPIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gpio%E7%BC%96%E5%8F%B7%E8%AE%A1%E7%AE%97"><span class="toc-text">gpio编号计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#export"><span class="toc-text">export</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#direction"><span class="toc-text">direction</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#active-low"><span class="toc-text">active_low</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#edge"><span class="toc-text">edge</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#value"><span class="toc-text">value</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unexport"><span class="toc-text">unexport</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8C%E7%A8%8B%E5%BA%8F%E9%80%9A%E8%BF%87sysfs%E6%8E%A7%E5%88%B6GPIO"><span class="toc-text">使用C程序通过sysfs控制GPIO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87IO%E5%91%BD%E4%BB%A4%E6%93%8D%E4%BD%9C%E5%AF%84%E5%AD%98%E5%99%A8%E6%8E%A7%E5%88%B6GPIO"><span class="toc-text">通过IO命令操作寄存器控制GPIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO%E5%91%BD%E4%BB%A4"><span class="toc-text">IO命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LED%E5%BC%95%E8%84%9A%E5%AF%84%E5%AD%98%E5%99%A8%E6%9F%A5%E6%89%BE"><span class="toc-text">LED引脚寄存器查找</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%8D%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-text">复用寄存器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E5%90%91%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-text">方向寄存器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-text">数据寄存器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87mem%E8%AE%BE%E5%A4%87%E5%92%8Cmmap%E6%8E%A7%E5%88%B6GPIO"><span class="toc-text">通过mem设备和mmap控制GPIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7%E6%80%81%E8%AE%BF%E9%97%AE%E5%86%85%E6%A0%B8%E6%80%81%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-text">Linux系统用户态访问内核态的方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dev-mem-%E8%AE%BE%E5%A4%87"><span class="toc-text">&#x2F;dev&#x2F;mem 设备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mmap-%E5%87%BD%E6%95%B0"><span class="toc-text">mmap()函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mmap-%E5%87%BD%E6%95%B0%E6%80%BB%E7%BB%93"><span class="toc-text">mmap() 函数总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GPIO%E8%B0%83%E8%AF%95"><span class="toc-text">GPIO调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#debugfs"><span class="toc-text">debugfs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GPIO%E5%AD%90%E7%B3%BB%E7%BB%9FAPI"><span class="toc-text">GPIO子系统API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gpio-desc-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">gpio_desc 结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gpio-device-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">gpio_device 结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gpio-chip%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">gpio_chip结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%8D%95%E4%B8%AAGPIO%E6%8F%8F%E8%BF%B0"><span class="toc-text">获取单个GPIO描述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gpiod-get"><span class="toc-text">gpiod_get()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gpiod-get-index"><span class="toc-text">gpiod_get_index()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gpiod-get-optional"><span class="toc-text">gpiod_get_optional()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gpiod-get-index-optional"><span class="toc-text">gpiod_get_index_optional()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gpiod-put"><span class="toc-text">gpiod_put()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GPIO%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0"><span class="toc-text">GPIO操作函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-GPIO-%E6%96%B9%E5%90%91"><span class="toc-text">获取 GPIO 方向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-GPIO-%E6%96%B9%E5%90%91"><span class="toc-text">配置 GPIO 方向</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%BA%E8%BE%93%E5%85%A5"><span class="toc-text">配置为输入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%BA%E8%BE%93%E5%87%BA%EF%BC%88%E5%B8%A6%E5%88%9D%E5%A7%8B%E7%94%B5%E5%B9%B3%EF%BC%89"><span class="toc-text">配置为输出（带初始电平）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96-GPIO-%E7%94%B5%E5%B9%B3%EF%BC%88%E8%BE%93%E5%85%A5%EF%BC%89"><span class="toc-text">读取 GPIO 电平（输入）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-GPIO-%E7%94%B5%E5%B9%B3%EF%BC%88%E8%BE%93%E5%87%BA%EF%BC%89"><span class="toc-text">设置 GPIO 电平（输出）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86-GPIO-%E8%BD%AC%E6%8D%A2%E4%B8%BA%E4%B8%AD%E6%96%AD%E5%8F%B7"><span class="toc-text">将 GPIO 转换为中断号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%BA%A7%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0"><span class="toc-text">三级节点操作函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#device-get-child-node-count"><span class="toc-text">device_get_child_node_count()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fwnode-get-named-gpiod"><span class="toc-text">fwnode_get_named_gpiod()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#device-get-next-child-node"><span class="toc-text">device_get_next_child_node()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B"><span class="toc-text">完整示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GPIO%E5%AD%90%E7%B3%BB%E7%BB%9F%E4%B8%8Epinctrl"><span class="toc-text">GPIO子系统与pinctrl</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-pinctrl-%E5%AE%9E%E4%BE%8B"><span class="toc-text">获取 pinctrl 实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8A%E6%94%BE-pinctrl-%E5%AE%9E%E4%BE%8B"><span class="toc-text">释放 pinctrl 实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE-pinctrl-%E7%8A%B6%E6%80%81"><span class="toc-text">查找 pinctrl 状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8-pinctrl-%E7%8A%B6%E6%80%81%E5%88%B0%E7%A1%AC%E4%BB%B6"><span class="toc-text">应用 pinctrl 状态到硬件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="toc-text">完整使用流程示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E8%AE%BE%E5%A4%87%E6%A0%91%E7%A4%BA%E4%BE%8B"><span class="toc-text">对应的设备树示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8E"><span class="toc-text">补充说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E5%88%87%E6%8D%A2%E5%BC%95%E8%84%9A%E5%A4%8D%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="toc-text">实现动态切换引脚复用功能</span></a></li></ol></li></ol></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient(135deg, rgba(146, 233, 227, 1) 0%, rgba(0, 0, 0, 0) 70%);;"><div id="footer-wrap"><div class="footer-button"><a target="_blank" rel="noopener" href="https://github.com/even629" title="github"><i class="fab fa-github"></i></a><a href="/img/qq.jpg" title="qq"><i class="fa-brands fa-qq"></i></a><a href="mailto:zhaohang731005515@proton.me" title="email"><i class="fas fa-envelope"></i></a><a target="_blank" rel="noopener" href="https://space.bilibili.com/519280138" title="bilibili"><i class="fa-brands fa-bilibili"></i></a><a href="/atom.xml" title="rss"><i class="fas fa-rss"></i></a></div><div class="copyright">&copy;2024 - 2026 By even629</div><p><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Frame-Hexo-blue.svg" title="博客框架为 Hexo"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Theme-Butterfly.svg" title="主题采用 butterfly"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Source-Github.svg" title="本站项目由 Github 托管"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Copyright-BY--NC--SA.4.svg" title="本站采用知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议进行许可"/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="中英转换">中</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span data-zh="新窗口打开" data-en="Open in New Window"></span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span data-zh="转到链接" data-en="Go to Link"></span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span data-zh="复制链接" data-en="Copy Link"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span data-zh="复制" data-en="Copy"> </span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.google.com/search?q=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span data-zh="谷歌搜索" data-en="Google Search"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span data-zh="转到链接" data-en="Go to Link"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span data-zh="粘贴" data-en="Paste"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span data-zh="空降评论" data-en="Jump to Comment"></span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();"><i class="fa fa-book"></i><span data-zh="阅读模式" data-en="Reading Mode"> </span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span data-zh="保存图片" data-en="Save Image"></span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span data-zh="在新窗口打开" data-en="Open in New Tab"></span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span data-zh="复制图片链接" data-en="Copy Image Link"></span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:rmf.switchDarkmode();"><i class="fa fa-moon"></i><span data-zh="昼夜切换" data-en="Day/Night Mode"></span></a><a class="rightMenu-item" href="javascript:rmf.stopSakura();"><i class="fa-solid fa-feather"></i><span data-zh="樱花特效" data-en="toggle sakura"></span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span data-zh="切换全屏" data-en="Toggle Full Screen"></span></a><a class="rightMenu-item" href="javascript:rmf.switchLanguageMode();"><i class="fas fa-language"></i><span data-zh="语言切换" data-en="Language Switch"></span></a><a class="rightMenu-item" href="/"><i class="fa fa-home"></i><span data-zh="回到首页" data-en="Go to Home"></span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span data-zh="打印页面" data-en="Print Page"></span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/utils.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }
      
      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: 'Ov23liyQTymWpBETlDO8',
      clientSecret: '1512bfe449aac2a5ec3b416df1ce27fb5ddb5db0',
      repo: 'even629.github.io',
      owner: 'even629',
      admin: ['even629'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || 'b352d5a96569d0135e6a742e34beb313'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.0.6/swiper-bundle.min.js"></script><script src="/js/sakura.js"></script><script defer src="/js/right_menu.js"></script><script async src="/js/fps.js"></script><script src="/js/solarlunar.js"></script><script src="/js/newYear.js"></script><script src="/js/pop-up-window.js"></script><script data-pjax src="/js/nav.js"></script><script data-pjax src="/js/music.js"></script><script data-pjax src="/js/btf.js"></script><script data-pjax src="/js/ch_en.js"></script><svg style="display: none">
<filter
  id="glass-distortion"
  x="0%"
  y="0%"
  width="100%"
  height="100%"
  filterUnits="objectBoundingBox"
>
  <feTurbulence
    type="fractalNoise"
    baseFrequency="0.01 0.01"
    numOctaves="1"
    seed="5"
    result="turbulence"
  />
  <!-- Seeds: 14, 17,  -->

  <feComponentTransfer in="turbulence" result="mapped">
    <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5" />
    <feFuncG type="gamma" amplitude="0" exponent="1" offset="0" />
    <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5" />
  </feComponentTransfer>

  <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap" />

  <feSpecularLighting
    in="softMap"
    surfaceScale="5"
    specularConstant="1"
    specularExponent="100"
    lighting-color="white"
    result="specLight"
  >
    <fePointLight x="-200" y="-200" z="300" />
  </feSpecularLighting>

  <feComposite
    in="specLight"
    operator="arithmetic"
    k1="0"
    k2="1"
    k3="1"
    k4="0"
    result="litImage"
  />

  <feDisplacementMap
    in="SourceGraphic"
    in2="softMap"
    scale="150"
    xChannelSelector="R"
    yChannelSelector="G"
  />
  </filter>
</svg>
<script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="/css/APlayer.min.css" media="print" onload="this.media='all'"><script src="/js/APlayer.min.js"></script><script src="/js/meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404.html')
    }
  })
})()</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="search" type="text"/></div></div><hr class="custom-hr"/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/c/font_4847823_upluhme7cv.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('container');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '800ms');
    arr[i].setAttribute('data-wow-delay', '0ms');
    arr[i].setAttribute('data-wow-offset', '0');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="/js/wowjs/wow.min.js"></script><script defer src="/js/wowjs/wow_init.js"></script><!-- hexo injector body_end end --></body></html>