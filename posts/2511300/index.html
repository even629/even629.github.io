<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Linux设备树 | 常想一二，不思八九</title><meta name="author" content="even629"><meta name="copyright" content="even629"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Linux设备树">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux设备树">
<meta property="og:url" content="https://even629.com/posts/2511300/index.html">
<meta property="og:site_name" content="常想一二，不思八九">
<meta property="og:description" content="Linux设备树">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://even629.com/images/linux_cover.webp">
<meta property="article:published_time" content="2025-11-30T13:53:13.000Z">
<meta property="article:modified_time" content="2025-12-03T13:08:00.000Z">
<meta property="article:author" content="even629">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="GNU">
<meta property="article:tag" content="driver">
<meta property="article:tag" content="DeviceTree">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://even629.com/images/linux_cover.webp"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://even629.com/posts/2511300/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><meta name="baidu-site-verification" content="codeva-g8sPzVXu98"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://npm.elemecdn.com/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"中"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Linux设备树',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><link rel='preload', href='/img/avatar.png', as='image'><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/custom_card_author.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/right_menu.css"><link rel="stylesheet" href="/css/nav.css"><link rel="stylesheet" href="/css/newYear.css"><link rel="stylesheet" href="/css/music.css"><link rel="stylesheet" href="/css/beautify_label_h.css"><link rel="stylesheet" href="/css/equipment.css"><link rel="stylesheet" href="/css/liquid_glass.css"><link rel="stylesheet" href="/css/tag_plugin_plus.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.0.6/swiper-bundle.min.css"><span id="fps"></span><!-- hexo injector head_end start --><link rel="stylesheet" href="/css/wow_animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="常想一二，不思八九" type="application/atom+xml">
</head><body><div class="float-box left top"></div><div class="float-box left bottom"></div><div class="float-box right top"></div><div class="float-box right bottom"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg" style="background-image: url(/img/12bb_background.png);"></div><div id="an_music_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">90</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/charts/"><i class="fa-fw fas fa-solid fa-chart-simple"></i><span> 统计</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 分享</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fa-solid fa-toolbox"></i><span> 装备</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-solid fa-link"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-solid fa-comments"></i><span> 留言</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/images/linux_top_image.jpg);"><nav class="liquidGlass-wrapper" id="nav" style="--glass-border-radius: 2rem;"><div class="liquidGlass-effect"></div><div class="liquidGlass-tint"></div><div class="liquidGlass-shine"></div><div class="liquidGlass-box" style="display:flex;align-items:center;justify-content:center;width:100%"><!-- 左侧博客信息区域--><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" alt="Logo"></a></span><!-- 新增的导航菜单容器（居中布局关键）--><div id="nav-menus-container"><!-- 菜单主体部分--><div id="menus"><!-- 菜单项--><div class="menus_items"><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/charts/"><i class="fa-fw fas fa-solid fa-chart-simple"></i><span> 统计</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 分享</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment"></i><span> 说说</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fa-solid fa-toolbox"></i><span> 装备</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-solid fa-link"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-solid fa-comments"></i><span> 留言</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div><!-- 显示当前标题名称--><center id="name-container"><a id="page-name" href="javascript:rmf.scrollToTop()">常想一二，不思八九</a></center></div></div><!-- 右侧功能区域（新增容器）--><div id="nav-right-container"><!-- 搜索按钮（移动到右侧）--><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><!-- 移动端汉堡菜单按钮--><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></div></nav><div id="post-info"><h1 class="post-title">Linux设备树</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-11-30T13:53:13.000Z" title="发表于 2025-11-30 21:53:13">2025-11-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-03T13:08:00.000Z" title="更新于 2025-12-03 21:08:00">2025-12-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">40.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>165分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/2511300/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><hr>
<div class="timeline blue"><div class='timeline-item headline'><div class='timeline-item-title'><div class='item-circle'><p>时间轴</p>
</div></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2025-11-30</p>
</div></div><div class='timeline-item-content'><p>init</p>
</div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2025-12-01</p>
</div></div><div class='timeline-item-content'><p>add devicetree</p>
</div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2025-12-03</p>
</div></div><div class='timeline-item-content'><p>add devicetree plugin</p>
</div></div></div>

<hr>
<h1 id="设备树介绍"><a href="#设备树介绍" class="headerlink" title="设备树介绍"></a>设备树介绍</h1><p><strong>背景</strong></p>
<p>设备树（Device Tree）是一种硬件描述机制，用于在嵌入式系统和操作系统中描述硬件设备的特性、连接关系和配置信息。它提供了一种与平台无关的方式来描述硬件，使得内核与硬件之间的耦合度降低，提高了系统的可移植性和可维护性。</p>
<p>在平台总线模型中我们用 <code>platform_device</code> 结构体来对硬件设备进行描述，这是一种传统的平台总线设备描述方式。</p>
<p>每个 <code>platform_device</code> 结构表示一个特定的硬件设备，并通过注册到平台总线上来使得内核能够与该设备进行通信和交互。该结构包含设备的名称、资源（如内存地址、中断号等）、设备驱动程序等信息。</p>
<p>然而，随着时间的推移，Linux 内核中的 ARM 部分存在着大量的平台相关配置代码，这些代码通常是杂乱而重复的，导致了维护的困难和工作量的增加。设备树的引入为 ARM 架构上的 Linux 内核带来了革命性的变化。它提供了一种统一的硬件描述方式，使得不同芯片和板级的支持更加简单和灵活。此外，设备树还提供了硬件配置的可视化和可读性，方便开发者理解和调试硬件。</p>
<p><strong>DTS（Device Tree Source）</strong>：<strong>DTS 是设备树的源文件</strong>，采用一种类似于文本的语法来描述硬件设备的结构、属性和连接关系。DTS 文件以.dts 为扩展名，通常由开发人员编写。它是人类可读的形式，用于描述设备树的层次结构和属性信息。</p>
<p><strong>DTSI（Device Tree Source Include）</strong>：<strong>DTSI 文件是设备树源文件的包含文件</strong>。它扩展了 DTS文件的功能，用于定义可重用的设备树片段。DTSI 文件以.dtsi 为扩展名，可以在多个 DTS 文件中包含和共享。通过使用 DTSI，可以提高设备树的可重用性和可维护性（和 C 语言中头文件的作用相同）。</p>
<p><strong>DTB（Device Tree Blob）</strong>：<strong>DTB 是设备树的二进制表示形式</strong>。DTB 文件是通过将 DTS 或 DTSI文件编译而成的二进制文件，以.dtb 为扩展名。DTB 文件包含了设备树的结构、属性和连接信息，被操作系统加载和解析。在运行时，操作系统使用 DTB 文件来动态识别和管理硬件设备。</p>
<p><strong>DTC（Device Tree Compiler）</strong>：<strong>DTC 是设备树的编译器</strong>。它是一个命令行工具，用于将 DTS和 DTSI 文件编译成 DTB 文件。DTC 将文本格式的设备树源代码转换为二进制的设备树表示形式，以便操作系统能够加载和解析。DTC 是设备树开发中一个重要的工具。</p>
<p><strong>设备树在源码存放的位置</strong></p>
<p>ARM64 体系结构下的设备树源文件通常存放在 <code>arch/arm64/boot/dts/</code>目录及其子目录中。该目录也是设备树源文件的根目录，并包含了针对不同 ARM64 平台和设备的子目录。</p>
<p>在 ARM64 的子目录中，同样会按照硬件平台、设备类型或制造商进行组织和分类。这些子目录的命名可能与特定芯片厂商（如 Qualcomm、NVIDIA、Samsung）有关，由于我们使用的 soc 是瑞芯微的rk3568, 所以匹配的设备树目录为<code>arch/arm64/boot/dts/rockchip</code>。每个子目录中可能包含多个设备树文件，用于描述不同的硬件配置和设备类型。</p>
<h1 id="设备树的编译"><a href="#设备树的编译" class="headerlink" title="设备树的编译"></a>设备树的编译</h1><p>在 Linux 内核源码中，DTC（Device Tree Compiler）的源代码和相关工具通常存放在<code>scripts/dtc/</code>目录中</p>
<p><strong>设备树编译</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dtc -I dts -O dtb -o output.dtb input.dts</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-I</code> 表示输入的文件类型</li>
<li><code>-O</code>表示输出的文件类型</li>
<li><code>-o</code>表示编译后输出文件名</li>
</ul>
<p><strong>设备树反编译</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dtc -I dtb -O dts -o output.dts input.dtb</span><br></pre></td></tr></table></figure>

<h1 id="设备树基本语法"><a href="#设备树基本语法" class="headerlink" title="设备树基本语法"></a>设备树基本语法</h1><h2 id="根节点"><a href="#根节点" class="headerlink" title="根节点"></a>根节点</h2><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span> <span class="comment">// 设备树版本信息</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment">// 根节点开始</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		在这里可以添加注释，描述根节点的属性和配置</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="子节点"><a href="#子节点" class="headerlink" title="子节点"></a>子节点</h2><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[label:] node-name@[unit-address] <span class="punctuation">&#123;</span></span><br><span class="line">	[properties definitions]</span><br><span class="line">	[child nodes]</span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>节点标签（Label）</strong>（可选）：节点标签是一个可选的标识符，用于在设备树中引用该节点。标签允许其他节点直接引用此节点，以便在设备树中建立引用关系。</p>
</li>
<li><p><strong>节点名称（Node Name）</strong>：节点名称是一个字符串，用于唯一标识该节点在设备树中的位置。节点名称通常是硬件设备的名称，但必须在设备树中是唯一的。</p>
</li>
<li><p><strong>单元地址（Unit Address）</strong>（可选）：单元地址用于标识设备的实例。它可以是一个整数、一个十六进制值或一个字符串，具体取决于设备的要求。单元地址的目的是区分相同类型的设备的不同实例。</p>
</li>
<li><p><strong>属性定义（Properties Definitions）</strong>：属性定义是一组键值对，用于描述设备的配置和特性。属性可以根据设备的需求进行定义，例如寄存器地址、中断号、时钟频率等。</p>
</li>
<li><p><strong>子节点（Child Nodes）</strong>：子节点是当前节点的子项，用于进一步描述硬件设备的子组件或配置。子节点可以包含自己的属性定义和更深层次的子节点，形成设备树的层次结构。</p>
</li>
</ul>
<h2 id="reg属性"><a href="#reg属性" class="headerlink" title="reg属性"></a>reg属性</h2><p>reg 属性用于<strong>在设备树中指定设备的寄存器地址和大小</strong>，提供了与设备树中的物理设备之间的寄存器映射关系。</p>
<p>reg 属性可以在设备节点中有<strong>单个值格式</strong>和<strong>列表值格式</strong>这两种常见格式。</p>
<ul>
<li>单个值格式如下所示：</li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;address size&gt;</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure>

<p>这种格式适用于描述单个寄存器的情况。其中，address 是设备的起始寄存器地址，可以是一个整数或十六进制值(u32)。size 表示寄存器的大小，即占用的字节数。</p>
<p>例子：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">my_device</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;vendor,device&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x1000</span> <span class="number">0x4</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="comment">// 其他属性和子节点的定义</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>列表值格式</li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;address1 size1 address2 size2 ...&gt;</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure>

<p>当设备具有多个寄存器区域时，可以使用列表值格式的 reg 属性来描述每个寄存器区域的地址和大小。通过这种方式，可以指定多个寄存器的位置和大小，以描述设备的完整寄存器映射。</p>
<p>例子：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">my_device</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;vendor,device&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x1000</span> <span class="number">0x8</span> <span class="number">0x2000</span> <span class="number">0x4</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="comment">// 其他属性和子节点的定义</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h2 id="address-cells-和-size-cells-属性"><a href="#address-cells-和-size-cells-属性" class="headerlink" title="#address-cells 和 #size-cells 属性"></a><code>#address-cells</code> 和 <code>#size-cells</code> 属性</h2><p><code>#address-cells</code> 和 <code>#size-cells</code> 属性用于指定在上个小节中要设置的设备树中<strong>地址单元</strong>和<strong>地址大小</strong>的位数。它们提供了设备树解析所需的元数据，以正确解释设备的地址和大小信息.</p>
<h3 id="address-cells"><a href="#address-cells" class="headerlink" title="#address-cells"></a><code>#address-cells</code></h3><p>属性是一个位于设备树根节点的特殊属性，它指定了设备树中地址单元的位数。地址单元是设备树中用于表示设备地址的单个单位。它通常是一个整数，可以是十进制或十六进制值。它的值告诉解析设备树的软件在解释设备地址时应该使用多少位来表示一个地址单元。</p>
<p><strong>默认情况下，<code>#address-cells</code> 的值为 2</strong>，表示使用两个单元来表示一个设备地址。这意味着设备的地址将由两个整数（每个整数使用指定位数的位）组成。</p>
<p>例如，对于一个使用<u>两个 32 位整数</u>表示地址的设备（64位），可以在设备树的根节点中设置 #address-cells 属性为 &lt;2&gt;。</p>
<h3 id="size-cells"><a href="#size-cells" class="headerlink" title="#size-cells"></a><code>#size-cells</code></h3><p><code>#size-cells </code>属性也是一个位于设备树根节点的特殊属性，它指定了设备树中大小单元的位数。大小单元是设备树中用于表示设备大小的单个单位。它通常是一个整数，可以是十进制或十六进制值。</p>
<p>例子</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">node1</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">node1-child</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x02200000</span> <span class="number">0x4000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="comment">// 其他属性和子节点的定义</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>地址部分：0x02200000 被解释为一个地址单元，地址为 0x02200000。</li>
<li>大小部分：0x4000 被解释为一个大小单元，大小为 0x4000。</li>
</ul>
<h2 id="model属性"><a href="#model属性" class="headerlink" title="model属性"></a>model属性</h2><p>在设备树中，<strong>model 属性用于描述设备的型号或者名称</strong>。它通常作为设备节点的一个属性，用来提供关于设备的标识信息。model 属性是可选的，但在实际应用中经常被使用。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">my_device</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;vendor,device&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">model</span> <span class="operator">=</span> <span class="string">&quot;My Device XYZ&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="comment">// 其他属性和子节点的定义</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>model 属性通常用于标识和区分不同的设备，特别是当设备节点的 compatible 属性相同或相似时。通过使用不同的 model 属性值，可以更加准确地确定所使用的设备类型</p>
<h2 id="status属性"><a href="#status属性" class="headerlink" title="status属性"></a>status属性</h2><p>在设备树中，status 属性<strong>用于描述设备或节点的状态</strong>。它是设备树中常见的属性之一，用于表示设备或节点的可用性或操作状态。</p>
<p>status 属性的值可以是以下几种：</p>
<ul>
<li><p>“<strong>okay</strong>“：表示设备或节点正常工作，可用。</p>
</li>
<li><p>“<strong>disabled</strong>“：表示设备或节点被禁用，不可用。</p>
</li>
<li><p>“<strong>reserved</strong>“：表示设备或节点已被保留，暂时不可用。</p>
</li>
<li><p>“<strong>fail</strong>“：表示设备或节点初始化或操作失败，不可用。</p>
</li>
</ul>
<p>例子：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">my_device</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;vendor,device&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="comment">// 其他属性和子节点的定义</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="compatible-属性"><a href="#compatible-属性" class="headerlink" title="compatible 属性"></a>compatible 属性</h2><p>在设备树中，compatible 属性用于描述设备的兼容性信息。它是设备树中重要的属性之一，<strong>用于识别设备节点与驱动程序之间的匹配关系</strong>。</p>
<p>compatible 属性的值是一个字符串或字符串列表，用于指定设备节点与相应的驱动程序或设备描述符兼容的规则。通常，compatible 属性的值由设备的厂商定义，并且在设备树中使用。</p>
<p>以下是一些常见的 compatible 属性值的示例：</p>
<ul>
<li><strong>单个字符串值</strong>：例如 <code>&quot;vendor,device&quot;</code>，用于指定设备节点与特定厂商的特定设备兼容。</li>
<li><strong>字符串列表</strong>：例如 <code>[&quot;vendor,device1&quot;, &quot;vendor,device2&quot;]</code>，用于指定设备节点与多个设备兼容，通常用于设备节点具有多种变体或配置。</li>
<li><strong>通配符匹配</strong>：例如 <code>&quot;vendor,*&quot;</code>，用于指定设备节点与特定厂商的所有设备兼容，不考虑具体的设备标识。</li>
</ul>
<p>通过使用 compatible 属性，设备树可以提供设备和驱动程序之间的匹配信息。当设备树被操作系统或设备管理软件解析时，会根据设备节点的 compatible 属性值来选择适合的驱动程序进行设备的初始化和配置。</p>
<h2 id="aliases节点"><a href="#aliases节点" class="headerlink" title="aliases节点"></a>aliases节点</h2><p>aliases 节点是一个特殊的节点，用于<strong>定义设备别名</strong>。该节点<strong>位于设备树的根部</strong>，并具有节点路径 <code>/aliases</code></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">aliases</span> <span class="punctuation">&#123;</span></span><br><span class="line">	mmc0 = <span class="variable">&amp;sdmmc0</span><span class="punctuation">;</span></span><br><span class="line">	mmc1 = <span class="variable">&amp;sdmmc1</span><span class="punctuation">;</span></span><br><span class="line">	mmc2 = <span class="variable">&amp;sdhci</span><span class="punctuation">;</span></span><br><span class="line">	serial0 = <span class="string">&quot;/simple@fe000000/seria1@11c500&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>在别名的定义中，<strong>&amp; 符号用于引用设备树中的节点</strong>。别名的目的是提供可读性更高的名称，使设备树更易于理解和维护。通过使用别名，可以简化设备节点之间的关联，并减少重复输入设备节点的路径。</p>
<p><strong>aliases 节点中定义的别名只在设备树内部可见，不能在设备树之外引用。</strong> 它们主要用于设备树的内部组织和引用，以提高可读性和可维护性。</p>
<h2 id="chosen节点"><a href="#chosen节点" class="headerlink" title="chosen节点"></a>chosen节点</h2><p>chosen 节点是设备树中的一个特殊节点，用于<strong>传递和存储系统引导和配置的相关信息</strong>。具有路径<code>/chosen</code>。</p>
<p>chosen 节点通常包含以下子节点和属性：</p>
<ul>
<li><strong>bootargs</strong>：用于<u>存储引导内核时传递的命令行参数</u>。它可以包含诸如内核参数、设备树参数等信息。在引导过程中，操作系统或引导加载程序可以读取该属性来获取启动参数。</li>
<li><strong>stdout-path</strong>：用于<u>指定用于标准输出的设备路径</u>。在引导过程中，操作系统可以使用该属性来确定将控制台输出发送到哪个设备，例如串口或显示屏。</li>
<li><strong>firmware-name</strong>：用于指定系统固件的名称。它可以用于标识所使用的引导加载程序或固件的类型和版本。</li>
<li><strong>linux,initrd-start 和 linux,initrd-end</strong>：这些属性用于指定 Linux 内核初始化 RAM 磁盘(initrd): 的起始地址和结束地址。这些信息在引导过程中被引导加载程序使用，以将 initrd 加载到内存中供内核使用。</li>
<li><strong>其他自定义属性</strong>：chosen 节点还可以包含其他自定义属性，用于存储特定于系统引导和配置的信息。这些属性的具体含义和用法取决于设备树的使用和上下文。</li>
</ul>
<p>示例</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">chosen</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">bootargs</span> <span class="operator">=</span> <span class="string">&quot;root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0,115200&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>通过使用 chosen 节点，系统引导过程中的相关信息可以方便地传递给操作系统或引导加载程序。这样，系统引导和配置的各个组件可以共享和访问这些信息，从而实现更灵活和可配置的系统引导流程。</p>
<h2 id="device-type节点"><a href="#device-type节点" class="headerlink" title="device_type节点"></a>device_type节点</h2><p>在设备树中，<strong>device_type 节点是用于描述设备类型的节点</strong>。它<strong>通常作为设备节点的一个属性存在</strong>。</p>
<p>device_type 属性的值是一个字符串，用于标识设备的类型。</p>
<p>device_type 节点的存在有助于操作系统或其他软件识别和处理设备。它提供了设备的基本分类信息，使得驱动程序、设备树解析器或其他系统组件能够根据设备的类型执行相应的操作。</p>
<p>常见的设备类型包括但不限于：</p>
<ul>
<li><span class='p cyan'>cpu</span>：表示中央处理器。</li>
<li><span class='p cyan'>memory</span>：表示内存设备。</li>
<li><span class='p cyan'>display</span>：表示显示设备，如液晶显示屏。</li>
<li><span class='p cyan'>serial</span>：表示串行通信设备，如串口。</li>
<li><span class='p cyan'>ethernet</span>：表示以太网设备。</li>
<li><span class='p cyan'>usb</span>：表示通用串行总线设备。</li>
<li><span class='p cyan'>i2c</span>：表示使用 I2C (Inter-Integrated Circuit) 总线通信的设备。</li>
<li><span class='p cyan'>spi</span>：表示使用 SPI (Serial Peripheral Interface) 总线通信的设备。</li>
<li><span class='p cyan'>gpio</span>：表示通用输入/输出设备。</li>
<li><span class='p cyan'>pwm</span>：表示脉宽调制设备。</li>
</ul>
<p>这些只是一些常见的设备类型示例，实际上，设备类型可以根据具体的硬件和设备树的使用情况进行自定义和扩展。</p>
<h2 id="自定义属性"><a href="#自定义属性" class="headerlink" title="自定义属性"></a>自定义属性</h2><p>设备树中的自定义属性是用户根据特定需求添加的属性。这些属性可以用于提供额外的信息、配置参数或元数据，以满足设备或系统的特定要求。</p>
<p>例如可以在设备树中自定义一个管脚标号的属性 pinnum</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">my_device</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;my_device&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">pinnum</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h1 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h1><h2 id="实例分析：中断"><a href="#实例分析：中断" class="headerlink" title="实例分析：中断"></a>实例分析：中断</h2><p><strong>arch&#x2F;arm64&#x2F;boot&#x2F;dts&#x2F;rk3568.dtsi</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">pinctrl:</span> <span class="title class_">pinctrl</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;rockchip,rk3568-pinctrl&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">rockchip,grf</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;grf</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">rockchip,pmu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;pmugrf</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;2&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;2&gt;;</span></span><br><span class="line">	<span class="attr">ranges</span><span class="punctuation">;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	gpio0:</span> <span class="title class_">gpio0@fdd60000</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;rockchip,gpio-bank&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0</span> <span class="number">0xfdd60000</span> <span class="number">0x0</span> <span class="number">0x100</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;GIC_SPI <span class="number">33</span> IRQ_TYPE_LEVEL_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">clocks</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;pmucru</span> PCLK_GPIO0&gt;</span>, <span class="params">&lt;<span class="variable">&amp;pmucru</span> DBCLK_GPIO0&gt;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">		<span class="attr">gpio-controller</span><span class="punctuation">;</span></span><br><span class="line">		<span class="meta">#gpio-cells = &lt;2&gt;;</span></span><br><span class="line">		<span class="attr">interrupt-controller</span><span class="punctuation">;</span></span><br><span class="line">		<span class="meta">#interrupt-cells = &lt;2&gt;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p><strong>arch&#x2F;arm64&#x2F;boot&#x2F;dts&#x2F;rockchip&#x2F;topeet-screen-lcds.dts</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&amp;i2c1</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="symbol">	ft5x061:</span><span class="title class_">ft5x06@38</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;disabled&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;edt,edt-ft5306&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x38</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">touch-gpio</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio3</span> RK_PA5 IRQ_TYPE_EDGE_RISING&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">interrupt-parent</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio3</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;RK_PA5 IRQ_TYPE_LEVEL_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reset-gpio</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio0</span> RK_PB6 GPIO_ACTIVE_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">touchscreen-size-x</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">800</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">touchscreen-size-y</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1280</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="interrupts-属性"><a href="#interrupts-属性" class="headerlink" title="interrupts 属性"></a>interrupts 属性</h3><p>interrupts 属性用于指定设备的中断相关信息。它描述了<strong>中断控制器的类型、中断号以及中断触发类型</strong>。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">gpio0:</span> <span class="title class_">gpio0@fdd60000</span> <span class="punctuation">&#123;</span></span><br><span class="line">	...</span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;GIC_SPI <span class="number">33</span> IRQ_TYPE_LEVEL_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupt-controller</span><span class="punctuation">;</span></span><br><span class="line">	...</span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">ft5x061:</span><span class="title class_">ft5x06@38</span> <span class="punctuation">&#123;</span></span><br><span class="line">	...</span><br><span class="line">	<span class="attr">interrupt-parent</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio3</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;RK_PA5 IRQ_TYPE_LEVEL_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">	...</span><br><span class="line">  	<span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><strong>中断控制器类型</strong></li>
</ol>
<p>interrupts 属性的第一个参数指定了中断控制器的类型。</p>
<p>常见的类型包括 <strong>GIC (Generic Interrupt Controller)、IRQ (Basic Interrupt Handling)</strong> 等。例如，在给定的代码片段中，GIC_SPI 表示中断控制器的类型为 GIC SPI 中断。<br>中断控制器负责管理系统中的中断信号，它可以是硬件中的专用中断控制器，也可以是处理器内部的中断控制器。</p>
<ol start="2">
<li><strong>中断号</strong></li>
</ol>
<p>interrupts 属性的第二个参数指定了设备所使用的中断号。<br>中断号是一个唯一标识符，用于区分不同的中断信号源。系统使用中断号来识别中断源并进行相应的中断处理。</p>
<p><strong>中断号可以是一个整数值，也可以是一个宏定义或符号引用</strong>。在给定的代码片段中，33 表示该设备使用的中断号为 33。</p>
<ol start="3">
<li><strong>中断触发类型</strong></li>
</ol>
<p>interrupts 属性的第三个参数指定了中断的触发类型，即中断信号的触发条件。常见的触发类型包括边沿触发和电平触发。<br>电平触发表示中断信号在保持特定电平状态时触发，可以是高电平触发或低电平触发。</p>
<p>在给定的代码片段中，IRQ_TYPE_LEVEL_HIGH 表示中断的触发类型为高电平触发。触发类型的宏定义在内核源码<code>include/dt-bindings/interrupt-controller/irq.h</code>目录下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IRQ_TYPE_NONE 0 <span class="comment">// 无中断触发类型</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRQ_TYPE_EDGE_RISING 1 <span class="comment">// 上升沿触发</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRQ_TYPE_EDGE_FALLING 2 <span class="comment">// 下降沿触发</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRQ_TYPE_EDGE_BOTH (IRQ_TYPE_EDGE_FALLING | IRQ_TYPE_EDGE_RISING)<span class="comment">// 双边沿触发</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRQ_TYPE_LEVEL_HIGH 4 <span class="comment">// 高电平触发</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRQ_TYPE_LEVEL_LOW 8 <span class="comment">// 低电平触发</span></span></span><br></pre></td></tr></table></figure>

<h3 id="interrupt-controller属性"><a href="#interrupt-controller属性" class="headerlink" title="interrupt-controller属性"></a>interrupt-controller属性</h3><p><code>interrupt-controller</code> 属性用于<strong>标识当前节点所描述的设备是一个中断控制器</strong>。</p>
<p>中断控制器是<strong>硬件或软件模块</strong>，负责管理和分发中断信号。它接收来自各种设备的中断请求，并根据优先级和配置规则分发中断给相应的处理器或设备。</p>
<p><code>interrupt-controller</code> 属性本身没有特定的属性值，只需出现在节点的属性列表中即可。</p>
<h3 id="interrupt-parent属性"><a href="#interrupt-parent属性" class="headerlink" title="interrupt-parent属性"></a>interrupt-parent属性</h3><p><code>interrupt-parent</code> 属性是设备树中用于建立中断信号源与中断控制器之间关联的属性。它<strong>指定了中断信号源所属的中断控制器节点，以确保正确的中断处理和分发</strong>。</p>
<p><code>interrupt-parent</code> 属性值是一个引用，它指向中断控制器节点的路径或标签。</p>
<p>可以使用路径来引用中断控制器节点，如<code>/interrupt-controller-node</code>，或使用标签来引用中断控制器节点，如<code>&amp;interrupt-controller-label</code></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">ft5x061:</span><span class="title class_">ft5x06@38</span> <span class="punctuation">&#123;</span></span><br><span class="line">	...</span><br><span class="line">	<span class="attr">interrupt-parent</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio3</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;RK_PA5 IRQ_TYPE_LEVEL_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">	...</span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在gpio0中没有<code>interrupt-parent</code>，但由于在根 DTS 有默认 <code>interrupt-parent = GIC</code>，因此 GPIO0 不需要显式写。</p>
</blockquote>
<h3 id="interrupt-cells属性"><a href="#interrupt-cells属性" class="headerlink" title="#interrupt-cells属性"></a><code>#interrupt-cells</code>属性</h3><p><code>#interrupt-cells</code> 属性用于<strong>描述中断控制器中每个中断信号源的中断编号单元的数量</strong>。</p>
<p><strong>中断编号单元是指用于表示中断号和其他相关信息的固定大小的单元</strong>。通过指定中断编号单元的数量，操作系统可以正确解析和处理中断信息，并将其与中断控制器和中断信号源进行关联。</p>
<p><code>#interrupt-cells</code> 属性的值是一个整数，表示中断编号单元的数量。通常，这个值是一个正整数，例如 1、2 或 3，取决于中断控制器和设备的要求。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">gpio0:</span> <span class="title class_">gpio0@fdd60000</span> <span class="punctuation">&#123;</span></span><br><span class="line">	...</span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;GIC_SPI <span class="number">33</span> IRQ_TYPE_LEVEL_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">	...</span><br><span class="line">	<span class="attr">interrupt-controller</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#interrupt-cells = &lt;2&gt;;</span></span><br><span class="line">	...</span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">ft5x061:</span><span class="title class_">ft5x06@38</span> <span class="punctuation">&#123;</span></span><br><span class="line">	...</span><br><span class="line">	<span class="attr">interrupt-parent</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio3</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;RK_PA5 IRQ_TYPE_LEVEL_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">	...</span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>在 gpio0 的中断控制器为 gic，在 gic 节点中<code>#interrupt-cells</code> 属性被设置为 3，这也就是为什么在 gpio0 节点中 interrupts 属性有三个值;</p>
<p>而 ft5x061 的中断控制器为 gpio3，在 gpio3 节点中<code>#interrupt-cells</code> 属性被设置为 2，所以 ft5x06 节点的 interrupts 属性只有两个值。</p>
<h3 id="其他SOC设备树对比"><a href="#其他SOC设备树对比" class="headerlink" title="其他SOC设备树对比"></a>其他SOC设备树对比</h3><p><strong>NXP</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">gpio1:</span> <span class="title class_">gpio@0209c000</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;fsl,inx6ul-gpio&quot;</span>, <span class="string">&quot;fsl,imx35-gpio&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0209c000</span> <span class="number">0x4000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;GIC_SPI <span class="number">66</span> IRQ_TYPE_LEVEL_HIGH&gt;</span>, <span class="params">&lt;GIC_SPI <span class="number">67</span> IRQ_TYPE_LEVEL_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">gpio-controller</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#gpio-cells = &lt;2&gt;;</span></span><br><span class="line">	<span class="attr">interrupt-controller</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#interrupt-cells = &lt;2&gt;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">edt-ft5x06@38</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;edt,edt-ft5306&quot;</span>, <span class="string">&quot;edt,edt-ft5x06&quot;</span>, <span class="string">&quot;edt,edt-ft5406&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">		pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;ts_int_pin</span> <span class="variable">&amp;ts_reset_pin</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x38</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">interrupt-parent</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">9</span> <span class="number">0</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reset-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio5</span> <span class="number">9</span> GPIO_ACTIVE_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">irq-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio1</span> <span class="number">9</span> GPIO_ACTIVE_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;disabled&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Samsung</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">gpio_c:</span> <span class="title class_">gpioc</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;gpio-controller&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#gpio-cells = &lt;2&gt;;</span></span><br><span class="line">	<span class="attr">interrupt-controller</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#interrupt-cells = &lt;2&gt;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">ft5x06:</span> <span class="title class_">ft5x06038</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;edt,edt-ft5406&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x38</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(RGB_1024x600) || defined(RGB_800x480)</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;tsc2007_irq</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupt-parent</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio_c</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">26</span> IRQ_TYPE_EDGE_FALLING&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(LvDs_800×1280) || defined(LvDS_1024x768)</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;gt911_irq</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupt-parent</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio_b</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">29</span> IRQ_TYPE_EDGE_FALLING&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="attr">reset-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio_e</span> <span class="number">30</span> <span class="number">0</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="实例分析：时钟"><a href="#实例分析：时钟" class="headerlink" title="实例分析：时钟"></a>实例分析：时钟</h2><p>时钟（Clock）用于<strong>描述硬件设备和系统中的时钟源以及时钟相关的配置和连接关系</strong>。</p>
<p>时钟在计算机系统中起着至关重要的作用，用于同步和定时各种硬件设备的操作。</p>
<p>时钟可以分为两个主要角色：<strong>时钟生产者（clock provider）<strong>和</strong>时钟消费者（clock consumer）</strong>。</p>
<h3 id="时钟生产者"><a href="#时钟生产者" class="headerlink" title="时钟生产者"></a><strong>时钟生产者</strong></h3><ul>
<li>定义：时钟生产者是<strong>负责生成和提供时钟信号的硬件或软件模块</strong>。它可以是时钟控制器、PLL、时钟发生器等。</li>
<li>设备树节点：时钟生产者在设备树中<strong>以时钟节点的形式表示</strong>。</li>
</ul>
<h4 id="时钟生产者属性"><a href="#时钟生产者属性" class="headerlink" title="时钟生产者属性"></a>时钟生产者属性</h4><h5 id="clock-cells"><a href="#clock-cells" class="headerlink" title="clock-cells"></a>clock-cells</h5><p>该属性用于指定时钟编号的位数。它是一个整数值，表示时钟编号的位数。</p>
<p>通常情况下，当 <code>clock-cells</code> 为 0 时表示一个时钟，为 1 表示多个时钟。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">osc24m:</span> <span class="title class_">osc24m</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;clock&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">clock-frequency</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">24000000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">clock-output-names</span> <span class="operator">=</span> <span class="string">&quot;osc24m&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#clock-cells = &lt;0&gt;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个时钟</span></span><br><span class="line"><span class="symbol">clock:</span> <span class="title class_">clock</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="meta">#clock-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="attr">clock-output-names</span> <span class="operator">=</span> <span class="string">&quot;clock1&quot;</span>, <span class="string">&quot;clock2&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h5 id="clock-frequency"><a href="#clock-frequency" class="headerlink" title="clock-frequency"></a>clock-frequency</h5><p>是设备树中用于指定时钟频率的属性。它用于描述时钟节点所提供的时钟信号的频率，使用 Hertz (Hz) 作为单位。</p>
<p>对于时钟生产者节点，<code>clock-frequency</code> 属性表示该节点生成的时钟信号的频率。它用于描述时钟控制器、晶振、PLL 等产生时钟信号的硬件或软件模块的输出频率。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">osc24m:</span> <span class="title class_">osc24m</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;clock&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">clock-frequency</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">24000000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">clock-output-names</span> <span class="operator">=</span> <span class="string">&quot;osc24m&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#clock-cells = &lt;O&gt;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h3 id="时钟消费者"><a href="#时钟消费者" class="headerlink" title="时钟消费者"></a>时钟消费者</h3><p>时钟消费者是<strong>依赖时钟信号的硬件设备或模块</strong>。它们通过引用时钟生产者节点提供的时钟源来获取时钟信号。</p>
<h4 id="时钟消费者属性"><a href="#时钟消费者属性" class="headerlink" title="时钟消费者属性"></a>时钟消费者属性</h4><h5 id="clock"><a href="#clock" class="headerlink" title="clock"></a>clock</h5><p>该属性用于指定时钟消费者节点所需的时钟源。它是一个整数数组，每个元素是一个时钟编号，表示时钟消费者需要的一个时钟源。</p>
<h5 id="clock-names"><a href="#clock-names" class="headerlink" title="clock-names"></a>clock-names</h5><p>可选属性，用于指定时钟消费者节点所需时钟源的名称。它是一个字符串数组，与 clocks 数组一一对应，用于提供时钟源的描述性名称。</p>
<p>一个时钟消费者示例如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">clock: </span><span class="keyword">clock </span>&#123;</span><br><span class="line">	<span class="keyword">clocks </span>= &lt;&amp;cru CLK_VOP&gt;;</span><br><span class="line">	<span class="keyword">clock-names </span>= <span class="string">&quot;clk_vop&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>clocks 属性指定了该节点使用的时钟源，引用了 <code>cru</code> 节点中的 <code>CLK_VOP</code> 时钟源。<code>clock-names</code> 属性指定了时钟源的名称，这里是 <code>clk_vop</code>。</p>
<h5 id="assigned-clocks-和-assigned-clock-rates"><a href="#assigned-clocks-和-assigned-clock-rates" class="headerlink" title="assigned-clocks 和 assigned-clock-rates"></a><strong>assigned-clocks</strong> 和 <strong>assigned-clock-rates</strong></h5><p>是设备树中用于描述多路时钟的属性，通常一起使用。</p>
<p><code>assigned-clocks</code> 属性用于<strong>标识时钟消费者节点所使用的时钟源</strong>。</p>
<p>它是一个整数数组，每个元素对应一个时钟编号。时钟编号是指时钟生产者节点（如时钟控制器）所提供的时钟源的编号。</p>
<p>通过在时钟消费者节点中使用 <code>assigned-clocks</code> 属性，可以指定该节点所需的时钟源。</p>
<p><code>assigned-clock-rates</code> 属性用于<strong>指定每个时钟源的时钟频率</strong>。</p>
<p>它是一个整数数组，每个元素对应一个时钟源的频率。时钟频率以 Hz (赫兹) 为单位表示。</p>
<p><code>assigned-clock-rates</code> 属性的元素数量和顺序应与 <code>assigned-clocks</code> 属性中的时钟编号相对应。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cru:</span> <span class="title class_">clock-controller@fdd20000</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="meta">#clock-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="attr">assigned-clocks</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;pmucru</span> CLK_RTC_32K&gt;</span>, <span class="params">&lt;<span class="variable">&amp;cru</span> ACLK_RKVDEC_PRE&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">assigned-clock-rates</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">32768</span>&gt;</span>, <span class="params">&lt;<span class="number">300000000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h5 id="clock-indices"><a href="#clock-indices" class="headerlink" title="clock-indices"></a>clock-indices</h5><p><code>clock-indices</code> 属性用于<strong>指定时钟消费者节点所使用的时钟源的索引值</strong>。</p>
<p>它是一个整数数组，每个元素对应一个时钟源的索引。</p>
<p><strong>时钟索引是指时钟生产者节点（如时钟控制器）所提供的时钟源的编号</strong>。通过在时钟消费者节点中使用 <code>clock-indices</code> 属性，可以明确指定该节点所需的时钟源，并按照特定的顺序进行匹配。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">scpi_dvfs:</span> <span class="title class_">clocks-0</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="meta">#clock-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="attr">clock-indices</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0</span>&gt;</span>, <span class="params">&lt;<span class="number">1</span>&gt;</span>, <span class="params">&lt;<span class="number">2</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">clock-output-names</span> <span class="operator">=</span> <span class="string">&quot;atlclk&quot;</span>, <span class="string">&quot;aplclk&quot;</span>, <span class="string">&quot;gpuclk&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">scpi_clk:</span> <span class="title class_">clocks-1</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="meta">#clock-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="attr">clock-indices</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">clock-output-names</span> <span class="operator">=</span> <span class="string">&quot;pxlclk&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>在第一个节点中<code>atlclk</code>, <code>aplclk</code>, <code>gpuclk</code>三个时钟源的索引就分别被设置为了 0、1、2，在第二个节点中<code>pxlclk</code>时钟源的索引值被设置为了 3.</p>
<h5 id="assigned-clock-parents"><a href="#assigned-clock-parents" class="headerlink" title="assigned-clock-parents"></a>assigned-clock-parents</h5><p>用于<strong>指定时钟消费者节点所使用的时钟源的父时钟源</strong>。</p>
<p>它是一个时钟源引用的数组，每个元素对应一个父时钟源的引用。</p>
<p>在时钟的层次结构中，<strong>某些时钟源可能是其他时钟源的父时钟源</strong>，即它们提供时钟信号给其他时钟源作为输入。</p>
<p>通过在时钟消费者节点中使用 <code>assigned-clock-parents</code> 属性，可以明确指定该节点所需的父时钟源，并按照特定的顺序进行匹配</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">clock:</span> <span class="title class_">clock</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">assigned-clocks</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;clkcon</span> <span class="number">0</span>&gt;</span>, <span class="params">&lt;<span class="variable">&amp;pll</span> <span class="number">2</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">assigned-clock-parents</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;pll</span> <span class="number">2</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">assigned-clock-rates</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">115200</span>&gt;</span>, <span class="params">&lt;<span class="number">9600</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p><code>assigned-clocks</code> 属性指定了该节点使用的时钟源，引用了两个时钟源节点：<code>clkcon 0</code> 和 <code>pll 2</code>。</p>
<p><code>assigned-clock-parents</code> 属性指定了这些时钟源的父时钟源，引用了 <code>pll 2</code> 时钟源节点。</p>
<p><code>assigned-clock-rates</code> 属性指定了每个时钟源的时钟频率，分别是 115200 和 9600。</p>
<h2 id="实例分析：CPU"><a href="#实例分析：CPU" class="headerlink" title="实例分析：CPU"></a>实例分析：CPU</h2><p>设备树的 <strong>cpus 节点</strong>是用于描述系统中的处理器的一个重要节点。它是<strong>处理器拓扑结构的顶层节点</strong>，包含了所有处理器相关的信息。</p>
<p><strong>节点结构</strong>：</p>
<p>cpus 节点是一个容器节点，其下包含了系统中每个处理器的子节点。</p>
<p>每个子节点的名称通常为 <code>cpu@X</code>，其中 X 是处理器的索引号。每个子节点都包含了与处理器相关的属性，例如时钟频率、缓存大小等。</p>
<p><strong>处理器属性</strong>：</p>
<p><code>cpu@X</code> 子节点中的属性可以包括以下信息：</p>
<ul>
<li><code>device_type</code>：指示设备类型为处理器（如 “cpu”）。</li>
<li><code>reg</code>：指定处理器的地址范围，通常是物理地址或寄存器地址。</li>
<li><code>compatible</code>：指定处理器的兼容性信息，用于匹配相应的设备驱动程序。</li>
<li><code>clock-frequency</code>：指定处理器的时钟频率。</li>
<li><code>cache-size</code>：指定处理器的缓存大小。</li>
</ul>
<h3 id="处理器拓扑关系"><a href="#处理器拓扑关系" class="headerlink" title="处理器拓扑关系"></a>处理器拓扑关系</h3><p>除了处理器的基本属性，<strong>cpus 节点还可以包含其他用于描述处理器拓扑关系的节点</strong>，以提供更详细的处理器拓扑信息。这些节点可以帮助操作系统和软件了解处理器之间的连接关系、组织结构和特性。</p>
<ul>
<li><code>cpu-map</code>：描述处理器的映射关系，通常在多核处理器系统中使用。</li>
<li><code>socket</code> ：描述多处理器系统中的物理插槽或芯片组。</li>
<li><code>cluster</code>：描述处理器集群，即将多个处理器组织在一起形成的逻辑组。</li>
<li><code>core</code> ：描述处理器核心，即一个物理处理器内的独立执行单元。</li>
<li><code>thread</code> ：描述处理器线程，即一个物理处理器核心内的线程。(启用了超线程才会有多个，否则一个core只有一个thread)</li>
</ul>
<p>这些节点的嵌套关系可以在 cpus 节点下形成一个层次结构，反映了处理器的拓扑结构。</p>
<p>单核CPU:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">cpus</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;0&gt;;</span></span><br><span class="line"><span class="symbol">	cpu0:</span> <span class="title class_">cpu@0</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a7&quot;</span><span class="punctuation">;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="comment">// 其他属性...</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>多核CPU:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">cpus</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;0&gt;;</span></span><br><span class="line"><span class="symbol">	cpu0:</span> <span class="title class_">cpu@0</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a9&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu1:</span> <span class="title class_">cpu@1</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a9&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu2:</span> <span class="title class_">cpu@2</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a9&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu3:</span> <span class="title class_">cpu@3</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a9&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>cpus 节点是一个容器节点，包含了 cpu0 子节点。该节点使用了 <code>#address-cells</code> 和 <code>#size-cells</code> 属性来指定地址和大小的单元数量。</p>
<h4 id="cpu-map、socket、cluster-节点"><a href="#cpu-map、socket、cluster-节点" class="headerlink" title="cpu-map、socket、cluster 节点"></a>cpu-map、socket、cluster 节点</h4><ul>
<li><p><code>cpu-map</code> 节点是<strong>设备树中用于描述大小核架构处理器的映射关系的节点之一</strong>。</p>
<ul>
<li>它的<strong>父节点必须是 <code>cpus</code> 节点</strong>，而<strong>子节点可以是一个或多个 <code>cluster</code> 和 <code>socket</code> 节点</strong>。</li>
<li>通过 <code>cpu-map</code> 节点，可以定义不同核心和集群之间的连接和组织结构。</li>
</ul>
</li>
<li><p><code>socket</code> 节点用于<strong>描述处理器插槽（<code>socket</code>）之间的映射关系</strong>。</p>
<ul>
<li><strong>每个 <code>socket</code> 子节点表示一个处理器插槽</strong>，可以<strong>使用 <code>cpu-map-mask</code> 属性来指定该插槽使用的核心</strong>。</li>
<li>通过为每个 <code>socket</code> 子节点指定适当的 <code>cpu-map-mask</code>，可以定义不同插槽中使用的核心。这样，操作系统和软件可以了解到不同插槽之间的核心分配情况。</li>
</ul>
</li>
<li><p><code>cluster</code> 节点<strong>用于描述核心（<code>cluster</code>）之间的映射关系</strong>。</p>
<ul>
<li><strong>每个 <code>cluster</code> 子节点表示一个核心集群</strong>，可以<strong>使用 <code>cpu-map-mask</code> 属性来指定该集群使用的核心</strong>。</li>
<li>通过为每个 <code>cluster</code> 子节点指定适当的 <code>cpu-map-mask</code>，可以定义每个集群中使用的核心。这样，操作系统和软件可以了解到不同集群之间的核心分配情况</li>
</ul>
</li>
</ul>
<p>一个大小核架构的具体示例</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">cpus</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;2&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;0&gt;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">cpu-map</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="title class_">cluster0</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="title class_">core0</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;cpu_l0</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">			<span class="title class_">core1</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;cpu_l1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line">			<span class="title class_">core2</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;cpu_l2</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line">			<span class="title class_">core3</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;cpu_l3</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">		<span class="title class_">cluster1</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="title class_">core0</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;cpu_b0</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line">			<span class="title class_">core1</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;cpu_b1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu_l0:</span> <span class="title class_">cpu@0</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a53&quot;</span>, <span class="string">&quot;arm,armv8&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu_l1:</span> <span class="title class_">cpu@1</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a53&quot;</span>, <span class="string">&quot;arm,armv8&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu_l2:</span> <span class="title class_">cpu@2</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a53&quot;</span>, <span class="string">&quot;arm,armv8&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu_l3:</span> <span class="title class_">cpu@3</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a53&quot;</span>, <span class="string">&quot;arm,armv8&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu_b0:</span> <span class="title class_">cpu@100</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a72&quot;</span>, <span class="string">&quot;arm,armv8&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu_b1:</span> <span class="title class_">cpu@101</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a72&quot;</span>, <span class="string">&quot;arm,armv8&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>这个设备树描述了一个具有多个 CPU 核心的系统，包括四个 Cortex-A53 核心和两个Cortex-A72 核心。</p>
<h4 id="core、thread-节点"><a href="#core、thread-节点" class="headerlink" title="core、thread 节点"></a>core、thread 节点</h4><p><code>core</code> 和 <code>thread</code> 节点通常用于描述处理器核心和线程的配置。</p>
<p><code>core</code> 节点用于描述处理器的核心。一个处理器通常由多个核心组成，每个核心可以独立执行指令和任务。</p>
<p><code>thread</code> 节点用于描述处理器的线程。线程是在处理器核心上执行的基本执行单元，每个核心可以支持多个线程。(除非启动了超线程，否则一个core只有一个thread)</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">cpus</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;2&gt;;</span></span><br><span class="line">	<span class="title class_">cpu-map</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="title class_">socket0</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="title class_">cluster0</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="title class_">core0</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="title class_">thread0</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU0&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">					<span class="title class_">thread1</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU1&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">				<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">				<span class="title class_">core1</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="title class_">thread0</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU2&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">					<span class="title class_">thread1</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU3&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">				<span class="punctuation">&#125;;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">			<span class="title class_">cluster1</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="title class_">core0</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="title class_">thread0</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU4&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">					<span class="title class_">thread1</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU5&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">				<span class="punctuation">&#125;;</span></span><br><span class="line">				<span class="title class_">core1</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="title class_">thread0</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU6&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">					<span class="title class_">thread1</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU7&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">				<span class="punctuation">&#125;;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">		<span class="title class_">socket1</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="title class_">cluster0</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="title class_">core0</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="title class_">thread0</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU8&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">					<span class="title class_">thread1</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU9&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">				<span class="punctuation">&#125;;</span></span><br><span class="line">				<span class="title class_">core1</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="title class_">thread0</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU10&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">					<span class="title class_">thread1</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU11&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">				<span class="punctuation">&#125;;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line">			<span class="title class_">cluster1</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="title class_">core0</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="title class_">thread0</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU12&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">					<span class="title class_">thread1</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU13&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">				<span class="punctuation">&#125;;</span></span><br><span class="line">				<span class="title class_">core1</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="title class_">thread0</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU14&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">					<span class="title class_">thread1</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">cpu</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;</span>CPU15&gt;</span><span class="punctuation">;</span></span><br><span class="line">					<span class="punctuation">&#125;;</span></span><br><span class="line">				<span class="punctuation">&#125;;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h2 id="实例分析：GPIO"><a href="#实例分析：GPIO" class="headerlink" title="实例分析：GPIO"></a>实例分析：GPIO</h2><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">gpio0:</span> <span class="title class_">gpio@fdd60000</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;rockchip,gpio-bank&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0</span> <span class="number">0xfdd60000</span> <span class="number">0x0</span> <span class="number">0x100</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;GIC_SPI <span class="number">33</span> IRQ_TYPE_LEVEL_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">clocks</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;pmucru</span> PCLK_GPI00&gt;</span>, <span class="params">&lt;<span class="variable">&amp;pmucru</span> DBCLK_GPI00&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">gpio-controller</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#gpio-cells = &lt;2&gt;;</span></span><br><span class="line">	<span class="attr">gpio-ranges</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;pinctrl</span> <span class="number">0</span> <span class="number">0</span> <span class="number">32</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupt-controller</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#interrupt-cells = &lt;2&gt;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">ft5x06:</span> <span class="title class_">ft5x06@38</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;disabled&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;edt,edt-ft5306&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x38</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">touch-gpio</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio0</span> RK_PB5 IRQ_TYPE_EDGE_RISING&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupt-parent</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio0</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;RK_PB5 IRQ_TYPE_LEVEL_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">reset-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio0</span> RK_PB6 GPIO_ACTIVE_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">touchscreen-size-x</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">800</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">touchscreen-size-y</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1280</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	touch_<span class="attr">type</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h3 id="gpio-controller属性"><a href="#gpio-controller属性" class="headerlink" title="gpio-controller属性"></a>gpio-controller属性</h3><p><code>gpio-controller</code> 属性用于<strong>标识一个设备节点作为 GPIO 控制器</strong>。</p>
<p><strong>GPIO 控制器是负责管理和控制 GPIO 引脚的硬件模块或驱动程序</strong>。</p>
<p><code>gpio-controller</code> 属性通常作为设备节点的一个属性出现，位于设备节点的属性列表中。</p>
<p>当一个设备节点被标识为 GPIO 控制器时，它通常会定义一组 GPIO 引脚，并提供相关的GPIO 控制和配置功能。其他设备节点可以使用该 GPIO 控制器来控制和管理其 GPIO 引脚。</p>
<h3 id="gpio-cells属性"><a href="#gpio-cells属性" class="headerlink" title="#gpio-cells属性"></a><code>#gpio-cells</code>属性</h3><p><code>#gpio-cells</code> 属性用于<strong>指定 GPIO 引脚描述符的编码方式</strong>。GPIO 引脚描述符是用于标识和配置 GPIO 引脚的一组值，例如引脚编号、引脚属性等。</p>
<p><code>#gpio-cells</code> 属性的属性值是一个整数，表示用于编码<strong>GPIO 引脚描述符</strong>的单元数。通常这个值为 2。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">ft5x06:</span> <span class="title class_">ft5x06@38</span> <span class="punctuation">&#123;</span></span><br><span class="line">	.....</span><br><span class="line">	<span class="attr">reset-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio0</span> RK_PB6 GPIO_ACTIVE_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">	.....</span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h3 id="gpio-ranges属性"><a href="#gpio-ranges属性" class="headerlink" title="gpio-ranges属性"></a>gpio-ranges属性</h3><p><strong>背景</strong></p>
<blockquote>
<p>每个 <u>GPIO 控制器内部</u>都会给自己的每个引脚一个 <strong>本地编号（local number）</strong>，比如 GPIO 控制器内部编号: 0, 1, 2, 3, … 31</p>
<p>但是<u>在整个系统或者在其他硬件模块中</u>，这些 GPIO 可能有自己的 <strong>全局编号（global number）</strong> 外部编号: 100, 101, 102, 103, … 131</p>
<p>也就是说，<strong>控制器内部编号和外部编号可能不一致</strong>。</p>
<p>为了方便其他设备使用 GPIO，需要有一张映射表，把控制器的内部编号映射到系统外部编号，这就是 <code>gpio-ranges</code> 的作用。</p>
</blockquote>
<p><code>gpio-ranges</code> 属性是设备树中一个用于<strong>描述 GPIO 范围映射的属性</strong>。它通常用于描述具有大量 GPIO 引脚的 GPIO 控制器，以简化 GPIO 引脚的编码和访问。<br><code>gpio-ranges</code> 属性是一个包含一系列整数值的列表，每个整数值对应于设备树中的一个 GPIO控制器。列表中的每个整数值按照特定的顺序提供以下信息：</p>
<ul>
<li><strong>外部引脚编号的起始值</strong></li>
<li><strong>GPIO 控制器内部本地编号的起始值</strong></li>
<li><strong>引脚范围的大小（引脚数量）</strong></li>
</ul>
<p>举例：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">ft5x06:</span> <span class="title class_">ft5x06@38</span> <span class="punctuation">&#123;</span></span><br><span class="line">	.....</span><br><span class="line">	<span class="attr">reset-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio0</span> RK_PB6 GPIO_ACTIVE_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">	.....</span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;&amp;pinctrl&gt;</code>表示引用了名为 pinctrl 的引脚控制器节点</li>
<li><code>0 0 32</code> 表示<ul>
<li>外部引脚从 0 开始</li>
<li>控制器本地编号从 0 开始</li>
<li>共映射了 32 个引脚。</li>
</ul>
</li>
</ul>
<h3 id="gpio描述属性与gpio-cells"><a href="#gpio描述属性与gpio-cells" class="headerlink" title="gpio描述属性与gpio-cells"></a>gpio描述属性与gpio-cells</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">ft5x06:</span> <span class="title class_">ft5x06@38</span> <span class="punctuation">&#123;</span></span><br><span class="line">	.....</span><br><span class="line">	<span class="attr">reset-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio0</span> RK_PB6 GPIO_ACTIVE_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">	.....</span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>gpio 引脚描述属性个数由<code>#gpio-cells</code> 所决定，因为 gpio0 节点中的<code>#gpio-cells</code> 属性设置为了2，所以上面设备树 gpio 引脚描述属性个数也为 2。</p>
<p>其中 <code>RK_PB6</code> 定义在内核源码目录下的<code>include/dt-bindings/pinctrl/rockchip.h</code>头文件中，定义了 RK 引脚名和 gpio 编号的宏定义。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __DT_BINDINGS_ROCKCHIP_PINCTRL_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __DT_BINDINGS_ROCKCHIP_PINCTRL_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA0		0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA1		1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA2		2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA3		3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA4		4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA5		5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA6		6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA7		7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB0		8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB1		9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB2		10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB3		11</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB4		12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB5		13</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB6		14</span></span><br></pre></td></tr></table></figure>

<p><code>GPIO_ACTIVE_LOW</code> 定义在源码目录下的<code>include/dt-bindings/gpio/gpio.h</code>中，表示设置为低电平，同理 <code>GPIO_ACTIVE_HIGH</code> 就表示将这个 GPIO 设置为高电平，但这里只是对设备的描述，具体的设置还是要跟驱动相匹配。</p>
<h3 id="其他属性"><a href="#其他属性" class="headerlink" title="其他属性"></a>其他属性</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">gpio-controller@00000000</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;foo&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x00000000</span> <span class="number">0x1000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">gpio-controller</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#gpio-cells = &lt;2&gt;;</span></span><br><span class="line">	<span class="attr">ngpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">18</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">gpio-reserved-ranges</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0</span> <span class="number">4</span>&gt;</span>, <span class="params">&lt;<span class="number">12</span> <span class="number">2</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">gpio-line-names</span> <span class="operator">=</span> <span class="string">&quot;MMC-CD&quot;</span>, <span class="string">&quot;MMC-WP&quot;</span>,</span><br><span class="line">			<span class="string">&quot;voD eth&quot;</span>, <span class="string">&quot;RST eth&quot;</span>, <span class="string">&quot;LED R&quot;</span>,</span><br><span class="line">			<span class="string">&quot;LED G&quot;</span>, <span class="string">&quot;LED B&quot;</span>, <span class="string">&quot;col A&quot;</span>,</span><br><span class="line">			<span class="string">&quot;col B&quot;</span>, <span class="string">&quot;col C&quot;</span>, <span class="string">&quot;col D&quot;</span>,</span><br><span class="line">			<span class="string">&quot;NMI button&quot;</span>, <span class="string">&quot;Row A&quot;</span>, <span class="string">&quot;Row B&quot;</span>,</span><br><span class="line">			<span class="string">&quot;Row C&quot;</span>, <span class="string">&quot;Row D&quot;</span>, <span class="string">&quot;poweroff&quot;</span>,</span><br><span class="line">			<span class="string">&quot;reset&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>ngpios 属性</strong></li>
</ul>
<p>指定了 <strong>GPIO 控制器所支持的 GPIO 引脚数量</strong>。它表示该设备上可用的 GPIO 引脚的总数。</p>
<p>在这个例子中，<code>ngpios</code> 的值为 18，意味着该 GPIO 控制器支持 18个 GPIO 引脚</p>
<ul>
<li><strong>gpio-reserved-ranges 属性</strong></li>
</ul>
<p><strong>定义了保留的 GPIO 范围</strong>。每个范围由两个整数值表示，用尖括号括起来。</p>
<p>保留的 GPIO 范围意味着这些 GPIO 引脚不可用或已被其他设备或功能保留。</p>
<p>在这个例子中，有两个保留范围：&lt;0 4&gt;和&lt;12 2&gt;。&lt;0 4&gt;表示从第 0 个引脚开始的连续 4 个引脚被保留，而&lt;12 2&gt;表示从第 12 个引脚开始的连续 2 个引脚被保留。</p>
<ul>
<li><strong>gpio-line-names 属性</strong></li>
</ul>
<p><strong>定义了 GPIO 引脚的名称</strong>，以逗号分隔。每个名称对应一个GPIO 引脚。这些名称用于标识和识别每个 GPIO 引脚的作用或连接的设备。</p>
<p>在这个例子中，<code>gpio-line-names</code> 属性列出了多个 GPIO 引脚的名称，如 “MMC-CD”、”MMC-WP”、”voD eth” 等等。通过这些名称，可以清楚地了解每个 GPIO 引脚的功能或用途。</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251201214009913.png" alt="topeet-rk3568 LED原理图" loading="lazy"></p>
<p>从上面的原理图可以得到 LED 灯的引脚网络标号为 <code>Working_LEDEN_H_GPIO0_B7</code>，对应的引脚为 <code>GPIO0_B7</code>。</p>
<p>然后来查看内核源码目录下的<code>drivers/leds/leds-gpio.c</code>文件，这是 led 的驱动文件，然后找到 compatible 匹配值相关的部分，如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_gpio_leds_match</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;gpio-leds&quot;</span>, &#125;,</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到 compatible 匹配值为 gpio-leds。</p>
<p>最后在内核源码目录下的<code>include/dt-bindings/pinctrl/rockchip.h</code>头文件中，定义了 RK 引脚名和 gpio 编号的宏定义，如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPDX-License-Identifier: GPL-2.0-or-later */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Header providing constants for Rockchip pinctrl bindings.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2013 MundoReader S.L.</span></span><br><span class="line"><span class="comment"> * Author: Heiko Stuebner &lt;heiko@sntech.de&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __DT_BINDINGS_ROCKCHIP_PINCTRL_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __DT_BINDINGS_ROCKCHIP_PINCTRL_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA0		0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA1		1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA2		2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA3		3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA4		4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA5		5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA6		6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PA7		7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB0		8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB1		9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB2		10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB3		11</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB4		12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB5		13</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB6		14</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PB7		15</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PC0		16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PC1		17</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PC2		18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PC3		19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PC4		20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PC5		21</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PC6		22</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PC7		23</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PD0		24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PD1		25</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PD2		26</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PD3		27</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PD4		28</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PD5		29</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PD6		30</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PD7		31</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_FUNC_GPIO	0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>include/dt-bindings/gpio/gpio.h</code>文件中定义了引脚极性设置宏定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPDX-License-Identifier: GPL-2.0 */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This header provides constants for most GPIO bindings.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Most GPIO bindings include a flags cell as part of the GPIO specifier.</span></span><br><span class="line"><span class="comment"> * In most cases, the format of the flags cell uses the standard values</span></span><br><span class="line"><span class="comment"> * defined in this header.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DT_BINDINGS_GPIO_GPIO_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DT_BINDINGS_GPIO_GPIO_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bit 0 express polarity */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_ACTIVE_HIGH 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_ACTIVE_LOW 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bit 1 express single-endedness */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_PUSH_PULL 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_SINGLE_ENDED 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bit 2 express Open drain or open source */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_LINE_OPEN_SOURCE 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_LINE_OPEN_DRAIN 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Open Drain/Collector is the combination of single-ended open drain interface.</span></span><br><span class="line"><span class="comment"> * Open Source/Emitter is the combination of single-ended open source interface.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_OPEN_DRAIN (GPIO_SINGLE_ENDED | GPIO_LINE_OPEN_DRAIN)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_OPEN_SOURCE (GPIO_SINGLE_ENDED | GPIO_LINE_OPEN_SOURCE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bit 3 express GPIO suspend/resume and reset persistence */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_PERSISTENT 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_TRANSITORY 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bit 4 express pull up */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_PULL_UP 16</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bit 5 express pull down */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_PULL_DOWN 32</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>因此设备树如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/dts-v1/;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;dt-bindings/pinctrl/rockchip.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;dt-bindings/gpio/gpio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">/&#123;</span><br><span class="line">	model = <span class="string">&quot;This is my devicetree!&quot;</span>;</span><br><span class="line">	</span><br><span class="line">	led: led@<span class="number">1</span> &#123;</span><br><span class="line">		compatible = <span class="string">&quot;gpio-leds&quot;</span>;</span><br><span class="line">		gpios = &lt;&amp;gpio0 RK_PB7 GPIO_ACTIVE_HIGH&gt;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>&amp;gpio0</code>是引脚控制器的引用，<code>RK_PB7</code> 是引脚的编号或标识，<code>GPIO_ACTIVE_HIGH</code> 表示该 GPIO 引脚的活动电平是高电平</p>
<h3 id="其他SOC对比"><a href="#其他SOC对比" class="headerlink" title="其他SOC对比"></a>其他SOC对比</h3><p><strong>NXP</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">gpio1:</span> <span class="title class_">gpio@0209c000</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;fsl,inx6ul-gpio&quot;</span>, <span class="string">&quot;fsl,imx35-gpio&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0209c000</span> <span class="number">0x4000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;GIC_SPI <span class="number">66</span> IRQ_TYPE_LEVEL_HIGH&gt;</span>, <span class="params">&lt;GIC_SPI <span class="number">67</span> IRQ_TYPE_LEVEL_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">gpio-controller</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#gpio-cells = &lt;2&gt;;</span></span><br><span class="line">	<span class="attr">interrupt-controller</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#interrupt-cells = &lt;2&gt;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">edt-ft5x06@38</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;edt,edt-ft5306&quot;</span>, <span class="string">&quot;edt,edt-ft5x06&quot;</span>, <span class="string">&quot;edt,edt-ft5406&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">		pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;ts_int_pin</span> <span class="variable">&amp;ts_reset_pin</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x38</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">interrupt-parent</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">9</span> <span class="number">0</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reset-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio5</span> <span class="number">9</span> GPIO_ACTIVE_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">irq-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio1</span> <span class="number">9</span> GPIO_ACTIVE_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;disabled&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p><strong>samsung</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">gpio_c:</span> <span class="title class_">gpioc</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;gpio-controller&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#gpio-cells = &lt;2&gt;;</span></span><br><span class="line">	<span class="attr">interrupt-controller</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#interrupt-cells = &lt;2&gt;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">ft5x06:</span> <span class="title class_">ft5x06038</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;edt,edt-ft5406&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x38</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(RGB_1024x600) || defined(RGB_800x480)</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;tsc2007_irq</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupt-parent</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio_c</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">26</span> IRQ_TYPE_EDGE_FALLING&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(LvDs_800×1280) || defined(LvDS_1024x768)</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;gt911_irq</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupt-parent</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio_b</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">29</span> IRQ_TYPE_EDGE_FALLING&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="attr">reset-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio_e</span> <span class="number">30</span> <span class="number">0</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h2 id="实例分析：pinctrl"><a href="#实例分析：pinctrl" class="headerlink" title="实例分析：pinctrl"></a>实例分析：pinctrl</h2><h3 id="pinmux介绍"><a href="#pinmux介绍" class="headerlink" title="pinmux介绍"></a>pinmux介绍</h3><p><strong>Pinmux（引脚复用）是指在系统中配置和管理引脚功能的过程</strong>。在许多现代集成电路中，<strong>单个引脚可以具有多个功能</strong>，例如作为 GPIO、UART、SPI 或 I2C 等。通过使用引脚复用功能，可以在这些不同的功能之间切换。</p>
<p>引脚复用通过硬件和软件的方式实现。</p>
<ul>
<li><strong>硬件层面</strong></li>
</ul>
<p>芯片设计会为每个引脚提供多个功能的选择。这些功能通常由芯片厂商在芯片规格文档中定义。通过编程设置寄存器或开关，可以选择某个功能来连接引脚。这种硬件层面的配置通常是由 <strong>引脚控制器（Pin Controller）</strong> 或 <strong>引脚复用控制器（Pin Mux Controller）</strong> 负责管理。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251201214009943.png" alt="芯片手册中的管脚定义" loading="lazy"></p>
<ul>
<li><strong>软件层面</strong></li>
</ul>
<p>操作系统或设备驱动程序需要了解和配置引脚的功能。它们使用设备树（DeviceTree）或设备树绑定（Device Tree Bindings）来描述和配置引脚的功能。在设备树中，可以指定引脚的复用功能，将其连接到特定的硬件接口或功能。操作系统或设备驱动程序在启动过程中解析设备树，并根据配置对引脚进行初始化和设置。</p>
<p>从上图可以看到 <code>UART4_RX_M1</code> 对应的引脚可以复用为以下 6 个功能 <code>LCDC_D16</code>、<code>VOP_BT1120_D7</code>、<code>GMAC1_RXD0_M0</code>、<code>UART4_RX_M1</code>、<code>PWM8_M0</code>、<code>GPIO3_B1_d</code>，对应的 BGA引脚标号为 AG1</p>
<p>在 <strong>BGA（Ball Grid Array，球栅阵列）封装</strong>中，引脚标号是用于唯一标识每个引脚的标识符。这些标号通常由芯片制造商定义，并在芯片的规格文档或数据手册中提供。</p>
<p>BGA 芯片的引脚标号通常由字母和数字的组合构成。它们用于在芯片的封装底部的焊盘上进行标记。每个引脚标号都与芯片内部的功能或信号相对应，以便正确连接到印刷电路板（PCB）上的目标位置。RK3568 的引脚标号图如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251201214010005.png" alt="RK3568引脚标号图" loading="lazy"></p>
<p>可以看到纵向为 A-AH 的 28 个字母类型标号，横向为 1-28 的 28 个字母类型标号，瑞芯微也在对应的 3568 数据手册中加入了根据 BGA 位置制作的复用功能图，部分内容如下图。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251201214212379.png" alt="根据BGA位置制作的复用功能图" loading="lazy"></p>
<p>其中黑色框代表被保留的引脚，其他有颜色的框一般为电源和地，白色的框代表有具体复用功能的引脚。</p>
<h3 id="使用-pinctrl-设置复用关系"><a href="#使用-pinctrl-设置复用关系" class="headerlink" title="使用 pinctrl 设置复用关系"></a>使用 pinctrl 设置复用关系</h3><p><strong>pinctrl（引脚控制）用于描述和配置硬件设备上的引脚功能和连接方式</strong>。它是设备树的一部分，用于在启动过程中传递引脚配置信息给操作系统和设备驱动程序，以便正确地初始化和控制引脚。</p>
<p>在设备树中，pinctrl（引脚控制）使用了客户端Client和服务端Server的概念来描述引脚控制的关系和配置。</p>
<h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">node</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;pinctrl_hog_1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在上例中，<code>pinctrl-names</code> 属性定义了一个状态名称：default。</p>
<p><code>pinctrl-0</code> 属性指定了第一个状态 default 对应的引脚配置。</p>
<p><code>&lt;&amp;pinctrl_hog_1&gt;</code> 是一个引脚描述符，它引用了一个名为 <code>pinctrl_hog_1</code> 的引脚控制器节点。这表示在 default 状态下，设备的引脚配置将使用 <code>pinctrl_hog_1</code> 节点中定义的配置。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">node</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span>, <span class="string">&quot;wake up&quot;</span><span class="punctuation">;</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;pinctrl_hog_1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	pinctrl<span class="number">-1</span> = <span class="params">&lt;<span class="variable">&amp;pinctrl_hog_2</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在例子中，<code>pinctrl-names</code> 属性定义了两个状态名称：default 和 wake up。</p>
<p><code>pinctrl-0</code> 属性指定了第一个状态 default 对应的引脚配置，引用了 <code>pinctrl_hog_1</code> 节点。</p>
<p><code>pinctrl-1</code> 属性指定了第二个状态 wake up 对应的引脚配置，引用了 <code>pinctrl_hog_2</code> 节点。</p>
<p>这意味着设备可以处于两个不同的状态之一，每个状态分别使用不同的引脚配置</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">node</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;pinctrl_hog_1</span> <span class="variable">&amp;pinctrl_hog_2</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在这个例子中，<code>pinctrl-names</code> 属性仍然定义了一个状态名称：default。</p>
<p><code>pinctrl-0</code> 属性指定了第一个状态 default 对应的引脚配置，但与之前的例子不同的是，它引用了两个引脚描述符：<code>pinctrl_hog_1</code> 和 <code>pinctrl_hog_2</code>。</p>
<p>这表示在 default 状态下，设备的引脚配置将使用 <code>pinctrl_hog_1</code> 和 <code>pinctrl_hog_2</code> 两个节点中定义的配置。</p>
<p>这种方式可以 <strong>将多个引脚控制器的配置组合在一起</strong> ，以满足特定状态下的引脚需求。</p>
<h4 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h4><p>服务端是设备树中定义引脚配置的部分。它包含引脚组和引脚描述符，为客户端提供引脚配置选择。</p>
<p>服务端在设备树中定义了 pinctrl 节点，其中包含引脚组和引脚描述符的定义。</p>
<p>这里以瑞芯微的 RK3568 为例进行 pinctrl 服务端的讲解，瑞芯微原厂 BSP 工程师为了方便用户通过 pinctrl 设置管脚的复用关系，将包含所有复用关系的配置写在了内核目录下的<code>arch/arm64/boot/dts/rockchip/rk3568-pinctrl.dtsi</code>设备树中：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: (GPL-2.0+ OR MIT)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2020 Rockchip Electronics Co., Ltd.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dt-bindings/pinctrl/rockchip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rockchip-pinconf.dtsi&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This file is auto generated by pin2dts tool, please keep these code</span></span><br><span class="line"><span class="comment"> * by adding changes at end of this file.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">&amp;pinctrl</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="title class_">acodec</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="keyword">/omit-if-no-ref/</span></span><br><span class="line"><span class="symbol">		acodec_pins:</span> <span class="title class_">acodec-pins</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">rockchip,pins</span> <span class="operator">=</span></span><br><span class="line">				<span class="comment">/* acodec_adc_sync */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">1</span> RK_PB1 <span class="number">5</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span>,</span><br><span class="line">				<span class="comment">/* acodec_adcclk */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">1</span> RK_PA1 <span class="number">5</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span>,</span><br><span class="line">				<span class="comment">/* acodec_adcdata */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">1</span> RK_PA0 <span class="number">5</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span>,</span><br><span class="line">				<span class="comment">/* acodec_dac_datal */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">1</span> RK_PA7 <span class="number">5</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span>,</span><br><span class="line">				<span class="comment">/* acodec_dac_datar */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">1</span> RK_PB0 <span class="number">5</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span>,</span><br><span class="line">				<span class="comment">/* acodec_dacclk */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">1</span> RK_PA3 <span class="number">5</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span>,</span><br><span class="line">				<span class="comment">/* acodec_dacsync */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">1</span> RK_PA5 <span class="number">5</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>在 pinctrl 节点中就是每个节点的复用功能，然后我们以 uart4 的引脚复用为例</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">uart4</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="keyword">/omit-if-no-ref/</span></span><br><span class="line"><span class="symbol">		uart4m0_xfer:</span> <span class="title class_">uart4m0-xfer</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">rockchip,pins</span> <span class="operator">=</span></span><br><span class="line">				<span class="comment">/* uart4_rxm0 */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">1</span> RK_PA4 <span class="number">2</span> <span class="variable">&amp;pcfg_pull_up</span>&gt;</span>,</span><br><span class="line">				<span class="comment">/* uart4_txm0 */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">1</span> RK_PA6 <span class="number">2</span> <span class="variable">&amp;pcfg_pull_up</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">/omit-if-no-ref/</span></span><br><span class="line"><span class="symbol">		uart4m0_ctsn:</span> <span class="title class_">uart4m0-ctsn</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">rockchip,pins</span> <span class="operator">=</span></span><br><span class="line">				<span class="comment">/* uart4m0_ctsn */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">1</span> RK_PA7 <span class="number">2</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">/omit-if-no-ref/</span></span><br><span class="line"><span class="symbol">		uart4m0_rtsn:</span> <span class="title class_">uart4m0-rtsn</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">rockchip,pins</span> <span class="operator">=</span></span><br><span class="line">				<span class="comment">/* uart4m0_rtsn */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">1</span> RK_PA5 <span class="number">2</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">/omit-if-no-ref/</span></span><br><span class="line"><span class="symbol">		uart4m1_xfer:</span> <span class="title class_">uart4m1-xfer</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">rockchip,pins</span> <span class="operator">=</span></span><br><span class="line">				<span class="comment">/* uart4_rxm1 */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">3</span> RK_PB1 <span class="number">4</span> <span class="variable">&amp;pcfg_pull_up</span>&gt;</span>,</span><br><span class="line">				<span class="comment">/* uart4_txm1 */</span></span><br><span class="line">				<span class="params">&lt;<span class="number">3</span> RK_PB2 <span class="number">4</span> <span class="variable">&amp;pcfg_pull_up</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中<code>&lt;3 RK_PB1 4 &amp;pcfg_pull_up&gt;</code>和<code>&lt;3 RK_PB2 4 &amp;pcfg_pull_up&gt;</code>分别表示将 GPIO3 的 PB1 引脚设置为功能 4，将 GPIO3 的 PB2 也设置为功能 4，且电器属性都会设置为上拉。通过查找原理图可以得到两个引脚在 BGA 封装位置分别为 AG1 和 AF2</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251201214018634.png" alt="功能4" loading="lazy"></p>
<p>可以看到功能 4 对应串口 4 的发送端和接收端，pinctrl 服务端的配置和数据手册中的引脚复用功能是一一对应的。</p>
<p>那如果要将 <code>RK_PB1</code> 和 <code>RK_PB2</code> 设置为 GPIO 功能要如何设置呢，从上图可以看到 GPIO 对应功能 0，所以可以通过以下 pinctrl 内容将设置 <code>RK_PB1</code> 和 <code>RK_PB2</code> 设置为 GPIO 功能（事实上如果不对该管脚进行功能复用该引脚默认就会设置为 GPIO 功能）：</p>
<ul>
<li><code>&lt;3 RK_PB1 0 &amp;pcfg_pull_up&gt;</code></li>
<li><code>&lt;3 RK_PB2 0 &amp;pcfg_pull_up&gt;</code></li>
</ul>
<p>最后来看客户端对 uart4 服务端的引用，具体内容在内核源码目录<code>arch/arm64/boot/dts/rockchip/topeet-rk3568-linux.dts</code></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&amp;uart4</span><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;uart4m1_xfer</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>通过在客户端中引用服务端的引脚描述符，设备树可以将客户端和服务端的引脚配置关联起来。</p>
<h3 id="pinctrl实例编写"><a href="#pinctrl实例编写" class="headerlink" title="pinctrl实例编写"></a>pinctrl实例编写</h3><p>sdk 源码目录下的<code>device/rockchip/rk356x/BoardConfig-rk3568-evb1-ddr4-v10.mk</code>默认配置文件可以了解到编译的设备树为 <code>rk3568-evb1-ddr4-v10-linux.dts</code>,设备树之间包含关系列表如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251201214021465.png" alt="设备树之间包含关系" loading="lazy"></p>
<blockquote>
<p>上述设备树是4.x版本的内核</p>
</blockquote>
<p>Led 在设备树中已经被正常配置了：</p>
<p><code>arch/arm64/boot/dts/rockchip/topeet-rk3568-linux.dts </code></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LED</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> LED_PWM</span></span><br><span class="line">        <span class="title class_">leds</span> <span class="punctuation">&#123;</span>                                                                                              		   		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;pwm-leds&quot;</span><span class="punctuation">;</span></span><br><span class="line">                <span class="title class_">work</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">pwms</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;pwm0</span> <span class="number">0</span> <span class="number">500000</span> <span class="number">0</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">                        <span class="attr">linux,default-trigger</span> <span class="operator">=</span> <span class="string">&quot;heartbeat&quot;</span><span class="punctuation">;</span></span><br><span class="line">                        <span class="attr">default-state</span> <span class="operator">=</span> <span class="string">&quot;on&quot;</span><span class="punctuation">;</span></span><br><span class="line">                <span class="punctuation">&#125;;</span></span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="title class_">leds</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;gpio-leds&quot;</span><span class="punctuation">;</span></span><br><span class="line">                <span class="title class_">work</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio0</span> RK_PB7 GPIO_ACTIVE_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">                        <span class="attr">linux,default-trigger</span> <span class="operator">=</span> <span class="string">&quot;heartbeat&quot;</span><span class="punctuation">;</span></span><br><span class="line">                        <span class="attr">default-state</span> <span class="operator">=</span> <span class="string">&quot;on&quot;</span><span class="punctuation">;</span></span><br><span class="line">                <span class="punctuation">&#125;;</span></span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>这里并没有配置 pinctrl ，那为什么 led 最后能正常使用呢，上面我们已经提到了，在rk3568中，当GPIO0_B7引脚没有被复用为任何功能时，默认就是 GPIO 功能，所以即使这里没有 pinctrl led 功能也可以正常使用。</p>
<p>我们可以编写自己的led节点：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">my_led:</span> <span class="title class_">led</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;topeet,led&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio0</span> RK_PB7 GPIO_ACTIVE_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;rk_led_gpio</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>服务端</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rk_led<span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">	rk_led_gpio:</span><span class="title class_">rk-led-gpio</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">rockchip,pins</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0</span> RK_PB7 RK_FUNC_GPIO <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h1 id="dtb文件格式解析"><a href="#dtb文件格式解析" class="headerlink" title="dtb文件格式解析"></a>dtb文件格式解析</h1><p><strong>设备树 Blob (DTB) 格式是设备树数据的平面二进制编码</strong>。它用于在软件程序之间交换设备树数据。例如，在启动操作系统时，固件会将 DTB 传递给操作系统内核。</p>
<p>DTB 格式在单个、线性、无指针数据结构中对设备树数据进行编码。</p>
<p>它由<strong>一个小头部</strong>和三个可变大小的部分组成：<strong>内存保留块</strong>、<strong>结构块</strong>和<strong>字符串块</strong>。这些应该以该顺序出现在展平的设备树中。因此，设备树结构作为一个整体，当加载到内存地址时，将类似于下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251201214006999.png" alt="DTB" loading="lazy"></p>
<p>以下面这个设备树文件为例</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">model</span> <span class="operator">=</span> <span class="string">&quot;This is my devicetree!&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">chosen</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">bootargs</span> <span class="operator">=</span> <span class="string">&quot;root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0, 115200&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu1:</span> <span class="title class_">cpu@1</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a35&quot;</span>, <span class="string">&quot;arm,armv8&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">aliases</span> <span class="punctuation">&#123;</span></span><br><span class="line">		led1 = <span class="string">&quot;/gpio@22020101&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">node1</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">		<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">		<span class="title class_">gpio@22020102</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x20220102</span> <span class="number">0x40</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">node2</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="title class_">node1-child</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">pinnum</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">01234</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">gpio@22020101</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;led&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x20220101</span> <span class="number">0x40</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>编译为dtb后用Binary Viewer打开：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251201214339220.png" alt="Binary Viewer" loading="lazy"></p>
<h2 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdt_header</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> magic;  <span class="comment">// 设备树头部的魔数</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> totalsize; <span class="comment">// 设备树文件的总大小</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> off_dt_struct; <span class="comment">// 设备树结构体（节点数据）相对于文件开头的偏移量</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> off_dt_strings; <span class="comment">// 设备树字符串表相对于文件开头的偏移量</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> off_mem_rsvmap; <span class="comment">// 内存保留映射表相对于文件开头的偏移量</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> version; <span class="comment">// 设备树版本号</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> last_comp_version; <span class="comment">// 最后一个兼容版本号</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> boot_cpuid_phys; <span class="comment">// 启动 CPU 的物理 ID</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> size_dt_strings; <span class="comment">// 设备树字符串表的大小</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> size_dt_struct; <span class="comment">// 设备树结构体（节点数据）的大小</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>核心作用分类</th>
<th>字段</th>
<th>关键说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>文件标识</strong></td>
<td><code>magic</code></td>
<td>DTB 的固定魔数（<code>0xd00dfeed</code>，大端），用于验证文件合法性</td>
</tr>
<tr>
<td><strong>尺寸与偏移定位</strong></td>
<td><code>totalsize</code></td>
<td>DTB 整体大小（含所有块及间隙），确定文件读取范围</td>
</tr>
<tr>
<td></td>
<td><code>off_dt_struct</code></td>
<td>结构块（存储硬件节点 &#x2F; 属性）的偏移量，是解析硬件描述的核心入口</td>
</tr>
<tr>
<td></td>
<td><code>off_dt_strings</code></td>
<td>字符串块（存储属性名称）的偏移量，配合结构块中的索引获取属性名</td>
</tr>
<tr>
<td></td>
<td><code>off_mem_rsvmap</code></td>
<td>内存保留块（标记不可分配内存区域）的偏移量，避免内核内存冲突</td>
</tr>
<tr>
<td></td>
<td><code>size_dt_strings</code></td>
<td>字符串块长度，用于读取完整的属性名称集合</td>
</tr>
<tr>
<td></td>
<td><code>size_dt_struct</code></td>
<td>结构块长度，用于读取完整的硬件描述数据</td>
</tr>
<tr>
<td><strong>版本兼容性</strong></td>
<td><code>version</code></td>
<td>当前 DTB 遵循的格式版本，决定解析逻辑</td>
</tr>
<tr>
<td></td>
<td><code>last_comp_version</code></td>
<td>向下兼容的最低版本，保障不同版本内核的兼容性</td>
</tr>
<tr>
<td><strong>硬件关联</strong></td>
<td><code>boot_cpuid_phys</code></td>
<td>启动 CPU 的物理 ID，与设备树中 CPU 节点的<code>reg</code>属性对应，用于多核系统的核识别</td>
</tr>
</tbody></table>
<h2 id="内存保留块"><a href="#内存保留块" class="headerlink" title="内存保留块"></a>内存保留块</h2><p>内存保留块（Memory Reserved Block）是用于客户端程序的保护和保留物理内存区域的列表。</p>
<p>这些保留区域 <strong>不应被用于一般的内存分配，而是用于保护重要数据结构，以防止客户端程序覆盖这些数据</strong> 。</p>
<emp>内存保留块的目的是确保特定的内存区域在客户端程序运行时不被修改或使用</emp> 。由于在示例设备树中没有设置内存保留块，所以相应的区域都为 0。


<ul>
<li><strong>保留区域列表</strong>： 内存保留块是一个由一组 64 位大端整数对构成的列表。每对整数对应一个保留内存区域，其中包含物理地址和区域的大小（以字节为单位）。这些保留区域应该彼此不重叠。</li>
</ul>
<p>内存保留块中的每个保留区域由一个 64 位大端整数对表示。每对由以下 C 结构表示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdt_reserve_entry</span> &#123;</span></span><br><span class="line">	<span class="type">uint64_t</span> address;</span><br><span class="line">	<span class="type">uint64_t</span> size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中的第一个整数表示保留区域的物理地址，第二个整数表示保留区域的大小（以字节为单位）。每个整数都以 64 位的形式表示，即使在 32 位架构上也是如此。在 32 位 CPU 上，整数的高 32 位将被忽略。</p>
<ul>
<li><strong>保留区域的用途</strong>： 客户端程序不应访问内存保留块中的保留区域，除非引导程序提供的其他信息明确指示可以访问。引导程序可以使用特定的方式来指示客户端程序可以访问保留内存的部分内容。引导程序可能会在文档、可选的扩展或特定于平台的文档中说明保留内存的特定用途。</li>
</ul>
<p>内存保留块为设备树提供了保护和保留物理内存区域的功能。它确保了特定的内存区域在客户端程序运行时不被修改或使用。这样可以确保引导程序和其他关键组件在需要的情况下能够访问保留内存的特定部分，并保护关键数据结构免受意外修改。</p>
<h2 id="结构块"><a href="#结构块" class="headerlink" title="结构块"></a>结构块</h2><p>结构块是设备树中描述设备树本身结构和内容的部分。它<strong>由一系列带有数据的令牌序列组成，这些令牌按照线性树结构进行组织</strong>。</p>
<h3 id="令牌类型"><a href="#令牌类型" class="headerlink" title="令牌类型"></a>令牌类型</h3><p>结构块中的令牌分为五种类型，每种类型用于不同的目的。</p>
<ul>
<li><code>FDT_BEGIN_NODE (0x00000001)</code></li>
</ul>
<p><code>FDT_BEGIN_NODE</code> 标记 <strong>表示一个节点的开始</strong> 。它后面跟着节点的单元名称作为额外数据。节点名称以以空字符结尾的字符串形式存储，并且可以包括单元地址。节点名称后可能需要填充零字节以对齐，然后是下一个标记，可以是除了 <code>FDT_END</code> 之外的任何标记。</p>
<ul>
<li><code>FDT_END_NODE (0x00000002)</code></li>
</ul>
<p><code>FDT_END_NODE</code> 标记 <strong>表示一个节点的结束</strong> 。该标记没有额外的数据，紧随其后的是下一个标记，可以是除了 <code>FDT_PROP</code> 之外的任何标记。</p>
<ul>
<li><code>FDT_PROP (0x00000003)</code></li>
</ul>
<p><code>FDT_PROP</code> 标记 <strong>表示设备树中属性的开始</strong> 。它后面跟着描述属性的额外数据，该数据首先由属性的长度和名称组成，表示为以下 C 结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span> len;</span><br><span class="line">	<span class="type">uint32_t</span> nameoff;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>长度表示属性值的字节长度，名称偏移量指向字符串块中存储属性名称的位置。<br>在这个结构之后，属性的值作为字节字符串给出。属性值后可能需要填充零字节以对齐，然后是下一个令牌，可以是除了 <code>FDT_END</code> 之外的任何标记。</p>
<ul>
<li><code>FDT_NOP (0x00000004)</code></li>
</ul>
<p><code>FDT_NOP</code> 令牌可以被解析设备树的程序忽略。该令牌没有额外的数据，紧随其后的是下一个令牌，可以是任何有效的令牌。<strong>使用 <code>FDT_NOP</code> 令牌可以覆盖树中的属性或节点定义，从而将其从树中删除，而无需移动设备树 blob 中的其他部分</strong>。</p>
<h3 id="树状结构"><a href="#树状结构" class="headerlink" title="树状结构"></a>树状结构</h3><p>设备树的结构以线性树的形式表示。每个节点由 <code>FDT_BEGIN_NODE</code> 标记开始，由 <code>FDT_END_NODE</code> 标记结束。</p>
<p>节点的属性和子节点在 <code>FDT_END_NODE</code> 之前表示，因此 <strong>子节点的 <code>FDT_BEGIN_NODE</code> 和 <code>FDT_END_NODE</code> 令牌嵌套在父节点的令牌中</strong> 。</p>
<h3 id="结构块的结束"><a href="#结构块的结束" class="headerlink" title="结构块的结束"></a>结构块的结束</h3><p>结构块以单个 <code>FDT_END</code> 标记结束。该标记没有额外的数据，它位于结构块的末尾，并且是结构块中的最后一个标记。<br><code>FDT_END</code> 标记之后的字节应位于结构块的开头偏移处，该偏移等于设备树 blob 标头中的 <code>size_dt_struct</code> 字段的值。</p>
<h2 id="字符串块"><a href="#字符串块" class="headerlink" title="字符串块"></a>字符串块</h2><p>字符串块用于存储设备树中使用的所有属性名称。它由一系列以空字符结尾的字符串组成，这些字符串在字符串块中简单地连接在一起。</p>
<ul>
<li><strong>字符串连接</strong></li>
</ul>
<p>字符串块中的字符串<strong>以空字符（\0）作为终止符来连接</strong>。这意味着每个字符串都以空字符结尾，并且下一个字符串紧跟在上一个字符串的末尾。这种连接方式使得字符串块中的所有字符串形成一个连续的字符序列。</p>
<ul>
<li><strong>偏移量引用</strong></li>
</ul>
<p>在结构块中，<strong>属性的名称是通过偏移量来引用字符串块中的相应字符串的</strong>。偏移量是一个无符号整数值，它表示字符串在字符串块中的位置。通过使用偏移量引用，设备树可以节省空间，并且在属性名称发生变化时也更加灵活，因为只需要更新偏移量，而不需要修改结构块中的属性引用。</p>
<ul>
<li><strong>对齐约束</strong></li>
</ul>
<p><strong>字符串块没有对齐约束，这意味着它可以出现在设备树 blob 的任何偏移处</strong>。这使得字符串块的位置在设备树 blob 中是灵活的，并且可以根据需要进行调整，而不会对设备树的解析和处理造成影响。</p>
<p>字符串块是设备树中用于存储属性名称的部分。它由字符串连接而成，并通过偏移量在结构块中进行引用。字符串块的灵活位置使得设备树的表示更加紧凑和可扩展。</p>
<h1 id="dtb展开成device-node"><a href="#dtb展开成device-node" class="headerlink" title="dtb展开成device_node"></a>dtb展开成device_node</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251201214007096.png" alt="dtb 展开流程图" loading="lazy"></p>
<ul>
<li><strong>U-Boot 加载</strong></li>
</ul>
<p>U-Boot（Universal Bootloader）是一种常用的开源引导加载程序，用于引导嵌入式系统。在系统启动过程中，U-Boot 会将 <code>boot.img</code> 中的内核和设备树的二进制文件加载到系统内存的特定地址。</p>
<ul>
<li><strong>内核初始化</strong></li>
</ul>
<p>U-Boot 将内核和设备树的二进制文件加载到系统内存的特定地址后，控制权会转交给内核。在内核初始化的过程中，会解析设备树二进制文件，将其展开为内核可以识别的数据结构，以便内核能够正确地初始化和管理硬件资源。</p>
<ul>
<li><strong>设备树展开</strong></li>
</ul>
<p><strong>设备树展开是指将设备树二进制文件解析成内核中的设备节点（<code>struct device_node</code>）的过程</strong>。内核会读取设备树二进制文件的内容，并根据设备树的描述信息，构建设备树数据结构，例如设备节点、中断控制器、寄存器、时钟等。这些设备树数据结构将在内核运行时用于管理和配置硬件资源</p>
<p><code>struct device_node</code>定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/of.h</span></span><br><span class="line"><span class="keyword">typedef</span> u32 phandle;</span><br><span class="line"><span class="keyword">typedef</span> u32 ihandle;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">property</span> &#123;</span></span><br><span class="line">	<span class="type">char</span>	*name; <span class="comment">// 属性的名称</span></span><br><span class="line">	<span class="type">int</span>	length;<span class="comment">// 属性值的长度（字节数）</span></span><br><span class="line">	<span class="type">void</span>	*value;<span class="comment">// 属性值的指针</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">next</span>;</span><span class="comment">// 下一个属性节点指针</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_OF_DYNAMIC) || defined(CONFIG_SPARC)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> _flags;<span class="comment">// 属性的标志位</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_OF_PROMTREE)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> unique_id;<span class="comment">// 属性的唯一标识</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_OF_KOBJ)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bin_attribute</span> <span class="title">attr</span>;</span><span class="comment">// 内核对象二进制属性</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SPARC)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">of_irq_controller</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name; <span class="comment">//设备节点的名称</span></span><br><span class="line">	phandle phandle; <span class="comment">// 设备节点的句柄</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *full_name;<span class="comment">// 设备节点的完整名称</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fwnode_handle</span> <span class="title">fwnode</span>;</span><span class="comment">// 设备节点的固件节点句柄</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>	<span class="title">property</span> *<span class="title">properties</span>;</span><span class="comment">// 设备节点的属性列表</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>	<span class="title">property</span> *<span class="title">deadprops</span>;</span>	<span class="comment">/* removed properties */</span> <span class="comment">// 已删除的属性列表</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>	<span class="title">device_node</span> *<span class="title">parent</span>;</span> <span class="comment">// 父设备节点指针</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>	<span class="title">device_node</span> *<span class="title">child</span>;</span> <span class="comment">// 子设备节点指针</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>	<span class="title">device_node</span> *<span class="title">sibling</span>;</span> <span class="comment">// 兄弟设备节点指针</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_OF_KOBJ)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>	<span class="title">kobject</span> <span class="title">kobj</span>;</span> <span class="comment">// 内核对象(用于 sysfs)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> _flags; <span class="comment">// 设备节点的标志位</span></span><br><span class="line">	<span class="type">void</span>	*data; <span class="comment">// 与设备节点相关的数据指针</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SPARC)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> unique_id;<span class="comment">// 设备节点的唯一标识</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">of_irq_controller</span> *<span class="title">irq_trans</span>;</span><span class="comment">// 设备节点的中断控制器</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="dtb解析过程源码分析"><a href="#dtb解析过程源码分析" class="headerlink" title="dtb解析过程源码分析"></a>dtb解析过程源码分析</h2><h3 id="init-main-c"><a href="#init-main-c" class="headerlink" title="init&#x2F;main.c"></a><strong>init&#x2F;main.c</strong></h3><p>在内核<code>start_kernel()</code>中调用<code>setup_arch(&amp;command_line);</code>进行架构相关的初始化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init/main.c</span></span><br><span class="line">asmlinkage __visible <span class="type">void</span> __init __no_sanitize_address <span class="title function_">start_kernel</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> *command_line;</span><br><span class="line">	<span class="type">char</span> *after_dashes;</span><br><span class="line"></span><br><span class="line">	set_task_stack_end_magic(&amp;init_task);<span class="comment">// 设置任务栈的魔数</span></span><br><span class="line">	smp_setup_processor_id();<span class="comment">// 设置处理器 ID</span></span><br><span class="line">	debug_objects_early_init();<span class="comment">// 初始化调试对象</span></span><br><span class="line"></span><br><span class="line">	cgroup_init_early();<span class="comment">// 初始化 cgroup（控制组）</span></span><br><span class="line"></span><br><span class="line">	local_irq_disable();<span class="comment">// 禁用本地中断</span></span><br><span class="line">	early_boot_irqs_disabled = <span class="literal">true</span>;<span class="comment">// 标记早期引导期间中断已禁用</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	* 中断仍然被禁用。进行必要的设置，然后启用它们。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	boot_cpu_init();<span class="comment">// 初始化引导 CPU</span></span><br><span class="line">	page_address_init();<span class="comment">// 设置页地址</span></span><br><span class="line">	pr_notice(<span class="string">&quot;%s&quot;</span>, linux_banner);<span class="comment">// 打印 Linux 内核版本信息</span></span><br><span class="line">	early_security_init();</span><br><span class="line">	setup_arch(&amp;command_line);<span class="comment">// 架构相关的初始化</span></span><br><span class="line">	setup_boot_config(command_line);</span><br><span class="line">	setup_command_line(command_line);<span class="comment">// 设置命令行参数</span></span><br><span class="line">	setup_nr_cpu_ids();<span class="comment">// 设置 CPU 个数</span></span><br><span class="line">	setup_per_cpu_areas();<span class="comment">// 设置每个 CPU 的区域</span></span><br><span class="line">	smp_prepare_boot_cpu();	<span class="comment">/* arch-specific boot-cpu hooks */</span></span><br><span class="line">	boot_cpu_hotplug_init();<span class="comment">// 初始化热插拔的引导 CPU</span></span><br><span class="line"></span><br><span class="line">	build_all_zonelists(<span class="literal">NULL</span>);<span class="comment">// 构建所有内存区域列表</span></span><br><span class="line">	page_alloc_init();<span class="comment">// 初始化页面分配器</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="arch-arm64-kernel-setup-c"><a href="#arch-arm64-kernel-setup-c" class="headerlink" title="arch&#x2F;arm64&#x2F;kernel&#x2F;setup.c"></a><strong>arch&#x2F;arm64&#x2F;kernel&#x2F;setup.c</strong></h3><p>而在<code>setup_arch()</code>中下面第21行调用<code>setup_machine_fdt(__fdt_pointer);</code>设置机器的 FDT (平台设备树)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arch/arm64/kernel/setup.c</span></span><br><span class="line"><span class="type">void</span> __init __no_sanitize_address <span class="title function_">setup_arch</span><span class="params">(<span class="type">char</span> **cmdline_p)</span></span><br><span class="line">&#123;</span><br><span class="line">	init_mm.start_code = (<span class="type">unsigned</span> <span class="type">long</span>) _text;</span><br><span class="line">	init_mm.end_code   = (<span class="type">unsigned</span> <span class="type">long</span>) _etext;</span><br><span class="line">	init_mm.end_data   = (<span class="type">unsigned</span> <span class="type">long</span>) _edata;</span><br><span class="line">	init_mm.brk	   = (<span class="type">unsigned</span> <span class="type">long</span>) _end;</span><br><span class="line"></span><br><span class="line">	*cmdline_p = boot_command_line;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If know now we are going to need KPTI then use non-global</span></span><br><span class="line"><span class="comment">	 * mappings from the start, avoiding the cost of rewriting</span></span><br><span class="line"><span class="comment">	 * everything later.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	arm64_use_ng_mappings = kaslr_requires_kpti();</span><br><span class="line"></span><br><span class="line">	early_fixmap_init();<span class="comment">// 初始化 early fixmap</span></span><br><span class="line">	early_ioremap_init();<span class="comment">// 初始化 early ioremap</span></span><br><span class="line"></span><br><span class="line">	setup_machine_fdt(__fdt_pointer);<span class="comment">// 设置机器的 FDT（平台设备树）</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Initialise the static keys early as they may be enabled by the</span></span><br><span class="line"><span class="comment">	 * cpufeature code and early parameters.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	jump_label_init();<span class="comment">// 初始化静态密钥，早期可能会被 cpufeature 代码和早期参数启用</span></span><br><span class="line">	parse_early_param();</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Unmask asynchronous aborts and fiq after bringing up possible</span></span><br><span class="line"><span class="comment">	 * earlycon. (Report possible System Errors once we can report this</span></span><br><span class="line"><span class="comment">	 * occurred).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	 <span class="comment">// 在启动可能的早期控制台后，解除屏蔽异步中断和 FIQ（我们可以立即报告发生的系统错误）</span></span><br><span class="line">	local_daif_restore(DAIF_PROCCTX_NOIRQ);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * TTBR0 is only used for the identity mapping at this stage. Make it</span></span><br><span class="line"><span class="comment">	 * point to zero page to avoid speculatively fetching new entries.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	cpu_uninstall_idmap();<span class="comment">// 在这个阶段，TTBR0 仅用于身份映射。将其指向零页面，以避免做出猜测性的新条目获取。</span></span><br><span class="line"></span><br><span class="line">	xen_early_init();<span class="comment">// Xen 平台的早期初始化</span></span><br><span class="line">	efi_init();<span class="comment">// EFI 平台的初始化</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!efi_enabled(EFI_BOOT) &amp;&amp; ((u64)_text % MIN_KIMG_ALIGN) != <span class="number">0</span>)</span><br><span class="line">	     pr_warn(FW_BUG <span class="string">&quot;Kernel image misaligned at boot, please fix your bootloader!&quot;</span>);</span><br><span class="line"></span><br><span class="line">	arm64_memblock_init();<span class="comment">// ARM64 内存块的初始化</span></span><br><span class="line"></span><br><span class="line">	paging_init();<span class="comment">// 分页初始化</span></span><br><span class="line"></span><br><span class="line">	acpi_table_upgrade();<span class="comment">// ACPI 表的升级</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Parse the ACPI tables for possible boot-time configuration */</span></span><br><span class="line">	acpi_boot_table_init();<span class="comment">// 解析 ACPI 表以进行可能的引导时配置</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (acpi_disabled)</span><br><span class="line">		unflatten_device_tree();<span class="comment">// 展开设备树</span></span><br><span class="line"></span><br><span class="line">	bootmem_init();<span class="comment">// 引导内存的初始化</span></span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="setup-machine-fdt-fdt-pointer"><a href="#setup-machine-fdt-fdt-pointer" class="headerlink" title="setup_machine_fdt(__fdt_pointer)"></a>setup_machine_fdt(__fdt_pointer)</h3><p><code>__fdt_pointer</code> 是 dtb 二进制文件加载到内存的地址，该地址由 bootloader 启动 kernel 时透过 x0 寄存器传递过来的</p>
<p><strong>arch&#x2F;arm64&#x2F;kernel&#x2F;head.S</strong></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arch/arm64/kernel/head.S</span></span><br><span class="line"><span class="symbol">SYM_CODE_START_LOCAL</span>(preserve_boot_args)</span><br><span class="line">	<span class="keyword">mov</span>	<span class="built_in">x21</span>, <span class="built_in">x0</span>				<span class="comment">// x21=FDT</span></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line"><span class="symbol">SYM_FUNC_START_LOCAL</span>(__primary_switched)</span><br><span class="line">	...</span><br><span class="line">	str_l	<span class="built_in">x21</span>, __fdt_pointer, <span class="built_in">x5</span>		<span class="comment">// Save FDT pointer</span></span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p><strong>arch&#x2F;arm64&#x2F;kernel&#x2F;setup.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arch/arm64/kernel/setup.c</span></span><br><span class="line"><span class="comment">// 初始化设置机器的设备树</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __init <span class="title function_">setup_machine_fdt</span><span class="params">(<span class="type">phys_addr_t</span> dt_phys)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> size;</span><br><span class="line">	<span class="comment">// 将设备树物理地址映射到内核虚拟地址空间</span></span><br><span class="line">	<span class="type">void</span> *dt_virt = fixmap_remap_fdt(dt_phys, &amp;size, PAGE_KERNEL);</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dt_virt)<span class="comment">// 如果映射成功</span></span><br><span class="line">		memblock_reserve(dt_phys, size);<span class="comment">// 保留设备树占用的内存区域</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!dt_virt || !early_init_dt_scan(dt_virt)) &#123;<span class="comment">// 如果设备树映射失败或者设备树解析失败</span></span><br><span class="line">		pr_crit(<span class="string">&quot;\n&quot;</span></span><br><span class="line">			<span class="string">&quot;Error: invalid device tree blob at physical address %pa (virtual address 0x%p)\n&quot;</span></span><br><span class="line">			<span class="string">&quot;The dtb must be 8-byte aligned and must not exceed 2 MB in size\n&quot;</span></span><br><span class="line">			<span class="string">&quot;\nPlease check your bootloader.&quot;</span>,</span><br><span class="line">			&amp;dt_phys, dt_virt);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (<span class="literal">true</span>)<span class="comment">// 无限循环，等待系统崩溃</span></span><br><span class="line">			cpu_relax();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Early fixups are done, map the FDT as read-only now */</span></span><br><span class="line">	fixmap_remap_fdt(dt_phys, &amp;size, PAGE_KERNEL_RO);<span class="comment">// 将设备树映射为只读模式</span></span><br><span class="line"></span><br><span class="line">	name = of_flat_dt_get_machine_name();<span class="comment">// 获取设备树的机器名</span></span><br><span class="line">	<span class="keyword">if</span> (!name)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;Machine model: %s\n&quot;</span>, name);<span class="comment">// 输出机器型号信息</span></span><br><span class="line">	dump_stack_set_arch_desc(<span class="string">&quot;%s (DT)&quot;</span>, name);<span class="comment">// 设置栈转储的架构描述为机器型号</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面第13行<code>early_init_dt_scan</code>函数对设备树进行兼容性和完整性验证。该函数可能会检查设备树中的一致性标记、版本信息以及必需的节点和属性是否存在。如果验证失败，函数会返回 false。该函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/fdt.c</span></span><br><span class="line"><span class="type">bool</span> __init <span class="title function_">early_init_dt_scan</span><span class="params">(<span class="type">void</span> *params)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">bool</span> status;</span><br><span class="line"></span><br><span class="line">	status = early_init_dt_verify(params);<span class="comment">// 验证设备树的兼容性和完整性</span></span><br><span class="line">	<span class="keyword">if</span> (!status)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	early_init_dt_scan_nodes();<span class="comment">// 扫描设备树节点</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>early_init_dt_scan</code>中先调用了<code>early_init_dt_verify</code>对设备树进行校验，验证设备树的兼容性和完整性</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/fdt.c</span></span><br><span class="line"><span class="type">bool</span> __init <span class="title function_">early_init_dt_verify</span><span class="params">(<span class="type">void</span> *params)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!params)<span class="comment">// 验证传入的参数是否为空</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* check device tree validity */</span></span><br><span class="line">    <span class="comment">// 检查设备树头部的有效性</span></span><br><span class="line">	<span class="comment">// 如果设备树头部无效，返回 false</span></span><br><span class="line">	<span class="keyword">if</span> (fdt_check_header(params))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Setup flat device-tree pointer */</span></span><br><span class="line">	initial_boot_params = params;<span class="comment">// 设置指向设备树的指针为传入的参数</span></span><br><span class="line">    <span class="comment">// 计算设备树的 CRC32 校验值</span></span><br><span class="line">	<span class="comment">// 并将结果保存在全局变量 of_fdt_crc32 中</span></span><br><span class="line">	of_fdt_crc32 = crc32_be(~<span class="number">0</span>, initial_boot_params,</span><br><span class="line">				fdt_totalsize(initial_boot_params));</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后<code>early_init_dt_scan</code>调用了<code>early_init_dt_scan_nodes</code>扫描设备树节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/fdt.c</span></span><br><span class="line"><span class="type">void</span> __init <span class="title function_">early_init_dt_scan_nodes</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> rc = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Retrieve various information from the /chosen node */</span></span><br><span class="line">	rc = of_scan_flat_dt(early_init_dt_scan_chosen, boot_command_line);<span class="comment">/* 从 /chosen 节点中检索各种信息 */</span></span><br><span class="line">	<span class="keyword">if</span> (!rc)</span><br><span class="line">		pr_warn(<span class="string">&quot;No chosen node found, continuing without\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Initialize &#123;size,address&#125;-cells info */</span></span><br><span class="line">	of_scan_flat_dt(early_init_dt_scan_root, <span class="literal">NULL</span>);<span class="comment">/* 初始化 &#123;size,address&#125;-cells 信息 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Setup memory, calling early_init_dt_add_memory_arch */</span></span><br><span class="line">	of_scan_flat_dt(early_init_dt_scan_memory, <span class="literal">NULL</span>);<span class="comment">/* 设置内存信息，调用 early_init_dt_add_memory_arch 函数 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数 <code>early_init_dt_scan_nodes</code> 被声明为<code>__init</code>，这<u>表示它是在内核初始化阶段被调用，并且在初始化完成后不再需要</u>。该函数的目的是在早期阶段扫描设备树节点，并执行一些初始化操作。</p>
<p>函数中主要调用了 <code>of_scan_flat_dt</code> 函数，该函数用于扫描平面设备树（flat device tree）。平面设备树是一种<emp>将设备树以紧凑形式表示的数据结构，它不使用树状结构，而是使用线性结构，以节省内存空间</emp>。</p>
<h3 id="unflatten-device-tree"><a href="#unflatten-device-tree" class="headerlink" title="unflatten_device_tree()"></a>unflatten_device_tree()</h3><p>该函数用于解析设备树，将紧凑的设备树数据结构转换为树状结构的设备树</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/fdt.c</span></span><br><span class="line"><span class="type">void</span> __init <span class="title function_">unflatten_device_tree</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* 解析设备树 */</span></span><br><span class="line">	__unflatten_device_tree(initial_boot_params, <span class="literal">NULL</span>, &amp;of_root,</span><br><span class="line">				early_init_dt_alloc_memory_arch, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get pointer to &quot;/chosen&quot; and &quot;/aliases&quot; nodes for use everywhere */</span></span><br><span class="line">	<span class="comment">/* 获取指向 &quot;/chosen&quot; 和 &quot;/aliases&quot; 节点的指针，以供全局使用 */</span></span><br><span class="line">	of_alias_scan(early_init_dt_alloc_memory_arch);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 运行设备树的单元测试 */</span></span><br><span class="line">	unittest_unflatten_overlay_base();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数主要用于解析设备树，并将解析后的设备树存储在全局变量 <code>of_root</code> 中。</p>
<p>函数首先调用<code>__unflatten_device_tree</code> 函数来执行设备树的解析操作。解析后的设备树将使用 <code>of_root</code> 指针进行存储。</p>
<p>接下来，函数调用 <code>of_alias_scan</code> 函数。这个函数用于扫描设备树中的<code>/chosen</code> 和<code>/aliases</code> 节点，并为它们分配内存。这样，其他部分的代码可以通过全局变量访问这些节点。</p>
<p>最后，函数调用 <code>unittest_unflatten_overlay_base</code> 函数，用于运行设备树的单元测试。</p>
<h4 id="unflatten-device-tree-1"><a href="#unflatten-device-tree-1" class="headerlink" title="__unflatten_device_tree"></a>__unflatten_device_tree</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//drivers/of/fdt.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * __unflatten_device_tree - create tree of device_nodes from flat blob</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * unflattens a device-tree, creating the</span></span><br><span class="line"><span class="comment"> * tree of struct device_node. It also fills the &quot;name&quot; and &quot;type&quot;</span></span><br><span class="line"><span class="comment"> * pointers of the nodes so the normal device-tree walking functions</span></span><br><span class="line"><span class="comment"> * can be used.</span></span><br><span class="line"><span class="comment"> * @blob: The blob to expand</span></span><br><span class="line"><span class="comment"> * @dad: Parent device node</span></span><br><span class="line"><span class="comment"> * @mynodes: The device_node tree created by the call</span></span><br><span class="line"><span class="comment"> * @dt_alloc: An allocator that provides a virtual address to memory</span></span><br><span class="line"><span class="comment"> * for the resulting tree</span></span><br><span class="line"><span class="comment"> * @detached: if true set OF_DETACHED on @mynodes</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns NULL on failure or the memory chunk containing the unflattened</span></span><br><span class="line"><span class="comment"> * device tree on success.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> *__unflatten_device_tree(<span class="type">const</span> <span class="type">void</span> *blob,</span><br><span class="line">			      <span class="keyword">struct</span> device_node *dad,</span><br><span class="line">			      <span class="keyword">struct</span> device_node **mynodes,</span><br><span class="line">			      <span class="type">void</span> *(*dt_alloc)(u64 size, u64 align),</span><br><span class="line">			      <span class="type">bool</span> detached)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> size;</span><br><span class="line">	<span class="type">void</span> *mem;</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">&quot; -&gt; unflatten_device_tree()\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!blob) &#123;</span><br><span class="line">		pr_debug(<span class="string">&quot;No device tree pointer\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">&quot;Unflattening device tree:\n&quot;</span>);</span><br><span class="line">	pr_debug(<span class="string">&quot;magic: %08x\n&quot;</span>, fdt_magic(blob));</span><br><span class="line">	pr_debug(<span class="string">&quot;size: %08x\n&quot;</span>, fdt_totalsize(blob));</span><br><span class="line">	pr_debug(<span class="string">&quot;version: %08x\n&quot;</span>, fdt_version(blob));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fdt_check_header(blob)) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;Invalid device tree blob header\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* First pass, scan for size */</span></span><br><span class="line">	size = unflatten_dt_nodes(blob, <span class="literal">NULL</span>, dad, <span class="literal">NULL</span>);<span class="comment">/* 第一遍扫描，计算大小 */</span></span><br><span class="line">	<span class="keyword">if</span> (size &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	size = ALIGN(size, <span class="number">4</span>);</span><br><span class="line">	pr_debug(<span class="string">&quot;  size is %d, allocating...\n&quot;</span>, size);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocate memory for the expanded device tree */</span></span><br><span class="line">	mem = dt_alloc(size + <span class="number">4</span>, __alignof__(<span class="keyword">struct</span> device_node));<span class="comment">/* 为展开的设备树分配内存 */</span></span><br><span class="line">	<span class="keyword">if</span> (!mem)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(mem, <span class="number">0</span>, size);</span><br><span class="line"></span><br><span class="line">	*(__be32 *)(mem + size) = cpu_to_be32(<span class="number">0xdeadbeef</span>);</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">&quot;  unflattening %p...\n&quot;</span>, mem);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Second pass, do actual unflattening */</span></span><br><span class="line">	unflatten_dt_nodes(blob, mem, dad, mynodes);<span class="comment">/* 第二遍扫描，实际展开设备树 */</span></span><br><span class="line">	<span class="keyword">if</span> (be32_to_cpup(mem + size) != <span class="number">0xdeadbeef</span>)</span><br><span class="line">		pr_warn(<span class="string">&quot;End of tree marker overwritten: %08x\n&quot;</span>,</span><br><span class="line">			be32_to_cpup(mem + size));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (detached &amp;&amp; mynodes) &#123;</span><br><span class="line">		of_node_set_flag(*mynodes, OF_DETACHED);</span><br><span class="line">		pr_debug(<span class="string">&quot;unflattened tree is detached\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">&quot; &lt;- unflatten_device_tree()\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> mem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>该函数的重点在两次设备树的扫描上，第一遍扫描的目的是计算展开设备树所需的内存大小。</p>
<p>第 46 行：<code>size = unflatten_dt_nodes(blob, NULL, dad, NULL);</code> 函数的作用是递归地遍历设备树数据块，并计算展开设备树所需的内存大小。它接受四个参数：</p>
<ul>
<li>blob（设备树数据块指针）</li>
<li>start（当前节点的起始地址，初始为 NULL）</li>
<li>dad（父节点指针，而<code>unflatten_device_tree</code>函数中传入的是NULL）</li>
<li>mynodes（用于存储节点指针数组的指针，初始为 NULL）。</li>
</ul>
<p>第一遍扫描完成后，<code>unflatten_dt_nodes</code> 函数会<emp>返回展开设备树所需的内存大小，然后在对大小进行对齐操作，并为展开的设备树分配内存</emp>。</p>
<p>第 65 行：再次调用了 <code>unflatten_dt_nodes(blob, mem, dad, mynodes);</code> 函数进行第二遍扫描。通过这样的过程，<emp>第二遍扫描会将设备树数据块中的节点展开为真正的设备节点，并填充节点的名称、类型和属性等信息</emp>。这样就完成了设备树的展开过程。</p>
<h4 id="unflatten-dt-nodes"><a href="#unflatten-dt-nodes" class="headerlink" title="unflatten_dt_nodes()"></a>unflatten_dt_nodes()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/fdt.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * unflatten_dt_nodes - Alloc and populate a device_node from the flat tree</span></span><br><span class="line"><span class="comment"> * @blob: The parent device tree blob</span></span><br><span class="line"><span class="comment"> * @mem: Memory chunk to use for allocating device nodes and properties</span></span><br><span class="line"><span class="comment"> * @dad: Parent struct device_node</span></span><br><span class="line"><span class="comment"> * @nodepp: The device_node tree created by the call</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * It returns the size of unflattened device tree or error code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">unflatten_dt_nodes</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *blob,</span></span><br><span class="line"><span class="params">			      <span class="type">void</span> *mem,</span></span><br><span class="line"><span class="params">			      <span class="keyword">struct</span> device_node *dad,</span></span><br><span class="line"><span class="params">			      <span class="keyword">struct</span> device_node **nodepp)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">root</span>;</span><span class="comment">// 根节点</span></span><br><span class="line">	<span class="type">int</span> offset = <span class="number">0</span>, depth = <span class="number">0</span>, initial_depth = <span class="number">0</span>;<span class="comment">// 偏移量、深度和初始深度</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FDT_MAX_DEPTH	64 <span class="comment">// 最大深度</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">nps</span>[<span class="title">FDT_MAX_DEPTH</span>];</span><span class="comment">// 设备节点数组</span></span><br><span class="line">	<span class="type">void</span> *base = mem;<span class="comment">// 基地址，用于计算偏移量</span></span><br><span class="line">	<span class="type">bool</span> dryrun = !base;<span class="comment">// 是否只是模拟运行，不实际处理</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nodepp)</span><br><span class="line">		*nodepp = <span class="literal">NULL</span>;<span class="comment">// 如果指针不为空，将其置为空指针</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We&#x27;re unflattening device sub-tree if @dad is valid. There are</span></span><br><span class="line"><span class="comment">	 * possibly multiple nodes in the first level of depth. We need</span></span><br><span class="line"><span class="comment">	 * set @depth to 1 to make fdt_next_node() happy as it bails</span></span><br><span class="line"><span class="comment">	 * immediately when negative @depth is found. Otherwise, the device</span></span><br><span class="line"><span class="comment">	 * nodes except the first one won&#x27;t be unflattened successfully.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	* 如果 @dad 有效，则表示正在展开设备子树。</span></span><br><span class="line"><span class="comment">	* 在第一层深度可能有多个节点。</span></span><br><span class="line"><span class="comment">	* 将 @depth 设置为 1，以使 fdt_next_node() 正常工作。</span></span><br><span class="line"><span class="comment">	* 当发现负的 @depth 时，该函数会立即退出。</span></span><br><span class="line"><span class="comment">	* 否则，除第一个节点外的设备节点将无法成功展开。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">if</span> (dad)</span><br><span class="line">		depth = initial_depth = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	root = dad;<span class="comment">// 根节点为 @dad</span></span><br><span class="line">	nps[depth] = dad;<span class="comment">// 将根节点放入设备节点数组</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (offset = <span class="number">0</span>;</span><br><span class="line">	     offset &gt;= <span class="number">0</span> &amp;&amp; depth &gt;= initial_depth;</span><br><span class="line">	     offset = fdt_next_node(blob, offset, &amp;depth)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (WARN_ON_ONCE(depth &gt;= FDT_MAX_DEPTH - <span class="number">1</span>))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="comment">// 如果未启用 CONFIG_OF_KOBJ 并且节点不可用，则跳过该节点</span></span><br><span class="line">		<span class="keyword">if</span> (!IS_ENABLED(CONFIG_OF_KOBJ) &amp;&amp;</span><br><span class="line">		    !of_fdt_device_is_available(blob, offset))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="comment">// 填充节点信息，并将子节点添加到设备节点数组</span></span><br><span class="line">		<span class="keyword">if</span> (!populate_node(blob, offset, &amp;mem, nps[depth],</span><br><span class="line">				   &amp;nps[depth+<span class="number">1</span>], dryrun))</span><br><span class="line">			<span class="keyword">return</span> mem - base;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!dryrun &amp;&amp; nodepp &amp;&amp; !*nodepp)</span><br><span class="line">			*nodepp = nps[depth+<span class="number">1</span>];<span class="comment">// 将子节点指针赋值给 @nodepp</span></span><br><span class="line">		<span class="keyword">if</span> (!dryrun &amp;&amp; !root)</span><br><span class="line">			root = nps[depth+<span class="number">1</span>];<span class="comment">// 如果根节点为空，则将子节点设置为根节点</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (offset &lt; <span class="number">0</span> &amp;&amp; offset != -FDT_ERR_NOTFOUND) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;Error %d processing FDT\n&quot;</span>, offset);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Reverse the child list. Some drivers assumes node order matches .dts</span></span><br><span class="line"><span class="comment">	 * node order</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!dryrun)<span class="comment">// 反转子节点列表。一些驱动程序假设节点顺序与 .dts 文件中的节点顺序一致</span></span><br><span class="line">		reverse_nodes(root);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> mem - base;<span class="comment">// 返回处理的字节数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>fdt_next_node()</code> 函数用来遍历设备树的节点。</p>
<p>从偏移量为 0 开始，只要偏移量大于等于 0 且深度大于等于初始深度，就执行循环。</p>
<p>循环中的每次迭代都会处理一个设备树节点。在每次迭代中，首先检查深度是否超过了最大深度 <code>FDT_MAX_DEPTH</code> 如果超过了，则跳过该节点。</p>
<p>如果未启用 <code>CONFIG_OF_KOBJ</code> 并且节点不可用（通过 <code>of_fdt_device_is_available()</code> 函数判断），则跳过该节点。</p>
<p>随后调用 <code>populate_node()</code>函数填充节点信息，并将子节点添加到设备节点数组 <code>nps</code> 中。 <code>populate_node()</code> 函数定义如下所示</p>
<h4 id="populate-node"><a href="#populate-node" class="headerlink" title="populate_node"></a>populate_node</h4><p>该函数会解析设备节点的属性，并根据需要分配内存来存储属性值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/fdt.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">populate_node</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *blob,</span></span><br><span class="line"><span class="params">			  <span class="type">int</span> offset,</span></span><br><span class="line"><span class="params">			  <span class="type">void</span> **mem,</span></span><br><span class="line"><span class="params">			  <span class="keyword">struct</span> device_node *dad,</span></span><br><span class="line"><span class="params">			  <span class="keyword">struct</span> device_node **pnp,</span></span><br><span class="line"><span class="params">			  <span class="type">bool</span> dryrun)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span>;</span><span class="comment">// 设备节点指针</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *pathp;<span class="comment">// 节点路径字符串指针</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> l, allocl;<span class="comment">// 路径字符串长度和分配的内存大小</span></span><br><span class="line"></span><br><span class="line">	pathp = fdt_get_name(blob, offset, &amp;l);<span class="comment">// 获取节点路径和长度</span></span><br><span class="line">	<span class="keyword">if</span> (!pathp) &#123;</span><br><span class="line">		*pnp = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	allocl = ++l;<span class="comment">// 分配内存大小为路径长度加一，用于存储节点路径字符串</span></span><br><span class="line"></span><br><span class="line">	np = unflatten_dt_alloc(mem, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> device_node) + allocl,</span><br><span class="line">				__alignof__(<span class="keyword">struct</span> device_node));<span class="comment">// 分配设备节点内存</span></span><br><span class="line">	<span class="keyword">if</span> (!dryrun) &#123;</span><br><span class="line">		<span class="type">char</span> *fn;</span><br><span class="line">		of_node_init(np);<span class="comment">// 初始化设备节点</span></span><br><span class="line">		np-&gt;full_name = fn = ((<span class="type">char</span> *)np) + <span class="keyword">sizeof</span>(*np);<span class="comment">// 设置设备节点的完整路径名</span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">memcpy</span>(fn, pathp, l);<span class="comment">// 将节点路径字符串复制到设备节点的完整路径名中</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (dad != <span class="literal">NULL</span>) &#123;</span><br><span class="line">			np-&gt;parent = dad;<span class="comment">// 设置设备节点的父节点</span></span><br><span class="line">			np-&gt;sibling = dad-&gt;child;<span class="comment">// 设置设备节点的兄弟节点</span></span><br><span class="line">			dad-&gt;child = np;<span class="comment">// 将设备节点添加为父节点的子节点</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	populate_properties(blob, offset, mem, np, pathp, dryrun);<span class="comment">// 填充设备节点的属性信息</span></span><br><span class="line">	<span class="keyword">if</span> (!dryrun) &#123;</span><br><span class="line">		np-&gt;name = of_get_property(np, <span class="string">&quot;name&quot;</span>, <span class="literal">NULL</span>);<span class="comment">// 获取设备节点的名称属性</span></span><br><span class="line">		<span class="keyword">if</span> (!np-&gt;name)</span><br><span class="line">			np-&gt;name = <span class="string">&quot;&lt;NULL&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*pnp = np;<span class="comment">// 将设备节点指针赋值给*pnp</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 <code>populate_node</code> 函数中首先会调用<code>unflatten_dt_alloc</code> 函数分配设备节点内存。</p>
<p>分配的内存大小为 <code>sizeof(struct device_node) + allocl</code> 字节, 并使用 <code>__alignof__(struct device_node)</code> 对齐，然后调用 <code>populate_properties</code> 函数填充设备节点的属性信息。</p>
<blockquote>
<p>这里<code>np-&gt;name = of_get_property(np, &quot;name&quot;, NULL);</code> 获取设备节点的名称属性存放在<code>struct device_node</code>的 <code>name</code> 属性中</p>
</blockquote>
<h1 id="device-node转为platform-device"><a href="#device-node转为platform-device" class="headerlink" title="device_node转为platform_device"></a>device_node转为platform_device</h1><p>在平台总线模型中，device 部分是用 <code>platform_device</code> 结构体来描述硬件资源的，所以内核最终会将内核认识的 <code>device_node</code> 树转换 <code>platform_device</code>，但是</p>
<p class='p bold center'>并不是所有的 device_node 都会被转换成 platform_device</p>
<p>只有满足要求的才会转换成 <code>platform_device</code>,转换成 <code>platform_device</code> 的节点可以在<code>/sys/bus/platform/devices</code>下查看。</p>
<h2 id="转换规则"><a href="#转换规则" class="headerlink" title="转换规则"></a>转换规则</h2><p>规则如下：</p>
<ul>
<li><strong>遍历根节点下包含 compatible 属性的子节点，对于每个子节点，创建一个对应的 <code>platform_device</code></strong>。</li>
<li><strong>遍历根节点下包含 compatible 属性为 <code>simple-bus</code>、<code>simple-mfd</code> 或 <code>isa</code> 的节点以及它们的子节点。如果它们子节点包含 compatible 属性值则会给该子节点创建一个对应的 <code>platform_device</code></strong>。</li>
<li><strong>检查节点的 compatible 属性是否包含 <code>arm</code> 或 <code>primecell</code>。如果是，则不将该节点转换为 <code>platform_device</code>，而是将其识别为 AMBA 设备</strong>。</li>
</ul>
<p>对于规则2：</p>
<div class="note flat"><p>某些节点虽然本身是“总线”或“容器”，但不直接对应硬件设备，而是用来组织子设备。这些节点的 compatible 值通常是：</p>
<ul>
<li><code>simple-bus</code>：通用简单总线（如 AMBA APB&#x2F;AHB 外的普通内存映射总线）</li>
<li><code>simple-mfd</code>：多功能设备（Multi-Function Device）容器</li>
<li><code>isa</code>：ISA 总线（老式 PC）</li>
</ul>
<p>对于这类节点它们自己通常不创建 <code>platform_device</code>，但会递归遍历它们的所有子节点，只要子节点有 compatible 属性，就为该子节点创建 <code>platform_device</code></p>
<p>目的：支持设备树中的“总线嵌套”结构。例如 SoC 内部的外设挂在一个 simple-bus 节点下。</p>
</div>

<p>对于规则3:</p>
<div class="note flat"><p>如果一个节点的 compatible 字符串中包含 <code>arm,xxx</code> 或 <code>primecell</code>（如 <code>arm,pl011</code>、<code>arm,pl081</code>），说明它是 ARM PrimeCell 外设，属于 AMBA 总线设备（APB&#x2F;AHB）。这类设备：</p>
<ul>
<li>不会被注册为 <code>platform_device</code>，而是由 AMBA 总线子系统（<code>amba_bus_type</code>）专门处理</li>
<li>使用 <code>amba_device</code> 结构，而非 <code>platform_device</code></li>
</ul>
<p>原因：ARM PrimeCell 设备有标准寄存器布局（如 CID&#x2F;PID），AMBA 子系统会自动探测并验证，比通用 <code>platform_device</code> 更安全高效。</p>
</div>

<h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h2><p>示例1：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">model</span> <span class="operator">=</span> <span class="string">&quot;This is my devicetree!&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="title class_">chosen</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">bootargs</span> <span class="operator">=</span> <span class="string">&quot;root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0, 115200&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu1:</span> <span class="title class_">cpu@1</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a35&quot;</span>, <span class="string">&quot;arm,armv8&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">aliases</span> <span class="punctuation">&#123;</span></span><br><span class="line">		led1 = <span class="string">&quot;/gpio@22020101&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">node1</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">		<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">		<span class="title class_">gpio@22020102</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x20220102</span> <span class="number">0x40</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">node2</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="title class_">node1-child</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">pinnum</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">01234</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">gpio@22020101</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;led&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x20220101</span> <span class="number">0x40</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在上面的设备树中，总共有 <code>chosen</code>、<code>cpu1: cpu@1</code>、<code>aliases</code>、<code>node1</code>、<code>node2</code>、<code>gpio@22020101</code>这六个节点，其中前五个节点都没有 compatible 属性，所以并不会被转换为 <code>platform_device</code>，而最后一个 <code>gpio@22020101</code> 节点符合规则一，在根节点下，且有 compatible 属性，所以最后会转换为 <code>platform_device</code>。</p>
<p>示例2：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">model</span> <span class="operator">=</span> <span class="string">&quot;This is my devicetree!&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="title class_">chosen</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">bootargs</span> <span class="operator">=</span> <span class="string">&quot;root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0, 115200&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu1:</span> <span class="title class_">cpu@1</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a35&quot;</span>, <span class="string">&quot;arm,armv8&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">aliases</span> <span class="punctuation">&#123;</span></span><br><span class="line">		led1 = <span class="string">&quot;/gpio@22020101&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">node1</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">		<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;simple-bus&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="title class_">gpio@22020102</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x20220102</span> <span class="number">0x40</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">node2</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="title class_">node1-child</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">pinnum</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">01234</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">gpio@22020101</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;led&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x20220101</span> <span class="number">0x40</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>这里在 <code>node1</code> 节点中添加了 compatible 属性，但是这个 compatible 属性值为 <code>simple-bus</code>，我们需要继续看他的子节点，子节点 <code>gpio@22020102</code> 并没有 compatible 属性值，所以这里的 <code>node1</code> 节点不会被转换。</p>
<p>示例3：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">model</span> <span class="operator">=</span> <span class="string">&quot;This is my devicetree!&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="title class_">chosen</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">bootargs</span> <span class="operator">=</span> <span class="string">&quot;root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0, 115200&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpu1:</span> <span class="title class_">cpu@1</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a35&quot;</span>, <span class="string">&quot;arm,armv8&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">aliases</span> <span class="punctuation">&#123;</span></span><br><span class="line">		led1 = <span class="string">&quot;/gpio@22020101&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">node1</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">		<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;simple-bus&quot;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">		<span class="title class_">gpio@22020102</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;gpio&quot;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x20220102</span> <span class="number">0x40</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">node2</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="title class_">node1-child</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">pinnum</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">01234</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">gpio@22020101</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;led&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x20220101</span> <span class="number">0x40</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>这里在 node1 节点的子节点 <code>gpio@22020102</code> 中添加了 compatible 属性，node1 节点的 compatible 属性值为 <code>simple-bus</code>，然后需要继续看他的子节点，子节点 <code>gpio@22020102</code> 的 compatible 属性值为 gpio，所以这里的 <code>gpio@22020102</code> 节点会被转换成<code>platform_device</code></p>
<p>示例4：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">model</span> <span class="operator">=</span> <span class="string">&quot;This is my devicetree!&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="title class_">chosen</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">bootargs</span> <span class="operator">=</span> <span class="string">&quot;root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0,115200&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">	cpul:</span> <span class="title class_">cpu@1</span> <span class="punctuation">&#123;</span></span><br><span class="line">		device_<span class="attr">type</span> <span class="operator">=</span> <span class="string">&quot;cpu&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a35&quot;</span>, <span class="string">&quot;arm,armv8&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">		<span class="title class_">amba</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;simple-bus&quot;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="meta">#address-cells = &lt;2&gt;;</span></span><br><span class="line">			<span class="meta">#size-cells = &lt;2&gt;;</span></span><br><span class="line">			<span class="attr">ranges</span><span class="punctuation">;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">			dmac_peri:</span> <span class="title class_">dma-controller@ff250000</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,p1330&quot;</span>, <span class="string">&quot;arm,primecell&quot;</span><span class="punctuation">;</span></span><br><span class="line">				<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0</span> <span class="number">0xff250000</span> <span class="number">0x0</span> <span class="number">0x4000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">				<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;GIC_SPI <span class="number">2</span> IRQ_TYPE_LEVEL_HIGH&gt;</span>,</span><br><span class="line">				<span class="params">&lt;GIC_SPI <span class="number">3</span> IRQ_TYPE_LEVEL_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">				<span class="meta">#dma-cells = &lt;1&gt;;</span></span><br><span class="line">				arm,pl330-<span class="attr">broken-no-flushp</span><span class="punctuation">;</span></span><br><span class="line">				arm,p1330-<span class="attr">periph-burst</span><span class="punctuation">;</span></span><br><span class="line">				<span class="attr">clocks</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;cru</span> ACLK DMAC_PERI&gt;</span><span class="punctuation">;</span></span><br><span class="line">				<span class="attr">clock-names</span> <span class="operator">=</span> <span class="string">&quot;apb_pclk&quot;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">			dmac_bus:</span> <span class="title class_">dma-controller@ff600000</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,p1330&quot;</span>, <span class="string">&quot;arm,primecell&quot;</span><span class="punctuation">;</span></span><br><span class="line">				<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0</span> <span class="number">0xff600000</span> <span class="number">0x0</span> <span class="number">0x4000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">				<span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;GIC_SPI <span class="number">0</span> IRQ_TYPE_LEVEL_HIGH&gt;</span>,</span><br><span class="line">				<span class="params">&lt;GIC_SPI <span class="number">1</span> IRQ_TYPE_LEVEL_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">				<span class="meta">#dma-cells = &lt;1&gt;;</span></span><br><span class="line">				arm,pl330-<span class="attr">broken-no-flushp</span><span class="punctuation">;</span></span><br><span class="line">				arm,pl330-<span class="attr">periph-burst</span><span class="punctuation">;</span></span><br><span class="line">				<span class="attr">clocks</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;cru</span> ACLK_DMAC_BUS&gt;</span><span class="punctuation">;</span></span><br><span class="line">				<span class="attr">clock-names</span> <span class="operator">=</span> <span class="string">&quot;apb_pclk&quot;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>amba 节点的 compatible 值为 <code>simple-bus</code>，不会被转换为 <code>platform_device</code>，而是作为父节点用于组织其他设备，所以需要来查看他的子节点。</p>
<p><code>dmac_peri: dma-controller@ff250000</code> 节点: 该节点的 compatible 属性包含 <code>arm,p1330</code>和 <code>arm,primecell</code>，根据规则 3，该节点不会被转换为 <code>platform_device</code>，而是被识别为 AMBA设备。</p>
<p><code>dmac_bus: dma-controller@ff600000</code> 节点: 该节点的 compatible 属性包含 <code>arm,p1330</code> 和<code>arm,primecell</code>，根据规则 3，该节点不会被转换为 <code>platform_device</code>，而是被识别为 AMBA 设备。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="of-platform-default-populate-init"><a href="#of-platform-default-populate-init" class="headerlink" title="of_platform_default_populate_init()"></a>of_platform_default_populate_init()</h3><p>先来看<code>of_platform_default_populate_init</code>，它使用<code>arch_initcall_sync(of_platform_default_populate_init);</code>将该函数注册到启动阶段调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/platform.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">of_platform_default_populate_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">node</span>;</span></span><br><span class="line">	<span class="comment">// 暂停设备链接供应商同步状态</span></span><br><span class="line">	device_links_supplier_sync_state_pause();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 如果设备树尚未填充，则返回错误码</span></span><br><span class="line">	<span class="keyword">if</span> (!of_have_populated_dt())</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Handle certain compatibles explicitly, since we don&#x27;t want to create</span></span><br><span class="line"><span class="comment">	 * platform_devices for every node in /reserved-memory with a</span></span><br><span class="line"><span class="comment">	 * &quot;compatible&quot;,</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	* 显式处理某些compatibles，因为我们不想为/reserved-memory 中的每个具有“compatible”的节点创建platform_device。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	for_each_matching_node(node, reserved_mem_matches)</span><br><span class="line">		of_platform_device_create(node, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">// 查找节点 &quot;/firmware&quot;</span></span><br><span class="line">	node = of_find_node_by_path(<span class="string">&quot;/firmware&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (node) &#123;</span><br><span class="line">		<span class="comment">// 使用该节点进行设备树平台设备的填充</span></span><br><span class="line">		of_platform_populate(node, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		of_node_put(node);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Populate everything else. */</span></span><br><span class="line">	of_platform_default_populate(<span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);<span class="comment">// 填充其他设备</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">arch_initcall_sync(of_platform_default_populate_init);</span><br></pre></td></tr></table></figure>

<p><code>arch_initcall_sync</code> 是 Linux 内核中的一个函数，用于在内核初始化过程中执行架构相关的初始化函数。它属于内核的初始化调用机制，用于确保在系统启动过程中适时地调用特定架构的初始化函数。</p>
<p>在 Linux 内核的初始化过程中，各个子系统和架构会注册自己的初始化函数。这些初始化函数负责完成特定子系统或架构相关的初始化工作，例如初始化硬件设备、注册中断处理程序、设置内存映射等。而 <strong><code>arch_initcall_sync</code> 函数则用于调用与当前架构相关的初始化函数</strong>。</p>
<p>当内核启动时, 调用<code>rest_init()</code> 函数来启动初始化过程 。 在初始化过程中 ，<code>arch_initcall_sync</code> 函数会被调用，以确保所有与当前架构相关的初始化函数按照正确的顺序执行。这样可以保证在启动过程中，特定架构相关的初始化工作得到正确地完成。</p>
<p>而 <strong><code>of_platform_default_populate_init</code> 函数的作用是在内核初始化过程中自动解析设备树</strong>，<strong>并根据设备树中的设备节点创建对应的 <code>platform_device</code> 结构</strong>。它会遍历设备树中的设备节点，并为每个设备节点创建一个对应的 <code>platform_device</code> 结构，然后将其注册到内核中，使得设备驱动程序能够识别和操作这些设备。</p>
<p><code>of_platform_default_populate_init</code> 函数最终调用<code>of_platform_default_populate</code>填充其他设备</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/platform.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">of_platform_default_populate</span><span class="params">(<span class="keyword">struct</span> device_node *root,</span></span><br><span class="line"><span class="params">				 <span class="type">const</span> <span class="keyword">struct</span> of_dev_auxdata *lookup,</span></span><br><span class="line"><span class="params">				 <span class="keyword">struct</span> device *parent)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> of_platform_populate(root, of_default_bus_match_table, lookup,</span><br><span class="line">				    parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数的作用是调用 <code>of_platform_populate</code> 函数来填充设备树中的平台设备，并使用默认的设备匹配表 <code>of_default_bus_match_table</code>，设备匹配表内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/platform.c</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_default_bus_match_table</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;simple-bus&quot;</span>, &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;simple-mfd&quot;</span>, &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;isa&quot;</span>, &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM_AMBA</span></span><br><span class="line">	&#123; .compatible = <span class="string">&quot;arm,amba-bus&quot;</span>, &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_ARM_AMBA */</span></span></span><br><span class="line">	&#123;&#125; <span class="comment">/* Empty terminated list */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上述的设备匹配表就是第 2 条规则：</p>
<p class='p center bold'>遍历根节点下包含 compatible 属性为 simple-bus、simple-mfd 或 isa 的节点以及它们的子节点。如果它们子节点包含 compatible 属性值则会给该子节点创建一个对应的 platform_device。</p>
<p>函数将自动根据设备树节点的属性匹配相应的设备驱动程序，并填充内核的平台设备列表。</p>
<h3 id="of-platform-populate"><a href="#of-platform-populate" class="headerlink" title="of_platform_populate()"></a>of_platform_populate()</h3><p><code>of_platform_populate</code>函数的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/platform.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * of_platform_populate() - Populate platform_devices from device tree data</span></span><br><span class="line"><span class="comment"> * @root: parent of the first level to probe or NULL for the root of the tree</span></span><br><span class="line"><span class="comment"> * @matches: match table, NULL to use the default</span></span><br><span class="line"><span class="comment"> * @lookup: auxdata table for matching id and platform_data with device nodes</span></span><br><span class="line"><span class="comment"> * @parent: parent to hook devices from, NULL for toplevel</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Similar to of_platform_bus_probe(), this function walks the device tree</span></span><br><span class="line"><span class="comment"> * and creates devices from nodes.  It differs in that it follows the modern</span></span><br><span class="line"><span class="comment"> * convention of requiring all device nodes to have a &#x27;compatible&#x27; property,</span></span><br><span class="line"><span class="comment"> * and it is suitable for creating devices which are children of the root</span></span><br><span class="line"><span class="comment"> * node (of_platform_bus_probe will only create children of the root which</span></span><br><span class="line"><span class="comment"> * are selected by the @matches argument).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * New board support should be using this function instead of</span></span><br><span class="line"><span class="comment"> * of_platform_bus_probe().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns 0 on success, &lt; 0 on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">of_platform_populate</span><span class="params">(<span class="keyword">struct</span> device_node *root,</span></span><br><span class="line"><span class="params">			<span class="type">const</span> <span class="keyword">struct</span> of_device_id *matches,</span></span><br><span class="line"><span class="params">			<span class="type">const</span> <span class="keyword">struct</span> of_dev_auxdata *lookup,</span></span><br><span class="line"><span class="params">			<span class="keyword">struct</span> device *parent)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">child</span>;</span></span><br><span class="line">	<span class="type">int</span> rc = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 如果 root 不为空，则增加 root 节点的引用计数；否则，在设备树中根据路径查找 root 节点</span></span><br><span class="line">	root = root ? of_node_get(root) : of_find_node_by_path(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!root)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">&quot;%s()\n&quot;</span>, __func__);</span><br><span class="line">	pr_debug(<span class="string">&quot; starting at: %pOF\n&quot;</span>, root);</span><br><span class="line">	<span class="comment">// 暂停设备链接供应商同步状态</span></span><br><span class="line">	device_links_supplier_sync_state_pause();</span><br><span class="line">	<span class="comment">// 遍历 root 节点的所有子节点</span></span><br><span class="line">	for_each_child_of_node(root, child) &#123;</span><br><span class="line">		<span class="comment">// 创建平台设备并添加到设备树总线</span></span><br><span class="line">		rc = of_platform_bus_create(child, matches, lookup, parent, <span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">if</span> (rc) &#123;</span><br><span class="line">			of_node_put(child);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 恢复设备链接供应商同步状态</span></span><br><span class="line">	device_links_supplier_sync_state_resume();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 设置 root 节点的 OF_POPULATED_BUS 标志</span></span><br><span class="line">	of_node_set_flag(root, OF_POPULATED_BUS);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 释放 root 节点的引用计数</span></span><br><span class="line">	of_node_put(root);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(of_platform_populate);</span><br></pre></td></tr></table></figure>
<p><code>of_platform_populate</code>通过调用<code>rc = of_platform_bus_create(child, matches, lookup, parent, true);</code>创建<code>platform_device</code>。</p>
<h3 id="of-platform-bus-create"><a href="#of-platform-bus-create" class="headerlink" title="of_platform_bus_create()"></a>of_platform_bus_create()</h3><p><code>of_platform_bus_create</code>定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/platform.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * of_platform_bus_create() - Create a device for a node and its children.</span></span><br><span class="line"><span class="comment"> * @bus: device node of the bus to instantiate</span></span><br><span class="line"><span class="comment"> * @matches: match table for bus nodes</span></span><br><span class="line"><span class="comment"> * @lookup: auxdata table for matching id and platform_data with device nodes</span></span><br><span class="line"><span class="comment"> * @parent: parent for new device, or NULL for top level.</span></span><br><span class="line"><span class="comment"> * @strict: require compatible property</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Creates a platform_device for the provided device_node, and optionally</span></span><br><span class="line"><span class="comment"> * recursively create devices for all the child nodes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">of_platform_bus_create</span><span class="params">(<span class="keyword">struct</span> device_node *bus,</span></span><br><span class="line"><span class="params">				  <span class="type">const</span> <span class="keyword">struct</span> of_device_id *matches,</span></span><br><span class="line"><span class="params">				  <span class="type">const</span> <span class="keyword">struct</span> of_dev_auxdata *lookup,</span></span><br><span class="line"><span class="params">				  <span class="keyword">struct</span> device *parent, <span class="type">bool</span> strict)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_dev_auxdata</span> *<span class="title">auxdata</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">child</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *bus_id = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">void</span> *platform_data = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">int</span> rc = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Make sure it has a compatible property */</span></span><br><span class="line">	<span class="comment">/* 确保设备节点具有 compatible 属性 */</span></span><br><span class="line">	<span class="keyword">if</span> (strict &amp;&amp; (!of_get_property(bus, <span class="string">&quot;compatible&quot;</span>, <span class="literal">NULL</span>))) &#123;</span><br><span class="line">		pr_debug(<span class="string">&quot;%s() - skipping %pOF, no compatible prop\n&quot;</span>,</span><br><span class="line">			 __func__, bus);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Skip nodes for which we don&#x27;t want to create devices */</span></span><br><span class="line">	<span class="comment">/* 跳过不想创建设备的节点 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(of_match_node(of_skipped_node_table, bus))) &#123;</span><br><span class="line">		pr_debug(<span class="string">&quot;%s() - skipping %pOF node\n&quot;</span>, __func__, bus);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (of_node_check_flag(bus, OF_POPULATED_BUS)) &#123;</span><br><span class="line">		pr_debug(<span class="string">&quot;%s() - skipping %pOF, already populated\n&quot;</span>,</span><br><span class="line">			__func__, bus);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	auxdata = of_dev_lookup(lookup, bus);</span><br><span class="line">	<span class="keyword">if</span> (auxdata) &#123;</span><br><span class="line">		bus_id = auxdata-&gt;name;</span><br><span class="line">		platform_data = auxdata-&gt;platform_data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (of_device_is_compatible(bus, <span class="string">&quot;arm,primecell&quot;</span>)) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Don&#x27;t return an error here to keep compatibility with older</span></span><br><span class="line"><span class="comment">		 * device tree files.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		* 在此处不返回错误以保持与旧设备树文件的兼容性。</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		of_amba_device_create(bus, bus_id, platform_data, parent);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dev = of_platform_device_create_pdata(bus, bus_id, platform_data, parent);</span><br><span class="line">	<span class="keyword">if</span> (!dev || !of_match_node(matches, bus))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	for_each_child_of_node(bus, child) &#123;</span><br><span class="line">		pr_debug(<span class="string">&quot;   create child: %pOF\n&quot;</span>, child);</span><br><span class="line">		rc = of_platform_bus_create(child, matches, lookup, &amp;dev-&gt;dev, strict);</span><br><span class="line">		<span class="keyword">if</span> (rc) &#123;</span><br><span class="line">			of_node_put(child);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	of_node_set_flag(bus, OF_POPULATED_BUS);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note flat"><p><code>of_platform_bus_create</code>通过调用<code>of_match_node(of_skipped_node_table, bus)</code>匹配想要跳过的节点，<code>of_skipped_node_table</code>定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_skipped_node_table</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;operating-points-v2&quot;</span>, &#125;,</span><br><span class="line">	&#123;&#125; <span class="comment">/* Empty terminated list */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>operating-points-v2</code></p>
<p>这是一个 设备树绑定（Device Tree Binding），用于描述 CPU 或设备的 工作性能状态（Operating Performance Points, OPP），例如不同频率&#x2F;电压组合。它不是硬件设备，而是一个 数据表（描述性能状态）通常作为子节点出现在 CPU、GPU 或 SoC 设备节点下。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">cpu@0</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,cortex-a53&quot;</span><span class="punctuation">;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="title class_">operating-points-v2</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;operating-points-v2&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="title class_">opp00</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">opp-hz</span> <span class="operator">=</span> <span class="keyword">/bits/</span> <span class="number">64</span> <span class="params">&lt;<span class="number">1000000000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="attr">opp-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">900000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line">        <span class="title class_">opp01</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">opp-hz</span> <span class="operator">=</span> <span class="keyword">/bits/</span> <span class="number">64</span> <span class="params">&lt;<span class="number">1500000000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="attr">opp-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1000000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure></div>

<p>随后<code>of_platform_bus_create</code>调用 <code>of_platform_device_create_pdata</code> 函数创建平台设备，并将其赋值给变量dev。然后，检查设备节点 bus 是否与给定的匹配表 <code>matches</code> 匹配。如果平台设备创建失败或者设备节点不匹配，那么返回 0。</p>
<p>最后<code>of_platform_bus_create</code>使用<code>for_each_child_of_node(bus, child)</code>, 遍历设备节点 bus 的每个子节点 child，并递归调用 <code>of_platform_bus_create</code> 函数来创建子节点的平台设备。</p>
<h3 id="of-platform-device-create-pdata"><a href="#of-platform-device-create-pdata" class="headerlink" title="of_platform_device_create_pdata()"></a>of_platform_device_create_pdata()</h3><p><code>of_platform_device_create_pdata</code>定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/platform.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * of_platform_device_create_pdata - Alloc, initialize and register an of_device</span></span><br><span class="line"><span class="comment"> * @np: pointer to node to create device for</span></span><br><span class="line"><span class="comment"> * @bus_id: name to assign device</span></span><br><span class="line"><span class="comment"> * @platform_data: pointer to populate platform_data pointer with</span></span><br><span class="line"><span class="comment"> * @parent: Linux device model parent device.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns pointer to created platform device, or NULL if a device was not</span></span><br><span class="line"><span class="comment"> * registered.  Unavailable devices will not get registered.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> platform_device *<span class="title function_">of_platform_device_create_pdata</span><span class="params">(</span></span><br><span class="line"><span class="params">					<span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params">					<span class="type">const</span> <span class="type">char</span> *bus_id,</span></span><br><span class="line"><span class="params">					<span class="type">void</span> *platform_data,</span></span><br><span class="line"><span class="params">					<span class="keyword">struct</span> device *parent)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="comment">/* 检查设备节点是否可用或已填充 */</span></span><br><span class="line">	<span class="keyword">if</span> (!of_device_is_available(np) ||</span><br><span class="line">	    of_node_test_and_set_flag(np, OF_POPULATED))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">/* 分配平台设备结构体 */</span></span><br><span class="line">	dev = of_device_alloc(np, bus_id, parent);</span><br><span class="line">	<span class="keyword">if</span> (!dev)</span><br><span class="line">		<span class="keyword">goto</span> err_clear_flag;</span><br><span class="line">	<span class="comment">/* 设置平台设备的一些属性 */</span></span><br><span class="line">	dev-&gt;dev.coherent_dma_mask = DMA_BIT_MASK(<span class="number">32</span>);</span><br><span class="line">	<span class="keyword">if</span> (!dev-&gt;dev.dma_mask)</span><br><span class="line">		dev-&gt;dev.dma_mask = &amp;dev-&gt;dev.coherent_dma_mask;</span><br><span class="line">	dev-&gt;dev.bus = &amp;platform_bus_type;</span><br><span class="line">	dev-&gt;dev.platform_data = platform_data;</span><br><span class="line">	of_msi_configure(&amp;dev-&gt;dev, dev-&gt;dev.of_node);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 将平台设备添加到设备模型中 */</span></span><br><span class="line">	<span class="keyword">if</span> (of_device_add(dev) != <span class="number">0</span>) &#123;</span><br><span class="line">		platform_device_put(dev);</span><br><span class="line">		<span class="keyword">goto</span> err_clear_flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dev;</span><br><span class="line"></span><br><span class="line">err_clear_flag:</span><br><span class="line">	of_node_clear_flag(np, OF_POPULATED);<span class="comment">/* 清除设备节点的已填充标志 */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>of_platform_device_create_pdata</code>函数调用 <code>of_device_alloc</code> 分配一个平台设备结构体，并将设备节点指针、设备标识符和父设备指针传递给它。如果分配失败，则跳转到 <code>err_clear_flag</code> 标签处进行错误处理。</p>
<p>第29 ~ 34行<code>of_platform_device_create_pdata</code>设置平台设备的一些属性：</p>
<ul>
<li>它将 <code>coherent_dma_mask</code> 属性设置为 32 位的 DMA 位掩码</li>
<li>检查 <code>dma_mask</code> 属性是否为 NULL。如果 <code>dma_mask</code> 为 NULL，则将其指向 <code>coherent_dma_mask</code>。</li>
<li>设置平台设备的总线类型为 <code>platform_bus_type</code>，并将平台数据指针存储在 <code>platform_data</code> 属性中。</li>
<li>调用 <code>of_msi_configure</code> 和 <code>of_reserved_mem_device_init_by_idx</code> 来配置设备的 MSI 和保留内存信息</li>
</ul>
<p><code>of_device_alloc</code>函数定义如下</p>
<h3 id="of-device-alloc"><a href="#of-device-alloc" class="headerlink" title="of_device_alloc()"></a>of_device_alloc()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * of_device_alloc - Allocate and initialize an of_device</span></span><br><span class="line"><span class="comment"> * @np: device node to assign to device</span></span><br><span class="line"><span class="comment"> * @bus_id: Name to assign to the device.  May be null to use default name.</span></span><br><span class="line"><span class="comment"> * @parent: Parent device.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> platform_device *<span class="title function_">of_device_alloc</span><span class="params">(<span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params">				  <span class="type">const</span> <span class="type">char</span> *bus_id,</span></span><br><span class="line"><span class="params">				  <span class="keyword">struct</span> device *parent)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="type">int</span> rc, i, num_reg = <span class="number">0</span>, num_irq;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span>, <span class="title">temp_res</span>;</span></span><br><span class="line"></span><br><span class="line">	dev = platform_device_alloc(<span class="string">&quot;&quot;</span>, PLATFORM_DEVID_NONE);</span><br><span class="line">	<span class="keyword">if</span> (!dev)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* count the io and irq resources */</span></span><br><span class="line">	<span class="keyword">while</span> (of_address_to_resource(np, num_reg, &amp;temp_res) == <span class="number">0</span>)</span><br><span class="line">		num_reg++;</span><br><span class="line">	num_irq = of_irq_count(np);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Populate the resource table */</span></span><br><span class="line">	<span class="keyword">if</span> (num_irq || num_reg) &#123;</span><br><span class="line">		res = kcalloc(num_irq + num_reg, <span class="keyword">sizeof</span>(*res), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!res) &#123;</span><br><span class="line">			platform_device_put(dev);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		dev-&gt;num_resources = num_reg + num_irq;</span><br><span class="line">		dev-&gt;resource = res;</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_reg; i++, res++) &#123;</span><br><span class="line">			rc = of_address_to_resource(np, i, res);</span><br><span class="line">			WARN_ON(rc);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (of_irq_to_resource_table(np, res, num_irq) != num_irq)</span><br><span class="line">			pr_debug(<span class="string">&quot;not all legacy IRQ resources mapped for %pOFn\n&quot;</span>,</span><br><span class="line">				 np);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dev-&gt;dev.of_node = of_node_get(np);</span><br><span class="line">	dev-&gt;dev.fwnode = &amp;np-&gt;fwnode;</span><br><span class="line">	dev-&gt;dev.parent = parent ? : &amp;platform_bus;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bus_id)</span><br><span class="line">		dev_set_name(&amp;dev-&gt;dev, <span class="string">&quot;%s&quot;</span>, bus_id);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		of_device_make_bus_id(&amp;dev-&gt;dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dev;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(of_device_alloc);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到调用了<code>platform_device_alloc(&quot;&quot;, PLATFORM_DEVID_NONE)</code>创建的<code>platform_device</code>的<code>name</code>为空</p>
<h1 id="设备树下-platform-device-和-platform-driver-匹配"><a href="#设备树下-platform-device-和-platform-driver-匹配" class="headerlink" title="设备树下 platform_device 和 platform_driver 匹配"></a>设备树下 platform_device 和 platform_driver 匹配</h1><h2 id="of-match-table"><a href="#of-match-table" class="headerlink" title="of_match_table"></a>of_match_table</h2><p>在平台总线模型中只有满足下面三个条件之一才会正确匹配并加载 probe 初始化函数：</p>
<ol>
<li><code>platform_driver.driver.of_match_table</code>与设备树中的compatible中的值匹配</li>
<li><code>platform_driver.id_table</code>与设备树中的compatible中的值匹配</li>
<li><code>platform_driver.driver.name</code>与<code>platform_device.name</code>匹配</li>
</ol>
<div class="note flat"><p>对于匹配的优先级，从下面的<code>platform_match</code>函数可以看出:</p>
<ul>
<li>优先使用设备树匹配，即<code>platform_driver.driver.of_match_table</code></li>
<li>然后是ACPI匹配</li>
<li>然后是<code>platform_driver</code>中的<code>id_table</code>匹配。</li>
<li>最后fall-back到<code>return (strcmp(pdev-&gt;name, drv-&gt;name) == 0);</code>，即匹配<code>platform_device.name</code>和<code>platform_driver.driver.name</code>，而这个name是一个历史遗留字段，设备树解析后从<code>struct device_node</code>转为<code>struct platform_device</code>时将此<code>name</code>设置为了空（<code>of_device_alloc</code>）,即通过设备树生成的<code>struct platform_device</code>不会使用这个字段。</li>
</ul>
<p>但是<code>platform_driver.driver.name</code>必须设置，否则会 kernel panic，因为<code>strcmp(pdev-&gt;name, drv-&gt;name)</code>这句代码使用<code>strcmp</code>，而<code>drv-&gt;name</code>为NULL时会报错。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/base/platform.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * platform_match - bind platform device to platform driver.</span></span><br><span class="line"><span class="comment"> * @dev: device.</span></span><br><span class="line"><span class="comment"> * @drv: driver.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Platform device IDs are assumed to be encoded like this:</span></span><br><span class="line"><span class="comment"> * &quot;&lt;name&gt;&lt;instance&gt;&quot;, where &lt;name&gt; is a short description of the type of</span></span><br><span class="line"><span class="comment"> * device, like &quot;pci&quot; or &quot;floppy&quot;, and &lt;instance&gt; is the enumerated</span></span><br><span class="line"><span class="comment"> * instance of the device, like &#x27;0&#x27; or &#x27;42&#x27;.  Driver IDs are simply</span></span><br><span class="line"><span class="comment"> * &quot;&lt;name&gt;&quot;.  So, extract the &lt;name&gt; from the platform_device structure,</span></span><br><span class="line"><span class="comment"> * and compare it against the name of the driver. Return whether they match</span></span><br><span class="line"><span class="comment"> * or not.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">platform_match</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_driver *drv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">pdev</span> =</span> to_platform_device(dev);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> *<span class="title">pdrv</span> =</span> to_platform_driver(drv);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* When driver_override is set, only bind to the matching driver */</span></span><br><span class="line">	<span class="keyword">if</span> (pdev-&gt;driver_override)</span><br><span class="line">		<span class="keyword">return</span> !<span class="built_in">strcmp</span>(pdev-&gt;driver_override, drv-&gt;name);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Attempt an OF style match first */</span></span><br><span class="line">	<span class="keyword">if</span> (of_driver_match_device(dev, drv))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Then try ACPI style match */</span></span><br><span class="line">	<span class="keyword">if</span> (acpi_driver_match_device(dev, drv))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Then try to match against the id table */</span></span><br><span class="line">	<span class="keyword">if</span> (pdrv-&gt;id_table)</span><br><span class="line">		<span class="keyword">return</span> platform_match_id(pdrv-&gt;id_table, pdev) != <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* fall-back to driver name match */</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="built_in">strcmp</span>(pdev-&gt;name, drv-&gt;name) == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而<code>of_driver_match_device</code>函数定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/of_device.h</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * of_driver_match_device - Tell if a driver&#x27;s of_match_table matches a device.</span></span><br><span class="line"><span class="comment"> * @drv: the device_driver structure to test</span></span><br><span class="line"><span class="comment"> * @dev: the device structure to match against</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">of_driver_match_device</span><span class="params">(<span class="keyword">struct</span> device *dev,</span></span><br><span class="line"><span class="params">					 <span class="type">const</span> <span class="keyword">struct</span> device_driver *drv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> of_match_device(drv-&gt;of_match_table, dev) != <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>of_driver_match_device</code>调用了<code>of_match_device</code>函数，第一个参数传入<code>drv-&gt;of_match_table</code>，该函数定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/device.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * of_match_device - Tell if a struct device matches an of_device_id list</span></span><br><span class="line"><span class="comment"> * @matches: array of of device match structures to search in</span></span><br><span class="line"><span class="comment"> * @dev: the of device structure to match against</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Used by a driver to check whether an platform_device present in the</span></span><br><span class="line"><span class="comment"> * system is in its list of supported devices.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">const</span> <span class="keyword">struct</span> of_device_id *<span class="title function_">of_match_device</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> of_device_id *matches,</span></span><br><span class="line"><span class="params">					   <span class="type">const</span> <span class="keyword">struct</span> device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> ((!matches) || (!dev-&gt;of_node))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> of_match_node(matches, dev-&gt;of_node);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(of_match_device);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>of_match_device</code>又调用了<code>of_match_node</code>函数，<code>of_match_node</code>中使用自旋锁对<code>__of_match_node</code>进行加锁，<code>__of_match_node</code>是真正的匹配函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/base.c</span></span><br><span class="line">**</span><br><span class="line"> * of_match_node - Tell <span class="keyword">if</span> a device_node has a matching of_match structure</span><br><span class="line"> *	@matches:	<span class="built_in">array</span> of of device match structures to search in</span><br><span class="line"> *	@node:		the of device structure to match against</span><br><span class="line"> *</span><br><span class="line"> *	Low level utility function used by device matching.</span><br><span class="line"> */</span><br><span class="line"><span class="type">const</span> <span class="keyword">struct</span> of_device_id *<span class="title function_">of_match_node</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> of_device_id *matches,</span></span><br><span class="line"><span class="params">					 <span class="type">const</span> <span class="keyword">struct</span> device_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">match</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">	raw_spin_lock_irqsave(&amp;devtree_lock, flags);</span><br><span class="line">	match = __of_match_node(matches, node);</span><br><span class="line">	raw_spin_unlock_irqrestore(&amp;devtree_lock, flags);</span><br><span class="line">	<span class="keyword">return</span> match;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(of_match_node);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *__<span class="title">of_match_node</span>(<span class="title">const</span> <span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">matches</span>,</span></span><br><span class="line"><span class="class">					   <span class="title">const</span> <span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">node</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">best_match</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">int</span> score, best_score = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!matches)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (; matches-&gt;name[<span class="number">0</span>] || matches-&gt;type[<span class="number">0</span>] || matches-&gt;compatible[<span class="number">0</span>]; matches++) &#123;</span><br><span class="line">		score = __of_device_is_compatible(node, matches-&gt;compatible,</span><br><span class="line">						  matches-&gt;type, matches-&gt;name);</span><br><span class="line">		<span class="keyword">if</span> (score &gt; best_score) &#123;</span><br><span class="line">			best_match = matches;</span><br><span class="line">			best_score = score;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> best_match;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>__of_match_node</code>调用<code>__of_device_is_compatible</code>匹配，传入的参数依次为：</p>
<ul>
<li><code>struct device_node *node</code></li>
<li><code>struct of_device_id *matches</code>的<code>compatible</code>，<code>type</code>，<code>name</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * __of_device_is_compatible() - Check if the node matches given constraints</span></span><br><span class="line"><span class="comment"> * @device: pointer to node</span></span><br><span class="line"><span class="comment"> * @compat: required compatible string, NULL or &quot;&quot; for any match</span></span><br><span class="line"><span class="comment"> * @type: required device_type value, NULL or &quot;&quot; for any match</span></span><br><span class="line"><span class="comment"> * @name: required node name, NULL or &quot;&quot; for any match</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Checks if the given @compat, @type and @name strings match the</span></span><br><span class="line"><span class="comment"> * properties of the given @device. A constraints can be skipped by</span></span><br><span class="line"><span class="comment"> * passing NULL or an empty string as the constraint.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns 0 for no match, and a positive integer on match. The return</span></span><br><span class="line"><span class="comment"> * value is a relative score with larger values indicating better</span></span><br><span class="line"><span class="comment"> * matches. The score is weighted for the most specific compatible value</span></span><br><span class="line"><span class="comment"> * to get the highest score. Matching type is next, followed by matching</span></span><br><span class="line"><span class="comment"> * name. Practically speaking, this results in the following priority</span></span><br><span class="line"><span class="comment"> * order for matches:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. specific compatible &amp;&amp; type &amp;&amp; name</span></span><br><span class="line"><span class="comment"> * 2. specific compatible &amp;&amp; type</span></span><br><span class="line"><span class="comment"> * 3. specific compatible &amp;&amp; name</span></span><br><span class="line"><span class="comment"> * 4. specific compatible</span></span><br><span class="line"><span class="comment"> * 5. general compatible &amp;&amp; type &amp;&amp; name</span></span><br><span class="line"><span class="comment"> * 6. general compatible &amp;&amp; type</span></span><br><span class="line"><span class="comment"> * 7. general compatible &amp;&amp; name</span></span><br><span class="line"><span class="comment"> * 8. general compatible</span></span><br><span class="line"><span class="comment"> * 9. type &amp;&amp; name</span></span><br><span class="line"><span class="comment"> * 10. type</span></span><br><span class="line"><span class="comment"> * 11. name</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __of_device_is_compatible(<span class="type">const</span> <span class="keyword">struct</span> device_node *device,</span><br><span class="line">				     <span class="type">const</span> <span class="type">char</span> *compat, <span class="type">const</span> <span class="type">char</span> *type, <span class="type">const</span> <span class="type">char</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">prop</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *cp;</span><br><span class="line">	<span class="type">int</span> index = <span class="number">0</span>, score = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Compatible match has highest priority */</span></span><br><span class="line">	<span class="keyword">if</span> (compat &amp;&amp; compat[<span class="number">0</span>]) &#123;</span><br><span class="line">		prop = __of_find_property(device, <span class="string">&quot;compatible&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">for</span> (cp = of_prop_next_string(prop, <span class="literal">NULL</span>); cp;</span><br><span class="line">		     cp = of_prop_next_string(prop, cp), index++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (of_compat_cmp(cp, compat, <span class="built_in">strlen</span>(compat)) == <span class="number">0</span>) &#123;</span><br><span class="line">				score = INT_MAX/<span class="number">2</span> - (index &lt;&lt; <span class="number">2</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!score)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Matching type is better than matching name */</span></span><br><span class="line">	<span class="keyword">if</span> (type &amp;&amp; type[<span class="number">0</span>]) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!__of_node_is_type(device, type))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		score += <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Matching name is a bit better than not */</span></span><br><span class="line">	<span class="keyword">if</span> (name &amp;&amp; name[<span class="number">0</span>]) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!of_node_name_eq(device, name))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		score++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> score;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>of_device_id</code>的<code>compatible</code>属性优先级最高，其次是<code>type</code>属性，最后是<code>name</code>属性。根据这三个属性计算分数<code>score</code>，分数越高匹配度越高。</p>
</div>

<p>而<code>platform_driver</code> 结构体嵌套的 <code>driver</code> 结构体的 <code>of_match_table</code> 属性 是一个指向 <code>const struct of_device_id</code> 结构的指针，用于描述设备树节点和驱动程序之间的匹配规则。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/mod_devicetable.h</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Struct used for matching a device</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> &#123;</span></span><br><span class="line">	<span class="type">char</span>	name[<span class="number">32</span>];</span><br><span class="line">	<span class="type">char</span>	type[<span class="number">32</span>];</span><br><span class="line">	<span class="type">char</span>	compatible[<span class="number">128</span>];</span><br><span class="line">	<span class="type">const</span> <span class="type">void</span> *data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>struct of_device_id</code> <emp>通常作为一个数组在驱动程序中定义，用于描述设备树节点和驱动程序之间的匹配规则</emp>。并且：</p>
<p class='p center bold'>数组的最后一个元素必须是一个空的结构体，以标记数组的结束</p>


<p>示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">my_driver_match</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;vendor,device-1&quot;</span> &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;vendor,device-2&quot;</span> &#125;,</span><br><span class="line">	&#123; &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h2><table>
<thead>
<tr>
<th>设备树层级</th>
<th>设备树名称</th>
<th>设备树名称</th>
</tr>
</thead>
<tbody><tr>
<td>顶层设备树</td>
<td>rk3568-evb1-ddr4-v10-linux.dts</td>
<td>rk3568-evb1-ddr4-v10-linux.dts</td>
</tr>
<tr>
<td>第二级设备树</td>
<td>rk3568-evb1-ddr4-v10.dtsi</td>
<td>rk3568-linux.dtsi</td>
</tr>
<tr>
<td>第三级设备树</td>
<td>rk3568.dtsi<br>rk3568-evb.dtsi<br>topeet_screen_choose.dtsi<br>topeet_rk3568_lcds.dtsi</td>
<td></td>
</tr>
</tbody></table>
<p><code>rk3568-evb1-ddr4-v10-linux.dts</code> 是顶层设备树</p>
<p>添加：</p>
<p><strong>rk3568-evb1-ddr4-v10-linux.dts</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: (GPL-2.0+ OR MIT)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2020 Rockchip Electronics Co., Ltd.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rk3568-evb1-ddr4-v10.dtsi&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rk3568-linux.dtsi&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dt-bindings/display/rockchip_vop.h&gt;</span></span></span><br><span class="line"><span class="title class_">/</span><span class="punctuation">&#123;</span></span><br><span class="line">    topeet<span class="punctuation">&#123;</span></span><br><span class="line">        <span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">        <span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;simple-bus&quot;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">        myLed<span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;my devicetree&quot;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0xFDD60000</span> <span class="number">0x00000004</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;vp0</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">cursor-win-id</span> <span class="operator">=</span> <span class="params">&lt;ROCKCHIP_VOP2_CLUSTER0&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;vp1</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">cursor-win-id</span> <span class="operator">=</span> <span class="params">&lt;ROCKCHIP_VOP2_CLUSTER1&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">&amp;uart7</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">status</span> <span class="operator">=</span><span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">pinctrl-name</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">		pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;uart7m1_xfer</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"><span class="variable">&amp;uart4</span> <span class="punctuation">&#123;</span></span><br><span class="line">	    <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">		pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;uart4m1_xfer</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"><span class="variable">&amp;uart9</span> <span class="punctuation">&#123;</span></span><br><span class="line">	    <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">		pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;uart9m1_xfer</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"><span class="variable">&amp;can1</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;rockchip,canfd-1.0&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">assigned-clocks</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;cru</span> CLK_CAN1&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">assigned-clock-rates</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">150000000</span>&gt;</span><span class="punctuation">;</span>  <span class="comment">//If can bitrate lower than 3M,the clock-rates should set 100M,else set 200M.</span></span><br><span class="line">        <span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">        pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;can1m1_pins</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>驱动</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mod_devicetable.h&gt;</span></span></span><br><span class="line"><span class="comment">// 平台设备的初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_probe: Probing platform device\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加设备特定的操作</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备的移除函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_remove: Removing platform device\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理设备特定的操作</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_match_table_id</span>[]  =</span> &#123;</span><br><span class="line">	&#123;.compatible=<span class="string">&quot;my devicetree&quot;</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义平台驱动结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">my_platform_driver</span> =</span> &#123;</span><br><span class="line">    .probe = my_platform_probe,</span><br><span class="line">    .remove = my_platform_remove,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;my_platform_device&quot;</span>,</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">		.of_match_table =  of_match_table_id,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">my_platform_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册平台驱动</span></span><br><span class="line">    ret = platform_driver_register(&amp;my_platform_driver);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;Failed to register platform driver\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_driver: Platform driver initialized\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">my_platform_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注销平台驱动</span></span><br><span class="line">    platform_driver_unregister(&amp;my_platform_driver);</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_platform_driver: Platform driver exited\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_platform_driver_init);</span><br><span class="line">module_exit(my_platform_driver_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>);</span><br></pre></td></tr></table></figure>

<h1 id="of操作"><a href="#of操作" class="headerlink" title="of操作"></a>of操作</h1><h2 id="获取设备树节点"><a href="#获取设备树节点" class="headerlink" title="获取设备树节点"></a>获取设备树节点</h2><h3 id="of-find-by-name"><a href="#of-find-by-name" class="headerlink" title="of_find_by_name()"></a>of_find_by_name()</h3><p><code>of_find_node_by_name</code> 是 Linux 内核中用于通过节点名称查找设备树节点的函数</p>
<table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>struct device_node *of_find_node_by_name(struct device_node *from, const char *name);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 from</strong></td>
<td>起始查找节点： <br />NULL：从设备树根节点开始查找<br /> 非 NULL：从该节点之后继续查找同名节点</td>
</tr>
<tr>
<td><strong>参数 name</strong></td>
<td>要查找的设备树节点名称（设备树节点的 node name，不是 compatible）</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>在设备树中查找名称匹配的节点，返回对应的 <code>device_node</code> 结构体指针</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>找到：返回匹配节点的 <code>struct device_node *</code>；未找到：返回 <code>NULL</code></td>
</tr>
</tbody></table>
<h3 id="of-find-node-by-path"><a href="#of-find-node-by-path" class="headerlink" title="of_find_node_by_path()"></a>of_find_node_by_path()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>struct device_node *of_find_node_by_path(const char *path);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 path</strong></td>
<td>设备树节点的绝对路径字符串，例如：<code>/soc/gpio@ff720000</code>、<code>/topeet/myLed</code></td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>根据设备树节点的<strong>绝对路径</strong>查找对应节点，返回匹配的 <code>struct device_node</code> 结构体指针</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回指向 <code>struct device_node</code> 的指针；<br />失败：返回 <code>NULL</code></td>
</tr>
</tbody></table>
<h3 id="of-get-parent"><a href="#of-get-parent" class="headerlink" title="of_get_parent()"></a>of_get_parent()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>struct device_node *of_get_parent(const struct device_node *node);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 node</strong></td>
<td>要获取父节点的设备树节点指针</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>获取指定节点的父节点，并返回其对应的 <code>device_node</code> 结构体指针</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回父节点的 <code>struct device_node</code> 指针；<br />失败或无父节点：返回 <code>NULL</code></td>
</tr>
</tbody></table>
<h3 id="of-get-next-child"><a href="#of-get-next-child" class="headerlink" title="of_get_next_child()"></a>of_get_next_child()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>struct device_node *of_get_next_child(const struct device_node *node, struct device_node *prev);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 node</strong></td>
<td>当前设备树节点指针，用于指定要遍历其子节点的父节点</td>
</tr>
<tr>
<td><strong>参数 prev</strong></td>
<td>上一个子节点的指针；如果为 <code>NULL</code>，则返回第一个子节点</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>遍历设备树节点的子节点；逐个返回指定节点的所有子节点</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回指向下一个子节点的 <code>struct device_node</code> 指针；<br />无更多子节点：返回 <code>NULL</code></td>
</tr>
</tbody></table>
<h3 id="of-find-compatible-node"><a href="#of-find-compatible-node" class="headerlink" title="of_find_compatible_node()"></a>of_find_compatible_node()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>struct device_node *of_find_compatible_node(struct device_node *from, const char *type, const char *compatible);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 from</strong></td>
<td>指定开始查找的节点；若为 <code>NULL</code>，则从设备树根节点开始搜索</td>
</tr>
<tr>
<td><strong>参数 type</strong></td>
<td>要匹配的设备类型字符串，可用于匹配节点的 <code>device_type</code> 属性；通常可设为 <code>NULL</code></td>
</tr>
<tr>
<td><strong>参数 compatible</strong></td>
<td>设备树中需要匹配的 <code>compatible</code> 属性字符串</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>在设备树中查找第一个与指定 compatible 字符串匹配的节点；返回值可用于继续查找下一个匹配节点</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回匹配节点的 <code>struct device_node*</code>；<br />失败或不存在：返回 <code>NULL</code></td>
</tr>
</tbody></table>
<h3 id="of-find-matching-node-and-match"><a href="#of-find-matching-node-and-match" class="headerlink" title="of_find_matching_node_and_match()"></a>of_find_matching_node_and_match()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>struct device_node *of_find_matching_node_and_match(struct device_node *from, const struct of_device_id *matches, const struct of_device_id **match);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 from</strong></td>
<td>指定从哪个节点开始查找: <br />传 <code>NULL</code> 表示从设备树根节点开始查找；<br /> 传上一次返回的节点可继续查找下一个匹配节点</td>
</tr>
<tr>
<td><strong>参数 matches</strong></td>
<td>指向一个 <strong><code>of_device_id[]</code> 匹配表</strong>，匹配表中包含用于匹配设备树节点 <code>compatible</code> 或 <code>type</code> 的条件</td>
</tr>
<tr>
<td><strong>参数 match</strong></td>
<td>输出参数，用于返回此次匹配到的 <strong><code>of_device_id</code> 条目指针</strong>；可以为 NULL</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>在设备树中根据 <code>matches</code> 匹配表查找符合条件的节点，同时可返回对应匹配项</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回匹配到的 <code>struct device_node *</code>；<br />失败：返回 <code>NULL</code></td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">my_match_table</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;vendor,device&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">match</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从根节点开始查找匹配的节点</span></span><br><span class="line">np = of_find_matching_node_and_match(<span class="literal">NULL</span>, my_match_table, &amp;match)</span><br></pre></td></tr></table></figure>

<p>首先定义了一个 <code>of_device_id</code> 匹配表 <code>my_match_table</code>，其中包含了一个兼容性字符串为<code>vendor,device</code>的匹配项。然后，我们使用 <code>of_find_matching_node_and_match</code> 函数从根节点开始查找匹配的节点。</p>
<h3 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h3><p>设备树：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">/</span><span class="punctuation">&#123;</span></span><br><span class="line">	test_device<span class="punctuation">&#123;</span></span><br><span class="line">                <span class="meta">#address-cells =&lt;1&gt;;</span></span><br><span class="line">                <span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">                <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;simple-bus&quot;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">                myLed<span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;my devicetree&quot;</span><span class="punctuation">;</span></span><br><span class="line">                        <span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0xFDD60000</span> <span class="number">0x00000004</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">                <span class="punctuation">&#125;;</span></span><br><span class="line">                </span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p>驱动：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">mynode_of_match</span>[] =</span> &#123; &#123; .compatible = <span class="string">&quot;my devicetree&quot;</span> &#125;, &#123;&#125; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_driver_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">mydev_node</span>;</span></span><br><span class="line">        pr_info(<span class="string">&quot;my_platform_driver_probe: Probing platform device\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过node name查找设备树接单</span></span><br><span class="line">        mydev_node = of_find_node_by_name(<span class="literal">NULL</span>, <span class="string">&quot;myLed&quot;</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_find_node_by_name]: device node is %s\n&quot;</span>, mydev_node-&gt;name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过节点路径查找设备树节点</span></span><br><span class="line">        mydev_node = of_find_node_by_path(<span class="string">&quot;/test_device/myLed&quot;</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_find_node_by_path]: device node is %s\n&quot;</span>, mydev_node-&gt;name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取父节点</span></span><br><span class="line">        mydev_node = of_get_parent(mydev_node);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_find_node_by_path]: device node is %s\n&quot;</span>, mydev_node-&gt;name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取子节点</span></span><br><span class="line">        mydev_node = of_get_next_child(mydev_node, <span class="literal">NULL</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_get_next_child]: device node is %s\n&quot;</span>, mydev_node-&gt;name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用compatible 查找节点</span></span><br><span class="line">        mydev_node = of_find_compatible_node(<span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="string">&quot;my devicetree&quot;</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_find_compatible_node]: device node is %s\n&quot;</span>, mydev_node-&gt;name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用of_device_id匹配表查找匹配的节点</span></span><br><span class="line">        mydev_node = of_find_matching_node_and_match(<span class="literal">NULL</span>, mynode_of_match, <span class="literal">NULL</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_find_matching_node_and_match]: device node is %s\n&quot;</span>, mydev_node-&gt;name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_driver_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">match_table</span>[] =</span> &#123; &#123; .compatible = <span class="string">&quot;my devicetree&quot;</span> &#125;, &#123;&#125; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">my_platform_driver</span> =</span>&#123;</span><br><span class="line">        .driver = &#123;</span><br><span class="line">                .owner = THIS_MODULE,</span><br><span class="line">                .name = <span class="string">&quot;my_platform_driver&quot;</span>,</span><br><span class="line">                .of_match_table = match_table,</span><br><span class="line">        &#125;,</span><br><span class="line">        .probe = my_platform_driver_probe,</span><br><span class="line">        .remove = my_platform_driver_remove,</span><br><span class="line">        </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">module_platform_driver(my_platform_driver);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;even629&lt;asqwgo@outlook.com&gt;&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;This is a test sample for of api&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@topeet:/root# insmod of_api_test.ko</span><br><span class="line">[ 1230.073568] my_platform_driver_probe: Probing platform device</span><br><span class="line">[ 1230.074042] [of_find_node_by_name]: device node is myLed</span><br><span class="line">[ 1230.074156] [of_find_node_by_path]: device node is myLed</span><br><span class="line">[ 1230.074163] [of_find_node_by_path]: device node is test_device</span><br><span class="line">[ 1230.074170] [of_get_next_child]: device node is myLed</span><br><span class="line">[ 1230.074461] [of_find_compatible_node]: device node is myLed</span><br><span class="line">[ 1230.074717] [of_find_matching_node_and_match]: device node is myLed</span><br></pre></td></tr></table></figure>
<h2 id="获取设备树属性"><a href="#获取设备树属性" class="headerlink" title="获取设备树属性"></a>获取设备树属性</h2><h3 id="of-find-property"><a href="#of-find-property" class="headerlink" title="of_find_property()"></a>of_find_property()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>struct property *of_find_property(const struct device_node *np, const char *name, int *lenp);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 np</strong></td>
<td>要查找属性的设备树节点（<code>struct device_node</code> 指针）</td>
</tr>
<tr>
<td><strong>参数 name</strong></td>
<td>要查找的属性名称字符串，例如 <code>compatible</code>、<code>reg</code>、<code>status</code></td>
</tr>
<tr>
<td><strong>参数 lenp</strong></td>
<td>指向 <code>int</code> 类型的指针，用于返回属性值的字节长度；<br />如果不需要获取长度，可以传入 NULL</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>在指定节点 <code>np</code> 下查找名称为 <code>name</code> 的属性，并可返回属性值长度</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回属性结构体指针 <code>struct property *</code>；</br>失败（未找到属性或参数无效）：返回 NULL</td>
</tr>
</tbody></table>
<h3 id="of-property-count-elems-of-size"><a href="#of-property-count-elems-of-size" class="headerlink" title="of_property_count_elems_of_size()"></a>of_property_count_elems_of_size()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>int of_property_count_elems_of_size(const struct device_node *np, const char *propname, int elem_size);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 np</strong></td>
<td>设备树节点指针（<code>struct device_node *</code>），表示要读取属性的节点</td>
</tr>
<tr>
<td><strong>参数 propname</strong></td>
<td>属性名称字符串，例如 <code>reg</code>、<code>gpios</code> 等</td>
</tr>
<tr>
<td><strong>参数 elem_size</strong></td>
<td>单个元素的大小（单位：字节），例如：<code>sizeof(u32)</code> → 计算属性中 32 位整数的数量</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>计算指定属性中的元素个数（按照给定的元素大小划分）</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回属性中包含的元素数量 <br />属性不存在或无内容：返回 <strong>0</strong><br /> 其他错误：返回 <strong>负数错误码</strong>（例如 <code>-EINVAL</code>）</td>
</tr>
</tbody></table>
<h3 id="of-property-read-u32-index"><a href="#of-property-read-u32-index" class="headerlink" title="of_property_read_u32_index()"></a>of_property_read_u32_index()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>int of_property_read_u32_index(const struct device_node *np, const char *propname, u32 index, u32 *out_value);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 np</strong></td>
<td>设备树节点指针（<code>struct device_node *</code>），表示要读取属性的节点</td>
</tr>
<tr>
<td><strong>参数 propname</strong></td>
<td>属性名称字符串，例如 <code>reg</code>、<code>gpios</code> 等</td>
</tr>
<tr>
<td><strong>参数 index</strong></td>
<td>属性元素的索引（从 0 开始），指定要读取第几个元素</td>
</tr>
<tr>
<td><strong>参数 out_value</strong></td>
<td>指向 <code>u32</code> 类型变量的指针，用于存储读取到的值</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>从指定属性中获取指定索引位置的 32 位无符号整数（u32）</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回 <strong>0</strong>，<code>out_value</code> 保存读取值<br />失败：返回负数错误码，(属性不存在或读取失败)</td>
</tr>
</tbody></table>
<h3 id="of-property-read-u64-index"><a href="#of-property-read-u64-index" class="headerlink" title="of_property_read_u64_index()"></a>of_property_read_u64_index()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>static inline int of_property_read_u64_index(const struct device_node *np, const char *propname, u32 index, u64 *out_value);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 np</strong></td>
<td>设备树节点指针（<code>struct device_node *</code>），表示要读取属性的节点</td>
</tr>
<tr>
<td><strong>参数 propname</strong></td>
<td>属性名称字符串，例如 <code>reg</code>、<code>gpios</code> 等</td>
</tr>
<tr>
<td><strong>参数 index</strong></td>
<td>属性元素的索引（从 0 开始），指定要读取第几个元素</td>
</tr>
<tr>
<td><strong>参数 out_value</strong></td>
<td>指向 <code>u64</code> 类型变量的指针，用于存储读取到的值</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>从指定属性中获取指定索引位置的 64 位无符号整数（u64）</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回 <strong>0</strong>，<code>out_value</code> 保存读取值<br />失败：返回负数错误码，例如属性不存在或读取失败</td>
</tr>
</tbody></table>
<h3 id="of-property-read-variable-u32-array"><a href="#of-property-read-variable-u32-array" class="headerlink" title="of_property_read_variable_u32_array()"></a>of_property_read_variable_u32_array()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>int of_property_read_variable_u32_array(const struct device_node *np, const char *propname, u32 *out_values, size_t SZ_min, size_t SZ_max);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 np</strong></td>
<td>设备树节点指针（<code>struct device_node *</code>），表示要读取属性的节点</td>
</tr>
<tr>
<td><strong>参数 propname</strong></td>
<td>属性名称字符串，例如 <code>reg</code>、<code>gpios</code> 等</td>
</tr>
<tr>
<td><strong>参数 out_values</strong></td>
<td>指向 <code>u32</code> 类型数组的指针，用于存储读取到的值</td>
</tr>
<tr>
<td><strong>参数 SZ_min</strong></td>
<td>指定数组的最小元素数量</td>
</tr>
<tr>
<td><strong>参数 SZ_max</strong></td>
<td>指定数组的最大元素数量</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>从指定属性中读取可变长度的 <code>u32</code> 数组，并存储到 <code>out_values</code></td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回实际读取到的数组元素数量<br />失败：返回负数错误码，例如属性不存在或读取失败</td>
</tr>
</tbody></table>
<ul>
<li>从指定属性中读取变长的 u8 数组</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_variable_u8_array</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np, <span class="type">const</span> <span class="type">char</span> *propname, u8 *out_values,</span></span><br><span class="line"><span class="params"><span class="type">size_t</span> SZ_min, <span class="type">size_t</span> SZ_max)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>从指定属性中读取变长的 u16 数组</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_variable_u16_array</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np, <span class="type">const</span> <span class="type">char</span> *propname, u16</span></span><br><span class="line"><span class="params">*out_values, <span class="type">size_t</span> SZ_min, <span class="type">size_t</span> SZ_max)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>从指定属性中读取变长的 u64 数组</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_variable_u64_array</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np, <span class="type">const</span> <span class="type">char</span> *propname, u64</span></span><br><span class="line"><span class="params">*out_values, <span class="type">size_t</span> SZ_min, <span class="type">size_t</span> SZ_max)</span></span><br></pre></td></tr></table></figure>

<h3 id="of-property-read-string"><a href="#of-property-read-string" class="headerlink" title="of_property_read_string()"></a>of_property_read_string()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>static inline int of_property_read_string(const struct device_node *np, const char *propname, const char **out_string);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 np</strong></td>
<td>设备树节点指针（<code>struct device_node *</code>），表示要读取属性的节点</td>
</tr>
<tr>
<td><strong>参数 propname</strong></td>
<td>属性名称字符串，例如 <code>compatible</code>、<code>status</code> 等</td>
</tr>
<tr>
<td><strong>参数 out_string</strong></td>
<td>指向字符串指针的指针，用于存储读取到的字符串</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>从指定属性中读取字符串值</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回 0<br />失败：返回负数错误码，例如属性不存在或读取失败</td>
</tr>
</tbody></table>
<h3 id="示例-4"><a href="#示例-4" class="headerlink" title="示例"></a>示例</h3><p>设备树：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">/</span><span class="punctuation">&#123;</span></span><br><span class="line">	test_device<span class="punctuation">&#123;</span></span><br><span class="line">                <span class="meta">#address-cells =&lt;1&gt;;</span></span><br><span class="line">                <span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">                <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;simple-bus&quot;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">                myLed<span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;my devicetree&quot;</span><span class="punctuation">;</span></span><br><span class="line">                        <span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0xFDD60000</span> <span class="number">0x00000004</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">                <span class="punctuation">&#125;;</span></span><br><span class="line">                </span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p>驱动：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_driver_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">mydev_node</span>;</span></span><br><span class="line">        <span class="type">int</span> i, num;</span><br><span class="line">        u32 out_value_u32;</span><br><span class="line">        u64 out_value_u64;</span><br><span class="line">        u32 out_value_u32_array[<span class="number">2</span>];</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *value_compatible;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">my_prop</span>;</span></span><br><span class="line"></span><br><span class="line">        pr_info(<span class="string">&quot;my_platform_driver_probe: Probing platform device\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过名字查找设备树节点</span></span><br><span class="line">        mydev_node = of_find_node_by_name(<span class="literal">NULL</span>, <span class="string">&quot;myLed&quot;</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_find_node_by_name]: device node is %s\n&quot;</span>, mydev_node-&gt;name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查找compatible 属性</span></span><br><span class="line">        my_prop = of_find_property(mydev_node, <span class="string">&quot;compatible&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_find_property]: property name is %s\n&quot;</span>, my_prop-&gt;name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取reg 属性的元素的数量</span></span><br><span class="line">        num = of_property_count_elems_of_size(mydev_node, <span class="string">&quot;reg&quot;</span>, <span class="keyword">sizeof</span>(u32));</span><br><span class="line">        pr_info(<span class="string">&quot;[of_property_count_elems_of_size]: reg elem size is %d\n&quot;</span>, num);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取 reg 属性的值 u32</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                of_property_read_u32_index(mydev_node, <span class="string">&quot;reg&quot;</span>, i, &amp;out_value_u32);</span><br><span class="line">                pr_info(<span class="string">&quot;[of_property_read_u32_index]: reg u32 value: 0x%X\n&quot;</span>, out_value_u32);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取 reg 属性的值 u64</span></span><br><span class="line">        of_property_read_u64_index(mydev_node, <span class="string">&quot;reg&quot;</span>, <span class="number">0</span>, &amp;out_value_u64);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_property_read_u64_index]: reg u64 value: 0x%llX\n&quot;</span>, out_value_u64);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取 reg 属性为一个数组</span></span><br><span class="line">        of_property_read_variable_u32_array(mydev_node, <span class="string">&quot;reg&quot;</span>, out_value_u32_array, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_property_read_variable_u32_array]: array[0] is 0x%X\n&quot;</span>,</span><br><span class="line">                out_value_u32_array[<span class="number">0</span>]);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_property_read_variable_u32_array]: array[1] is 0x%X\n&quot;</span>,</span><br><span class="line">                out_value_u32_array[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取 compatible 属性的字符串值</span></span><br><span class="line">        of_property_read_string(mydev_node, <span class="string">&quot;compatible&quot;</span>, &amp;value_compatible);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_property_read_string]: compatible string is %s\n&quot;</span>, value_compatible);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_driver_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_match_table</span>[] =</span> &#123; &#123; .compatible = <span class="string">&quot;my devicetree&quot;</span> &#125;, &#123;&#125; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">my_platform_driver</span>=</span>&#123;</span><br><span class="line">        .driver=&#123;</span><br><span class="line">                .owner = THIS_MODULE,</span><br><span class="line">                .name = <span class="string">&quot;my_platform_driver&quot;</span>,</span><br><span class="line">                .of_match_table = of_match_table,</span><br><span class="line">        &#125;,</span><br><span class="line">        .probe = my_platform_driver_probe,</span><br><span class="line">        .remove = my_platform_driver_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">module_platform_driver(my_platform_driver);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;even629&lt;asqwgo@outlook.com&gt;&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;this is a test sample for devicetree api: of_property&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@topeet:/root# insmod of_api_property_test.ko</span><br><span class="line">[ 1173.158496] my_platform_driver_probe: Probing platform device</span><br><span class="line">[ 1173.158912] [of_find_node_by_name]: device node is myLed</span><br><span class="line">[ 1173.158922] [of_find_property]: property name is compatible</span><br><span class="line">[ 1173.158929] [of_property_count_elems_of_size]: reg elem size is 2</span><br><span class="line">[ 1173.158935] [of_property_read_u32_index]: reg u32 value: 0xFDD60000</span><br><span class="line">[ 1173.158941] [of_property_read_u32_index]: reg u32 value: 0x4</span><br><span class="line">[ 1173.158947] [of_property_read_u64_index]: reg u64 value: 0xFDD6000000000004</span><br><span class="line">[ 1173.158954] [of_property_read_variable_u32_array]: array[0] is 0xFDD60000</span><br><span class="line">[ 1173.158958] [of_property_read_variable_u32_array]: array[1] is 0x4</span><br><span class="line">[ 1173.158964] [of_property_read_string]: compatible string is my devicetree</span><br></pre></td></tr></table></figure>

<h2 id="ranges属性"><a href="#ranges属性" class="headerlink" title="ranges属性"></a>ranges属性</h2><h3 id="platform-get-resource-获取设备树资源的前提"><a href="#platform-get-resource-获取设备树资源的前提" class="headerlink" title="platform_get_resource 获取设备树资源的前提"></a>platform_get_resource 获取设备树资源的前提</h3><p>由于设备树在系统启动的时候都会转化为 platform 设备，我们可以接在驱动中使用在平台总线中的<code>platform_get_resource</code> 函数直接获取 <code>platform_device</code> 资源</p>
<p>示例：</p>
<p>设备树：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">/</span><span class="punctuation">&#123;</span></span><br><span class="line">	test_device<span class="punctuation">&#123;</span></span><br><span class="line">                <span class="meta">#address-cells =&lt;1&gt;;</span></span><br><span class="line">                <span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">                <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;simple-bus&quot;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">                myLed<span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;my devicetree&quot;</span><span class="punctuation">;</span></span><br><span class="line">                        <span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0xFDD60000</span> <span class="number">0x00000004</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">                <span class="punctuation">&#125;;</span></span><br><span class="line">                </span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p>驱动：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mod_devicetable.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备的初始化函数</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">myresources</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">	printk(KERN_INFO <span class="string">&quot;my_platform_probe: Probing platform device\n&quot;</span>);</span><br><span class="line">	<span class="comment">// 获取平台设备的资源</span></span><br><span class="line">	myresources = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (myresources == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="comment">// 如果获取资源失败，打印 value_compatible 的值</span></span><br><span class="line">		printk(<span class="string">&quot;platform_get_resource is error\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	printk(<span class="string">&quot;reg valus is %llx\n&quot;</span>, myresources-&gt;start);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备的移除函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">	printk(KERN_INFO <span class="string">&quot;my_platform_remove: Removing platform device\n&quot;</span>);</span><br><span class="line">	<span class="comment">// 清理设备特定的操作</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_match_table_id</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;my devicetree&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义平台驱动结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">my_platform_driver</span> =</span> &#123;</span><br><span class="line">  .probe = my_platform_probe,</span><br><span class="line">  .remove = my_platform_remove,</span><br><span class="line">  .driver = &#123;</span><br><span class="line">    .name = <span class="string">&quot;my_platform_device&quot;</span>,</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .of_match_table = of_match_table_id,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">my_platform_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line">	<span class="comment">// 注册平台驱动</span></span><br><span class="line">	ret = platform_driver_register(&amp;my_platform_driver);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		printk(KERN_ERR <span class="string">&quot;Failed to register platform driver\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">	printk(KERN_INFO <span class="string">&quot;my_platform_driver: Platform driver initialized\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">my_platform_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 注销平台驱动</span></span><br><span class="line">	platform_driver_unregister(&amp;my_platform_driver);</span><br><span class="line">	printk(KERN_INFO <span class="string">&quot;my_platform_driver: Platform driver exited\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_platform_driver_init);</span><br><span class="line">module_exit(my_platform_driver_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这种方法会加载失败。原因是<code>platform_get_resource</code>返回NULL</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/base/platform.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * platform_get_resource - get a resource for a device</span></span><br><span class="line"><span class="comment"> * @dev: platform device</span></span><br><span class="line"><span class="comment"> * @type: resource type</span></span><br><span class="line"><span class="comment"> * @num: resource index</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: a pointer to the resource or NULL on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> resource *<span class="title function_">platform_get_resource</span><span class="params">(<span class="keyword">struct</span> platform_device *dev,</span></span><br><span class="line"><span class="params">				       <span class="type">unsigned</span> <span class="type">int</span> type, <span class="type">unsigned</span> <span class="type">int</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">	u32 i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dev-&gt;num_resources; i++) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">r</span> =</span> &amp;dev-&gt;resource[i];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (type == resource_type(r) &amp;&amp; num-- == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> r;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(platform_get_resource);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回 NULL 的情况有两种可能性，一种是没进入上面的 for 循环直接返回了 NULL，另外一种是进入了 for 循环，但是类型匹配不正确，跳出 for循环之后再返回 NULL。</p>
<p>这里的类型一定是匹配的，所以我们就来寻找为什么没有进入 for 循环，这里只有一种可能，也就是 <code>dev-&gt;num_resources 为 0</code>。</p>
<p>我们来看<code>of_platform_device_create_pdata</code>这个函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/platform.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * of_platform_device_create_pdata - Alloc, initialize and register an of_device</span></span><br><span class="line"><span class="comment"> * @np: pointer to node to create device for</span></span><br><span class="line"><span class="comment"> * @bus_id: name to assign device</span></span><br><span class="line"><span class="comment"> * @platform_data: pointer to populate platform_data pointer with</span></span><br><span class="line"><span class="comment"> * @parent: Linux device model parent device.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns pointer to created platform device, or NULL if a device was not</span></span><br><span class="line"><span class="comment"> * registered.  Unavailable devices will not get registered.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> platform_device *<span class="title function_">of_platform_device_create_pdata</span><span class="params">(</span></span><br><span class="line"><span class="params">					<span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params">					<span class="type">const</span> <span class="type">char</span> *bus_id,</span></span><br><span class="line"><span class="params">					<span class="type">void</span> *platform_data,</span></span><br><span class="line"><span class="params">					<span class="keyword">struct</span> device *parent)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 检查设备节点是否可用或已填充 */</span></span><br><span class="line">	<span class="keyword">if</span> (!of_device_is_available(np) ||</span><br><span class="line">	    of_node_test_and_set_flag(np, OF_POPULATED))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 分配平台设备结构体 */</span></span><br><span class="line">	dev = of_device_alloc(np, bus_id, parent);</span><br><span class="line">	<span class="keyword">if</span> (!dev)</span><br><span class="line">		<span class="keyword">goto</span> err_clear_flag;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 设置平台设备的一些属性 */</span></span><br><span class="line">	dev-&gt;dev.coherent_dma_mask = DMA_BIT_MASK(<span class="number">32</span>);</span><br><span class="line">	<span class="keyword">if</span> (!dev-&gt;dev.dma_mask)</span><br><span class="line">		dev-&gt;dev.dma_mask = &amp;dev-&gt;dev.coherent_dma_mask;</span><br><span class="line">	dev-&gt;dev.bus = &amp;platform_bus_type;</span><br><span class="line">	dev-&gt;dev.platform_data = platform_data;</span><br><span class="line">	of_msi_configure(&amp;dev-&gt;dev, dev-&gt;dev.of_node);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 将平台设备添加到设备模型中 */</span></span><br><span class="line">	<span class="keyword">if</span> (of_device_add(dev) != <span class="number">0</span>) &#123;</span><br><span class="line">		platform_device_put(dev);</span><br><span class="line">		<span class="keyword">goto</span> err_clear_flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dev;</span><br><span class="line"></span><br><span class="line">err_clear_flag:</span><br><span class="line">	<span class="comment">/* 清除设备节点的已填充标志 */</span></span><br><span class="line">	of_node_clear_flag(np, OF_POPULATED);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>函数调用 <code>of_device_alloc</code> 分配一个平台设备结构体，并将设备节点指针、设备标识符和父设备指针传递给它，正是该函数决定的 <code>resource.num</code></p>
<p><code>of_device_alloc</code>函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/platform.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * of_device_alloc - Allocate and initialize an of_device</span></span><br><span class="line"><span class="comment"> * @np: device node to assign to device</span></span><br><span class="line"><span class="comment"> * @bus_id: Name to assign to the device.  May be null to use default name.</span></span><br><span class="line"><span class="comment"> * @parent: Parent device.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> platform_device *<span class="title function_">of_device_alloc</span><span class="params">(<span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params">				  <span class="type">const</span> <span class="type">char</span> *bus_id,</span></span><br><span class="line"><span class="params">				  <span class="keyword">struct</span> device *parent)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="type">int</span> rc, i, num_reg = <span class="number">0</span>, num_irq;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span>, <span class="title">temp_res</span>;</span></span><br><span class="line"></span><br><span class="line">	dev = platform_device_alloc(<span class="string">&quot;&quot;</span>, PLATFORM_DEVID_NONE);</span><br><span class="line">	<span class="keyword">if</span> (!dev)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* count the io and irq resources */</span></span><br><span class="line">	<span class="keyword">while</span> (of_address_to_resource(np, num_reg, &amp;temp_res) == <span class="number">0</span>)</span><br><span class="line">		num_reg++;</span><br><span class="line">	num_irq = of_irq_count(np);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Populate the resource table */</span></span><br><span class="line">	<span class="keyword">if</span> (num_irq || num_reg) &#123;</span><br><span class="line">		res = kcalloc(num_irq + num_reg, <span class="keyword">sizeof</span>(*res), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!res) &#123;</span><br><span class="line">			platform_device_put(dev);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		dev-&gt;num_resources = num_reg + num_irq;</span><br><span class="line">		dev-&gt;resource = res;</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_reg; i++, res++) &#123;</span><br><span class="line">			rc = of_address_to_resource(np, i, res);</span><br><span class="line">			WARN_ON(rc);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (of_irq_to_resource_table(np, res, num_irq) != num_irq)</span><br><span class="line">			pr_debug(<span class="string">&quot;not all legacy IRQ resources mapped for %pOFn\n&quot;</span>,</span><br><span class="line">				 np);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dev-&gt;dev.of_node = of_node_get(np);</span><br><span class="line">	dev-&gt;dev.fwnode = &amp;np-&gt;fwnode;</span><br><span class="line">	dev-&gt;dev.parent = parent ? : &amp;platform_bus;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bus_id)</span><br><span class="line">		dev_set_name(&amp;dev-&gt;dev, <span class="string">&quot;%s&quot;</span>, bus_id);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		of_device_make_bus_id(&amp;dev-&gt;dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dev;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(of_device_alloc);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在第 32 行<code>dev-&gt;num_resources = num_reg + num_irq;</code> 即 reg 的 number 和 irq 的 number，由于在设备树中并没有添加中断相关的属性 <code>num_irq</code> 为 0，而 <code>num_reg</code> 由第20行通过这个函数<code>of_address_to_resource(np, num_reg, &amp;temp_res) == 0</code>循环计数获得 <code>num_rg</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* count the io and irq resources */</span></span><br><span class="line"><span class="keyword">while</span> (of_address_to_resource(np, num_reg, &amp;temp_res) == <span class="number">0</span>)</span><br><span class="line">	num_reg++;</span><br></pre></td></tr></table></figure>

<p><code>of_address_to_resource</code> 函数定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/address.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * of_address_to_resource - Translate device tree address and return as resource</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that if your address is a PIO address, the conversion will fail if</span></span><br><span class="line"><span class="comment"> * the physical address can&#x27;t be internally converted to an IO token with</span></span><br><span class="line"><span class="comment"> * pci_address_to_pio(), that is because it&#x27;s either called too early or it</span></span><br><span class="line"><span class="comment"> * can&#x27;t be matched to any host bridge IO space</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">of_address_to_resource</span><span class="params">(<span class="keyword">struct</span> device_node *dev, <span class="type">int</span> index,</span></span><br><span class="line"><span class="params">			   <span class="keyword">struct</span> resource *r)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> __be32	*addrp;</span><br><span class="line">	u64		size;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>	flags;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>	*name = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	addrp = of_get_address(dev, index, &amp;size, &amp;flags);</span><br><span class="line">	<span class="keyword">if</span> (addrp == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get optional &quot;reg-names&quot; property to add a name to a resource */</span></span><br><span class="line">	of_property_read_string_index(dev, <span class="string">&quot;reg-names&quot;</span>,	index, &amp;name);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> __of_address_to_resource(dev, addrp, size, flags, name, r);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(of_address_to_resource);</span><br></pre></td></tr></table></figure>

<p>第 18 行，获取 reg 属性的地址、大小和类型，在设备树中 reg 属性已经存在了，所以这里会正确返回。</p>
<p>第 23 行，读取 <code>reg-names</code> 属性，由于设备树中没有定义这个属性，所以该函数不会有影响。</p>
<p>最后具有决定性作用的函数就是返回的<code>__of_address_to_resource</code> 函数了，跳转到该函数的定义如下所示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/address.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __of_address_to_resource(<span class="keyword">struct</span> device_node *dev,</span><br><span class="line">		<span class="type">const</span> __be32 *addrp, u64 size, <span class="type">unsigned</span> <span class="type">int</span> flags,</span><br><span class="line">		<span class="type">const</span> <span class="type">char</span> *name, <span class="keyword">struct</span> resource *r)</span><br><span class="line">&#123;</span><br><span class="line">	u64 taddr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; IORESOURCE_MEM)</span><br><span class="line">		taddr = of_translate_address(dev, addrp);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; IORESOURCE_IO)</span><br><span class="line">		taddr = of_translate_ioport(dev, addrp, size);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (taddr == OF_BAD_ADDR)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="built_in">memset</span>(r, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> resource));</span><br><span class="line"></span><br><span class="line">	r-&gt;start = taddr;</span><br><span class="line">	r-&gt;end = taddr + size - <span class="number">1</span>;</span><br><span class="line">	r-&gt;flags = flags;</span><br><span class="line">	r-&gt;name = name ? name : dev-&gt;full_name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>reg 属性的 flags 为 <code>IORESOURCE_MEM</code>，所以又会执行第 9 行的 <code>of_translate_address</code> 函数，跳转到该函数，该函数的定义如下所示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/address.c</span></span><br><span class="line">u64 <span class="title function_">of_translate_address</span><span class="params">(<span class="keyword">struct</span> device_node *dev, <span class="type">const</span> __be32 *in_addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">host</span>;</span></span><br><span class="line">	u64 ret;</span><br><span class="line"></span><br><span class="line">	ret = __of_translate_address(dev, of_get_parent,</span><br><span class="line">				     in_addr, <span class="string">&quot;ranges&quot;</span>, &amp;host);</span><br><span class="line">	<span class="keyword">if</span> (host) &#123;</span><br><span class="line">		of_node_put(host);</span><br><span class="line">		<span class="keyword">return</span> OF_BAD_ADDR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(of_translate_address);</span><br></pre></td></tr></table></figure>

<p>该函数的重点在第 7 行，上述函数实际上是<code>__of_translate_address</code> 函数的封装，其中 <strong>传入的第三个参数<code>ranges</code></strong> 是我们要关注的重点，继续跳转到该函数的定义，具体内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/address.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Translate an address from the device-tree into a CPU physical address,</span></span><br><span class="line"><span class="comment"> * this walks up the tree and applies the various bus mappings on the</span></span><br><span class="line"><span class="comment"> * way.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note: We consider that crossing any level with #size-cells == 0 to mean</span></span><br><span class="line"><span class="comment"> * that translation is impossible (that is we are not dealing with a value</span></span><br><span class="line"><span class="comment"> * that can be mapped to a cpu physical address). This is not really specified</span></span><br><span class="line"><span class="comment"> * that way, but this is traditionally the way IBM at least do things</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Whenever the translation fails, the *host pointer will be set to the</span></span><br><span class="line"><span class="comment"> * device that had registered logical PIO mapping, and the return code is</span></span><br><span class="line"><span class="comment"> * relative to that node.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> u64 __of_translate_address(<span class="keyword">struct</span> device_node *dev,</span><br><span class="line">				  <span class="keyword">struct</span> device_node *(*get_parent)(<span class="type">const</span> <span class="keyword">struct</span> device_node *),</span><br><span class="line">				  <span class="type">const</span> __be32 *in_addr, <span class="type">const</span> <span class="type">char</span> *rprop,</span><br><span class="line">				  <span class="keyword">struct</span> device_node **host)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">parent</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">of_bus</span> *<span class="title">bus</span>, *<span class="title">pbus</span>;</span></span><br><span class="line">	__be32 addr[OF_MAX_ADDR_CELLS];</span><br><span class="line">	<span class="type">int</span> na, ns, pna, pns;</span><br><span class="line">	u64 result = OF_BAD_ADDR;</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">&quot;** translation for device %pOF **\n&quot;</span>, dev);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Increase refcount at current level */</span></span><br><span class="line">	of_node_get(dev);</span><br><span class="line"></span><br><span class="line">	*host = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">/* Get parent &amp; match bus type */</span></span><br><span class="line">	parent = get_parent(dev);</span><br><span class="line">	<span class="keyword">if</span> (parent == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> bail;</span><br><span class="line">	bus = of_match_bus(parent);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Count address cells &amp; copy address locally */</span></span><br><span class="line">	bus-&gt;count_cells(dev, &amp;na, &amp;ns);</span><br><span class="line">	<span class="keyword">if</span> (!OF_CHECK_COUNTS(na, ns)) &#123;</span><br><span class="line">		pr_debug(<span class="string">&quot;Bad cell count for %pOF\n&quot;</span>, dev);</span><br><span class="line">		<span class="keyword">goto</span> bail;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">memcpy</span>(addr, in_addr, na * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">&quot;bus is %s (na=%d, ns=%d) on %pOF\n&quot;</span>,</span><br><span class="line">	    bus-&gt;name, na, ns, parent);</span><br><span class="line">	of_dump_addr(<span class="string">&quot;translating address:&quot;</span>, addr, na);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Translate */</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">logic_pio_hwaddr</span> *<span class="title">iorange</span>;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Switch to parent bus */</span></span><br><span class="line">		of_node_put(dev);</span><br><span class="line">		dev = parent;</span><br><span class="line">		parent = get_parent(dev);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* If root, we have finished */</span></span><br><span class="line">		<span class="keyword">if</span> (parent == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			pr_debug(<span class="string">&quot;reached root node\n&quot;</span>);</span><br><span class="line">			result = of_read_number(addr, na);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * For indirectIO device which has no ranges property, get</span></span><br><span class="line"><span class="comment">		 * the address from reg directly.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		iorange = find_io_range_by_fwnode(&amp;dev-&gt;fwnode);</span><br><span class="line">		<span class="keyword">if</span> (iorange &amp;&amp; (iorange-&gt;flags != LOGIC_PIO_CPU_MMIO)) &#123;</span><br><span class="line">			result = of_read_number(addr + <span class="number">1</span>, na - <span class="number">1</span>);</span><br><span class="line">			pr_debug(<span class="string">&quot;indirectIO matched(%pOF) 0x%llx\n&quot;</span>,</span><br><span class="line">				 dev, result);</span><br><span class="line">			*host = of_node_get(dev);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Get new parent bus and counts */</span></span><br><span class="line">		pbus = of_match_bus(parent);</span><br><span class="line">		pbus-&gt;count_cells(dev, &amp;pna, &amp;pns);</span><br><span class="line">		<span class="keyword">if</span> (!OF_CHECK_COUNTS(pna, pns)) &#123;</span><br><span class="line">			pr_err(<span class="string">&quot;Bad cell count for %pOF\n&quot;</span>, dev);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		pr_debug(<span class="string">&quot;parent bus is %s (na=%d, ns=%d) on %pOF\n&quot;</span>,</span><br><span class="line">		    pbus-&gt;name, pna, pns, parent);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Apply bus translation */</span></span><br><span class="line">		<span class="keyword">if</span> (of_translate_one(dev, bus, pbus, addr, na, ns, pna, rprop))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Complete the move up one level */</span></span><br><span class="line">		na = pna;</span><br><span class="line">		ns = pns;</span><br><span class="line">		bus = pbus;</span><br><span class="line"></span><br><span class="line">		of_dump_addr(<span class="string">&quot;one level translation:&quot;</span>, addr, na);</span><br><span class="line">	&#125;</span><br><span class="line"> bail:</span><br><span class="line">	of_node_put(parent);</span><br><span class="line">	of_node_put(dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第 34 ~ 37 行，获取父节点和匹配的总线类型</p>
<p>第 40 行，获取 <code>address-cell</code> 和 <code>size-cells</code> 分别存入 int 类型的变量 na 和 ns 中</p>
<p>第 52 行是一个 for 循环，循环中在 92 行使用 <code>of_translate_one</code> 函数进行转换，其中 <code>rprop</code> 参数表示要转换的资源属性，该参数的值为传入的字符串<code>&quot;ranges&quot;</code>，然后我们继续跳转到该函数，该函数的具体内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/of/address.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">of_translate_one</span><span class="params">(<span class="keyword">struct</span> device_node *parent, <span class="keyword">struct</span> of_bus *bus,</span></span><br><span class="line"><span class="params">			    <span class="keyword">struct</span> of_bus *pbus, __be32 *addr,</span></span><br><span class="line"><span class="params">			    <span class="type">int</span> na, <span class="type">int</span> ns, <span class="type">int</span> pna, <span class="type">const</span> <span class="type">char</span> *rprop)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> __be32 *ranges;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> rlen;</span><br><span class="line">	<span class="type">int</span> rone;</span><br><span class="line">	u64 offset = OF_BAD_ADDR;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Normally, an absence of a &quot;ranges&quot; property means we are</span></span><br><span class="line"><span class="comment">	 * crossing a non-translatable boundary, and thus the addresses</span></span><br><span class="line"><span class="comment">	 * below the current cannot be converted to CPU physical ones.</span></span><br><span class="line"><span class="comment">	 * Unfortunately, while this is very clear in the spec, it&#x27;s not</span></span><br><span class="line"><span class="comment">	 * what Apple understood, and they do have things like /uni-n or</span></span><br><span class="line"><span class="comment">	 * /ht nodes with no &quot;ranges&quot; property and a lot of perfectly</span></span><br><span class="line"><span class="comment">	 * useable mapped devices below them. Thus we treat the absence of</span></span><br><span class="line"><span class="comment">	 * &quot;ranges&quot; as equivalent to an empty &quot;ranges&quot; property which means</span></span><br><span class="line"><span class="comment">	 * a 1:1 translation at that level. It&#x27;s up to the caller not to try</span></span><br><span class="line"><span class="comment">	 * to translate addresses that aren&#x27;t supposed to be translated in</span></span><br><span class="line"><span class="comment">	 * the first place. --BenH.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * As far as we know, this damage only exists on Apple machines, so</span></span><br><span class="line"><span class="comment">	 * This code is only enabled on powerpc. --gcl</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * This quirk also applies for &#x27;dma-ranges&#x27; which frequently exist in</span></span><br><span class="line"><span class="comment">	 * child nodes without &#x27;dma-ranges&#x27; in the parent nodes. --RobH</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ranges = of_get_property(parent, rprop, &amp;rlen);</span><br><span class="line">	<span class="keyword">if</span> (ranges == <span class="literal">NULL</span> &amp;&amp; !of_empty_ranges_quirk(parent) &amp;&amp;</span><br><span class="line">	    <span class="built_in">strcmp</span>(rprop, <span class="string">&quot;dma-ranges&quot;</span>)) &#123;</span><br><span class="line">		pr_debug(<span class="string">&quot;no ranges; cannot translate\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (ranges == <span class="literal">NULL</span> || rlen == <span class="number">0</span>) &#123;</span><br><span class="line">		offset = of_read_number(addr, na);</span><br><span class="line">		<span class="built_in">memset</span>(addr, <span class="number">0</span>, pna * <span class="number">4</span>);</span><br><span class="line">		pr_debug(<span class="string">&quot;empty ranges; 1:1 translation\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> finish;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">&quot;walking ranges...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now walk through the ranges */</span></span><br><span class="line">	rlen /= <span class="number">4</span>;</span><br><span class="line">	rone = na + pna + ns;</span><br><span class="line">	<span class="keyword">for</span> (; rlen &gt;= rone; rlen -= rone, ranges += rone) &#123;</span><br><span class="line">		offset = bus-&gt;<span class="built_in">map</span>(addr, ranges, na, ns, pna);</span><br><span class="line">		<span class="keyword">if</span> (offset != OF_BAD_ADDR)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (offset == OF_BAD_ADDR) &#123;</span><br><span class="line">		pr_debug(<span class="string">&quot;not found !\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">memcpy</span>(addr, ranges + na, <span class="number">4</span> * pna);</span><br><span class="line"></span><br><span class="line"> finish:</span><br><span class="line">	of_dump_addr(<span class="string">&quot;parent translation for:&quot;</span>, addr, pna);</span><br><span class="line">	pr_debug(<span class="string">&quot;with offset: %llx\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)offset);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Translate it into parent bus space */</span></span><br><span class="line">	<span class="keyword">return</span> pbus-&gt;translate(addr, offset, pna);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在该函数的第 30 行使用 <code>of_get_property</code> 函数获取<code>&quot;ranges&quot;</code>属性，但由于在我们添加的设备树节点中并没有该属性，所以这里的 ranges 值就为 NULL，第 34 行的条件判断成立，也就会返回 1。</p>
<p>接下来再根据这个返回值继续分析上级函数:</p>
<p><code>of_translate_one</code> 函数返回 1 之后，上一级的<code>_of_translate_address</code> 的返回值就为 <code>OF_BAD_ADDR</code>;</p>
<p>再上一级的 <code>of_translate_address</code> 返回值也是 <code>OF_BAD_ADDR</code>;</p>
<p>继续向上查找<code>__of_address_to_resource</code> 函数会返回 <code>-EINVAL</code>;</p>
<p><code>of_address_to_resource</code> 返回 <code>-EINVAL</code>，所以 <code>num_reg</code> 为 0;</p>
<p>到这里关于为什么 <code>platform_get_resource</code> 函数获取资源失败的问题就找到了，只是因为在其设备树中的父节点并没有这个名为 <code>ranges</code> 这个属性，所以只需添加 <code>ranges</code> 属性即可。</p>
<h3 id="ranges属性介绍"><a href="#ranges属性介绍" class="headerlink" title="ranges属性介绍"></a>ranges属性介绍</h3><p><code>ranges</code> 属性是一种<strong>用于描述设备之间地址映射关系的属性。<strong>它在设备树（Device Tree）中使用，用于</strong>描述子设备地址空间如何映射到父设备地址空间</strong>。设备树是一种硬件描述语言，用于描述嵌入式系统中的硬件组件和它们之间的连接关系。</p>
<p>设备树中的每个设备节点都可以具有 <code>ranges</code> 属性，其中包含了地址映射的信息。</p>
<p>下面是常见的格式：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ranges</span> <span class="operator">=</span> <span class="params">&lt;child-bus-address parent-bus-address length&gt;</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ranges</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>child-bus-address</strong></li>
</ul>
<p>子设备地址空间的起始地址。</p>
<p>它指定了子设备在父设备地址空间中的位置。具体的字长由 <code>ranges</code> 所在节点的 <code>#address-cells</code> 属性决定。</p>
<ul>
<li><strong>parent-bus-address</strong></li>
</ul>
<p>父设备地址空间的起始地址。</p>
<p>它指定了父设备中用于映射子设备的地址范围。具体的字长由 <code>ranges</code> 的父节点的 <code>#address-cells</code> 属性决定。</p>
<ul>
<li><strong>length</strong></li>
</ul>
<p>映射的大小。它指定了子设备地址空间在父设备地址空间中的长度。具体的字长由 <code>ranges</code> 的父节点的 <code>#size-cells</code> 属性决定。</p>
<p>当 <code>ranges</code> 属性的值为空时，表示子设备地址空间和父设备地址空间具有完全相同的映射，即 1:1 映射。这通常用于描述内存区域，其中子设备和父设备具有相同的地址范围。</p>
<p>当 <code>ranges</code> 属性的值不为空时，按照指定的映射规则将子设备地址空间映射到父设备地址空间。具体的映射规则取决于设备树的结构和设备的特定要求。</p>
<p>示例</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;acme,coyotes-revenge&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">	....</span><br><span class="line"></span><br><span class="line">	<span class="title class_">external-bus</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="meta">#address-cells = &lt;2&gt;;</span></span><br><span class="line">		<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">		<span class="attr">ranges</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0</span> <span class="number">0</span> <span class="number">0x10100000</span> <span class="number">0x10000</span></span></span><br><span class="line"><span class="params">			  <span class="number">1</span> <span class="number">0</span> <span class="number">0x10160000</span> <span class="number">0x10000</span></span></span><br><span class="line"><span class="params">		          <span class="number">2</span> <span class="number">0</span> <span class="number">0x30000000</span> <span class="number">0x30000000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Chipselect 1, Ethernet</span></span><br><span class="line">		<span class="comment">// Chipselect 2, i2c controller</span></span><br><span class="line">		<span class="comment">// Chipselect 3, NOR Flash</span></span><br><span class="line">		.......</span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line">	......</span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>external-bus</code> 节点中 <code>#address-cells</code> 属性值为 2 表示 <code>child-bus-address</code> 由两个值表示，也就是 0 和 0，父节点的 <code>#address-cells</code> 属性值和<code>#size-cells</code> 属性值为 1，表示 <code>parent-bus-address</code> 和 <code>length</code> 都由 1 个表示，也就是 <code>0x10100000</code> 和 <code>0x10000</code>，该 <code>ranges</code> 值表示将子地址空间（<code>0x0-0xFFFF</code>）映射到父地址空间 <code>0x10100000 - 0x1010FFFF</code>，这里的例子为带参数 <code>ranges</code> 属性映射，不带参数的 <code>ranges</code> 属性为 1：1 映射，较为简单，这里不再进行举例。</p>
<p>在嵌入式系统中，不同的设备可能连接到相同的总线或总线控制器上，它们需要在物理地址空间中进行正确的映射，以便进行数据交换和通信。</p>
<p>例如，一个设备可能通过总线连接到主处理器或其他设备，而这些设备的物理地址范围可能不同。ranges 属性就是用来描述这种地址映射关系的。</p>
<h3 id="设备分类"><a href="#设备分类" class="headerlink" title="设备分类"></a>设备分类</h3><h4 id="内存映射型设备"><a href="#内存映射型设备" class="headerlink" title="内存映射型设备"></a>内存映射型设备</h4><p>内存映射型设备是指<strong>可以通过内存地址进行直接访问的设备</strong>。这类设备在物理地址空间中的一部分被映射到系统的内存地址空间中，使得 CPU 可以通过读写内存地址的方式与设备进行通信和控制。</p>
<ul>
<li><strong>特点</strong>：<ul>
<li><strong>直接访问</strong>：内存映射型设备可以被 CPU 直接访问，类似于访问内存中的数据。这种直接访问方式提供了高速的数据传输和低延迟的设备操作。</li>
<li><strong>内存映射</strong>：设备的寄存器、缓冲区等资源被映射到系统的内存地址空间中，使用读写内存的方式与设备进行通信。</li>
<li><strong>读写操作</strong>：CPU 可以通过读取和写入映射的内存地址来与设备进行数据交换和控制操作。</li>
</ul>
</li>
</ul>
<p>在设备树中，内存映射型设备的设备树举例如下所示：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="attr">ranges</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">serial@101f0000</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,pl011&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x101f0000</span> <span class="number">0x1000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">gpio@101f3000</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,pl061&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x101f3000</span> <span class="number">0x1000</span></span></span><br><span class="line"><span class="params">			   <span class="number">0x101f4000</span> <span class="number">0x10</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">spi@10115000</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;arm,pl022&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x10115000</span> <span class="number">0x1000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h4 id="非内存映射型设备"><a href="#非内存映射型设备" class="headerlink" title="非内存映射型设备"></a>非内存映射型设备</h4><p>非内存映射型设备是指不能通过内存地址直接访问的设备。这类设备可能采用其他方式与CPU 进行通信，例如通过 I&#x2F;O 端口、专用总线或特定的通信协议。</p>
<ul>
<li><strong>特点</strong>：<ul>
<li><strong>非内存访问</strong>：非内存映射型设备不能像内存映射型设备那样直接通过内存地址进行访问。它们可能使用独立的 I&#x2F;O 端口或专用总线进行通信。</li>
<li><strong>特定接口</strong>：设备通常使用特定的接口和协议与 CPU 进行通信和控制，例如 SPI、I2C、UART 等。</li>
<li><strong>驱动程序</strong>：非内存映射型设备通常需要特定的设备驱动程序来实现与 CPU 的通信和控制。</li>
</ul>
</li>
</ul>
<p>在设备树中，非内存映射型设备的设备树举例如下所示：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;acme,coyotes-revenge&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">	....</span><br><span class="line">	<span class="title class_">external-bus</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="meta">#address-cells = &lt;2&gt;;</span></span><br><span class="line">		<span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">		<span class="attr">ranges</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0</span> <span class="number">0</span> <span class="number">0x10100000</span> <span class="number">0x10000</span></span></span><br><span class="line"><span class="params">			  <span class="number">1</span> <span class="number">0</span> <span class="number">0x10160000</span> <span class="number">0x10000</span></span></span><br><span class="line"><span class="params">			  <span class="number">2</span> <span class="number">0</span> <span class="number">0x30000000</span> <span class="number">0x30000000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Chipselect 1, Ethernet</span></span><br><span class="line">		<span class="comment">// Chipselect 2, i2c controller</span></span><br><span class="line">		<span class="comment">// Chipselect 3, NOR Flash</span></span><br><span class="line"></span><br><span class="line">		ethernet@<span class="number">0</span>,<span class="number">0</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;smc,smc91c111&quot;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0</span> <span class="number">0</span> <span class="number">0x1000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">		i2c@<span class="number">1</span>,<span class="number">0</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;acme,a1234-i2c-bus&quot;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">			<span class="meta">#size-cells = &lt;0&gt;;</span></span><br><span class="line">			<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1</span> <span class="number">0</span> <span class="number">0x1000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="title class_">rtc@58</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;maxim,ds1338&quot;</span><span class="punctuation">;</span></span><br><span class="line">				<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x58</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">			<span class="punctuation">&#125;;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p><strong>映射地址计算</strong></p>
<p>接下来以上面列举的非内存映射型设备的设备树中的 <code>ethernet@0</code> 节点为例，计算该网卡设备的映射地址。</p>
<p>首先，找到 <code>ethernet@0</code> 所在的节点，并查看其 reg 属性。在给定的设备树片段中，<code>ethernet@0</code> 的 reg 属性为<code>&lt;0 0 0x1000&gt;</code>。在根节点中，<code>#address-cells</code> 的值为 1，表示地址由一个单元格组成。</p>
<p>接下来，根据 <code>ranges</code> 属性进行地址映射计算。在 <code>external-bus</code> 节点的 <code>ranges</code> 属性中，有三个映射条目：</p>
<ul>
<li>第一个映射条目为<code>0 0 0x10100000 0x10000</code>，表示外部总线的地址范围为 <code>0x10100000</code> 到 <code>0x1010FFFF</code>。该映射条目的第一个值为 0，表示与 <code>external-bus</code> 节点的第一个子节点（<code>ethernet@0,0</code>）相关联。</li>
<li>第二个映射条目：<code>1 0 0x10160000 0x10000</code>，表示外部总线的地址范围为 <code>0x10160000</code> 到 <code>0x1016FFFF</code>。该映射条目的第一个值为 1，表示与 <code>external-bus</code> 节点的第二个子节点（<code>i2c@1,0</code>）相关联。</li>
<li>第三个映射条目：<code>2 0 0x30000000 0x30000000</code>，表示外部总线的地址范围为 <code>0x30000000</code> 到 <code>0x5FFFFFFF</code>。该映射条目的第一个值为 2，表示与 <code>external-bus</code> 节点的第三个子节点相关联。</li>
</ul>
<p>由于<code>ethernet@0</code>与<code>external-bus</code>的第一个子节点相关联，并且它的reg属性为<code>&lt;0 0 0x1000&gt;</code>，我们可以进行以下计算：</p>
<p><code>ethernet@0</code> 的物理起始地址 &#x3D; 外部总线地址起始值 &#x3D; 0x10100000</p>
<p><code>ethernet@0</code> 的物理结束地址 &#x3D; 外部总线地址起始值 + （<code>ethernet@0</code> 的 reg 属性的第二个值-1）&#x3D; $$ 0x10100000 + 0xFFF &#x3D; 0x10100FFF $$</p>
<p>因此，<code>ethernet@0</code> 的物理地址范围为 <code>0x10100000 - 0x10100FFF</code>，</p>
<h2 id="获取中断资源"><a href="#获取中断资源" class="headerlink" title="获取中断资源"></a>获取中断资源</h2><h3 id="irq-of-parse-and-map"><a href="#irq-of-parse-and-map" class="headerlink" title="irq_of_parse_and_map()"></a>irq_of_parse_and_map()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>unsigned int irq_of_parse_and_map(struct device_node *dev, int index);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of_irq.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 dev</strong></td>
<td>设备树节点指针（<code>struct device_node *</code>），表示要解析中断号的设备节点</td>
</tr>
<tr>
<td><strong>参数 index</strong></td>
<td>索引号，表示从设备节点的 <code>interrupts</code> 属性中获取第几个中断号</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>从设备节点的 <code>interrupts</code> 属性中解析和映射对应的中断号</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回无符号整数表示解析和映射的中断号<br />失败：通常返回 0 或无效中断号（具体错误处理依赖平台实现）</td>
</tr>
</tbody></table>
<h3 id="irqd-get-trigger-type"><a href="#irqd-get-trigger-type" class="headerlink" title="irqd_get_trigger_type()"></a>irqd_get_trigger_type()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>u32 irqd_get_trigger_type(struct irq_data *d);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/irq.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 d</strong></td>
<td>指向中断数据结构（<code>struct irq_data *</code>），表示要获取触发类型的中断</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>从中断数据结构中获取对应中断的触发类型</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回一个无符号 32 位整数，表示中断触发类型（如电平触发或边沿触发）不会失败，因为总是返回一个有效的触发类型定义宏</td>
</tr>
</tbody></table>
<h3 id="irq-get-irq-data"><a href="#irq-get-irq-data" class="headerlink" title="irq_get_irq_data()"></a>irq_get_irq_data()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>struct irq_data *irq_get_irq_data(unsigned int irq);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/irq.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 irq</strong></td>
<td>中断号，表示要获取中断数据结构的中断号</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>根据中断号获取对应的中断数据结构</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回指向 <code>struct irq_data</code> 的指针；<br />失败：返回 NULL</td>
</tr>
</tbody></table>
<h3 id="gpio-to-irq"><a href="#gpio-to-irq" class="headerlink" title="gpio_to_irq()"></a>gpio_to_irq()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>int gpio_to_irq(unsigned int gpio);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/gpio.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 gpio</strong></td>
<td>GPIO 编号，表示要获取中断号的 GPIO</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>根据 GPIO 编号获取对应的中断号</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回对应的中断号（整数）；<br />失败：返回负数错误码</td>
</tr>
</tbody></table>
<h3 id="of-irq-get"><a href="#of-irq-get" class="headerlink" title="of_irq_get()"></a>of_irq_get()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>int of_irq_get(struct device_node *dev, int index);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/of_irq.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 dev</strong></td>
<td>设备节点，表示要获取中断号的设备节点</td>
</tr>
<tr>
<td><strong>参数 index</strong></td>
<td>索引号，表示从 <code>interrupts</code> 属性中获取第几个中断号</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>从设备节点的 <code>interrupts</code> 属性中获取对应的中断号</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回对应的中断号（整数）；<br />失败：返回负数错误码</td>
</tr>
</tbody></table>
<h3 id="platform-get-irq"><a href="#platform-get-irq" class="headerlink" title="platform_get_irq()"></a>platform_get_irq()</h3><table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>函数定义</strong></td>
<td><strong>int platform_get_irq(struct platform_device *dev, unsigned int num);</strong></td>
</tr>
<tr>
<td><strong>头文件</strong></td>
<td><code>#include &lt;linux/platform_device.h&gt;</code></td>
</tr>
<tr>
<td><strong>参数 dev</strong></td>
<td>平台设备，表示要获取中断号的平台设备</td>
</tr>
<tr>
<td><strong>参数 num</strong></td>
<td>索引号，表示从设备中获取第几个中断号</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>根据平台设备和索引号获取对应的中断号</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>成功：返回对应的中断号（整数）；<br />失败：返回负数错误码</td>
</tr>
</tbody></table>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: (GPL-2.0+ OR MIT)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2020 Rockchip Electronics Co., Ltd.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rk3568-evb1-ddr4-v10.dtsi&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rk3568-linux.dtsi&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dt-bindings/display/rockchip_vop.h&gt;</span></span></span><br><span class="line"><span class="title class_">/</span><span class="punctuation">&#123;</span></span><br><span class="line">        test_device<span class="punctuation">&#123;</span></span><br><span class="line">                <span class="meta">#address-cells =&lt;1&gt;;</span></span><br><span class="line">                <span class="meta">#size-cells = &lt;1&gt;;</span></span><br><span class="line">                <span class="attr">ranges</span><span class="punctuation">;</span></span><br><span class="line">                <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;simple-bus&quot;</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">                myLed<span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;my devicetree&quot;</span><span class="punctuation">;</span></span><br><span class="line">                        <span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0xFDD60000</span> <span class="number">0x00000004</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">                <span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">                myirq<span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;my irq&quot;</span><span class="punctuation">;</span></span><br><span class="line">                        <span class="attr">interrupt-parent</span><span class="operator">=</span><span class="params">&lt;<span class="variable">&amp;gpio3</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">                        <span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;RK_PA5 IRQ_TYPE_LEVEL_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">                <span class="punctuation">&#125;;</span></span><br><span class="line">                </span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>驱动代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_irq.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_driver_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;        </span><br><span class="line">        <span class="type">int</span> irq;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">irq_data</span> *<span class="title">my_irq_data</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">mydev_node</span>;</span></span><br><span class="line">        u32 trigger_type;</span><br><span class="line">        pr_info(<span class="string">&quot;my_platform_probe: Probing platform device\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取设备节点</span></span><br><span class="line">        mydev_node = pdev-&gt;dev.of_node;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析和映射中断</span></span><br><span class="line">        irq = irq_of_parse_and_map(mydev_node, <span class="number">0</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[irq_of_parse_and_map]: irq is %d\n&quot;</span>, irq);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取中断数据结构</span></span><br><span class="line">        my_irq_data = irq_get_irq_data(irq);</span><br><span class="line">        <span class="comment">// 获取中断出发类型</span></span><br><span class="line">        trigger_type = irqd_get_trigger_type(my_irq_data);</span><br><span class="line">        pr_info(<span class="string">&quot;[irqd_get_trigger_type]: trigger_type is %d\n&quot;</span>, trigger_type);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 gpio转为中断号</span></span><br><span class="line">        irq = gpio_to_irq(<span class="number">101</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[gpio_to_irq]: irq is %d\n&quot;</span>, irq);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从设备节点获取中断号</span></span><br><span class="line">        irq = of_irq_get(mydev_node, <span class="number">0</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[of_irq_get]: irq is %d\n&quot;</span>, irq);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取平台设备的中断号</span></span><br><span class="line">        irq = platform_get_irq(pdev, <span class="number">0</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;[platform_get_irq]: irq is %d\n&quot;</span>, irq);</span><br><span class="line">               </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_platform_driver_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_match_table</span>[] =</span> &#123; &#123; .compatible = <span class="string">&quot;my irq&quot;</span> &#125;, &#123;&#125; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">my_platform_drv</span> =</span> &#123;</span><br><span class="line">        .driver = &#123;</span><br><span class="line">                .owner = THIS_MODULE,</span><br><span class="line">                .name = <span class="string">&quot;my platform driver&quot;</span>,</span><br><span class="line">                .of_match_table = of_match_table,</span><br><span class="line">        &#125;,</span><br><span class="line">        .probe = my_platform_driver_probe,</span><br><span class="line">        .remove = my_platform_driver_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">module_platform_driver(my_platform_drv);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;even629&lt;asqwgo@outlook.com&gt;&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;This is a test sample for platform irq&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@topeet:/root# insmod of_api_irq_test.ko</span><br><span class="line">[ 7138.032958] of_api_irq_test: loading out-of-tree module taints kernel.</span><br><span class="line">[ 7138.033958] my_platform_probe: Probing platform device</span><br><span class="line">[ 7138.033994] [irq_of_parse_and_map]: irq is 94</span><br><span class="line">[ 7138.034002] [irqd_get_trigger_type]: trigger_type is 8</span><br><span class="line">[ 7138.034013] [gpio_to_irq]: irq is 94</span><br><span class="line">[ 7138.034025] [of_irq_get]: irq is 94</span><br><span class="line">[ 7138.034037] [platform_get_irq]: irq is 94</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="参考文档：dts-bindings"><a href="#参考文档：dts-bindings" class="headerlink" title="参考文档：dts-bindings"></a>参考文档：dts-bindings</h1><p><code>Documentation/devicetree/bindings</code> 目录是 Linux 内核源码中的一个重要目录，用于存储设备树（Device Tree）的 bindings 文档。设备树是一种描述硬件平台和设备配置的数据结构，它以一种可移植和独立于具体硬件的方式描述了设备的属性、寄存器配置、中断信息等。</p>
<p>bindings 目录中的文档提供了有关设备树的各种设备和驱动程序的详细说明和用法示例。这些文档对于开发人员来说非常重要，因为它们提供了在设备树中描述硬件和配置驱动程序所需的属性和约定。</p>
<p><code>Documentation/devicetree/bindings</code> 目录的一些常见子目录和其内容的概述：</p>
<ul>
<li><code>arm</code>：包含与 ARM 体系结构相关的设备和驱动程序的 bindings 文档。</li>
<li><code>clock</code>：包含与时钟设备和时钟控制器相关的 bindings 文档。</li>
<li><code>dma</code>：包含与直接内存访问（DMA）控制器和设备相关的 bindings 文档。</li>
<li><code>gpio</code>：包含与通用输入输出（GPIO）控制器和设备相关的 bindings 文档。</li>
<li><code>i2c</code>：包含与 I2C 总线和设备相关的 bindings 文档。</li>
<li><code>interrupt-controller</code>：包含与中断控制器相关的 bindings 文档。</li>
<li><code>media</code>：包含与多媒体设备和驱动程序相关的 bindings 文档。</li>
<li><code>mfd</code>：包含与多功能设备（MFD）子系统和设备相关的 bindings 文档。</li>
<li><code>networking</code>：包含与网络设备和驱动程序相关的 bindings 文档。</li>
<li><code>power</code>：包含与电源管理子系统和设备相关的 bindings 文档。</li>
<li><code>spi</code>：包含与 SPI 总线和设备相关的 bindings 文档。</li>
<li><code>usb</code>：包含与 USB 控制器和设备相关的 bindings 文档。</li>
<li><code>video</code>：包含与视频设备和驱动程序相关的 bindings 文档。</li>
</ul>
<p>每个子目录中的文档通常以<code>.txt</code> 或<code>.yaml</code> 的扩展名保存，使用文本或 YAML 格式编写。这些文档提供了有关设备树中属性的详细说明、属性的语法、可选值和用法示例。它们还描述了设备树的约定和最佳实践，以帮助开发人员正确地配置和描述硬件设备和驱动程序。</p>
<p>yaml格式是遵循<code>json-schema</code>编写的Devicetree绑定，参考:</p>
<div class="tag link"><a class="link-card" title="使用 json-schema 编写 Devicetree 绑定" target="_blank" rel="noopener" href="https://docs.linuxkernel.org.cn/devicetree/bindings/writing-schema.html"><div class="left"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://docs.linuxkernel.org.cn/_static/logo.svg"/></div><div class="right"><p class="text">使用 json-schema 编写 Devicetree 绑定</p><p class="url">https://docs.linuxkernel.org.cn/devicetree/bindings/writing-schema.html</p></div></a></div>

<h1 id="设备树插件"><a href="#设备树插件" class="headerlink" title="设备树插件"></a>设备树插件</h1><p>Linux4.4 以后引入了动态设备树（Dynamic DeviceTree）。设备树插件（Device Tree Overlay）是一种用于设备树（Device Tree）的扩展机制。设备树是一种用于描述硬件设备的数据结构，广泛应用于嵌入式系统中，特别是基于 Linux 内核的系统中。</p>
<p>设备树插件<strong>允许在运行时动态修改设备树的内容，以便添加，修改或删除设备节点和属性</strong>。它提供了一种灵活的方式来配置和管理硬件设备，而无需重新编译整个设备树。通过使用设备树插件，开发人员可以在不重新启动系统的情况下对硬件进行配置更改。</p>
<p>设备树插件（Dynamic DeviceTree）通常以一种文本格式定义，称为设备树源文件（DeviceTree Source, DTS）。DTS 文件描述了设备树的结构和属性，包括设备节点，寄存器地址，中断信息等。设备树插件可以通过加载和解析设备树文件，并将其合并到现有的设备树中，从而实现对设备树的动态修改。</p>
<p><strong>应用场景</strong></p>
<p>使用设备树插件，可以实现一些常见的配置变化，比如添加外部设备，禁用不需要的设备，修改设备属性等。这对于嵌入式系统的开发和调试非常有用，特别是面对多种硬件配置或需要频繁更改硬件配置的情况下</p>
<h2 id="设备树插件语法"><a href="#设备树插件语法" class="headerlink" title="设备树插件语法"></a>设备树插件语法</h2><p><strong>overlay.dts</strong></p>
<ul>
<li>头部声明</li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span></span><br><span class="line"><span class="keyword">/plugin/</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>插件节点名称用于定义要添加，修改或删除的设备节点及其属性。它使用与设备树源文件相同的语法，但在节点名称前面使用特定的修饰符来指示插件的操作</li>
</ul>
<p>比如下面这个节点：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//arch/arm64/boot/dts/rockchip/topeet-rk3568-linux.dts</span></span><br><span class="line">		<span class="comment">//485 使能引脚</span></span><br><span class="line"><span class="symbol">        rk_485_ctl:</span> <span class="title class_">rk-485-ctl</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;topeet,rs485_ctl&quot;</span><span class="punctuation">;</span></span><br><span class="line">                <span class="attr">gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio0</span> RK_PC6 GPIO_ACTIVE_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">                <span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">                pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;rk_485_gpio</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>如果在设备树插件中要为这个节点添加 <code>overlay_node</code> 节点:</p>
<p>有以下几种表达方式：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">/dts-v1/</span><span class="punctuation">;</span></span><br><span class="line"><span class="keyword">/plugin/</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法1</span></span><br><span class="line">&amp;<span class="punctuation">&#123;</span>/rk<span class="number">-485</span>-ctl<span class="punctuation">&#125;</span><span class="punctuation">&#123;</span></span><br><span class="line">	overlay_node<span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法2</span></span><br><span class="line"><span class="variable">&amp;rk_485_ctl</span><span class="punctuation">&#123;</span></span><br><span class="line">	overlay_node<span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法3</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">/</span><span class="punctuation">&#123;</span></span><br><span class="line">    fragment@<span class="number">0</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">target-path</span><span class="operator">=</span><span class="string">&quot;/rk-485-ctl&quot;</span><span class="punctuation">;</span></span><br><span class="line">        __overlay__<span class="punctuation">&#123;</span></span><br><span class="line">            overlay_node<span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="punctuation">&#125;;</span></span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line">    fragment@<span class="number">1</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">target</span><span class="operator">=</span><span class="params">&lt;<span class="variable">&amp;rk_485_ctl</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        __overlay__<span class="punctuation">&#123;</span></span><br><span class="line">            overlay_node<span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="punctuation">&#125;;</span></span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>设备树插件的编译和设备树编译一样的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dtc -I dts -O dtb overlay.dts -o overlay.dtbo</span><br></pre></td></tr></table></figure>

<h2 id="移植设备树驱动插件"><a href="#移植设备树驱动插件" class="headerlink" title="移植设备树驱动插件"></a>移植设备树驱动插件</h2><p>我们将探讨如何移植设备树插件到 iTOP-RK3568 开发板上。移植设备树插件主要包括以下几个步骤</p>
<ul>
<li>配置内核支持挂载 configfs 虚拟文件系统。</li>
<li>配置内核支持设备树插件</li>
<li>移植设备树插件驱动</li>
</ul>
<p><strong>配置内核支持挂载 configfs 虚拟文件系统</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm64 menuconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># File System-&gt;Pseudo filesystems -&gt;UserSpace-driven configuration filesystem</span></span><br></pre></td></tr></table></figure>

<p>启动用后检查内核是否挂载了虚拟文件系统，如果没有运行下面命令挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mount -t configfs none /sys/kernel/config</span><br></pre></td></tr></table></figure>

<p><strong>配置内核支持设备树插件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm64 menuconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># Device Driver -&gt; Device Tree and Open Firmware support -&gt; Device Tree overlays</span></span><br><span class="line"><span class="comment"># File System -&gt; Overlay filesystem support</span></span><br></pre></td></tr></table></figure>

<p>保存配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> .config <span class="built_in">arch</span>/arm64/configs/rockchip_linux_defconfig</span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line">./build.sh kernel</span><br></pre></td></tr></table></figure>

<p><strong>移植设备树插件驱动</strong></p>
<p>github上已有编写好的<a target="_blank" rel="noopener" href="https://github.com/ikwzm/dtbocfg/">设备树插件驱动</a>，我们只要将此驱动编译成驱动模块或者编译进内核即可</p>
<p align="center"><a class="ghcard" rel="external nofollow noopener noreferrer noopener" target="_blank" href="https://github.com/ikwzm/dtbocfg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://github-readme-stats.vercel.app/api/pin/?username=ikwzm&repo=dtbocfg&show_owner=true"/></a></p>

<h2 id="加载设备树插件"><a href="#加载设备树插件" class="headerlink" title="加载设备树插件"></a>加载设备树插件</h2><p>加载设备树插件(首先要有设备树插件驱动，通过<code>cat proc/filesystems</code> 检查 configfs 是否挂载成功)</p>
<p>进入系统目录<code>/sys/kernel/config/device-tree/overlays/</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /sys/kernel/config/device-tree/overlays/</span><br><span class="line"><span class="comment"># 创建一个内核对象</span></span><br><span class="line">$ <span class="built_in">mkdir</span> <span class="built_in">test</span></span><br><span class="line">$ <span class="built_in">cd</span> <span class="built_in">test</span></span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">dtbo status</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> overlay.dtb &gt; dtbo</span><br><span class="line"><span class="comment"># 使能 dtbo</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; status</span><br><span class="line"><span class="comment"># 此时我们可以使用以下命令看到加载的节点</span></span><br><span class="line">$ <span class="built_in">ls</span> /proc/device-tree/rk-485-ctl/overlay_node/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果我们想删掉使用 dtbo 修改的节点，删除创建的内核对象test即可</span></span><br><span class="line">$ <span class="built_in">cd</span> /sys/kernel/config/device-tree/overlays/</span><br><span class="line">$ <span class="built_in">rmdir</span> <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>可以创建多个</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /sys/kernel/config/device-tree/overlays/</span><br><span class="line"><span class="comment"># 创建一个内核对象</span></span><br><span class="line">$ <span class="built_in">mkdir</span> test1</span><br><span class="line"><span class="comment"># 用另一个设备树覆盖</span></span><br></pre></td></tr></table></figure>

<p>删除时会恢复到test加载后的设备树</p>
<h2 id="改变集"><a href="#改变集" class="headerlink" title="改变集"></a>改变集</h2><p>设备树插件（dtbo）里面的节点也要被转换成 <code>device_node</code>，有的 <code>device_node</code> 也要被转换成 <code>platform_device</code>。不过在进行转换之前，<code>of_overlay_fdt_apply</code> 函数会先创建一个<strong>改变集</strong>。然后根据这个改变集去进行修改。</p>
<p>创建改变集的目的是为了方便对设备树进行修改和复原。设备树是一种静态的数据结构，一旦被编译和加载到内核中，就难以直接修改。为了解决这个问题，设备树覆盖功能引入了改变集的概念。</p>
<p><strong>改变集是一个描述设备树变化的数据结构，它记录了对设备树的修改操作，如添加、删除或修改节点。通过创建改变集，我们可以在运行时对设备树进行动态修改，而无需修改原始的设备树源文件</strong>。</p>
<p>通过创建改变集，我们可以方便地定义需要进行的修改操作，而不必直接操作设备树的底层结构。这提供了一种高层次的抽象，使我们能够以更简洁和可读的方式描述设备树的变化。</p>
<p>同时，改变集也可以被保存、传递和应用到其他设备树上，方便在不同系统或环境中进行设备树的配置和定制。</p>
<p>此外，改变集还可以用于设备树的复原。在某些情况下，我们可能需要在运行时撤销对设备树的修改并恢复到原始状态。通过应用反向的改变集，我们可以还原设备树，使其回到修改之前的状态，实现修改的复原。</p>
<p>因此，创建改变集提供了一种方便、可控和可复原的方式来修改设备树，使设备树的管理和配置更加灵活和可靠。</p>
<h2 id="虚拟文件系统ConfigFS介绍"><a href="#虚拟文件系统ConfigFS介绍" class="headerlink" title="虚拟文件系统ConfigFS介绍"></a>虚拟文件系统ConfigFS介绍</h2><p>在 Linux 内核中，有几个常用的虚拟文件系统，虚拟文件系统提供了一个内核抽象层，使得应用程序可以通过统一的文件访问接口操作不同类型的文件和设备。它简化了应用程序的开发和维护，提供了更高的可移植性和灵活性，并提供了管理文件系统和访问底层硬件的功能。</p>
<ul>
<li><strong>procfs</strong></li>
</ul>
<p>虚拟文件系统，<strong>提供了对系统内核运行时状态的访问接口</strong>。它以文件和目录的形式表示内核中的进程，设备，驱动程序和其他系统信息。通过读取和写入 procfs 中的文件，可以获取和修改有关系统状态的信息。</p>
<ul>
<li><strong>sysfs</strong></li>
</ul>
<p>虚拟文件系统，<strong>用于表示系统中的设备，驱动程序和其他内核对象</strong>。它提供一种统一的接口，通过文件和目录来访问和配置这些对象的属性和状态。Sysfs 常用于设备驱动程序和系统管理工具，用于查看和控制系统的硬件和内核对象。</p>
<ul>
<li><strong>configfs</strong></li>
</ul>
<p>虚拟文件系统，<strong>用于动态配置和管理内核对象</strong>。它提供了一种以文件和目录的形式访问内核对象的接口，允许用户在运行时添加，修改和删除内核对象，而无需重新编译内核或重新启动系统。ConfigFS 常用于配置和管理设备，驱动程序和子系统</p>
<blockquote>
<p>这些虚拟文件系统在功能上有一些区别：</p>
<ul>
<li>Procfs 主要用于访问和管理进程信息，提供了有关进程，内核参数和系统状态的信息。</li>
<li>Sysfs 主要用于表示和配置系统中的设备，驱动程序和其他内核对象，提供了一种统一的接口来访问和控制这些对象的属性和状态。</li>
<li>Configfs 主要用于动态配置和管理内核对象，提供了一种以文件和目录的形式访问内核对象的接口，允许在运行时添加，修改和删除内核对象。</li>
</ul>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251203210651392.png" alt="linu启动对设备树的处理" loading="lazy"></p>
<p>要实现上述的功能，用户空间需要和内核进行交互，也就是将 dtbo 加载到内存里面去。sysfs 虚拟文件系统的作用是将内核中的数据、属性以文件的方式导出到用户空间。导出到用户空间以后，读这些文件表示读取设备的文件，写这些文件就表示控制设备。</p>
<p>configfs 作用的英文解释为 <strong>Userspace-driven kernel object configuration</strong>，翻译过来就是用户空间配置内核对象。</p>
<p>所以 configfs 与 sysfs 恰恰相反，sysfs 导出内核对象给用户空间，configfs 是从用户空间去配置内核对象，并且不需要重新编译内核或者修改内核代码。所以 configfs 更适合设备树插件这个技术。</p>
<h2 id="ConfigFS核心数据结构"><a href="#ConfigFS核心数据结构" class="headerlink" title="ConfigFS核心数据结构"></a>ConfigFS核心数据结构</h2><p>ConfigFS 的核心数据结构主要包括以下几个部分：</p>
<p><strong>configfs_subsystem</strong></p>
<p>configfs_subsystem 是一个顶层的数据结构，用于表示整个 ConfigFS 子系统。它包含了根配置项组的指针，以及 ConfigFS 的其他属性和状态信息。</p>
<p><strong>config_group</strong></p>
<p>config_group 是一种特殊类型的配置项，表示一个配置项组。它可以包含一组相关的配置项，形成一个层次结构。config_group 结构包含了父配置项的指针，以及指向子配置项的链表。</p>
<p><strong>config_item</strong></p>
<p>这是 ConfigFS 中最基本的数据结构，用于表示一个配置项。每个配置项都是一个内核对象，可以是设备、驱动程序、子系统等。config_item 结构包含了配置项的类型、名称、属性、状态等信息，以及指向父配置项和子配置项的指针。</p>
<p>这些数据结构之间的关系可以形成一个树形结构，其中 configfs_subsystem 是根节点，config_group 表示配置项组，config_item 表示单个配置项。子配置项通过链表连接在一起，形成父子关系。</p>
<p><strong>configfs_subsystem</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> <span class="title">su_group</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">su_mutex</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>configfs_subsystem 结构体中包含 config_group 结构体，config_group 结构体如下所示：</p>
<p><strong>config_group</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> <span class="title">cg_item</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">cg_children</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> *<span class="title">cg_subsys</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">default_groups</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">group_entry</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>config_group 结构体中包含 config_item 结构体，config_item结构体如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> &#123;</span></span><br><span class="line">	<span class="type">char</span> *ci_name;</span><br><span class="line">	<span class="type">char</span> ci_namebuf[CONFIGFS_ITEM_NAME_LEN]; <span class="comment">//目录的名字</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">ci_kref</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">ci_entry</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> *<span class="title">ci_parent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> *<span class="title">ci_group</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> *<span class="title">ci_type</span>;</span> <span class="comment">//目录下属性文件和属性操作</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">ci_dentry</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接下来我们来分析设备树插件驱动代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">dtbocfg_root_subsys</span> =</span> &#123;</span><br><span class="line">    .su_group = &#123;</span><br><span class="line">        .cg_item = &#123;</span><br><span class="line">            .ci_namebuf = <span class="string">&quot;device-tree&quot;</span>,</span><br><span class="line">            .ci_type   = &amp;dtbocfg_root_type,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    .su_mutex = __MUTEX_INITIALIZER(dtbocfg_root_subsys.su_mutex),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这段代码定义了一个名为 dtbocfg_root_subsys 的 configfs_subsystem 结构体实例，表示ConfigFS 中的一个子系统。</p>
<p>首先，<code>dtbocfg_root_subsys.su_group</code> 是一个 config_group 结构体，它表示子系统的根配置项组。在这里，该结构体的.cg_item 字段表示根配置项组的基本配置项。</p>
<p><code>.ci_namebuf = &quot;device-tree&quot;</code>：配置项的名称设置为”device-tree”，表示该配置项的名称为”device-tree”。</p>
<p><code>.ci_type = &amp;dtbocfg_root_type</code>：配置项的类型设置为 <code>dtbocfg_root_type</code>，这是一个自定义的配置项类型。<br>接下来，<code>.su_mutex</code> 字段是一个互斥锁，用于保护子系统的操作。在这里，使用了<code>__MUTEX_INITIALIZER</code> 宏来初始化互斥锁。</p>
<p>上面的代码创建了一个名为”device-tree”的子系统，它的根配置项组为空。可以在该子系统下添加更多的配置项和配置项组，用于动态配置和管理设备树相关的内核对象。Linux系统下创建了 device-tree 这个子系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> /sys/kernel/config/</span><br><span class="line">devicetree usb_gadget</span><br></pre></td></tr></table></figure>

<p>驱动代码入口部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">dtbocfg_module_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> retval = <span class="number">0</span>;</span><br><span class="line">    pr_info(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 configfs 组</span></span><br><span class="line">    config_group_init(&amp;dtbocfg_root_subsys.su_group);</span><br><span class="line">    config_group_init_type_name(&amp;dtbocfg_overlay_group, <span class="string">&quot;overlays&quot;</span>, &amp;dtbocfg_overlays_type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册子系统</span></span><br><span class="line">    retval = configfs_register_subsystem(&amp;dtbocfg_root_subsys);</span><br><span class="line">    <span class="keyword">if</span> (retval != <span class="number">0</span>) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;%s: couldn&#x27;t register subsys\n&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> register_subsystem_failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册组</span></span><br><span class="line">    retval = configfs_register_group(&amp;dtbocfg_root_subsys.su_group, &amp;dtbocfg_overlay_group);</span><br><span class="line">    <span class="keyword">if</span> (retval != <span class="number">0</span>) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;%s: couldn&#x27;t register group\n&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> register_group_failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;%s: OK\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">register_group_failed:</span><br><span class="line">    configfs_unregister_subsystem(&amp;dtbocfg_root_subsys);</span><br><span class="line">register_subsystem_failed:</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码是一个初始化函数 <code>dtbocfg_module_init()</code>，用于初始化和注册 ConfigFS 子系统和配置项组。</p>
<p>首先，通过 <code>config_group_init()</code>函数初始化了 <code>dtbocfg_root_subsys.su_group</code>，即子系统的根配置项组。接下来，使用 <code>config_group_init_type_name()</code>函数初始化了<code>dtbocfg_overlay_group</code>，表示名为”overlays”的配置项组，并指定了配置项组的类型为<code>dtbocfg_overlays_type</code>，这是一个自定义的配置项类型。</p>
<p>然后，调用 <code>configfs_register_subsystem()</code>函数注册了 <code>dtbocfg_root_subsys</code> 子系统。如果注册失败，将打印错误信息，并跳转到<code>register_subsystem_failed</code> 标签处进行错误处理。</p>
<p>接着，调用 <code>configfs_register_group()</code>函数注册了 dtbocfg_overlay_group 配置项组，并将其添加到 <code>dtbocfg_root_subsys.su_group</code> 下。</p>
<p>这段代码的作用是初始化和注册一个名为”device-tree”的 ConfigFS 子系统，并在其下创建一个名为”overlays”的配置项组。</p>
<p>Linux 系统下，在 device-tree 子系统下创建了 overlays 容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> /sys/kernel/config/device-tree/</span><br><span class="line">overlays</span><br></pre></td></tr></table></figure>

<h2 id="属性和方法"><a href="#属性和方法" class="headerlink" title="属性和方法"></a>属性和方法</h2><p><strong>config_item</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> &#123;</span></span><br><span class="line">	<span class="type">char</span> *ci_name;</span><br><span class="line">	<span class="type">char</span> ci_namebuf[CONFIGFS_ITEM_NAME_LEN]; <span class="comment">//目录的名字</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">ci_kref</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">ci_entry</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> *<span class="title">ci_parent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> *<span class="title">ci_group</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> *<span class="title">ci_type</span>;</span> <span class="comment">//目录下属性文件和属性操作</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">ci_dentry</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>config_item 结构体中包含了 config_item_type 结构体，config_item_type 结构体如下所示</p>
<p><strong>config_item_type</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">ct_owner</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span> *<span class="title">ct_item_ops</span>;</span> <span class="comment">//item（目录）的操作方法</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span> *<span class="title">ct_group_ops</span>;</span> <span class="comment">//group（容器）的操作方法</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span> **<span class="title">ct_attrs</span>;</span> <span class="comment">//属性文件的操作方法</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">configfs_bin_attribute</span> **<span class="title">ct_bin_attrs</span>;</span> <span class="comment">//bin 属性文件的操作方法</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>config_item_type包含了许多重要数据结构：configfs_item_operations，configfs_group_operations，configfs_attribute，configfs_bin_attribute</p>
<p><strong>configfs_item_operations</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span> &#123;</span></span><br><span class="line">	<span class="comment">//删除 item 方法，在 group 下面使用 rmdir 命令会调用这个方法</span></span><br><span class="line">	<span class="type">void</span> (*release)(<span class="keyword">struct</span> config_item *);</span><br><span class="line">	<span class="type">int</span> (*allow_link)(<span class="keyword">struct</span> config_item *src, <span class="keyword">struct</span> config_item *target);</span><br><span class="line">	<span class="type">void</span> (*drop_link)(<span class="keyword">struct</span> config_item *src, <span class="keyword">struct</span> config_item *target);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>configfs_group_operations</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span> &#123;</span></span><br><span class="line">	<span class="comment">//创建 item 的方法，在 group 下面使用 mkdir 命令会调用这个方法</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> *(*<span class="title">make_item</span>)(<span class="keyword">struct</span> <span class="title">config_group</span> *<span class="title">group</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>);</span></span><br><span class="line">	<span class="comment">//创建 group 的方法</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> *(*<span class="title">make_group</span>)(<span class="keyword">struct</span> <span class="title">config_group</span> *<span class="title">group</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>);</span></span><br><span class="line">	<span class="type">int</span> (*commit_item)(<span class="keyword">struct</span> config_item *item);</span><br><span class="line">	<span class="type">void</span> (*disconnect_notify)(<span class="keyword">struct</span> config_group *group, <span class="keyword">struct</span> config_item *item);</span><br><span class="line">	<span class="type">void</span> (*drop_item)(<span class="keyword">struct</span> config_group *group, <span class="keyword">struct</span> config_item *item);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>struct configfs_attribute</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *ca_name; <span class="comment">// 属性文件的名字</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">ca_owner</span>;</span><span class="comment">// 属性文件文件的所属模块</span></span><br><span class="line">	<span class="type">umode_t</span> ca_mode; <span class="comment">// 属性文件访问权限</span></span><br><span class="line">	<span class="comment">// 读写方法的函数指针，具体功能需要自行实现。</span></span><br><span class="line">	<span class="type">ssize_t</span> (*show)(<span class="keyword">struct</span> config_item *, <span class="type">char</span> *);</span><br><span class="line">	<span class="type">ssize_t</span> (*store)(<span class="keyword">struct</span> config_item *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/even629/myPicGo/20251203210651422.png" alt="结构图" loading="lazy"></p>
<h2 id="示例-5"><a href="#示例-5" class="headerlink" title="示例"></a>示例</h2><h3 id="注册configFS子系统"><a href="#注册configFS子系统" class="headerlink" title="注册configFS子系统"></a>注册configFS子系统</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/configfs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义名为&quot;myconfig_item_type&quot;的配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">myconfig_item_type</span> =</span>&#123;</span><br><span class="line">  .ct_owner = THIS_MODULE,</span><br><span class="line">  .ct_item_ops = <span class="literal">NULL</span>,</span><br><span class="line">  .ct_group_ops = <span class="literal">NULL</span>,</span><br><span class="line">  .ct_attrs = <span class="literal">NULL</span>,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//定义一个configfs_subsystem结构体实例&quot;myconfigfs_subsystem&quot;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">myconfigfs_subsystem</span> =</span>&#123;</span><br><span class="line">  .su_group = &#123;</span><br><span class="line">    .cg_item = &#123;</span><br><span class="line">      .ci_namebuf = <span class="string">&quot;myconfigfs&quot;</span>,</span><br><span class="line">      .ci_type = &amp;myconfig_item_type,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模块的初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">myconfigfs_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//初始化配置组</span></span><br><span class="line">  config_group_init(&amp;myconfigfs_subsystem.su_group);</span><br><span class="line">  <span class="comment">//注册子系统</span></span><br><span class="line">  configfs_register_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">myconfigfs_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  configfs_unregister_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(myconfigfs_init); <span class="comment">// 指定模块的初始化函数</span></span><br><span class="line">module_exit(myconfigfs_exit); <span class="comment">// 指定模块的退出函数</span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);   <span class="comment">// 模块使用的许可证</span></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>); <span class="comment">// 模块的作者</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>加载后可以在<code>/sys/kernel/config</code>目录下看到注册的子系统myconfigfs</p>
<h3 id="注册group容器"><a href="#注册group容器" class="headerlink" title="注册group容器"></a>注册group容器</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/configfs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个名为&quot;mygroup&quot;的config_group结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> <span class="title">mygroup</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个名为&quot;mygroup_config_item_type&quot;的config_item_type结构体，用于描述配置项类型。</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">mygroup_config_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_item_ops = <span class="literal">NULL</span>,</span><br><span class="line">    .ct_group_ops = <span class="literal">NULL</span>,</span><br><span class="line">    .ct_attrs = <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义名为&quot;myconfig_item_type&quot;的配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">myconfig_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_group_ops = <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个configfs_subsystem结构体实例&quot;myconfigfs_subsystem&quot;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">myconfigfs_subsystem</span> =</span> &#123;</span><br><span class="line">    .su_group = &#123;</span><br><span class="line">        .cg_item = &#123;</span><br><span class="line">            .ci_namebuf = <span class="string">&quot;myconfigfs&quot;</span>,</span><br><span class="line">            .ci_type = &amp;myconfig_item_type,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块的初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">myconfig_group_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 初始化配置组</span></span><br><span class="line">  config_group_init(&amp;myconfigfs_subsystem.su_group);</span><br><span class="line">  <span class="comment">// 注册子系统</span></span><br><span class="line">  configfs_register_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化配置组&quot;mygroup&quot;</span></span><br><span class="line">  config_group_init_type_name(&amp;mygroup, <span class="string">&quot;mygroup&quot;</span>, &amp;mygroup_config_item_type);</span><br><span class="line">  <span class="comment">// 在子系统中注册配置组&quot;mygroup&quot;</span></span><br><span class="line">  configfs_register_group(&amp;myconfigfs_subsystem.su_group, &amp;mygroup);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">myconfig_group_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 注销子系统</span></span><br><span class="line">  configfs_unregister_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(myconfig_group_init); <span class="comment">// 指定模块的初始化函数</span></span><br><span class="line">module_exit(myconfig_group_exit); <span class="comment">// 指定模块的退出函数</span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);   <span class="comment">// 模块使用的许可证</span></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>); <span class="comment">// 模块的作者</span></span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> /sys/kernel/config/myconfigfs</span><br><span class="line">mygroup</span><br></pre></td></tr></table></figure>

<h3 id="用户空间创建item"><a href="#用户空间创建item" class="headerlink" title="用户空间创建item"></a>用户空间创建item</h3><p>我们已经成功在&#x2F;sys&#x2F;kernel&#x2F;config&#x2F;目录下创建了 myconfigfs 子系统，并在这个子系统下创建了 mygroup 容器，但是 mygroup 容器下不能使用 mkdir 创建 item</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/configfs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个名为&quot;mygroup&quot;的config_group结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> <span class="title">mygroup</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义的配置项结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">myitem</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> <span class="title">item</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项释放函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">myitem_release</span><span class="params">(<span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myitem</span> =</span> container_of(item, <span class="keyword">struct</span> myitem, item);</span><br><span class="line">    kfree(myitem);</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项操作结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span> <span class="title">myitem_ops</span> =</span> &#123;</span><br><span class="line">    .release = myitem_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">mygroup_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_item_ops = &amp;myitem_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建配置项函数</span></span><br><span class="line"><span class="keyword">struct</span> config_item *<span class="title function_">mygroup_make_item</span><span class="params">(<span class="keyword">struct</span> config_group *group, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myconfig_item</span>;</span></span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">    myconfig_item = kzalloc(<span class="keyword">sizeof</span>(*myconfig_item), GFP_KERNEL);</span><br><span class="line">    config_item_init_type_name(&amp;myconfig_item-&gt;item, name, &amp;mygroup_item_type);</span><br><span class="line">    <span class="keyword">return</span> &amp;myconfig_item-&gt;item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置组操作结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span> <span class="title">mygroup_ops</span> =</span> &#123;</span><br><span class="line">    .make_item = mygroup_make_item,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义名为&quot;mygroup_config_item_type&quot;的config_item_type结构体，用于描述配置项类型。</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">mygroup_config_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_group_ops = &amp;mygroup_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义名为&quot;myconfig_item_type&quot;的配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">myconfig_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_group_ops = <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个configfs_subsystem结构体实例&quot;myconfigfs_subsystem&quot;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">myconfigfs_subsystem</span> =</span> &#123;</span><br><span class="line">    .su_group = &#123;</span><br><span class="line">        .cg_item = &#123;</span><br><span class="line">            .ci_namebuf = <span class="string">&quot;myconfigfs&quot;</span>,</span><br><span class="line">            .ci_type = &amp;myconfig_item_type,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块的初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">myconfig_group_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 初始化配置组</span></span><br><span class="line">    config_group_init(&amp;myconfigfs_subsystem.su_group);</span><br><span class="line">    <span class="comment">// 注册子系统</span></span><br><span class="line">    configfs_register_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化配置组&quot;mygroup&quot;</span></span><br><span class="line">    config_group_init_type_name(&amp;mygroup, <span class="string">&quot;mygroup&quot;</span>, &amp;mygroup_config_item_type);</span><br><span class="line">    <span class="comment">// 在子系统中注册配置组&quot;mygroup&quot;</span></span><br><span class="line">    configfs_register_group(&amp;myconfigfs_subsystem.su_group, &amp;mygroup);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">myconfig_group_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注销子系统</span></span><br><span class="line">    configfs_unregister_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(myconfig_group_init); <span class="comment">// 指定模块的初始化函数</span></span><br><span class="line">module_exit(myconfig_group_exit); <span class="comment">// 指定模块的退出函数</span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);   <span class="comment">// 模块使用的许可证</span></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>); <span class="comment">// 模块的作者</span></span><br></pre></td></tr></table></figure>

<h3 id="完善drop和release"><a href="#完善drop和release" class="headerlink" title="完善drop和release"></a>完善drop和release</h3><p>release 和 .drop_item 是两个不同的成员字段，用于不同的目的：</p>
<ul>
<li><code>.release</code> 成员字段是在 <code>struct config_item_type</code> 结构体中定义的一个回调函数指针。它指向一个函数，当 configfs 中的配置项被释放或删除时，内核会调用该函数来执行相应的资源释放操作。它通常用于释放与配置项相关的资源，比如释放动态分配的内存、关闭打开的文件描述符等。</li>
<li><code>.drop_item</code> 是在 <code>struct configfs_group_operations</code> 结构体中定义的一个回调函数指针。它指向一个函数，当 configfs 中的配置组（group）被删除时，内核会调用该函数来处理与配置组相关的操作。这个函数通常用于清理配置组的状态、释放相关的资源以及执行其他必要的清理操作。<code>.drop_item</code> 函数在删除配置组时被调用，而不是在删除单个配置项时被调用。</li>
</ul>
<p><code>.release</code> 成员字段用于配置项的释放操作，而 <code>.drop_item</code> 成员字段用于配置组的删除操作。它们分别在不同的上下文中执行不同的任务，但都与资源释放和清理有关。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/configfs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个名为&quot;mygroup&quot;的config_group结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> <span class="title">mygroup</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义的配置项结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">myitem</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> <span class="title">item</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项释放函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">myitem_release</span><span class="params">(<span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myitem</span> =</span> container_of(item, <span class="keyword">struct</span> myitem, item);</span><br><span class="line">    kfree(myitem);</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项操作结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span> <span class="title">myitem_ops</span> =</span> &#123;</span><br><span class="line">    .release = myitem_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">mygroup_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_item_ops = &amp;myitem_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建配置项函数</span></span><br><span class="line"><span class="keyword">struct</span> config_item *<span class="title function_">mygroup_make_item</span><span class="params">(<span class="keyword">struct</span> config_group *group, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myconfig_item</span>;</span></span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">    myconfig_item = kzalloc(<span class="keyword">sizeof</span>(*myconfig_item), GFP_KERNEL);</span><br><span class="line">    config_item_init_type_name(&amp;myconfig_item-&gt;item, name, &amp;mygroup_item_type);</span><br><span class="line">    <span class="keyword">return</span> &amp;myconfig_item-&gt;item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除配置项函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mygroup_delete_item</span><span class="params">(<span class="keyword">struct</span> config_group *group, <span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myitem</span> =</span> container_of(item, <span class="keyword">struct</span> myitem, item);</span><br><span class="line"></span><br><span class="line">    config_item_put(&amp;myitem-&gt;item);</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置组操作结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span> <span class="title">mygroup_ops</span> =</span> &#123;</span><br><span class="line">    .make_item = mygroup_make_item,</span><br><span class="line">    .drop_item = mygroup_delete_item,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义名为&quot;mygroup_config_item_type&quot;的config_item_type结构体，用于描述配置项类型。</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">mygroup_config_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_group_ops = &amp;mygroup_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义名为&quot;myconfig_item_type&quot;的配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">myconfig_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_group_ops = <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个configfs_subsystem结构体实例&quot;myconfigfs_subsystem&quot;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">myconfigfs_subsystem</span> =</span> &#123;</span><br><span class="line">    .su_group = &#123;</span><br><span class="line">        .cg_item = &#123;</span><br><span class="line">            .ci_namebuf = <span class="string">&quot;myconfigfs&quot;</span>,</span><br><span class="line">            .ci_type = &amp;myconfig_item_type,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块的初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">myconfig_group_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 初始化配置组</span></span><br><span class="line">    config_group_init(&amp;myconfigfs_subsystem.su_group);</span><br><span class="line">    <span class="comment">// 注册子系统</span></span><br><span class="line">    configfs_register_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化配置组&quot;mygroup&quot;</span></span><br><span class="line">    config_group_init_type_name(&amp;mygroup, <span class="string">&quot;mygroup&quot;</span>, &amp;mygroup_config_item_type);</span><br><span class="line">    <span class="comment">// 在子系统中注册配置组&quot;mygroup&quot;</span></span><br><span class="line">    configfs_register_group(&amp;myconfigfs_subsystem.su_group, &amp;mygroup);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">myconfig_group_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注销子系统</span></span><br><span class="line">    configfs_unregister_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(myconfig_group_init); <span class="comment">// 指定模块的初始化函数</span></span><br><span class="line">module_exit(myconfig_group_exit); <span class="comment">// 指定模块的退出函数</span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);   <span class="comment">// 模块使用的许可证</span></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>); <span class="comment">// 模块的作者</span></span><br></pre></td></tr></table></figure>

<h3 id="注册attribute"><a href="#注册attribute" class="headerlink" title="注册attribute"></a>注册attribute</h3><p>我们成功创建了 item，但是 item 下面没有创建属性和操作项。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/configfs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个名为&quot;mygroup&quot;的config_group结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> <span class="title">mygroup</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义的配置项结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">myitem</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> <span class="title">item</span>;</span></span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    <span class="type">void</span> *addr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项释放函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">myitem_release</span><span class="params">(<span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myitem</span> =</span> container_of(item, <span class="keyword">struct</span> myitem, item);</span><br><span class="line">    kfree(myitem);</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取配置项内容的回调函数</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">myread_show</span><span class="params">(<span class="keyword">struct</span> config_item *item, <span class="type">char</span> *page)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myitem</span> =</span> container_of(item, <span class="keyword">struct</span> myitem, item);</span><br><span class="line">    <span class="built_in">memcpy</span>(page, myitem-&gt;addr, myitem-&gt;size);</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> myitem-&gt;size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入配置项内容的回调函数</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">mywrite_store</span><span class="params">(<span class="keyword">struct</span> config_item *item, <span class="type">const</span> <span class="type">char</span> *page, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myitem</span> =</span> container_of(item, <span class="keyword">struct</span> myitem, item);</span><br><span class="line">    myitem-&gt;addr = kmemdup(page, size, GFP_KERNEL);</span><br><span class="line">    myitem-&gt;size = size;</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> myitem-&gt;size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建只读配置项</span></span><br><span class="line">CONFIGFS_ATTR_RO(my, read);</span><br><span class="line"><span class="comment">// 创建只写配置项</span></span><br><span class="line">CONFIGFS_ATTR_WO(my, write);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项属性数组</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span> *<span class="title">my_attrs</span>[] =</span> &#123;</span><br><span class="line">    &amp;myattr_read,</span><br><span class="line">    &amp;myattr_write,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项操作结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span> <span class="title">myitem_ops</span> =</span> &#123;</span><br><span class="line">    .release = myitem_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">mygroup_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_item_ops = &amp;myitem_ops,</span><br><span class="line">    .ct_attrs = my_attrs,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建配置项函数</span></span><br><span class="line"><span class="keyword">struct</span> config_item *<span class="title function_">mygroup_make_item</span><span class="params">(<span class="keyword">struct</span> config_group *group, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myconfig_item</span>;</span></span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">    myconfig_item = kzalloc(<span class="keyword">sizeof</span>(*myconfig_item), GFP_KERNEL);</span><br><span class="line">    config_item_init_type_name(&amp;myconfig_item-&gt;item, name, &amp;mygroup_item_type);</span><br><span class="line">    <span class="keyword">return</span> &amp;myconfig_item-&gt;item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除配置项函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mygroup_delete_item</span><span class="params">(<span class="keyword">struct</span> config_group *group, <span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myitem</span> =</span> container_of(item, <span class="keyword">struct</span> myitem, item);</span><br><span class="line"></span><br><span class="line">    config_item_put(&amp;myitem-&gt;item);</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置组操作结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span> <span class="title">mygroup_ops</span> =</span> &#123;</span><br><span class="line">    .make_item = mygroup_make_item,</span><br><span class="line">    .drop_item = mygroup_delete_item,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">mygroup_config_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_group_ops = &amp;mygroup_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">myconfig_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_group_ops = <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个configfs_subsystem结构体实例&quot;myconfigfs_subsystem&quot;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">myconfigfs_subsystem</span> =</span> &#123;</span><br><span class="line">    .su_group = &#123;</span><br><span class="line">        .cg_item = &#123;</span><br><span class="line">            .ci_namebuf = <span class="string">&quot;myconfigfs&quot;</span>,</span><br><span class="line">            .ci_type = &amp;myconfig_item_type,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块的初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">myconfig_group_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 初始化配置组</span></span><br><span class="line">    config_group_init(&amp;myconfigfs_subsystem.su_group);</span><br><span class="line">    <span class="comment">// 注册子系统</span></span><br><span class="line">    configfs_register_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化配置组&quot;mygroup&quot;</span></span><br><span class="line">    config_group_init_type_name(&amp;mygroup, <span class="string">&quot;mygroup&quot;</span>, &amp;mygroup_config_item_type);</span><br><span class="line">    <span class="comment">// 在子系统中注册配置组&quot;mygroup&quot;</span></span><br><span class="line">    configfs_register_group(&amp;myconfigfs_subsystem.su_group, &amp;mygroup);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">myconfig_group_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注销子系统</span></span><br><span class="line">    configfs_unregister_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(myconfig_group_init); <span class="comment">// 指定模块的初始化函数</span></span><br><span class="line">module_exit(myconfig_group_exit); <span class="comment">// 指定模块的退出函数</span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);   <span class="comment">// 模块使用的许可证</span></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>); <span class="comment">// 模块的作者</span></span><br></pre></td></tr></table></figure>

<h3 id="实现多级目录"><a href="#实现多级目录" class="headerlink" title="实现多级目录"></a>实现多级目录</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/configfs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个名为&quot;mygroup&quot;的config_group结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> <span class="title">mygroup</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义的配置项结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">myitem</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> <span class="title">item</span>;</span></span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    <span class="type">void</span> *addr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 自定义的配置组结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mygroup</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> <span class="title">group</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项释放函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">myitem_release</span><span class="params">(<span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myitem</span> =</span> container_of(item, <span class="keyword">struct</span> myitem, item);</span><br><span class="line">    kfree(myitem);</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取配置项内容的回调函数</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">myread_show</span><span class="params">(<span class="keyword">struct</span> config_item *item, <span class="type">char</span> *page)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myitem</span> =</span> container_of(item, <span class="keyword">struct</span> myitem, item);</span><br><span class="line">    <span class="built_in">memcpy</span>(page, myitem-&gt;addr, myitem-&gt;size);</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> myitem-&gt;size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入配置项内容的回调函数</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">mywrite_store</span><span class="params">(<span class="keyword">struct</span> config_item *item, <span class="type">const</span> <span class="type">char</span> *page, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myitem</span> =</span> container_of(item, <span class="keyword">struct</span> myitem, item);</span><br><span class="line">    myitem-&gt;addr = kmemdup(page, size, GFP_KERNEL);</span><br><span class="line">    myitem-&gt;size = size;</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> myitem-&gt;size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建只读配置项</span></span><br><span class="line">CONFIGFS_ATTR_RO(my, read);</span><br><span class="line"><span class="comment">// 创建只写配置项</span></span><br><span class="line">CONFIGFS_ATTR_WO(my, write);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项属性数组</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span> *<span class="title">my_attrs</span>[] =</span> &#123;</span><br><span class="line">    &amp;myattr_read,</span><br><span class="line">    &amp;myattr_write,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项操作结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span> <span class="title">myitem_ops</span> =</span> &#123;</span><br><span class="line">    .release = myitem_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">mygroup_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_item_ops = &amp;myitem_ops,</span><br><span class="line">    .ct_attrs = my_attrs,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置组类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">mygroup_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建配置项函数</span></span><br><span class="line"><span class="keyword">struct</span> config_item *<span class="title function_">mygroup_make_item</span><span class="params">(<span class="keyword">struct</span> config_group *group, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myconfig_item</span>;</span></span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">    myconfig_item = kzalloc(<span class="keyword">sizeof</span>(*myconfig_item), GFP_KERNEL);</span><br><span class="line">    config_item_init_type_name(&amp;myconfig_item-&gt;item, name, &amp;mygroup_item_type);</span><br><span class="line">    <span class="keyword">return</span> &amp;myconfig_item-&gt;item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除配置项函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mygroup_delete_item</span><span class="params">(<span class="keyword">struct</span> config_group *group, <span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myitem</span> *<span class="title">myitem</span> =</span> container_of(item, <span class="keyword">struct</span> myitem, item);</span><br><span class="line"></span><br><span class="line">    config_item_put(&amp;myitem-&gt;item);</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建配置组函数</span></span><br><span class="line"><span class="keyword">struct</span> config_group *<span class="title function_">mygroup_make_group</span><span class="params">(<span class="keyword">struct</span> config_group *group, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mygroup</span> *<span class="title">mygroup</span>;</span></span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">    mygroup = kzalloc(<span class="keyword">sizeof</span>(*mygroup), GFP_KERNEL);</span><br><span class="line">    config_group_init_type_name(&amp;mygroup-&gt;group, name, &amp;mygroup_type);</span><br><span class="line">    <span class="keyword">return</span> &amp;mygroup-&gt;group;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置组操作结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span> <span class="title">mygroup_ops</span> =</span> &#123;</span><br><span class="line">    .make_item = mygroup_make_item,</span><br><span class="line">    .drop_item = mygroup_delete_item,</span><br><span class="line">    .make_group = mygroup_make_group,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">mygroup_config_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_group_ops = &amp;mygroup_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置项类型结构体</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">myconfig_item_type</span> =</span> &#123;</span><br><span class="line">    .ct_owner = THIS_MODULE,</span><br><span class="line">    .ct_group_ops = <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个configfs_subsystem结构体实例&quot;myconfigfs_subsystem&quot;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">myconfigfs_subsystem</span> =</span> &#123;</span><br><span class="line">    .su_group = &#123;</span><br><span class="line">        .cg_item = &#123;</span><br><span class="line">            .ci_namebuf = <span class="string">&quot;myconfigfs&quot;</span>,</span><br><span class="line">            .ci_type = &amp;myconfig_item_type,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块的初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">myconfig_group_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 初始化配置组</span></span><br><span class="line">    config_group_init(&amp;myconfigfs_subsystem.su_group);</span><br><span class="line">    <span class="comment">// 注册子系统</span></span><br><span class="line">    configfs_register_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化配置组&quot;mygroup&quot;</span></span><br><span class="line">    config_group_init_type_name(&amp;mygroup, <span class="string">&quot;mygroup&quot;</span>, &amp;mygroup_config_item_type);</span><br><span class="line">    <span class="comment">// 在子系统中注册配置组&quot;mygroup&quot;</span></span><br><span class="line">    configfs_register_group(&amp;myconfigfs_subsystem.su_group, &amp;mygroup);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">myconfig_group_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注销子系统</span></span><br><span class="line">    configfs_unregister_subsystem(&amp;myconfigfs_subsystem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(myconfig_group_init); <span class="comment">// 指定模块的初始化函数</span></span><br><span class="line">module_exit(myconfig_group_exit); <span class="comment">// 指定模块的退出函数</span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);   <span class="comment">// 模块使用的许可证</span></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>); <span class="comment">// 模块的作者</span></span><br></pre></td></tr></table></figure>



<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a><strong>参考资料</strong></h2><p><code>kernel/Documentation/filesystems/configfs</code> 目录下的 configfs.txt。</p>
<p><code>kernel/samples/configfs</code> 目录下的 configfs_sample.c</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://even629.github.io/">even629</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://even629.com/posts/2511300/">https://even629.com/posts/2511300/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://even629.com" target="_blank">常想一二，不思八九</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/GNU/">GNU</a><a class="post-meta__tags" href="/tags/driver/">driver</a><a class="post-meta__tags" href="/tags/DeviceTree/">DeviceTree</a></div><div class="post-share"><div class="social-share" data-image="/images/linux_cover.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center liquidGlass-wrapper" id="my-custom-card-author"><div class="liquidGlass-effect"></div><div class="liquidGlass-tint"></div><div class="liquidGlass-shine"></div><div class="liquidGlass-box"><div class="card-info-avatar"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-status-box"><div class="author-status">🐟<span>认真摸鱼中</span></div></div></div><div><div class="author-info-name">even629</div><div class="author-info-description">常想一二，不思八九</div></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">90</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/even629" target="_blank" title="github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="/img/qq.jpg" target="_blank" title="qq"><i class="fa-brands fa-qq" style="color: #000000;"></i></a><a class="social-icon" href="mailto:zhaohang731005515@proton.me" target="_blank" title="email"><i class="fas fa-envelope" style="color: #000000;"></i></a><a class="social-icon" href="https://space.bilibili.com/519280138" target="_blank" title="bilibili"><i class="fa-brands fa-bilibili" style="color: #000000;"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="rss"><i class="fas fa-rss" style="color: #000000;"></i></a></div></div></div><div class="card-widget" id="newYear"><div class="item-headline"><i></i><span></span></div><div class="item-content"> <div class="newYear-slider"> <div class="swiper-wrapper"> <div class="swiper-slide" style="background-image:url(/img/happy_new_year1.jpg)"></div> <div class="swiper-slide" style="background-image:url(/img/happy_new_year2.jpg)"></div> <div class="swiper-slide" style="background-image:url(/img/happy_new_year3.webp)"></div> <div class="swiper-slide" style="background-image:url(/img/happy_new_year4.gif)"></div> </div> </div> <div id="newYear-main"> <div class="mask"></div> <p class="title"></p> <div class="newYear-time"></div> <p class="today" style="text-align: right;"></p> </div> </div></div><div class="sticky_layout"><div class="card-widget liquidGlass-wrapper" id="card-toc"><div class="liquidGlass-effect"></div><div class="liquidGlass-tint"></div><div class="liquidGlass-shine"></div><div class="liquidGlass-box"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E6%A0%91%E4%BB%8B%E7%BB%8D"><span class="toc-text">设备树介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E6%A0%91%E7%9A%84%E7%BC%96%E8%AF%91"><span class="toc-text">设备树的编译</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E6%A0%91%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-text">设备树基本语法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B9%E8%8A%82%E7%82%B9"><span class="toc-text">根节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E8%8A%82%E7%82%B9"><span class="toc-text">子节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reg%E5%B1%9E%E6%80%A7"><span class="toc-text">reg属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#address-cells-%E5%92%8C-size-cells-%E5%B1%9E%E6%80%A7"><span class="toc-text">#address-cells 和 #size-cells 属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#address-cells"><span class="toc-text">#address-cells</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#size-cells"><span class="toc-text">#size-cells</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#model%E5%B1%9E%E6%80%A7"><span class="toc-text">model属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#status%E5%B1%9E%E6%80%A7"><span class="toc-text">status属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#compatible-%E5%B1%9E%E6%80%A7"><span class="toc-text">compatible 属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aliases%E8%8A%82%E7%82%B9"><span class="toc-text">aliases节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#chosen%E8%8A%82%E7%82%B9"><span class="toc-text">chosen节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#device-type%E8%8A%82%E7%82%B9"><span class="toc-text">device_type节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B1%9E%E6%80%A7"><span class="toc-text">自定义属性</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-text">实例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90%EF%BC%9A%E4%B8%AD%E6%96%AD"><span class="toc-text">实例分析：中断</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#interrupts-%E5%B1%9E%E6%80%A7"><span class="toc-text">interrupts 属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interrupt-controller%E5%B1%9E%E6%80%A7"><span class="toc-text">interrupt-controller属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interrupt-parent%E5%B1%9E%E6%80%A7"><span class="toc-text">interrupt-parent属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interrupt-cells%E5%B1%9E%E6%80%A7"><span class="toc-text">#interrupt-cells属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96SOC%E8%AE%BE%E5%A4%87%E6%A0%91%E5%AF%B9%E6%AF%94"><span class="toc-text">其他SOC设备树对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90%EF%BC%9A%E6%97%B6%E9%92%9F"><span class="toc-text">实例分析：时钟</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%92%9F%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-text">时钟生产者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%92%9F%E7%94%9F%E4%BA%A7%E8%80%85%E5%B1%9E%E6%80%A7"><span class="toc-text">时钟生产者属性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#clock-cells"><span class="toc-text">clock-cells</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#clock-frequency"><span class="toc-text">clock-frequency</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%92%9F%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-text">时钟消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%92%9F%E6%B6%88%E8%B4%B9%E8%80%85%E5%B1%9E%E6%80%A7"><span class="toc-text">时钟消费者属性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#clock"><span class="toc-text">clock</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#clock-names"><span class="toc-text">clock-names</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#assigned-clocks-%E5%92%8C-assigned-clock-rates"><span class="toc-text">assigned-clocks 和 assigned-clock-rates</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#clock-indices"><span class="toc-text">clock-indices</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#assigned-clock-parents"><span class="toc-text">assigned-clock-parents</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90%EF%BC%9ACPU"><span class="toc-text">实例分析：CPU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%99%A8%E6%8B%93%E6%89%91%E5%85%B3%E7%B3%BB"><span class="toc-text">处理器拓扑关系</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cpu-map%E3%80%81socket%E3%80%81cluster-%E8%8A%82%E7%82%B9"><span class="toc-text">cpu-map、socket、cluster 节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#core%E3%80%81thread-%E8%8A%82%E7%82%B9"><span class="toc-text">core、thread 节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90%EF%BC%9AGPIO"><span class="toc-text">实例分析：GPIO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gpio-controller%E5%B1%9E%E6%80%A7"><span class="toc-text">gpio-controller属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gpio-cells%E5%B1%9E%E6%80%A7"><span class="toc-text">#gpio-cells属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gpio-ranges%E5%B1%9E%E6%80%A7"><span class="toc-text">gpio-ranges属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gpio%E6%8F%8F%E8%BF%B0%E5%B1%9E%E6%80%A7%E4%B8%8Egpio-cells"><span class="toc-text">gpio描述属性与gpio-cells</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%B1%9E%E6%80%A7"><span class="toc-text">其他属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-text">示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96SOC%E5%AF%B9%E6%AF%94"><span class="toc-text">其他SOC对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90%EF%BC%9Apinctrl"><span class="toc-text">实例分析：pinctrl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pinmux%E4%BB%8B%E7%BB%8D"><span class="toc-text">pinmux介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-pinctrl-%E8%AE%BE%E7%BD%AE%E5%A4%8D%E7%94%A8%E5%85%B3%E7%B3%BB"><span class="toc-text">使用 pinctrl 设置复用关系</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Client"><span class="toc-text">Client</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server"><span class="toc-text">Server</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pinctrl%E5%AE%9E%E4%BE%8B%E7%BC%96%E5%86%99"><span class="toc-text">pinctrl实例编写</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dtb%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90"><span class="toc-text">dtb文件格式解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Header"><span class="toc-text">Header</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BF%9D%E7%95%99%E5%9D%97"><span class="toc-text">内存保留块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%9D%97"><span class="toc-text">结构块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A4%E7%89%8C%E7%B1%BB%E5%9E%8B"><span class="toc-text">令牌类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%91%E7%8A%B6%E7%BB%93%E6%9E%84"><span class="toc-text">树状结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%9D%97%E7%9A%84%E7%BB%93%E6%9D%9F"><span class="toc-text">结构块的结束</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%9D%97"><span class="toc-text">字符串块</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dtb%E5%B1%95%E5%BC%80%E6%88%90device-node"><span class="toc-text">dtb展开成device_node</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dtb%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">dtb解析过程源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#init-main-c"><span class="toc-text">init&#x2F;main.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#arch-arm64-kernel-setup-c"><span class="toc-text">arch&#x2F;arm64&#x2F;kernel&#x2F;setup.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setup-machine-fdt-fdt-pointer"><span class="toc-text">setup_machine_fdt(__fdt_pointer)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unflatten-device-tree"><span class="toc-text">unflatten_device_tree()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#unflatten-device-tree-1"><span class="toc-text">__unflatten_device_tree</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unflatten-dt-nodes"><span class="toc-text">unflatten_dt_nodes()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#populate-node"><span class="toc-text">populate_node</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#device-node%E8%BD%AC%E4%B8%BAplatform-device"><span class="toc-text">device_node转为platform_device</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E8%A7%84%E5%88%99"><span class="toc-text">转换规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="toc-text">示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#of-platform-default-populate-init"><span class="toc-text">of_platform_default_populate_init()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-platform-populate"><span class="toc-text">of_platform_populate()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-platform-bus-create"><span class="toc-text">of_platform_bus_create()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-platform-device-create-pdata"><span class="toc-text">of_platform_device_create_pdata()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-device-alloc"><span class="toc-text">of_device_alloc()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E6%A0%91%E4%B8%8B-platform-device-%E5%92%8C-platform-driver-%E5%8C%B9%E9%85%8D"><span class="toc-text">设备树下 platform_device 和 platform_driver 匹配</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#of-match-table"><span class="toc-text">of_match_table</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#of%E6%93%8D%E4%BD%9C"><span class="toc-text">of操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%AE%BE%E5%A4%87%E6%A0%91%E8%8A%82%E7%82%B9"><span class="toc-text">获取设备树节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#of-find-by-name"><span class="toc-text">of_find_by_name()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-find-node-by-path"><span class="toc-text">of_find_node_by_path()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-get-parent"><span class="toc-text">of_get_parent()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-get-next-child"><span class="toc-text">of_get_next_child()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-find-compatible-node"><span class="toc-text">of_find_compatible_node()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-find-matching-node-and-match"><span class="toc-text">of_find_matching_node_and_match()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-3"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%AE%BE%E5%A4%87%E6%A0%91%E5%B1%9E%E6%80%A7"><span class="toc-text">获取设备树属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#of-find-property"><span class="toc-text">of_find_property()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-property-count-elems-of-size"><span class="toc-text">of_property_count_elems_of_size()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-property-read-u32-index"><span class="toc-text">of_property_read_u32_index()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-property-read-u64-index"><span class="toc-text">of_property_read_u64_index()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-property-read-variable-u32-array"><span class="toc-text">of_property_read_variable_u32_array()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-property-read-string"><span class="toc-text">of_property_read_string()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-4"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ranges%E5%B1%9E%E6%80%A7"><span class="toc-text">ranges属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#platform-get-resource-%E8%8E%B7%E5%8F%96%E8%AE%BE%E5%A4%87%E6%A0%91%E8%B5%84%E6%BA%90%E7%9A%84%E5%89%8D%E6%8F%90"><span class="toc-text">platform_get_resource 获取设备树资源的前提</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ranges%E5%B1%9E%E6%80%A7%E4%BB%8B%E7%BB%8D"><span class="toc-text">ranges属性介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E5%88%86%E7%B1%BB"><span class="toc-text">设备分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E5%9E%8B%E8%AE%BE%E5%A4%87"><span class="toc-text">内存映射型设备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E5%9E%8B%E8%AE%BE%E5%A4%87"><span class="toc-text">非内存映射型设备</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%B8%AD%E6%96%AD%E8%B5%84%E6%BA%90"><span class="toc-text">获取中断资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#irq-of-parse-and-map"><span class="toc-text">irq_of_parse_and_map()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#irqd-get-trigger-type"><span class="toc-text">irqd_get_trigger_type()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#irq-get-irq-data"><span class="toc-text">irq_get_irq_data()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gpio-to-irq"><span class="toc-text">gpio_to_irq()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#of-irq-get"><span class="toc-text">of_irq_get()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#platform-get-irq"><span class="toc-text">platform_get_irq()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-text">例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3%EF%BC%9Adts-bindings"><span class="toc-text">参考文档：dts-bindings</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E6%A0%91%E6%8F%92%E4%BB%B6"><span class="toc-text">设备树插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E6%A0%91%E6%8F%92%E4%BB%B6%E8%AF%AD%E6%B3%95"><span class="toc-text">设备树插件语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%BB%E6%A4%8D%E8%AE%BE%E5%A4%87%E6%A0%91%E9%A9%B1%E5%8A%A8%E6%8F%92%E4%BB%B6"><span class="toc-text">移植设备树驱动插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E8%AE%BE%E5%A4%87%E6%A0%91%E6%8F%92%E4%BB%B6"><span class="toc-text">加载设备树插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B9%E5%8F%98%E9%9B%86"><span class="toc-text">改变集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FConfigFS%E4%BB%8B%E7%BB%8D"><span class="toc-text">虚拟文件系统ConfigFS介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigFS%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">ConfigFS核心数据结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95"><span class="toc-text">属性和方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-5"><span class="toc-text">示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8CconfigFS%E5%AD%90%E7%B3%BB%E7%BB%9F"><span class="toc-text">注册configFS子系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8Cgroup%E5%AE%B9%E5%99%A8"><span class="toc-text">注册group容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E5%88%9B%E5%BB%BAitem"><span class="toc-text">用户空间创建item</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E5%96%84drop%E5%92%8Crelease"><span class="toc-text">完善drop和release</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8Cattribute"><span class="toc-text">注册attribute</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%A4%9A%E7%BA%A7%E7%9B%AE%E5%BD%95"><span class="toc-text">实现多级目录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text">参考资料</span></a></li></ol></li></ol></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient(135deg, rgba(146, 233, 227, 1) 0%, rgba(0, 0, 0, 0) 70%);;"><div id="footer-wrap"><div class="footer-button"><a target="_blank" rel="noopener" href="https://github.com/even629" title="github"><i class="fab fa-github"></i></a><a href="/img/qq.jpg" title="qq"><i class="fa-brands fa-qq"></i></a><a href="mailto:zhaohang731005515@proton.me" title="email"><i class="fas fa-envelope"></i></a><a target="_blank" rel="noopener" href="https://space.bilibili.com/519280138" title="bilibili"><i class="fa-brands fa-bilibili"></i></a><a href="/atom.xml" title="rss"><i class="fas fa-rss"></i></a></div><div class="copyright">&copy;2024 - 2026 By even629</div><p><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Frame-Hexo-blue.svg" title="博客框架为 Hexo"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Theme-Butterfly.svg" title="主题采用 butterfly"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Source-Github.svg" title="本站项目由 Github 托管"/></a><a style="margin-inline:5px;text-decoration:none;" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Copyright-BY--NC--SA.4.svg" title="本站采用知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议进行许可"/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="中英转换">中</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span data-zh="新窗口打开" data-en="Open in New Window"></span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span data-zh="转到链接" data-en="Go to Link"></span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span data-zh="复制链接" data-en="Copy Link"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span data-zh="复制" data-en="Copy"> </span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.google.com/search?q=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span data-zh="谷歌搜索" data-en="Google Search"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span data-zh="转到链接" data-en="Go to Link"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span data-zh="粘贴" data-en="Paste"></span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span data-zh="空降评论" data-en="Jump to Comment"></span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();"><i class="fa fa-book"></i><span data-zh="阅读模式" data-en="Reading Mode"> </span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span data-zh="保存图片" data-en="Save Image"></span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span data-zh="在新窗口打开" data-en="Open in New Tab"></span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span data-zh="复制图片链接" data-en="Copy Image Link"></span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:rmf.switchDarkmode();"><i class="fa fa-moon"></i><span data-zh="昼夜切换" data-en="Day/Night Mode"></span></a><a class="rightMenu-item" href="javascript:rmf.stopSakura();"><i class="fa-solid fa-feather"></i><span data-zh="樱花特效" data-en="toggle sakura"></span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span data-zh="切换全屏" data-en="Toggle Full Screen"></span></a><a class="rightMenu-item" href="javascript:rmf.switchLanguageMode();"><i class="fas fa-language"></i><span data-zh="语言切换" data-en="Language Switch"></span></a><a class="rightMenu-item" href="/"><i class="fa fa-home"></i><span data-zh="回到首页" data-en="Go to Home"></span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span data-zh="打印页面" data-en="Print Page"></span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/utils.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }
      
      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: 'Ov23liyQTymWpBETlDO8',
      clientSecret: '1512bfe449aac2a5ec3b416df1ce27fb5ddb5db0',
      repo: 'even629.github.io',
      owner: 'even629',
      admin: ['even629'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || '4de11f3600df5434638f5ef5d4dfb55d'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.0.6/swiper-bundle.min.js"></script><script src="/js/sakura.js"></script><script defer src="/js/right_menu.js"></script><script async src="/js/fps.js"></script><script src="/js/solarlunar.js"></script><script src="/js/newYear.js"></script><script src="/js/pop-up-window.js"></script><script data-pjax src="/js/nav.js"></script><script data-pjax src="/js/music.js"></script><script data-pjax src="/js/btf.js"></script><script data-pjax src="/js/ch_en.js"></script><svg style="display: none">
<filter
  id="glass-distortion"
  x="0%"
  y="0%"
  width="100%"
  height="100%"
  filterUnits="objectBoundingBox"
>
  <feTurbulence
    type="fractalNoise"
    baseFrequency="0.01 0.01"
    numOctaves="1"
    seed="5"
    result="turbulence"
  />
  <!-- Seeds: 14, 17,  -->

  <feComponentTransfer in="turbulence" result="mapped">
    <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5" />
    <feFuncG type="gamma" amplitude="0" exponent="1" offset="0" />
    <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5" />
  </feComponentTransfer>

  <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap" />

  <feSpecularLighting
    in="softMap"
    surfaceScale="5"
    specularConstant="1"
    specularExponent="100"
    lighting-color="white"
    result="specLight"
  >
    <fePointLight x="-200" y="-200" z="300" />
  </feSpecularLighting>

  <feComposite
    in="specLight"
    operator="arithmetic"
    k1="0"
    k2="1"
    k3="1"
    k4="0"
    result="litImage"
  />

  <feDisplacementMap
    in="SourceGraphic"
    in2="softMap"
    scale="150"
    xChannelSelector="R"
    yChannelSelector="G"
  />
  </filter>
</svg>
<script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="/css/APlayer.min.css" media="print" onload="this.media='all'"><script src="/js/APlayer.min.js"></script><script src="/js/meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404.html')
    }
  })
})()</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="search" type="text"/></div></div><hr class="custom-hr"/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('container');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '800ms');
    arr[i].setAttribute('data-wow-delay', '0ms');
    arr[i].setAttribute('data-wow-offset', '0');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="/js/wowjs/wow.min.js"></script><script defer src="/js/wowjs/wow_init.js"></script><script async src="//at.alicdn.com/t/c/font_4847823_upluhme7cv.js"></script><!-- hexo injector body_end end --></body></html>